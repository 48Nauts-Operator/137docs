<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Sphinx Docstring Parser

This module provides functionality to parse Sphinx-style docstrings into structured data. It converts Sphinx field directives (like `:param:`, `:type:`, `:returns:`) into organized docstring sections that can be used for documentation generation.

## Overview

The parser processes Sphinx docstrings and extracts:
- **Parameters** and their types
- **Attributes** and their types  
- **Return values** and types
- **Exceptions** that may be raised
- **Description text**

## Credits

Originally created by Patrick Lannigan ([@plannigan](https://github.com/plannigan)) for the [pytkdocs project](https://github.com/mkdocstrings/pytkdocs).

## Main Function

### `parse_sphinx()`

```python
def parse_sphinx(
    docstring: Docstring,
    *,
    warn_unknown_params: bool = True,
    warnings: bool = True,
    **options: Any,
) -> list[DocstringSection]:
```

**Purpose**: Main entry point for parsing Sphinx-style docstrings.

**Parameters**:
- `docstring`: The docstring object to parse
- `warn_unknown_params`: Whether to warn about documented parameters not in the function signature
- `warnings`: Whether to log warnings at all
- `**options`: Additional parsing options

**Returns**: List of structured docstring sections

## Core Classes

### `_FieldType`

```python
@dataclass(frozen=True)
class _FieldType:
    names: frozenset[str]
    reader: Callable[[Docstring, int, _ParsedValues], int]
```

Maps directive names to their corresponding parser functions.

**Key Method**:
- `matches(line: str) -> bool`: Checks if a line matches the field type

### `_ParsedDirective`

```python
@dataclass
class _ParsedDirective:
    line: str
    next_index: int
    directive_parts: list[str]
    value: str
    invalid: bool = False
```

Contains information about a parsed directive from the docstring.

### `_ParsedValues`

```python
@dataclass
class _ParsedValues:
    description: list[str]
    parameters: dict[str, DocstringParameter]
    param_types: dict[str, str]
    attributes: dict[str, DocstringAttribute]
    attribute_types: dict[str, str]
    exceptions: list[DocstringRaise]
    return_value: DocstringReturn | None
    return_type: str | None
```

Accumulates all parsed values from the docstring before converting to sections.

## Supported Sphinx Directives

The parser recognizes these directive types:

- **Parameters**: `:param:`, `:parameter:`, `:arg:`, `:argument:`, `:key:`, `:keyword:`
- **Parameter Types**: `:type:`
- **Attributes**: `:var:`, `:ivar:`, `:cvar:`
- **Attribute Types**: `:vartype:`
- **Returns**: `:returns:`, `:return:`
- **Return Types**: `:rtype:`
- **Exceptions**: `:raises:`, `:raise:`, `:except:`, `:exception:`

## Key Parser Functions

### Parameter Parsing
- `_read_parameter()`: Parses parameter directives
- `_read_parameter_type()`: Parses parameter type directives

### Attribute Parsing
- `_read_attribute()`: Parses attribute directives
- `_read_attribute_type()`: Parses attribute type directives

### Return/Exception Parsing
- `_read_return()`: Parses return value directives
- `_read_return_type()`: Parses return type directives
- `_read_exception()`: Parses exception directives

## Utility Functions

### `_parse_directive()`
Parses individual directive lines and handles continuation lines.

### `_consolidate_continuation_lines()`
Combines multi-line directive values into a single string.

### `_consolidate_descriptive_type()`
Converts "or" syntax to pipe syntax (e.g., "str or int" â†’ "str | int").

### `_strip_blank_lines()`
Removes leading and trailing blank lines from content.

## Type Annotation Precedence

The parser follows specific precedence rules for determining type annotations:

### Parameters
1. Inline directive type (e.g., `:param str name:`)
2. Separate `:type:` directive
3. Function signature annotation
4. None

### Attributes
1. `:vartype:` directive
2. Parent object annotation
3. None

### Returns
1. `:rtype:` directive
2. Function signature annotation
3. None

## Warning System

The parser includes comprehensive warnings for:
- Duplicate parameter/attribute entries
- Unknown parameters not in function signature
- Missing type information
- Malformed directives
- Conflicting type specifications

## Usage Notes

- **Continuation Lines**: Multi-line directive values are automatically consolidated
- **Type Conversion**: Descriptive types using "or" are converted to union syntax with "|"
- **Error Handling**: Malformed directives are logged as warnings but don't stop parsing
- **Flexible Naming**: Supports multiple aliases for each directive type

## Limitations

- **Examples**: No standard format support yet (marked as TODO)
- **Return Names**: Return values don't currently support names (always empty string)

This parser provides robust handling of Sphinx docstring format with extensive error checking and flexible directive recognition.