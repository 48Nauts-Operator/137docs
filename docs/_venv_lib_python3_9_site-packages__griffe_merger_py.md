<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Stubs Merging Module

This module provides utilities to merge Python stub files (`.pyi`) data with concrete implementation data. It's part of the Griffe library, which is used for Python code inspection and documentation generation.

## Purpose

The module handles the complex process of combining type information from stub files with actual implementation code. This is essential for generating accurate documentation that includes both runtime behavior and type annotations.

## Key Functions

### `merge_stubs(mod1: Module, mod2: Module) -> Module`

**Main entry point** for merging two modules - one regular module and one stub module.

```python
def merge_stubs(mod1: Module, mod2: Module) -> Module:
    """Merge stubs into a module.

    Parameters:
        mod1: A regular module or stubs module.
        mod2: A regular module or stubs module.

    Raises:
        ValueError: When both modules are regular modules (no stubs is passed).

    Returns:
        The regular module.
    """
```

**Key behaviors:**
- Automatically detects which module is the stub file (`.pyi` extension)
- Raises `ValueError` if both modules are regular (non-stub) modules
- Returns the enhanced regular module with merged stub data

### Type-Specific Merge Functions

The module provides specialized merge functions for different Python object types:

#### `_merge_module_stubs(module: Module, stubs: Module)`
- Merges docstrings, overloads, and members
- Handles top-level module merging

#### `_merge_class_stubs(class_: Class, stubs: Class)`
- Merges class-specific information
- Handles class docstrings, overloads, and members

#### `_merge_function_stubs(function: Function, stubs: Function)`
- Merges parameter annotations from stub to concrete function
- Updates return type annotations
- Preserves docstrings from stubs if missing in concrete implementation

```python
def _merge_function_stubs(function: Function, stubs: Function) -> None:
    _merge_stubs_docstring(function, stubs)
    for parameter in stubs.parameters:
        with suppress(KeyError):
            function.parameters[parameter.name].annotation = parameter.annotation
    function.returns = stubs.returns
```

#### `_merge_attribute_stubs(attribute: Attribute, stubs: Attribute)`
- Merges attribute type annotations
- Updates attribute values (unless stub value is `None` or `"..."`)

### Helper Functions

#### `_merge_stubs_docstring(obj: Object, stubs: Object)`
- Copies docstring from stub to object **only if** the object lacks a docstring
- Prevents overwriting existing documentation

#### `_merge_stubs_overloads(obj: Module | Class, stubs: Module | Class)`
- Merges function overload definitions from stubs
- Handles `@overload` decorator scenarios

#### `_merge_stubs_members(obj: Module | Class, stubs: Module | Class)`
- **Most complex function** - handles member-level merging
- Key behaviors:
  - Merges import statements
  - Updates export lists from stubs
  - Skips merging imported stub objects that already exist
  - Validates object kinds match before merging
  - Recursively merges nested objects
  - Marks stub-only members as `runtime = False`

## Important Features

### Error Handling
- Uses `contextlib.suppress` to gracefully handle expected exceptions
- Handles `AliasResolutionError` and `CyclicAliasError` when resolving object references
- Logs debug information when merging fails due to kind mismatches

### Smart Merging Logic
- **Preserves existing data**: Only fills in missing information, doesn't overwrite
- **Type validation**: Ensures stub and concrete objects are compatible types
- **Alias handling**: Properly handles Python object aliases and their canonical locations

## Usage Notes

### Best Practices
- Ensure stub files follow proper `.pyi` naming convention
- Stub objects should be defined at their public locations, not imported from other modules
- The function automatically identifies which module is the stub file

### Limitations
- Cannot merge two regular (non-stub) modules together
- Objects must be of the same kind (module, class, function, attribute) to merge successfully
- Imported stub objects are skipped if they already exist in the concrete module

### Logging
The module uses debug-level logging to track merge operations and report issues:
```python
logger.debug("Cannot merge stubs for %s: kind %s != %s", ...)
```

This module is essential for Python documentation tools that need to combine runtime introspection with static type information from stub files.