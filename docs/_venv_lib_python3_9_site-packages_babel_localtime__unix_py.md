<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Timezone Detection Module

## Overview

This Python module provides functionality to automatically detect the local timezone configuration on Unix-like systems. It's part of the Babel library's localization utilities and implements a comprehensive fallback strategy to determine the system's timezone settings.

## Purpose

The module attempts to identify the local timezone by checking various system configuration sources in order of preference:
1. Environment variables
2. Symbolic links
3. Distribution-specific configuration files
4. System timezone data files

## Key Functions

### `_tz_from_env(tzenv: str) -> datetime.tzinfo`

Processes timezone information from environment variables.

**Parameters:**
- `tzenv`: Timezone string from environment variable

**Behavior:**
- Strips leading colon (`:`) if present
- Checks if the string represents a file path
- Falls back to treating it as a timezone name

```python
# Example usage (internal)
tzinfo = _tz_from_env("America/New_York")
tzinfo = _tz_from_env(":/usr/share/zoneinfo/UTC")
```

### `_get_localzone(_root: str = '/') -> datetime.tzinfo`

**Main function** that attempts to find the local timezone configuration using multiple detection methods.

**Parameters:**
- `_root`: Root directory for searching configuration files (default: `'/'`)
  - Primarily used for testing purposes
  - Allows testing without system-level access

**Returns:**
- `datetime.tzinfo`: Timezone information object

**Raises:**
- `LookupError`: When no timezone configuration can be found

## Detection Strategy

The function follows this priority order:

### 1. Environment Variable (`TZ`)
- Checks the `TZ` environment variable first
- Handles both file paths and timezone names

### 2. Symbolic Link Analysis
- Examines `/etc/localtime` symlink
- Extracts timezone name from zoneinfo path
- Handles malformed paths with double slashes

### 3. Distribution-Specific Files

#### `/etc/timezone` (Debian/Ubuntu)
```bash
# Example file content
America/New_York
```
- Handles misconfigured files (ignores binary zoneinfo files)
- Strips comments and host definitions
- Replaces spaces with underscores

#### System Configuration Files
Searches these files with regex pattern matching:
- `/etc/sysconfig/clock` (CentOS)
- `/etc/conf.d/clock` (Gentoo, OpenSUSE)

**Regex Pattern:** `\s*(TIME)?ZONE\s*=\s*"(?P<etctz>.+)"`

Example matching lines:
```bash
ZONE="America/New_York"
TIMEZONE="Europe/London"
```

### 4. Fallback to Binary Files
As a last resort, reads timezone data directly from:
- `/etc/localtime`
- `/usr/local/etc/localtime`

## Usage Notes

### Normal Usage
```python
try:
    local_tz = _get_localzone()
    print(f"Local timezone: {local_tz}")
except LookupError:
    print("Could not determine local timezone")
```

### Testing Usage
```python
# For testing with custom root directory
test_tz = _get_localzone(_root='/path/to/test/root')
```

## Important Considerations

- **OS X Compatibility**: The symlink method is particularly reliable on macOS
- **Error Handling**: Gracefully handles missing files and malformed configurations
- **Misconfiguration Tolerance**: Detects and handles incorrectly configured timezone files
- **Cross-Distribution Support**: Works across major Linux distributions

## Dependencies

The module relies on helper functions from `babel.localtime._helpers`:
- `_get_tzinfo()`: Get timezone info by name
- `_get_tzinfo_from_file()`: Parse timezone from binary file
- `_get_tzinfo_or_raise()`: Get timezone info or raise exception

## Limitations

- Primarily designed for Unix-like systems
- May not work on Windows without additional configuration
- Requires appropriate file system permissions to read system files