<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Windows Local Timezone Detection Module

## Overview

This module provides functionality to detect the local timezone on Windows systems by interfacing with the Windows Registry. It handles the complexity of Windows timezone naming conventions and provides mapping between Windows-specific timezone names and standard timezone identifiers.

## Purpose

- **Primary Goal**: Determine the local timezone on Windows systems
- **Key Challenge**: Windows uses localized timezone names that need to be mapped to standard timezone identifiers
- **Integration**: Works as part of the Babel localization library's timezone handling system

## Dependencies

```python
import winreg          # Windows Registry access (Windows only)
import datetime        # Timezone info objects
from babel.core import get_global
from babel.localtime._helpers import _get_tzinfo_or_raise
```

## Global Variables

### `tz_names`
```python
tz_names: dict[str, str]
```
- **Purpose**: Maps Windows timezone names to standard timezone identifiers
- **Source**: Loaded from Babel's global CLDR data (`windows_zone_mapping`)
- **Fallback**: Empty dictionary if global data is unavailable during build process

## Functions

### `valuestodict(key) -> dict[str, Any]`

**Purpose**: Converts Windows Registry key values to a Python dictionary.

**Parameters**:
- `key`: Windows Registry key object

**Returns**: Dictionary containing all key-value pairs from the registry key

**Usage**:
```python
registry_values = valuestodict(registry_key)
```

---

### `get_localzone_name() -> str`

**Purpose**: Retrieves the local timezone name by querying the Windows Registry.

**Process**:
1. **Windows 7+ Path**: Attempts to read `TimeZoneKeyName` directly
2. **Legacy Path (Windows 2000/XP)**: 
   - Reads localized `StandardName`
   - Searches through all timezone entries to find matching standard name
   - Maps localized name back to timezone key

**Registry Locations**:
- Local timezone info: `SYSTEM\CurrentControlSet\Control\TimeZoneInformation`
- Timezone database: `SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time Zones`

**Returns**: Standard timezone identifier string

**Exceptions**:
- `LookupError`: When timezone configuration cannot be found or mapped

---

### `_get_localzone() -> datetime.tzinfo`

**Purpose**: Main entry point that returns a timezone info object for the local timezone.

**Returns**: `datetime.tzinfo` object representing the local timezone

**Exceptions**:
- `LookupError`: When `winreg` module is unavailable (non-Windows systems)

## Platform Compatibility

| Platform | Support | Notes |
|----------|---------|-------|
| Windows 7+ | ✅ Full | Uses `TimeZoneKeyName` registry value |
| Windows XP/2000 | ✅ Full | Uses legacy lookup method |
| Non-Windows | ❌ None | Raises `LookupError` |

## Error Handling

- **Missing winreg**: Gracefully handles import failure on non-Windows systems
- **Missing CLDR data**: Falls back to empty timezone mapping during build process
- **Registry access failures**: Raises descriptive `LookupError` exceptions
- **NUL byte handling**: Cleans up malformed registry strings

## Usage Notes

⚠️ **Important Considerations**:

1. **Windows-Only**: This module only functions on Windows systems
2. **Registry Dependency**: Requires appropriate permissions to read system registry
3. **Localization Handling**: Automatically handles localized timezone names
4. **Fallback Strategy**: Attempts multiple mapping strategies for maximum compatibility

## Example Usage

```python
try:
    local_tz = _get_localzone()
    print(f"Local timezone: {local_tz}")
except LookupError as e:
    print(f"Could not determine timezone: {e}")
```

## Technical Notes

- The module handles a Windows quirk where registry strings may contain NUL bytes
- Implements a fallback mechanism that appends "Standard Time" to timezone names when direct mapping fails
- Designed to work during Babel's CLDR data build process when global timezone data may not be available