<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Windows Local Time Zone Detection Module

## Overview

This module provides functionality to detect the local time zone on Windows systems by interfacing with the Windows Registry. It handles the complexity of Windows time zone naming conventions and maps Windows-specific time zone names to standard timezone identifiers.

## Purpose

Windows systems store time zone information in a unique format that differs from standard timezone naming conventions. This module:

- Reads Windows Registry entries to determine the current system time zone
- Maps Windows-specific timezone names to standard timezone identifiers
- Handles differences between Windows versions (Windows 2000/XP vs Windows 7/Vista+)
- Provides a standardized way to get timezone information on Windows systems

## Dependencies

- `winreg`: Windows Registry access (Windows-only)
- `babel.core`: For accessing global timezone mapping data
- `babel.localtime._helpers`: Helper functions for timezone operations
- `datetime`: Standard datetime operations

## Key Components

### Global Variables

```python
tz_names: dict[str, str]
```
- Dictionary containing Windows timezone name mappings
- Loaded from Babel's global timezone mapping data
- Falls back to empty dictionary if global data is unavailable

### Functions

#### `valuestodict(key) -> dict[str, Any]`

Utility function that converts Windows Registry key values to a Python dictionary.

**Parameters:**
- `key`: Windows Registry key object

**Returns:**
- Dictionary containing all key-value pairs from the registry key

**Usage:**
```python
registry_dict = valuestodict(registry_key)
```

#### `get_localzone_name() -> str`

Main function that determines the local timezone name by querying the Windows Registry.

**Process:**
1. Connects to Windows Registry (`HKEY_LOCAL_MACHINE`)
2. Reads timezone information from `SYSTEM\CurrentControlSet\Control\TimeZoneInformation`
3. Handles different Windows versions:
   - **Windows 7/Vista+**: Uses `TimeZoneKeyName` registry value
   - **Windows 2000/XP**: Performs reverse lookup using `StandardName`
4. Maps Windows timezone name to standard timezone identifier

**Returns:**
- Standard timezone identifier string

**Raises:**
- `LookupError`: When timezone configuration cannot be found or mapped

#### `_get_localzone() -> datetime.tzinfo`

Returns a timezone info object for the local Windows timezone.

**Returns:**
- `datetime.tzinfo` object representing the local timezone

**Raises:**
- `LookupError`: When runtime support is not available (non-Windows systems)

## Platform Compatibility

- **Supported**: Windows systems only
- **Unsupported**: Unix/Linux/macOS (will raise `LookupError`)

## Error Handling

The module includes robust error handling for common scenarios:

- **Missing `winreg` module**: Gracefully handles non-Windows environments
- **Registry access failures**: Provides meaningful error messages
- **Missing timezone mappings**: Attempts fallback strategies
- **Malformed registry data**: Handles NUL byte contamination in registry strings

## Usage Notes

### Important Considerations

- **Windows Version Differences**: The module automatically detects and handles differences between Windows versions
- **Localization Issues**: Windows timezone names can be localized, requiring reverse lookup for older Windows versions
- **Registry Dependencies**: Requires appropriate permissions to read Windows Registry
- **Build-time Safety**: Gracefully handles missing global timezone data during package building

### Example Integration

```python
try:
    local_tz = _get_localzone()
    print(f"Local timezone: {local_tz}")
except LookupError as e:
    print(f"Could not determine local timezone: {e}")
```

## Limitations

- Windows-only functionality
- Depends on Windows Registry structure (may break with major Windows updates)
- Requires Babel's timezone mapping data for accurate timezone identification
- Performance may be impacted by multiple registry queries on older Windows versions

## Maintenance Notes

- Monitor Windows Registry structure changes in future Windows versions
- Keep timezone mapping data synchronized with Windows timezone updates
- Test compatibility with new Windows releases
- Consider caching registry lookups for performance optimization