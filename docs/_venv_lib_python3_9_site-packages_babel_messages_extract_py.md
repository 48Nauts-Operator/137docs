<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# babel.messages.extract

## Overview

This module provides the core infrastructure for extracting localizable messages from source files in the Babel internationalization library. It implements an extensible system for collecting translatable strings from various file types, with built-in support for Python and JavaScript files.

## Purpose

The primary purpose of this module is to:
- Extract translatable strings from source code files
- Support multiple file formats through a plugin system
- Provide flexible keyword mapping for translation functions
- Handle translator comments and context information
- Enable batch processing of directory structures

## Main Entry Points

The module provides two main entry points for extraction:

### `extract_from_dir()`
Extracts messages from all matching files in a directory tree.

### `extract_from_file()`
Extracts messages from a single file.

## Key Functions and Classes

### Core Extraction Functions

#### `extract_from_dir(dirname=None, method_map=DEFAULT_MAPPING, ...)`

Recursively processes a directory to extract translatable messages.

**Parameters:**
- `dirname`: Directory path (defaults to current working directory)
- `method_map`: List of `(pattern, method)` tuples mapping file patterns to extraction methods
- `options_map`: Dictionary of additional options per file pattern
- `keywords`: Dictionary mapping function names to argument specifications
- `comment_tags`: List of translator comment tags to search for
- `callback`: Optional callback function called for each processed file
- `strip_comment_tags`: Whether to remove comment tags from results
- `directory_filter`: Function to filter which directories to process

**Returns:** Generator yielding `(filename, lineno, message, comments, context)` tuples

#### `extract_from_file(method, filename, keywords=DEFAULT_KEYWORDS, ...)`

Extracts messages from a specific file.

**Parameters:**
- `method`: Extraction method name or callable
- `filename`: Path to the file to process
- `keywords`: Function name to argument mapping
- `comment_tags`: Translator comment tags
- `options`: Additional method-specific options
- `strip_comment_tags`: Whether to strip comment tags

**Returns:** List of `(lineno, message, comments, context)` tuples

#### `extract(method, fileobj, keywords=DEFAULT_KEYWORDS, ...)`

Low-level extraction function that processes a file-like object.

**Parameters:**
- `method`: Extraction method (callable or string)
- `fileobj`: File-like object to read from
- `keywords`: Translation function mappings
- `comment_tags`: Comment tags to collect
- `options`: Method-specific options
- `strip_comment_tags`: Whether to remove comment tags

**Returns:** Generator of extraction results

### Built-in Extractors

#### `extract_python(fileobj, keywords, comment_tags, options)`

Extracts messages from Python source code, including:
- Regular string literals
- F-strings (Python 3.12+ support with PEP 701)
- Function call argument parsing
- Translator comments

#### `extract_javascript(fileobj, keywords, comment_tags, options, lineno=1)`

Extracts messages from JavaScript/JSX code with support for:
- String literals and template strings
- JSX expressions
- Multi-line comments
- String concatenation

**JavaScript-specific options:**
- `jsx`: Enable/disable JSX support (default: `True`)
- `template_string`: Support gettext(`key`) syntax (default: `False`)
- `parse_template_string`: Parse template string contents (default: `False`)

#### `extract_nothing(fileobj, keywords, comment_tags, options)`

Placeholder extractor that returns no results.

## Configuration Constants

### `DEFAULT_KEYWORDS`

Default mapping of translation function names to argument specifications:

```python
{
    '_': None,
    'gettext': None,
    'ngettext': (1, 2),
    'ugettext': None,
    'ungettext': (1, 2),
    'dgettext': (2,),
    'dngettext': (2, 3),
    'N_': None,
    'pgettext': ((1, 'c'), 2),
    'npgettext': ((1, 'c'), 2, 3),
}
```

### `DEFAULT_MAPPING`

Default file pattern to extraction method mapping:

```python
[('**.py', 'python')]
```

## Usage Examples

### Basic Directory Extraction

```python
from babel.messages.extract import extract_from_dir

# Extract from current directory
for filename, lineno, message, comments, context in extract_from_dir():
    print(f"{filename}:{lineno}: {message}")
```

### Custom Method Mapping

```python
method_map = [
    ('**/templates/**.*', 'genshi'),
    ('**.py', 'python'),
    ('**.js', 'javascript')
]

for result in extract_from_dir(method_map=method_map):
    # Process results
    pass
```

### Single File Extraction

```python
from babel.messages.extract import extract_from_file

results = extract_from_file('python', 'myapp.py')
for lineno, message, comments, context in results:
    print(f"Line {lineno}: {message}")
```

## Notes and Suggestions

### Performance Considerations
- The module uses `@lru_cache` for extractor lookup optimization
- Large directory trees may benefit from custom `directory_filter` functions

### Keyword Specifications
- `None`: Extract first argument
- `(1, 2)`: Extract arguments 1 and 2 for plural forms
- `((1, 'c'), 2)`: Argument 1 is context, argument 2 is message

### Error Handling
- Empty `msgid` strings generate warnings to stderr
- Unknown extraction methods raise `ValueError`
- File encoding is automatically detected or defaults to UTF-8

### Extensibility
- Custom extractors can be registered via entry points in the `babel.extractors` group
- Extractors should follow the signature: `(fileobj, keywords, comment_tags, options) -> Iterable[ExtractionResult]`

### Python 3.12+ Support
- Full support for PEP 701 f-string improvements
- Handles new `FSTRING_START`, `FSTRING_MIDDLE`, and `FSTRING_END` tokens