<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# babel.numbers Module Documentation

## Overview

The `babel.numbers` module provides **CLDR (Common Locale Data Repository) Plural support** according to UTS #35 Unicode Technical Standard. This module enables applications to handle pluralization rules for different languages by parsing, compiling, and executing plural rules defined in the CLDR specification.

## Purpose

This module allows developers to:
- Parse CLDR plural rules from various input formats
- Convert plural rules to different output formats (Python, JavaScript, Gettext)
- Evaluate numbers against plural rules to determine the correct plural form
- Handle complex pluralization logic across different languages and locales

## Key Components

### Core Functions

#### `extract_operands(source)`

Extracts CLDR operands from a number according to CLDR rules.

**Parameters:**
- `source`: A number (int, float, or Decimal)

**Returns:** 8-tuple `(n, i, v, w, f, t, c, e)` where:
- `n`: Absolute value of the source number
- `i`: Integer digits of n
- `v`: Number of visible fraction digits with trailing zeros
- `w`: Number of visible fraction digits without trailing zeros  
- `f`: Visible fractional digits with trailing zeros
- `t`: Visible fractional digits without trailing zeros
- `c`: Compact decimal exponent (currently 0)
- `e`: Synonym for c (currently 0)

```python
>>> extract_operands(1.230)
(Decimal('1.230'), 1, 3, 2, 230, 23, 0, 0)
```

### Main Class: `PluralRule`

The central class for handling pluralization rules.

#### Constructor

```python
PluralRule(rules: Mapping[str, str] | Iterable[tuple[str, str]])
```

**Parameters:**
- `rules`: Dict or list of tuples containing CLDR rule expressions

**Example:**
```python
rule = PluralRule({'one': 'n is 1', 'few': 'n in 2..4'})
print(rule(1))  # 'one'
print(rule(3))  # 'few' 
print(rule(5))  # 'other'
```

#### Key Methods

- `parse(rules)`: Class method to create PluralRule instances
- `rules`: Property returning rules as a dict
- `tags`: Property returning set of defined tags
- `__call__(n)`: Evaluate a number against the rules

### Conversion Functions

#### `to_python(rule)`

Converts rules to a Python function for direct evaluation.

```python
func = to_python({'one': 'n is 1', 'few': 'n in 2..4'})
result = func(3)  # Returns 'few'
```

#### `to_javascript(rule)`

Converts rules to a JavaScript function string.

```python
js_func = to_javascript({'one': 'n is 1'})
# Returns: "(function(n) { return (n == 1) ? 'one' : 'other'; })"
```

#### `to_gettext(rule)`

Converts rules to Gettext plural expression format.

```python
gettext_expr = to_gettext({'one': 'n is 1', 'two': 'n is 2'})
# Returns: "nplurals=3; plural=((n == 1) ? 0 : (n == 2) ? 1 : 2);"
```

### Utility Functions

#### Range Testing Functions

- `in_range_list(num, range_list)`: Tests if integer is in range list
- `within_range_list(num, range_list)`: Tests if number (including floats) is in range list

#### Mathematical Functions

- `cldr_modulo(a, b)`: Java-style modulo operation (sign follows dividend)

## Internal Components

### Parser System

The module includes a complete parser for CLDR plural rule expressions:

- `_Parser`: Main parser class that converts rule strings to abstract syntax trees
- `tokenize_rule()`: Tokenizes rule strings according to CLDR grammar
- Various helper functions for token processing

### Compiler System

Multiple compiler classes convert parsed rules to different output formats:

- `_PythonCompiler`: Generates Python code
- `_JavaScriptCompiler`: Generates JavaScript code  
- `_GettextCompiler`: Generates Gettext expressions
- `_UnicodeCompiler`: Regenerates Unicode CLDR format

## Usage Examples

### Basic Usage

```python
from babel.numbers import PluralRule

# Define rules for a language
rules = {
    'one': 'n is 1',
    'few': 'n in 2..4', 
    'many': 'n in 5..10'
}

rule = PluralRule(rules)

# Evaluate numbers
print(rule(1))    # 'one'
print(rule(3))    # 'few'
print(rule(7))    # 'many'
print(rule(15))   # 'other'
```

### Converting to Different Formats

```python
# Convert to Python function
py_func = to_python(rules)
result = py_func(2)  # 'few'

# Convert to JavaScript
js_code = to_javascript(rules)

# Convert to Gettext format
gettext_plural = to_gettext(rules)
```

## Important Notes

- Rules should be **mutually exclusive** - only one rule should match per number
- The `'other'` tag is the implicit fallback for unmatched numbers
- Compact decimal operands (`c`, `e`) are not currently supported
- JavaScript compilation has limited fraction support
- Float precision may be affected by string conversion in `extract_operands()`

## Error Handling

The module defines `RuleError` exception for malformed plural rule expressions.

```python
try:
    rule = PluralRule({'invalid': 'malformed expression'})
except RuleError as e:
    print(f"Rule parsing failed: {e}")
```