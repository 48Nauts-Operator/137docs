<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# babel.util

**Purpose**: This module provides various utility classes and functions for the Babel internationalization library. It contains helper functions for text processing, file encoding detection, timezone handling, and other common operations used throughout Babel.

## Overview

The `babel.util` module serves as a collection of utility functions and classes that support Babel's core internationalization functionality. It includes tools for:

- Removing duplicates while preserving order
- Parsing Python file encodings and future imports
- Pattern matching for file paths
- Text wrapping with special handling for filenames
- Timezone utilities

## Key Functions

### `distinct(iterable)`

Removes duplicate items from an iterable while preserving the original order.

```python
def distinct(iterable: Iterable[_T]) -> Generator[_T, None, None]:
```

**Parameters:**
- `iterable`: The collection to process

**Example:**
```python
list(distinct([1, 2, 1, 3, 4, 4]))  # Returns [1, 2, 3, 4]
list(distinct('foobar'))             # Returns ['f', 'o', 'b', 'a', 'r']
```

### `parse_encoding(fp)`

Detects the encoding of a Python source file by reading encoding declarations in comments.

```python
def parse_encoding(fp: IO[bytes]) -> str | None:
```

**Parameters:**
- `fp`: A seekable file object opened in binary mode

**Returns:**
- The detected encoding string, or `None` if no encoding is found

**Features:**
- Follows Python interpreter encoding detection rules
- Handles BOM (Byte Order Mark) detection
- Checks first two lines for encoding declarations
- Automatically resets file position after reading

### `parse_future_flags(fp, encoding='latin-1')`

Extracts compiler flags from `__future__` import statements in Python code.

```python
def parse_future_flags(fp: IO[bytes], encoding: str = 'latin-1') -> int:
```

**Parameters:**
- `fp`: File object containing Python source code
- `encoding`: Character encoding to use for decoding

**Returns:**
- Integer representing combined compiler flags

### `pathmatch(pattern, filename)`

Extended pathname pattern matching with support for recursive directory matching.

```python
def pathmatch(pattern: str, filename: str) -> bool:
```

**Supported Patterns:**
- `?`: Matches any single character except `/`
- `*`: Matches any sequence of characters except `/`
- `**`: Matches files at any directory level
- `^pattern`: Anchors pattern to start of path
- `./pattern`: Relative path matching

**Examples:**
```python
pathmatch('**.py', 'foo/bar/baz.py')           # True
pathmatch('**/templates/*.html', 'templates/index.html')  # True
pathmatch('^foo/**.py', 'foo/bar/baz.py')      # True
```

## Key Classes

### `TextWrapper`

Enhanced version of `textwrap.TextWrapper` with special handling for filenames containing spaces.

```python
class TextWrapper(textwrap.TextWrapper):
```

**Features:**
- Prevents breaking lines on em-dashes in words
- Preserves filenames enclosed in Unicode directional formatting characters
- Custom word separation regex

**Special Handling:**
- Detects filenames enclosed in `\u2068...\u2069` (directional formatting)
- Prevents splitting filenames that contain spaces

### `FixedOffsetTimezone`

Simple timezone implementation for fixed UTC offsets.

```python
class FixedOffsetTimezone(datetime.tzinfo):
```

**Parameters:**
- `offset`: Minutes east from UTC
- `name`: Optional timezone name (defaults to `Etc/GMT±offset`)

**Example:**
```python
tz = FixedOffsetTimezone(-300, "EST")  # UTC-5
```

## Deprecated Functions

### `wraptext()`

⚠️ **Deprecated**: Use `TextWrapper` class directly instead.

```python
def wraptext(text: str, width: int = 70, initial_indent: str = '', 
             subsequent_indent: str = '') -> list[str]:
```

## Regular Expressions

The module defines several compiled regex patterns:

- `PYTHON_MAGIC_COMMENT_re`: Matches Python encoding declarations
- `PYTHON_FUTURE_IMPORT_re`: Matches `__future__` import statements

## Timezone Aliases

The module re-exports timezone-related functionality from other Babel modules:

- `UTC`: UTC timezone instance
- `LOCALTZ`: Local timezone instance  
- `get_localzone()`: Function to get local timezone
- Various timezone offset constants

## Notes and Suggestions

### Usage Recommendations

1. **File Encoding Detection**: Use `parse_encoding()` when processing Python source files to ensure proper character decoding.

2. **Path Matching**: The `pathmatch()` function is more powerful than `fnmatch` for complex directory structures - prefer it for file filtering in internationalization contexts.

3. **Text Wrapping**: Use `TextWrapper` directly instead of the deprecated `wraptext()` function for better control and future compatibility.

### Important Considerations

- The `parse_encoding()` function automatically handles BOM detection and follows Python's encoding detection rules exactly
- Pattern matching normalizes path separators to forward slashes internally
- The `distinct()` function uses a set internally, so items must be hashable

### Migration Notes

- `odict = dict`: The ordered dictionary alias is maintained for backward compatibility but `dict` is ordered by default in Python 3.7+
- Several timezone utilities are re-exported from other modules and may be moved in future versions