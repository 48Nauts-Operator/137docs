<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Backrefs Re Parser Documentation

This module provides advanced regular expression parsing capabilities, extending Python's built-in `re` module with additional features for search patterns and replacement templates.

## Overview

The **Backrefs Re parser** is a comprehensive regular expression parser that adds enhanced functionality to Python's standard regex capabilities. It includes:

- Extended Unicode property support
- Advanced replacement templates with case conversion
- Format-style replacement patterns
- Enhanced character classes and escapes
- Verbose pattern parsing with comments

## Key Classes

### `_SearchParser`

A generic parser class for processing search patterns with extended regex syntax.

#### Key Features:
- **Unicode Properties**: Support for `\p{property}` and `\P{property}` syntax
- **Extended Escapes**: Additional escape sequences like `\m`, `\M`, `\R`, `\X`
- **Quote Processing**: Handle `\Q...\E` literal quoting
- **Verbose Comments**: Parse comments in verbose mode patterns
- **Flag Handling**: Process inline flag modifications

#### Important Methods:
```python
def parse(self) -> AnyStr:
    """Apply search template and return processed pattern."""

def process_quotes(self, text: str) -> str:
    """Process \Q...\E quote sequences."""

def unicode_props(self, props: str, prop_value: str | None, 
                 in_group: bool = False, negate: bool = False) -> list[str]:
    """Insert Unicode properties into pattern."""
```

### `_ReplaceParser` 

A parser for replacement templates with advanced substitution capabilities.

#### Key Features:
- **Case Conversion**: `\l`, `\L`, `\c`, `\C`, `\E` for case manipulation
- **Format Strings**: Support for Python format string syntax in replacements
- **Unicode Escapes**: Handle `\u`, `\U`, `\N` Unicode sequences
- **Group References**: Enhanced group referencing with `\g<name>`

#### Important Methods:
```python
def parse(self) -> ReplaceTemplate[AnyStr]:
    """Parse template and return ReplaceTemplate object."""

def handle_format_group(self, field: str, text: list[tuple[int, Any]]) -> None:
    """Handle format-style group references."""
```

### `ReplaceTemplate`

The main replacement template class that handles string expansion during substitution.

#### Key Features:
- **Immutable**: Template objects are immutable after creation
- **Callable**: Can be used directly as replacement function
- **Case Conversion**: Automatic case conversion based on template directives
- **Format Support**: Advanced formatting capabilities

#### Usage Example:
```python
# Template expands match groups with case conversion
template = ReplaceTemplate(groups, group_slots, literals, pattern_hash, use_format, is_bytes)
result = template.expand(match_object)
```

## Constants and Character Sets

The module defines several important character sets and constants:

- **`_ASCII_LETTERS`**: All ASCII letters (a-z, A-Z)
- **`_DIGIT`**: Digits 0-9
- **`_OCTAL`**: Octal digits 0-7
- **`_HEX`**: Hexadecimal digits
- **`_STANDARD_ESCAPES`**: Standard escape sequences (a, b, f, n, r, t, v)
- **`_GLOBAL_FLAGS`**: Global regex flags (a, u, L)
- **`_SCOPED_FLAGS`**: Scoped regex flags (i, m, s, u, x)

## Extended Escape Sequences

| Escape | Description |
|--------|-------------|
| `\m` | Word boundary at start of word |
| `\M` | Word boundary at end of word |
| `\R` | Line break (various line ending types) |
| `\X` | Grapheme cluster |
| `\e` | Escape character (deprecated, use `\x1b`) |
| `\h` | Horizontal whitespace (deprecated, use `\p{Horiz_Space}`) |

## Case Conversion in Replacements

| Escape | Description |
|--------|-------------|
| `\l` | Convert next character to lowercase |
| `\L` | Convert following characters to lowercase until `\E` |
| `\c` | Convert next character to uppercase |
| `\C` | Convert following characters to uppercase until `\E` |
| `\E` | End case conversion |

## Usage Notes

### Important Considerations:

1. **String Type Consistency**: Pattern and replacement template must use the same string type (bytes or str)

2. **Unicode Support**: Full Unicode property support when not in bytes mode

3. **Deprecation Warnings**: Some escape sequences (`\e`, `\h`) are deprecated in favor of Unicode properties

4. **Error Handling**: The parser includes comprehensive error checking with descriptive error messages

### Performance:

- Template objects are immutable and hashable for efficient caching
- Character sets use frozensets for fast membership testing
- Parsing is optimized with iterator-based string processing

### Compatibility:

- Supports Python 3.11+ with conditional imports for parser modules
- Handles both narrow and wide Unicode builds
- Compatible with bytes and string patterns

## Exception Classes

```python
class LoopException(Exception):
    """Raised when flag recursion is detected."""

class GlobalRetryException(Exception):
    """Raised when global flag changes require pattern reprocessing."""
```

These exceptions handle edge cases in flag processing and prevent infinite recursion scenarios.