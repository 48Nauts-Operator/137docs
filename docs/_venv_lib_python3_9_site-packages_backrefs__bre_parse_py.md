<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Backrefs Re Parser Documentation

## Overview

The `_parser.py` file is a core component of the Backrefs library that provides enhanced regular expression parsing and replacement functionality. It extends Python's standard `re` module with additional features like Unicode properties, case conversion, and advanced replacement templates.

## Purpose

This module serves as the main parser for:
- **Search patterns**: Parsing regular expressions with extended syntax
- **Replacement templates**: Handling complex replacement patterns with case conversion and formatting
- **Unicode support**: Managing Unicode properties and character classes
- **Template expansion**: Processing replacement strings with advanced formatting options

## Key Classes

### `_SearchParser`

A generic parser class for processing search patterns with extended regex syntax.

```python
parser = _SearchParser(pattern, re_verbose=False, re_unicode=None)
```

**Key Features:**
- Handles extended regex references (`\m`, `\M`, `\R`, `\X`, etc.)
- Processes Unicode properties (`\p{...}`, `\P{...}`)
- Manages verbose comments and flag parsing
- Supports both bytes and string patterns

**Important Methods:**
- `parse()`: Main entry point to parse the search pattern
- `reference()`: Handle special backslash references
- `unicode_props()`: Process Unicode property classes
- `flags()`: Parse and apply regex flags

### `_ReplaceParser`

Parser for replacement templates with advanced formatting and case conversion.

```python
parser = _ReplaceParser(pattern, template, use_format=False)
```

**Key Features:**
- Case conversion with `\l`, `\L`, `\c`, `\C`, `\E`
- Unicode escapes (`\u`, `\U`, `\N`)
- Format string support
- Group reference handling

**Important Methods:**
- `parse()`: Parse the replacement template
- `span_case()`: Apply case conversion to character ranges
- `single_case()`: Apply case conversion to single characters
- `handle_group()`: Process group references

### `ReplaceTemplate`

An immutable template expander that applies parsed replacement patterns.

```python
template = ReplaceTemplate(groups, group_slots, literals, pattern_hash, use_format, is_bytes)
result = template.expand(match_object)
```

**Key Features:**
- Thread-safe immutable design
- Efficient template expansion
- Support for both simple and format-style replacements
- Case conversion application

## Constants and Character Sets

The module defines several important character sets and constants:

```python
_ASCII_LETTERS = frozenset('a-zA-Z')
_DIGIT = frozenset('0-9')
_OCTAL = frozenset('0-7')
_HEX = frozenset('0-9a-f')
_STANDARD_ESCAPES = frozenset('abfnrtv')
```

**Case Conversion Constants:**
- `_UPPER = 1`: Uppercase conversion flag
- `_LOWER = 2`: Lowercase conversion flag

## Extended Regex References

The parser supports these additional backslash references:

| Reference | Description | Status |
|-----------|-------------|---------|
| `\m` | Word boundary (start) | Active |
| `\M` | Word boundary (end) | Active |
| `\R` | Line break | Active |
| `\X` | Grapheme cluster | Active |
| `\e` | Escape character | Deprecated |
| `\h` | Horizontal space | Deprecated |
| `\p{...}` | Unicode property | Active |
| `\P{...}` | Negated Unicode property | Active |
| `\N{...}` | Named Unicode character | Active |

## Usage Notes

### Thread Safety
- `ReplaceTemplate` objects are immutable and thread-safe
- Parser classes should not be shared between threads during parsing

### Performance Considerations
- Template parsing is done once and reused
- Unicode property lookups are cached
- Pattern compilation benefits from caching

### Error Handling

The module defines custom exceptions:

```python
class LoopException(Exception):
    """Raised when flag parsing enters an infinite loop"""

class GlobalRetryException(Exception):
    """Raised when global flags need to be re-evaluated"""
```

## Suggestions and Best Practices

### 1. Pattern Compilation
Cache compiled patterns when possible to avoid repeated parsing overhead:

```python
# Good: Compile once, use many times
pattern = bre.compile(r'\p{Letter}+')
for text in texts:
    matches = pattern.findall(text)
```

### 2. Unicode Handling
Be aware of the difference between bytes and string patterns:
- Use string patterns for Unicode text
- Use bytes patterns only when necessary for binary data

### 3. Replacement Templates
Prefer the newer format-style replacements for complex scenarios:

```python
# Format-style (recommended for complex cases)
bre.sub(pattern, '{0.upper()}', text, fmt=bre.FORMAT)

# Traditional style (simpler cases)
bre.sub(pattern, r'\U\1\E', text)
```

### 4. Deprecation Warnings
The module includes deprecated references (`\e`, `\h`). Use their modern equivalents:
- Replace `\e` with `\x1b`
- Replace `\h` with `\p{Horiz_Space}`

## Integration

This parser integrates with the broader Backrefs ecosystem:
- Uses `util` module for string iteration and formatting
- Leverages `uniprops` for Unicode property definitions
- Compatible with Python's standard `re` module patterns

The module provides a `__all__` export of `("ReplaceTemplate",)`, making `ReplaceTemplate` the primary public interface for users of the library.