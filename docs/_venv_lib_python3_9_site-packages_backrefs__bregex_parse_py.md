<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Backrefs Regex Parser Documentation

## Overview

This file implements a **Backrefs Regex Parser** that provides enhanced regex functionality beyond Python's standard `re` module. It's built on top of the `regex` library and adds support for advanced features like:

- Extended regex syntax with new references and escape sequences
- String formatting capabilities in replacement templates
- Case conversion operations
- Unicode support
- Version compatibility handling

## Main Classes

### `_SearchParser`

A generic class that parses and processes regex search patterns with extended syntax support.

**Key Features:**
- Handles new escape sequences (`\e`, `\R`, `\Q`, `\E`)
- Supports verbose comments and flag processing
- Manages character groups and POSIX character classes
- Handles version compatibility between regex V0 and V1

**Important Methods:**

```python
def parse(self) -> AnyStr:
    """Apply search template and return processed pattern"""
```

```python
def process_quotes(self, text: str) -> str:
    """Process \Q...\E quote sequences for literal matching"""
```

```python
def flags(self, text: str, scoped: bool = False) -> None:
    """Process and apply regex flags"""
```

### `_ReplaceParser`

A generic class that parses replacement templates with advanced formatting and case conversion capabilities.

**Key Features:**
- Python string formatting syntax support
- Case conversion with `\l`, `\L`, `\c`, `\C`, `\E`
- Unicode escape sequences
- Group references with named and numbered groups

**Important Methods:**

```python
def parse(self) -> ReplaceTemplate[AnyStr]:
    """Parse template and return ReplaceTemplate object"""
```

```python
def handle_format(self, t: str, i: _util.StringIter) -> None:
    """Handle Python format string syntax {field:spec}"""
```

### `ReplaceTemplate`

An immutable template expander that efficiently applies parsed replacement patterns.

**Key Features:**
- Immutable design for thread safety
- Caching of parsed templates
- Support for format specifications
- Case conversion operations

**Important Methods:**

```python
def expand(self, m: Match[AnyStr] | None) -> AnyStr:
    """Expand the template using match object"""
```

```python
def __call__(self, m: Match[AnyStr] | None) -> AnyStr:
    """Make template callable like a function"""
```

## Key Constants

### Character Sets
```python
_ASCII_LETTERS = frozenset(...)  # A-Z, a-z
_DIGIT = frozenset(...)          # 0-9
_OCTAL = frozenset(...)          # 0-7
_HEX = frozenset(...)            # 0-9, a-f
_WORD = frozenset(...)           # Letters, digits, underscore
```

### Escape Sequences
```python
_BACK_SLASH_TRANSLATION = {
    "\\a": '\a',   # Bell
    "\\b": '\b',   # Backspace
    "\\f": '\f',   # Form feed
    "\\r": '\r',   # Carriage return
    "\\t": '\t',   # Tab
    "\\n": '\n',   # Newline
    "\\v": '\v',   # Vertical tab
    "\\\\": '\\'   # Backslash
}
```

## Extended Regex Features

### New References
- `\e` - Escape character (deprecated, use `\x1b`)
- `\R` - Generic line break
- `\Q...\E` - Literal text (quote/unquote)

### Case Conversion
- `\l` - Lowercase next character
- `\L` - Lowercase until `\E`
- `\c` - Uppercase next character  
- `\C` - Uppercase until `\E`
- `\E` - End case conversion

### Format Support
Supports Python format string syntax in replacements:
```python
# Basic group reference
"{0}"

# With format specification
"{0:>10}"

# With fill and alignment
"{0:_^20}"
```

## Exception Classes

### `LoopException`
Raised when recursive flag processing is detected to prevent infinite loops.

### `GlobalRetryException`
Raised when global flags need to be reprocessed, triggering a pattern reparse.

## Usage Notes

### Performance Considerations
- Templates are parsed once and cached for reuse
- Immutable design allows safe sharing between threads
- Use `ReplaceTemplate` objects for repeated replacements

### Type Safety
- Generic classes support both `str` and `bytes`
- Type checking ensures pattern and replacement types match
- Proper Unicode handling for text operations

### Error Handling
- Comprehensive syntax error reporting with position information
- Validation of format specifications and group references
- Graceful handling of edge cases like unmatched brackets

## Suggestions

1. **Caching**: Consider caching compiled `_SearchParser` results for frequently used patterns
2. **Documentation**: The `\e` escape sequence is deprecated - migrate to `\x1b`
3. **Testing**: Thoroughly test Unicode edge cases, especially with mixed byte/string operations
4. **Performance**: For high-frequency replacements, pre-compile `ReplaceTemplate` objects
5. **Validation**: Add runtime validation for format specifications to catch errors early

## Dependencies

- `regex` - Enhanced regex library (not standard `re`)
- `unicodedata` - Unicode character database
- `copyreg` - Pickle registration utilities

This module requires the third-party `regex` library which provides more advanced regex features than Python's built-in `re` module.