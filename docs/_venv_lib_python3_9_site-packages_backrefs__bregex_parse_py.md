<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Backrefs Regex Parser Documentation

## Overview

This module provides a sophisticated regex parser for the `backrefs` library, extending the functionality of Python's `regex` module with additional features for pattern matching and replacement operations. It offers enhanced support for Unicode handling, case conversion, format strings, and advanced replacement templates.

## Purpose

The module serves as a comprehensive regex processing system that:
- Parses regex patterns with extended syntax support
- Handles complex replacement templates with case conversion
- Provides format string-style replacements
- Supports both string and bytes patterns
- Manages advanced Unicode operations

## Key Classes

### `_SearchParser`

A generic parser class for processing regex search patterns with extended syntax.

#### Key Features:
- **Quote Processing**: Handles `\Q...\E` literal quote sequences
- **Verbose Comments**: Processes comments in verbose mode (`(?x)`)
- **Flag Management**: Handles regex flags including version flags (`V0`, `V1`)
- **Reference Handling**: Processes escape sequences and special references
- **Character Groups**: Parses character classes `[...]` with POSIX support

#### Important Methods:
- `parse()`: Main entry point that returns the processed pattern
- `process_quotes()`: Handles literal quote sequences
- `flags()`: Processes regex flags and modifiers
- `reference()`: Handles escape sequences and special references

```python
# Example usage
parser = _SearchParser(r'\Q.*+?\E\w+', re_verbose=False)
processed_pattern = parser.parse()
```

### `_ReplaceParser`

A sophisticated parser for replacement templates with advanced formatting capabilities.

#### Key Features:
- **Format String Support**: Handles Python format string syntax `{field:spec}`
- **Case Conversion**: Supports `\l`, `\L`, `\c`, `\C` for case changes
- **Unicode Handling**: Processes `\u`, `\U`, `\N` Unicode escapes
- **Group References**: Handles numbered and named group references
- **Octal/Hex Escapes**: Processes `\nnn`, `\xHH` escape sequences

#### Important Methods:
- `parse()`: Returns a `ReplaceTemplate` object
- `handle_format()`: Processes format string syntax
- `reference()`: Handles escape sequences in replacements
- `span_case()`: Manages case conversion spans

```python
# Example usage
parser = _ReplaceParser(pattern, r'\L\1\E-\u{field:>10}', use_format=True)
template = parser.parse()
```

### `ReplaceTemplate`

An immutable template class for performing replacements with advanced formatting.

#### Key Features:
- **Immutable Design**: Thread-safe template objects
- **Format Support**: Handles both simple and format-style replacements
- **Case Conversion**: Applies case transformations during expansion
- **Group Mapping**: Efficiently maps template slots to regex groups

#### Important Methods:
- `expand(match)`: Expands the template using a regex match object
- `__call__(match)`: Callable interface for expansion

```python
# Example usage
result = template.expand(match_object)
# or
result = template(match_object)
```

## Constants and Configuration

### Character Sets
- `_ASCII_LETTERS`: ASCII letter characters
- `_DIGIT`: Digit characters (0-9)
- `_OCTAL`: Octal digit characters (0-7)
- `_HEX`: Hexadecimal characters
- `_WORD`: Word characters (letters, digits, underscore)

### Flags
- `_GLOBAL_FLAGS`: Global regex flags (`L`, `a`, `b`, `e`, `r`, `u`, `p`)
- `_SCOPED_FLAGS`: Scoped regex flags (`i`, `m`, `s`, `f`, `w`, `x`)
- `_VERSIONS`: Supported regex versions (`0`, `1`)

### Case Conversion
- `_UPPER = 1`: Uppercase conversion flag
- `_LOWER = 2`: Lowercase conversion flag

## Exception Classes

### `LoopException`
Raised when infinite loops are detected in flag processing.

### `GlobalRetryException`
Used internally to handle global flag changes that require pattern reprocessing.

## Usage Notes

### Pattern Processing
```python
# Basic pattern parsing
search_parser = _SearchParser(r'\Q.*\E\w+(?i:test)')
processed = search_parser.parse()
```

### Replacement Templates
```python
# Simple replacement
replace_parser = _ReplaceParser(pattern, r'\1-\2')
template = replace_parser.parse()

# Format-style replacement
replace_parser = _ReplaceParser(pattern, r'{0:>10}-{name}', use_format=True)
template = replace_parser.parse()
```

### Case Conversion
```python
# Uppercase first character, lowercase rest
template_str = r'\c\1\L\2\E'
```

## Important Considerations

### Thread Safety
- `ReplaceTemplate` objects are immutable and thread-safe
- Parser objects should not be shared between threads during parsing

### Performance
- Templates are compiled once and can be reused multiple times
- The module uses efficient string building techniques
- Pickling support is provided for template serialization

### Compatibility
- Supports both string and bytes patterns
- Compatible with Python's `regex` module
- Handles Unicode properly in string mode

### Error Handling
- Comprehensive syntax error reporting with position information
- Proper handling of malformed Unicode escapes
- Validation of format string syntax

## Dependencies

- `regex` module (third-party enhanced regex library)
- `unicodedata` (for Unicode character name lookups)
- `copyreg` (for pickle support)

## Notes

- This module is designed to work with the `regex` library, not Python's built-in `re` module
- The parser handles complex nested structures and maintains proper state management
- Format string support follows Python's format specification mini-language
- Case conversion works correctly with both ASCII and Unicode characters