<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Utilities Module Documentation

## Overview

This module provides utilities and compatibility abstractions for string processing and formatting operations. It's designed to work across different Python versions and provides helper classes and functions for string iteration, formatting, and immutable data structures.

## Version Compatibility

The module includes version checks for Python compatibility:

```python
PY311 = (3, 11) <= sys.version_info
PY312 = (3, 12) <= sys.version_info
```

These flags can be used throughout the codebase to handle version-specific features.

## Constants

### Format Field Types

```python
FMT_FIELD = 0
FMT_INDEX = 1
FMT_ATTR = 2
FMT_CONV = 3
FMT_SPEC = 4
```

These constants define different types of format operations used in string formatting:
- `FMT_FIELD`: Field formatting
- `FMT_INDEX`: Index-based access
- `FMT_ATTR`: Attribute access
- `FMT_CONV`: Type conversion
- `FMT_SPEC`: Format specification

## Classes

### StringIter

A string iterator class that provides character-by-character iteration with additional control features.

#### Features:
- **Index tracking**: Keeps track of current position
- **Rewind capability**: Can move backwards in the string
- **Python iterator protocol**: Implements `__iter__` and `__next__`

#### Methods:

```python
def __init__(self, text: str) -> None
```
Initialize with a string to iterate over.

```python
@property
def index(self) -> int
```
Get the current index position.

```python
def rewind(self, count: int) -> None
```
Move the index backwards by `count` positions.

```python
def iternext(self) -> str
```
Get the next character in the string.

#### Usage Example:
```python
iterator = StringIter("hello")
for char in iterator:
    print(char)  # Prints: h, e, l, l, o
```

### Immutable

A base class for creating immutable objects.

#### Features:
- **Slot-based**: Uses `__slots__` for memory efficiency
- **Initialization flexibility**: Accepts keyword arguments
- **Mutation prevention**: Prevents attribute modification after creation

#### Usage Example:
```python
class MyData(Immutable):
    __slots__ = ('value', 'name')

data = MyData(value=42, name="test")
# data.value = 50  # This would raise AttributeError
```

## Functions

### String Conversion Functions

#### `_to_bstr(obj: Any) -> bytes`
Converts any object to a byte string using ASCII encoding with backslash replacement for non-ASCII characters.

#### `_to_str(obj: Any) -> str`
Converts any object to a string representation.

### `format_captures()`

The main formatting function that applies complex formatting operations to captured strings.

```python
def format_captures(
    captures: list[AnyStr],
    formatting: tuple[tuple[int, Any]],
    converter: Callable[[Any], AnyStr],
    default: AnyStr
) -> AnyStr
```

#### Parameters:
- `captures`: List of captured strings to format
- `formatting`: Tuple of formatting operations
- `converter`: Function to convert objects to the desired string type
- `default`: Default value to use when captures are empty

#### Supported Operations:
- **Attribute access**: Access object attributes
- **Index access**: Access list/string elements
- **Type conversion**: Convert using 'a' (ascii), 'r' (repr), 's' (str)
- **Format specification**: Apply padding and alignment

### `warn_deprecated()`

Utility function for issuing deprecation warnings.

```python
def warn_deprecated(message: str, stacklevel: int = 2) -> None
```

## Notes and Suggestions

### Best Practices

1. **Error Handling**: The module includes proper error handling, especially in `StringIter.rewind()` and `format_captures()`

2. **Type Safety**: Uses type hints throughout for better code documentation and IDE support

3. **Memory Efficiency**: The `Immutable` class uses `__slots__` to reduce memory overhead

### Potential Improvements

1. **Documentation**: Consider adding more detailed docstrings with examples for complex functions like `format_captures()`

2. **Testing**: The `# pragma: no cover` comments suggest some code paths may need better test coverage

3. **Validation**: Consider adding more input validation, especially for the formatting operations

### Usage Context

This module appears to be part of a larger string processing or templating system, likely used for:
- Regular expression replacement operations
- String formatting with complex rules
- Template processing with variable substitution

The presence of capture-related functionality suggests it's used in conjunction with regex operations where captured groups need sophisticated formatting.