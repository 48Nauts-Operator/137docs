<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# AnsiToWin32 Module Documentation

## Overview

This module provides cross-platform support for ANSI color codes and terminal control sequences, with specific focus on Windows compatibility. It acts as a bridge between ANSI escape sequences (commonly used on Unix-like systems) and Windows console API calls, ensuring colored terminal output works consistently across different operating systems.

## Purpose

- **Cross-platform terminal output**: Enables ANSI color codes to work on Windows terminals that don't natively support them
- **Stream wrapping**: Transparently wraps output streams (stdout/stderr) to process ANSI sequences
- **Automatic conversion**: Converts ANSI escape sequences to appropriate Windows console API calls
- **Fallback handling**: Gracefully handles terminals that don't support color output

## Main Classes

### StreamWrapper

A transparent proxy class that wraps output streams and delegates write operations to a converter.

**Key Features:**
- Proxies all attribute access to the wrapped stream
- Intercepts `write()` calls for ANSI processing
- Handles context manager protocols (`__enter__`, `__exit__`)
- Special handling for PyCharm IDE environment
- Safe property access with error handling

**Constructor:**
```python
StreamWrapper(wrapped, converter)
```

**Important Methods:**
- `write(text)` - Delegates text processing to the converter
- `isatty()` - Determines if the stream is connected to a terminal
- `closed` (property) - Returns the closed state of the wrapped stream

### AnsiToWin32

The main class that handles ANSI-to-Windows conversion and ANSI sequence stripping.

**Key Features:**
- Parses ANSI Control Sequence Introducer (CSI) and Operating System Command (OSC) sequences
- Maps ANSI codes to Windows console API calls
- Supports color changes, cursor positioning, and screen clearing
- Configurable conversion and stripping behavior

**Constructor:**
```python
AnsiToWin32(wrapped, convert=None, strip=None, autoreset=False)
```

**Parameters:**
- `wrapped` - The output stream to wrap (typically `sys.stdout` or `sys.stderr`)
- `convert` - Whether to convert ANSI sequences to Win32 calls (auto-detected if None)
- `strip` - Whether to strip ANSI sequences from output (auto-detected if None)
- `autoreset` - Whether to reset colors after each write operation

## Important Methods

### AnsiToWin32.write(text)
Main entry point for processing text output. Handles the conversion/stripping logic based on configuration.

### AnsiToWin32.write_and_convert(text)
Core conversion method that:
- Parses ANSI sequences using regex patterns
- Writes plain text portions directly
- Converts ANSI sequences to appropriate Win32 calls

### AnsiToWin32.should_wrap()
Determines if wrapping is actually necessary based on platform and configuration.

```python
def should_wrap(self):
    return self.convert or self.strip or self.autoreset
```

## Regular Expressions

The module uses two main regex patterns:

```python
ANSI_CSI_RE = re.compile('\001?\033\\[((?:\\d|;)*)([a-zA-Z])\002?')   # Control Sequence Introducer
ANSI_OSC_RE = re.compile('\001?\033\\]([^\a]*)(\a)\002?')             # Operating System Command
```

- **CSI**: Matches color codes, cursor movements, and screen clearing commands
- **OSC**: Matches terminal title changes and other OS-specific commands

## Supported ANSI Features

### Colors
- **Foreground colors**: Black, Red, Green, Yellow, Blue, Magenta, Cyan, White
- **Background colors**: Same as foreground
- **Bright variants**: Extended bright color support
- **Reset**: Color reset functionality

### Terminal Control
- **Cursor positioning**: Absolute and relative positioning
- **Screen clearing**: Full screen and line clearing
- **Text styling**: Bright, dim, normal styles
- **Window title**: Terminal title changes

## Usage Notes

### Automatic Configuration
The module automatically detects the appropriate settings based on:
- Operating system (Windows vs. others)
- Terminal capabilities (TTY detection)
- Native ANSI support availability

### PyCharm Integration
Special handling for PyCharm IDE environment:
```python
if 'PYCHARM_HOSTED' in os.environ:
    if stream is not None and (stream is sys.__stdout__ or stream is sys.__stderr__):
        return True
```

### Error Handling
- Graceful fallback when Win32 API is unavailable
- Safe attribute access with try/except blocks
- Handles detached or closed streams properly

## Dependencies

- `ansi` module: ANSI color and style constants
- `winterm` module: Windows terminal interface
- `win32` module: Windows API bindings

## Recommendations

1. **Let auto-detection work**: Unless you have specific requirements, let the `convert` and `strip` parameters auto-detect appropriate settings

2. **Use autoreset carefully**: The `autoreset=True` option can impact performance in high-output scenarios

3. **Check should_wrap()**: Before wrapping streams, verify that wrapping is actually needed with `should_wrap()`

4. **Handle edge cases**: Be aware that some terminal emulators may not support all features

## Example Integration

```python
# Typical usage pattern
wrapper = AnsiToWin32(sys.stdout)
if wrapper.should_wrap():
    sys.stdout = wrapper.stream
```

This module is essential for libraries that need to provide colored terminal output across different platforms, particularly when supporting Windows environments alongside Unix-like systems.