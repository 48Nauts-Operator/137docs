<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# StreamWrapper and AnsiToWin32 Module Documentation

## Overview

This module provides cross-platform support for ANSI escape sequences in terminal output, specifically handling Windows compatibility. It wraps output streams (like `stdout` and `stderr`) to either convert ANSI sequences to Windows API calls or strip them entirely, ensuring colored terminal output works consistently across different platforms and terminals.

## Purpose

- **Cross-platform terminal compatibility**: Ensures ANSI color codes work on Windows terminals that don't natively support them
- **Stream wrapping**: Transparently wraps output streams while maintaining all original functionality
- **Intelligent detection**: Automatically determines whether conversion, stripping, or pass-through is needed based on the environment

## Classes

### StreamWrapper

A transparent proxy wrapper for streams that delegates the `write()` method to a converter while maintaining access to all other stream attributes.

#### Key Features
- **Transparent proxying**: All attribute access is forwarded to the wrapped stream
- **Context manager support**: Properly handles `__enter__` and `__exit__` methods
- **PyCharm compatibility**: Special handling for PyCharm's hosted environment
- **State management**: Supports pickle serialization via `__getstate__` and `__setstate__`

#### Methods
- `write(text)`: Delegates to the converter's write method
- `isatty()`: Enhanced terminal detection with PyCharm support
- `closed`: Property that safely checks if the stream is closed

### AnsiToWin32

The main converter class that processes ANSI escape sequences and handles Windows terminal compatibility.

#### Constructor Parameters
- `wrapped`: The stream to wrap (typically `sys.stdout` or `sys.stderr`)
- `convert`: Whether to convert ANSI sequences to Win32 calls (auto-detected if `None`)
- `strip`: Whether to strip ANSI sequences (auto-detected if `None`)
- `autoreset`: Whether to reset colors after each write operation

#### Key Features

##### ANSI Sequence Processing
- **CSI (Control Sequence Introducer)**: Handles color and cursor control sequences
- **OSC (Operating System Command)**: Processes terminal title changes
- **Regular expressions**: Uses compiled regex patterns for efficient parsing

##### Intelligent Mode Detection
The class automatically determines the appropriate mode based on:
- Operating system (Windows vs. others)
- Terminal capabilities (native ANSI support)
- Stream type (TTY vs. file)
- Windows API availability

##### Win32 Integration
- **Color mapping**: Converts ANSI colors to Windows console colors
- **Cursor control**: Handles cursor positioning and movement
- **Screen operations**: Supports clearing screen and lines
- **Title setting**: Converts OSC sequences to Windows title changes

#### Important Methods

##### `write(text)`
Main entry point that processes text based on configured mode:
```python
def write(self, text):
    if self.strip or self.convert:
        self.write_and_convert(text)
    else:
        self.wrapped.write(text)
        self.wrapped.flush()
    if self.autoreset:
        self.reset_all()
```

##### `write_and_convert(text)`
Core processing method that:
- Parses ANSI sequences using regex
- Writes plain text portions directly
- Converts or strips ANSI sequences as needed

##### `call_win32(command, params)`
Executes Windows API calls for various ANSI commands:
- `m`: Color and style changes
- `J`/`K`: Screen/line clearing
- `H`/`f`: Absolute cursor positioning
- `A`/`B`/`C`/`D`: Relative cursor movement

## Usage Notes

### Environment Detection
The module performs sophisticated environment detection:
- **Windows API availability**: Tests if Win32 console functions work
- **Native ANSI support**: Checks for VT processing capability
- **Terminal type**: Distinguishes between TTY and file output

### Performance Considerations
- **Compiled regex**: Uses pre-compiled regular expressions for efficiency
- **Lazy initialization**: Win32 calls dictionary is built only when needed
- **Minimal overhead**: When wrapping isn't needed, `should_wrap()` returns `False`

### Special Handling
- **PyCharm integration**: Special `isatty()` detection for PyCharm's console
- **Error resilience**: Graceful handling of streams that don't support certain operations
- **Context preservation**: Maintains all original stream functionality

## Dependencies

- `re`: Regular expression processing
- `sys`: System-specific parameters and functions  
- `os`: Operating system interface
- `.ansi`: ANSI color and style constants
- `.winterm`: Windows terminal interface
- `.win32`: Windows API bindings

## Notes and Suggestions

### Best Practices
- The module is designed to be used transparently - wrapped streams should behave identically to unwrapped ones
- Check `should_wrap()` before applying the wrapper to avoid unnecessary overhead
- The `autoreset` feature is useful for ensuring clean output but may impact performance

### Limitations
- Windows-specific functionality requires appropriate Win32 API access
- Some advanced ANSI sequences may not be fully supported
- Performance may be affected when processing large amounts of text with many ANSI sequences

### Debugging
- The module includes extensive environment detection - check the `convert` and `strip` flags to understand the chosen mode
- OSC sequence handling is limited to title changes - other OSC commands are stripped