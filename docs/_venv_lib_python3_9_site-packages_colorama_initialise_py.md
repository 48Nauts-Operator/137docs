<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Colorama Initialization Module

This module provides initialization and management functionality for the Colorama library, which enables cross-platform colored terminal text output. It handles the setup and teardown of ANSI escape sequence processing, particularly for Windows console compatibility.

## Purpose

The primary purpose of this module is to:
- Initialize and configure ANSI-to-Windows console conversion
- Manage the wrapping of `stdout` and `stderr` streams
- Provide cross-platform terminal color support
- Handle cleanup and restoration of original streams

## Global State Variables

The module maintains several global variables to track the state:
- `orig_stdout`, `orig_stderr`: Store original stream references
- `wrapped_stdout`, `wrapped_stderr`: Store wrapped stream references  
- `atexit_done`: Tracks if exit handler is registered
- `fixed_windows_console`: Tracks Windows console fix status

## Key Functions

### `init(autoreset=False, convert=None, strip=None, wrap=True)`

Initializes Colorama by wrapping stdout and stderr streams.

**Parameters:**
- `autoreset`: Automatically reset colors after each print
- `convert`: Convert ANSI sequences to Windows console calls
- `strip`: Strip ANSI sequences instead of converting
- `wrap`: Enable stream wrapping (required for other features)

**Usage:**
```python
from colorama import init
init(autoreset=True)  # Auto-reset colors after each print
```

**Note:** Setting `wrap=False` conflicts with other parameters being `True`.

### `deinit()`

Restores the original stdout and stderr streams, disabling Colorama.

```python
from colorama import deinit
deinit()  # Restore original streams
```

### `reset_all()`

Resets all ANSI formatting to default state. Automatically called on program exit.

### `just_fix_windows_console()`

Provides minimal Windows console ANSI support without full initialization.

**Behavior:**
- Only runs on Windows (`win32` platform)
- Enables native ANSI support on newer Windows versions
- Falls back to conversion mode on older Windows versions
- Won't override existing `init()` configuration

### `colorama_text(*args, **kwargs)` (Context Manager)

Provides temporary Colorama initialization within a context.

```python
with colorama_text(autoreset=True):
    print("This text can use colors")
# Colorama is automatically deinitialized here
```

### `reinit()`

Re-applies wrapped streams if they were previously initialized.

### `wrap_stream(stream, convert, strip, autoreset, wrap)`

Low-level function that wraps individual streams with `AnsiToWin32` conversion.

## Testing Support

### `_wipe_internal_state_for_tests()`

Resets all global state variables for testing purposes. This function:
- Clears all stream references
- Resets status flags
- Unregisters exit handlers (when supported)

## Important Notes

### Windows Compatibility
- The module automatically detects Windows platform
- Provides ANSI escape sequence conversion for older Windows versions
- Leverages native ANSI support on Windows 10+ when available

### Exit Handling
- Automatically registers cleanup function with `atexit`
- Gracefully handles cases where objects become `None` during exit
- Python 2 compatibility (no `atexit.unregister` fallback)

### Error Handling
- Validates parameter combinations in `init()`
- Handles `None` stdout/stderr gracefully
- Includes null-checks for exit scenarios

## Best Practices

1. **Always call `init()`** before using colored output
2. **Use context manager** for temporary color usage:
   ```python
   with colorama_text():
       # colored output here
   ```
3. **Call `deinit()`** when you want to restore original streams
4. **Use `just_fix_windows_console()`** for minimal Windows compatibility without full features

## Dependencies

- `atexit`: For cleanup registration
- `contextlib`: For context manager support
- `sys`: For stream access and platform detection
- `.ansitowin32.AnsiToWin32`: Core ANSI conversion functionality