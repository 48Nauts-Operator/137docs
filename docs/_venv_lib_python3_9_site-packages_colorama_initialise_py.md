<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Colorama Initialization Module

This module provides initialization and management functionality for the Colorama library, which enables cross-platform colored terminal text output. The primary purpose is to wrap standard output streams (`stdout` and `stderr`) with ANSI color code processing capabilities.

## Overview

The module handles the setup and teardown of ANSI color code processing by:
- Wrapping system output streams with `AnsiToWin32` processors
- Managing global state for original and wrapped streams
- Providing Windows console compatibility fixes
- Offering context manager support for temporary colorama usage

## Global State Variables

The module maintains several global variables to track initialization state:

- `orig_stdout`, `orig_stderr`: Store original system streams
- `wrapped_stdout`, `wrapped_stderr`: Store wrapped stream objects
- `atexit_done`: Prevents duplicate exit handler registration
- `fixed_windows_console`: Tracks Windows console fix application

## Key Functions

### `init(autoreset=False, convert=None, strip=None, wrap=True)`

Initializes colorama by wrapping system output streams.

**Parameters:**
- `autoreset`: Automatically reset colors after each print
- `convert`: Convert ANSI codes to Windows console calls
- `strip`: Remove ANSI codes instead of converting
- `wrap`: Enable/disable stream wrapping

**Important Notes:**
- Raises `ValueError` if `wrap=False` conflicts with other parameters
- Registers cleanup handler via `atexit`
- Preserves original streams for restoration

### `deinit()`

Restores original system streams, effectively disabling colorama processing.

### `just_fix_windows_console()`

Provides minimal Windows console ANSI support without full initialization.

**Behavior:**
- Only operates on Windows platforms
- Skips if already applied or if `init()` was previously called
- Enables native ANSI support on newer Windows versions
- Falls back to conversion mode on older systems

### `colorama_text(*args, **kwargs)`

Context manager for temporary colorama usage.

```python
with colorama_text(autoreset=True):
    print(colored_text)
# Automatically cleaned up after block
```

### `reinit()`

Reapplies wrapped streams if they were previously initialized.

### `wrap_stream(stream, convert, strip, autoreset, wrap)`

Creates wrapped stream objects with specified processing options.

**Returns:** Either the original stream or a wrapped `AnsiToWin32` object.

## Utility Functions

### `reset_all()`

Cleanup function registered with `atexit` to reset ANSI processing on program termination.

### `_wipe_internal_state_for_tests()`

Resets all global state variables for testing purposes.

## Usage Examples

### Basic Initialization
```python
import colorama
colorama.init()
# Now you can use colored output
print('\033[31mRed text\033[0m')
```

### Temporary Usage
```python
with colorama.colorama_text(autoreset=True):
    print('\033[32mGreen text')  # Automatically resets
```

### Windows-Only Fix
```python
colorama.just_fix_windows_console()
# Minimal setup for Windows ANSI support
```

## Important Considerations

- **Thread Safety**: This module uses global state and is not thread-safe
- **Windows Compatibility**: Special handling for Windows console differences
- **Cleanup**: Always calls cleanup on program exit via `atexit`
- **Stream Handling**: Safely handles `None` streams that may occur during shutdown

## Dependencies

- `atexit`: For cleanup registration
- `contextlib`: For context manager implementation
- `sys`: For stream access and platform detection
- `AnsiToWin32`: Core processing class (imported from `.ansitowin32`)