<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Colorama Initialization Tests Documentation

## Overview

This file contains comprehensive unit tests for the Colorama library's initialization functionality. Colorama is a Python library that enables cross-platform colored terminal text output by converting ANSI escape sequences to Windows console API calls on Windows systems.

## Purpose

The test suite validates two main initialization functions:
- `init()` - The main initialization function that wraps stdout/stderr streams
- `just_fix_windows_console()` - A minimal Windows-specific console fixing function

## Test Classes

### `InitTest`

Tests the main `init()` function behavior across different platforms and configurations.

#### Key Test Methods

- **Platform-specific wrapping tests:**
  - `testInitWrapsOnWindows()` - Verifies stream wrapping on Windows
  - `testInitDoesntWrapOnEmulatedWindows()` - Ensures no wrapping on emulated Windows
  - `testInitDoesntWrapOnNonWindows()` - Confirms no wrapping on non-Windows platforms

- **Configuration tests:**
  - `testInitAutoresetOnWrapsOnAllPlatforms()` - Tests autoreset parameter
  - `testInitWrapOffDoesntWrapOnWindows()` - Tests wrap=False parameter
  - `testInitWrapOffIncompatibleWithAutoresetOn()` - Tests parameter validation

- **State management tests:**
  - `testAutoResetPassedOn()` - Verifies autoreset parameter propagation
  - `testAutoResetChangeable()` - Tests dynamic autoreset changes
  - `testAtexitRegisteredOnlyOnce()` - Ensures cleanup is registered only once

#### Helper Methods

```python
def assertWrapped(self):
    # Verifies that stdout/stderr are properly wrapped with StreamWrapper

def assertNotWrapped(self):
    # Verifies that stdout/stderr remain unwrapped
```

### `JustFixWindowsConsoleTest`

Tests the minimal Windows console initialization function.

#### Key Features

- **Cross-platform behavior:** No-op on non-Windows systems
- **Windows-specific logic:** Handles TTY vs non-TTY streams differently
- **Native ANSI support detection:** Tests both enabled and disabled scenarios
- **State management:** Ensures proper interaction with `init()`

## Dependencies

### External Libraries
- `unittest` - Python's built-in testing framework
- `mock` - Mocking library (with fallback for older Python versions)

### Internal Modules
- `..ansitowin32.StreamWrapper` - Stream wrapping functionality
- `..initialise` - Main initialization functions
- `.utils` - Test utilities for OS simulation

## Key Testing Patterns

### Mocking and Patching

The tests extensively use `@patch` decorators to mock:
- Windows API functions (`winapi_test`, `enable_vt_processing`)
- Console functions (`SetConsoleTextAttribute`)
- Exit handlers (`atexit.register`)

### Context Managers

```python
with osname("nt"):          # Simulate Windows
with osname("posix"):       # Simulate Unix-like systems
with replace_by(None):      # Test with None streams
```

## Important Notes

### Test Environment Setup

- **setUp()**: Includes sanity check that stdout is a TTY
- **tearDown()**: Resets internal state and restores original streams
- **Stream preservation**: Original stdout/stderr are stored for restoration

### Platform-Specific Behavior

- **Windows**: Stream wrapping occurs when Windows API is available
- **Non-Windows**: Generally no wrapping unless autoreset=True
- **Emulated environments**: Detected and handled appropriately

## Usage Recommendations

### Running Tests

```bash
# Run all tests
python -m unittest test_initialise.py

# Run specific test class
python -m unittest test_initialise.InitTest

# Run with verbose output
python -m unittest -v test_initialise.py
```

### Adding New Tests

When extending these tests:

1. **Always reset state** in tearDown methods
2. **Use appropriate mocking** for platform-specific functions  
3. **Test both positive and negative cases**
4. **Consider cross-platform implications**

## Notes

- Tests skip automatically if stdout is not a TTY (using `@skipUnless`)
- Comprehensive mocking ensures tests run consistently across platforms
- State reset functions prevent test interference
- Both normal usage and edge cases are thoroughly tested

This test suite ensures Colorama's initialization functions work correctly across different platforms, configurations, and usage scenarios.