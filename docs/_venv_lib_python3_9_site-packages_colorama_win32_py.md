<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Windows Console API Wrapper

## Overview

This Python module provides a wrapper around the Windows Console API using the `ctypes` library. It's designed to enable direct manipulation of the Windows console/terminal, including text attributes, cursor positioning, screen buffer operations, and console mode management.

The module is part of a larger project (likely Colorama, based on the copyright) that provides cross-platform colored terminal text support.

## Purpose

- **Windows Console Control**: Direct access to Windows console functions for text formatting and cursor control
- **Cross-platform Support**: Graceful fallback when Windows APIs are unavailable
- **Terminal Manipulation**: Enable features like colored text, cursor positioning, and screen clearing on Windows terminals

## Constants

```python
STDOUT = -11  # Windows handle for standard output
STDERR = -12  # Windows handle for standard error
ENABLE_VIRTUAL_TERMINAL_PROCESSING = 0x0004  # Flag for enabling VT100 sequences
```

## Key Components

### Error Handling and Fallbacks

The module includes robust error handling for non-Windows environments:

```python
try:
    import ctypes
    # ... Windows-specific imports
except (AttributeError, ImportError):
    windll = None
    SetConsoleTextAttribute = lambda *_: None
    winapi_test = lambda *_: None
```

**Note**: When Windows APIs are unavailable, functions become no-ops rather than raising exceptions.

### Data Structures

#### `CONSOLE_SCREEN_BUFFER_INFO`

A ctypes Structure that mirrors the Windows `CONSOLE_SCREEN_BUFFER_INFO` struct:

- **Purpose**: Contains information about the console screen buffer
- **Fields**:
  - `dwSize`: Buffer size coordinates
  - `dwCursorPosition`: Current cursor position
  - `wAttributes`: Text attributes (color, etc.)
  - `srWindow`: Console window boundaries
  - `dwMaximumWindowSize`: Maximum window size

```python
class CONSOLE_SCREEN_BUFFER_INFO(Structure):
    _fields_ = [
        ("dwSize", COORD),
        ("dwCursorPosition", COORD),
        ("wAttributes", wintypes.WORD),
        ("srWindow", wintypes.SMALL_RECT),
        ("dwMaximumWindowSize", COORD),
    ]
```

## Important Functions

### Console Information

#### `winapi_test()`
- **Purpose**: Tests if Windows console API is available and functional
- **Returns**: Boolean indicating API availability
- **Usage**: Check before using other console functions

#### `GetConsoleScreenBufferInfo(stream_id=STDOUT)`
- **Purpose**: Retrieves current console screen buffer information
- **Parameters**: 
  - `stream_id`: Target stream (STDOUT or STDERR)
- **Returns**: `CONSOLE_SCREEN_BUFFER_INFO` object

### Text Attributes

#### `SetConsoleTextAttribute(stream_id, attrs)`
- **Purpose**: Sets text color and formatting attributes
- **Parameters**:
  - `stream_id`: Target stream
  - `attrs`: Attribute flags for colors and formatting
- **Returns**: Success boolean

### Cursor Control

#### `SetConsoleCursorPosition(stream_id, position, adjust=True)`
- **Purpose**: Moves console cursor to specified position
- **Parameters**:
  - `stream_id`: Target stream
  - `position`: Tuple of (x, y) coordinates
  - `adjust`: Whether to adjust for viewport scrolling
- **Note**: Handles coordinate system conversion (ANSI 1-based to Windows 0-based)

### Screen Buffer Operations

#### `FillConsoleOutputCharacter(stream_id, char, length, start)`
- **Purpose**: Fills console buffer with specified character
- **Use Case**: Screen clearing operations
- **Returns**: Number of characters written

#### `FillConsoleOutputAttribute(stream_id, attr, length, start)`
- **Purpose**: Fills console buffer region with specified attributes
- **Use Case**: Bulk attribute changes (e.g., background colors)

### Console Management

#### `SetConsoleTitle(title)`
- **Purpose**: Sets the console window title
- **Parameters**: `title` - New window title string

#### `GetConsoleMode(handle)` / `SetConsoleMode(handle, mode)`
- **Purpose**: Get/set console input and output modes
- **Use Case**: Enable features like virtual terminal processing
- **Error Handling**: Raises `ctypes.WinError()` on failure

## Usage Notes

### Coordinate Systems
- **ANSI**: 1-based, (row, column) format
- **Windows**: 0-based, (column, row) format
- The module handles conversion automatically in `SetConsoleCursorPosition()`

### Platform Compatibility
- Only functional on Windows systems
- Gracefully degrades on other platforms (functions become no-ops)
- Always check `winapi_test()` before relying on functionality

### Best Practices
```python
# Always test API availability first
if winapi_test():
    # Safe to use Windows console functions
    SetConsoleTextAttribute(STDOUT, color_attrs)
    SetConsoleCursorPosition(STDOUT, (10, 5))
```

## Dependencies

- **ctypes**: For Windows API bindings
- **Windows OS**: Required for actual functionality
- **kernel32.dll**: Windows system library (automatically available)

## License

BSD 3-Clause license - see LICENSE file for details.