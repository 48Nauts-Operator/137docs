<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Message and RawPolicy Classes Documentation

## Overview

This Python file provides specialized classes for handling email-formatted metadata messages, particularly designed for Python package metadata according to PEP 566. It extends the standard library's `email.message.Message` class to better handle metadata with multiline values and provides custom formatting policies.

## Classes

### RawPolicy

```python
class RawPolicy(email.policy.EmailPolicy)
```

A custom email policy class that handles the formatting of message headers with special indentation rules.

**Purpose:**
- Provides custom folding behavior for email headers
- Ensures proper indentation (8 spaces) for multiline values
- Maintains RFC822 compatibility while handling metadata-specific formatting

**Key Methods:**
- `fold(name, value)`: Formats header values with consistent 8-space indentation for continuation lines

### Message

```python
class Message(email.message.Message)
```

A specialized subclass of `email.message.Message` designed to handle Python package metadata naturally.

**Key Features:**
- Handles multiline metadata values correctly
- Converts message payload to a "Description" field
- Supports multiple-use keys as defined in PEP 566
- Provides JSON conversion functionality

#### Important Attributes

- **`multiple_use_keys`**: A set of field names that can appear multiple times in metadata according to PEP 566, including:
  - `Classifier`
  - `Obsoletes-Dist`
  - `Platform`
  - `Project-URL`
  - `Provides-Dist`
  - `Provides-Extra`
  - `Requires-Dist`
  - `Requires-External`
  - `Supported-Platform`
  - `Dynamic`

#### Key Methods

- **`__new__(cls, orig)`**: Creates a new Message instance from an existing email.message.Message
- **`__getitem__(item)`**: Override to raise KeyError for missing keys instead of returning None
- **`_repair_headers()`**: Corrects RFC822 indentation and processes payload as Description
- **`as_string()`**: Returns string representation using the custom RawPolicy
- **`json`** (property): Converts metadata to JSON-compatible format per PEP 566

## Usage Examples

### Basic Usage

```python
import email
from your_module import Message

# Parse metadata text
msg_text = """
Name: MyPackage
Version: 1.0.0
License: MIT License
        Extended license text

Package description goes here.
Multiple lines supported.
"""

# Create Message from email message
email_msg = email.message_from_string(msg_text)
msg = Message(email_msg)

# Access fields
print(msg['Name'])  # "MyPackage"
print(msg['Description'])  # Full description from payload
```

### JSON Conversion

```python
# Convert to JSON format
json_data = msg.json
# Returns dict with normalized keys (lowercase, underscores)
```

## Important Notes

‚ö†Ô∏è **Compatibility Notes:**
- Designed specifically for Python package metadata (PEP 566)
- Handles RFC822 formatting with 8-space indentation convention
- Missing keys raise `KeyError` instead of returning `None` (differs from standard email.message behavior)

üìù **Usage Recommendations:**
- Use this class when working with Python package metadata files
- Particularly useful for parsing PKG-INFO, METADATA files
- The `json` property is ideal for converting metadata to modern formats

üîß **Technical Details:**
- Uses `FoldedCase` for case-insensitive key handling
- Automatically moves message payload to "Description" field
- Maintains original email.message.Message interface while adding metadata-specific functionality

## Dependencies

- `email.message` and `email.policy` from Python standard library
- `re` and `textwrap` from Python standard library  
- `._text.FoldedCase` (internal dependency for case-insensitive string handling)