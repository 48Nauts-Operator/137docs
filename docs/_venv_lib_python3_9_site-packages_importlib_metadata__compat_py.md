<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# importlib_metadata/_compat.py

## Overview

This module provides compatibility utilities for the `importlib_metadata` backport package. It contains functionality to manage Python's import system metadata discovery by installing custom finders and handling compatibility issues across different Python implementations.

## Purpose

The primary purpose of this module is to:

- Install custom distribution finders onto Python's meta path
- Disable the standard library's distribution finder to give priority to the backport version
- Provide null finder implementations for testing or fallback scenarios
- Handle platform-specific compatibility issues (particularly with PyPy)

## Exports

The module exports the following public interfaces:

```python
__all__ = ['install', 'NullFinder']
```

## Functions

### `install(cls)`

**Purpose**: Class decorator that installs a custom finder class onto Python's import meta path.

**Parameters**:
- `cls`: A finder class to be installed

**Returns**: The original class (allowing use as a decorator)

**Behavior**:
- Instantiates the provided class and appends it to `sys.meta_path`
- Calls `disable_stdlib_finder()` to give the backport priority
- Returns the original class unchanged

**Usage Example**:
```python
@install
class CustomFinder:
    # finder implementation
    pass
```

### `disable_stdlib_finder()`

**Purpose**: Monkey-patches the standard library's distribution finder to prevent conflicts with the backport.

**⚠️ Warning**: This function performs "sketchy behavior" by modifying stdlib components at runtime.

**Behavior**:
- Searches `sys.meta_path` for finders from `_frozen_importlib_external` module
- Removes the `find_distributions` attribute from matching finders
- Referenced issue #91 provides background on why this approach was necessary

**Implementation Details**:
```python
def matches(finder):
    return getattr(
        finder, '__module__', None
    ) == '_frozen_importlib_external' and hasattr(finder, 'find_distributions')
```

### `pypy_partial(val)`

**Purpose**: Adjusts stack level values to account for PyPy implementation differences.

**Parameters**:
- `val`: Base stack level value (integer)

**Returns**: Adjusted stack level value

**Behavior**:
- Detects if running on PyPy using `platform.python_implementation()`
- Increments the value by 1 if on PyPy, otherwise returns unchanged
- Addresses issue #327 related to stack level discrepancies

## Classes

### `NullFinder`

**Purpose**: A minimal MetaPathFinder implementation that never finds modules but may find distributions.

**Use Cases**:
- Testing scenarios
- Fallback finder implementation
- Placeholder in meta path configurations

**Methods**:

#### `find_spec(*args, **kwargs)` (static method)
- **Returns**: Always returns `None`
- **Purpose**: Implements the MetaPathFinder protocol but never actually finds any module specs

## Dependencies

- `platform`: Used for Python implementation detection
- `sys`: Used for meta path manipulation and system-level operations

## Notes and Suggestions

### Security and Maintenance Concerns

- ⚠️ The `disable_stdlib_finder()` function uses monkey-patching which can be fragile
- Consider monitoring Python version updates that might change `_frozen_importlib_external` behavior
- The "sketchy behavior" comment suggests this is a workaround rather than an ideal solution

### Testing Recommendations

- Test across different Python implementations (CPython, PyPy)
- Verify behavior with different Python versions
- Test the interaction between custom finders and stdlib finders

### Platform Compatibility

- The `pypy_partial()` function demonstrates platform-specific handling
- Consider similar adjustments if other Python implementations show different behavior

### Usage Context

This module appears to be part of a larger backport strategy, likely for `importlib.metadata` functionality in older Python versions. The aggressive approach to disabling stdlib components suggests this backport needs to completely replace rather than supplement standard library functionality.