<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Module Documentation: `_compat.py`

## Overview

This module provides compatibility utilities for handling distribution finders in Python's import system. It serves as a compatibility layer that manages the interaction between backported distribution finders and the standard library's distribution finder functionality.

## Purpose

The primary purpose of this module is to:
- Install custom distribution finders on Python's meta path
- Manage conflicts between backported and standard library distribution finders
- Provide platform-specific compatibility adjustments
- Offer a null finder implementation for testing or fallback scenarios

## Public API

The module exports the following items through `__all__`:
- `install` - Class decorator for installing finders
- `NullFinder` - A no-op finder class

## Functions

### `install(cls)`

A class decorator that installs a custom distribution finder onto Python's import system.

**Parameters:**
- `cls`: The finder class to be installed

**Returns:**
- The original class (unmodified)

**Behavior:**
- Instantiates the provided class and adds it to `sys.meta_path`
- Calls `disable_stdlib_finder()` to prevent conflicts
- Returns the original class to allow normal decorator usage

**Usage Example:**
```python
@install
class CustomFinder:
    def find_distributions(self, context):
        # Custom distribution finding logic
        pass
```

### `disable_stdlib_finder()`

Disables the standard library's distribution finder to give backported finders priority.

**⚠️ Warning:** This function uses monkey-patching by deleting the `find_distributions` method from matching finders in `sys.meta_path`.

**Behavior:**
- Identifies stdlib finders by checking for:
  - `__module__` attribute equal to `'_frozen_importlib_external'`
  - Presence of `find_distributions` method
- Removes the `find_distributions` method from matching finders

**Note:** This is acknowledged as "sketchy behavior" in the code comments, implemented as a workaround (see issue #91 referenced in comments).

### `pypy_partial(val)`

Provides PyPy-specific compatibility adjustment for stack level handling.

**Parameters:**
- `val`: Base stack level value

**Returns:**
- Adjusted stack level (`val + 1` on PyPy, `val` on other implementations)

**Purpose:**
- Workaround for PyPy-specific behavior differences (issue #327)
- Ensures consistent stack level handling across Python implementations

## Classes

### `NullFinder`

A minimal finder implementation that never finds modules but may be used for distribution finding.

**Methods:**
- `find_spec(*args, **kwargs)`: Always returns `None`

**Use Cases:**
- Testing scenarios
- Fallback finder implementation
- Placeholder in finder chains

## Important Notes

### Security and Stability Considerations

- **Monkey-patching Warning**: The `disable_stdlib_finder()` function modifies standard library objects at runtime, which could potentially cause unexpected behavior
- **Import System Modification**: This module directly manipulates `sys.meta_path`, which affects Python's import mechanism globally

### Compatibility

- **PyPy Support**: Includes specific workarounds for PyPy implementation differences
- **Cross-platform**: Uses `platform.python_implementation()` for runtime detection

### Best Practices

- Use the `@install` decorator only when necessary
- Be aware that installing custom finders affects the entire Python process
- Consider the implications of disabling stdlib finder functionality
- Test thoroughly across different Python implementations if using this module

## Dependencies

- `platform` - For Python implementation detection
- `sys` - For meta path manipulation

## Error Handling

The module does not include explicit error handling. Users should be prepared for potential exceptions when:
- Modifying `sys.meta_path`
- Working with finder objects that may not have expected attributes
- Dealing with import system edge cases