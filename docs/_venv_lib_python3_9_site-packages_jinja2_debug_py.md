<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# debug.py - Jinja Template Debugging Utilities

## Purpose

This module provides debugging utilities for Jinja template engines, focusing on improving error reporting and traceback information. It rewrites Python tracebacks to show template source locations instead of compiled code locations, making debugging template errors much more user-friendly.

## Key Features

- **Traceback Rewriting**: Converts Python tracebacks from compiled template code to show original template source locations
- **Template Context Recovery**: Reconstructs template variable context from runtime locals
- **Fake Traceback Generation**: Creates synthetic tracebacks that point to template files instead of compiled Python code

## Dependencies

```python
import sys
import typing as t
from types import CodeType, TracebackType
from .exceptions import TemplateSyntaxError
from .utils import internal_code, missing
```

## Functions

### `rewrite_traceback_stack(source: Optional[str] = None) -> BaseException`

**Purpose**: Main function that rewrites the current exception's traceback to replace compiled template code frames with template source frames.

**Parameters**:
- `source` (Optional[str]): Original template source code for `TemplateSyntaxError` cases

**Returns**: The original exception with rewritten traceback

**Key Operations**:
- Handles special case for `TemplateSyntaxError` by setting source and removing compiler frames
- Filters out internal code frames (decorated with `@internalcode`)
- Replaces template code frames with fake tracebacks pointing to template source
- Rebuilds traceback chain in reverse to avoid circular references

**Usage Notes**:
- ‚ö†Ô∏è **Must be called within an `except` block**
- Automatically skips internal Jinja frames for cleaner output

### `fake_traceback(exc_value, tb, filename, lineno) -> TracebackType`

**Purpose**: Creates a synthetic traceback that appears to originate from template source code instead of compiled Python code.

**Parameters**:
- `exc_value` (BaseException): Original exception to re-raise
- `tb` (Optional[TracebackType]): Original traceback for context extraction
- `filename` (str): Template filename to display
- `lineno` (int): Line number in template source

**Returns**: New traceback object pointing to template source

**Key Features**:
- Reconstructs local variables from template context
- Creates appropriate location names (e.g., "top-level template code", "block 'name'")
- Handles Python version differences in code object creation
- Generates executable code that raises the exception at the correct line

### `get_template_locals(real_locals) -> Dict[str, Any]`

**Purpose**: Extracts and reconstructs the template variable context from runtime locals.

**Parameters**:
- `real_locals` (Mapping[str, Any]): Runtime local variables from the traceback frame

**Returns**: Dictionary of template variables and their values

**Key Operations**:
- Starts with base template context if available
- Processes local variable overrides with naming scheme `l_depth_name`
- Handles variable shadowing by selecting highest-depth values
- Filters out missing values and internal variables

## Implementation Details

### Template Variable Naming Convention

The module handles Jinja's internal variable naming scheme:
```python
# Template variables are stored as: l_{depth}_{name}
# Example: l_0_username, l_1_item, l_2_value
```

### Python Version Compatibility

The code handles differences between Python versions:
```python
if sys.version_info >= (3, 8):
    code = code.replace(co_name=location)
else:
    # Manual CodeType construction for older Python versions
    code = CodeType(...)
```

### Location Name Mapping

- `root` function ‚Üí "top-level template code"
- `block_*` function ‚Üí "block 'blockname'"
- Default ‚Üí "template"

## Usage Example

```python
try:
    # Template rendering code
    template.render()
except Exception:
    # Rewrite traceback to show template source locations
    exc = rewrite_traceback_stack(source=template_source)
    raise exc
```

## Notes and Considerations

- üîç **Debugging Focus**: This module is specifically designed for development and debugging
- ‚ö° **Performance**: Traceback rewriting adds overhead, typically used only when errors occur
- üîí **Exception Handling**: Requires careful exception handling to maintain proper error context
- üßπ **Memory Management**: Uses reverse iteration to build traceback chain and avoid circular references

## Integration Points

This module integrates with:
- Jinja's exception system (`TemplateSyntaxError`)
- Template compilation and runtime systems
- Internal code marking utilities (`@internalcode` decorator)