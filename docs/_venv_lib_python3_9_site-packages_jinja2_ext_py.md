<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Jinja2 Extension API Documentation

This file implements the extension API for the Jinja2 template engine, allowing developers to add custom tags, filters, and behavior to templates. It also includes several built-in extensions for common functionality.

## Overview

The extension system allows you to:
- Add custom template tags and syntax
- Implement internationalization (i18n) support
- Add debugging capabilities
- Extend template parsing and processing

## Core Classes

### Extension

The base class for all Jinja2 extensions.

```python
class Extension:
    tags: t.Set[str] = set()  # Tags this extension handles
    priority = 100           # Extension priority (lower = higher priority)
```

#### Key Methods

- **`__init__(environment: Environment)`** - Initialize with a Jinja environment
- **`bind(environment: Environment)`** - Create a copy bound to another environment
- **`preprocess(source: str, name: str, filename: str)`** - Preprocess template source before lexing
- **`filter_stream(stream: TokenStream)`** - Filter tokens during lexing
- **`parse(parser: Parser)`** - Parse custom tags (must be implemented by subclasses)
- **`attr(name: str, lineno: int)`** - Create attribute nodes for the extension
- **`call_method(name: str, args: List, kwargs: List)`** - Helper to call extension methods

#### Usage Notes

- Extensions are identified by their import name, so factory functions won't work
- Store configuration on the environment, not the extension instance
- Use descriptive configuration names (e.g., `fragment_cache_prefix` not `prefix`)

## Built-in Extensions

### InternationalizationExtension

Adds gettext-based internationalization support with the `{% trans %}` tag.

```python
# Example usage
{% trans %}Hello, World!{% endtrans %}
{% trans count=items|length %}
  There is {{ count }} item.
{% pluralize %}
  There are {{ count }} items.
{% endtrans %}
```

#### Features

- **Translation blocks**: `{% trans %}...{% endtrans %}`
- **Pluralization**: `{% pluralize %}` for handling singular/plural forms
- **Context support**: `{% trans "context" %}` for disambiguation
- **Variable interpolation**: Support for variables within translation blocks
- **Whitespace trimming**: `trimmed`/`notrimmed` options

#### Key Methods

- **`_install(translations, newstyle)`** - Install translation functions
- **`_install_null(newstyle)`** - Install null translations for testing
- **`_install_callables(...)`** - Install specific gettext callables
- **`_extract(source, gettext_functions)`** - Extract translatable strings

### ExprStmtExtension

Adds a `{% do %}` tag for executing expressions without output.

```python
# Example usage
{% do some_list.append('item') %}
{% do session.update({'key': 'value'}) %}
```

### LoopControlExtension

Adds `{% break %}` and `{% continue %}` tags for loop control.

```python
# Example usage
{% for item in items %}
    {% if item.skip %}
        {% continue %}
    {% endif %}
    {% if item.stop %}
        {% break %}
    {% endif %}
    {{ item.name }}
{% endfor %}
```

### DebugExtension

Adds a `{% debug %}` tag that dumps available variables, filters, and tests.

```python
# Example usage
<pre>{% debug %}</pre>
```

**Output includes:**
- Context variables
- Available filters
- Available tests

## Utility Functions

### extract_from_ast()

Extracts localizable strings from template AST nodes.

```python
def extract_from_ast(
    ast: nodes.Template,
    gettext_functions: Sequence[str] = GETTEXT_FUNCTIONS,
    babel_style: bool = True,
) -> Iterator[Tuple[int, str, Union[str, Tuple[str, ...]]]]:
```

**Parameters:**
- `ast`: Template AST node
- `gettext_functions`: Function names to extract from
- `babel_style`: Whether to use Babel-compatible output format

**Returns:** Iterator of `(line_number, function_name, message)` tuples

### babel_extract()

Babel extraction method for Jinja templates.

```python
def babel_extract(
    fileobj: BinaryIO,
    keywords: Sequence[str],
    comment_tags: Sequence[str],
    options: Dict[str, Any],
) -> Iterator[Tuple[int, str, Union[str, Tuple[str, ...]], List[str]]]:
```

**Features:**
- Extracts translatable strings for Babel
- Supports translator comments
- Configurable through options dictionary
- Handles template syntax errors gracefully

## Constants

### GETTEXT_FUNCTIONS

Tuple of internationalization function names available in templates:

```python
GETTEXT_FUNCTIONS = ("_", "gettext", "ngettext", "pgettext", "npgettext")
```

## Import Aliases

The module provides convenient import aliases:

```python
i18n = InternationalizationExtension
do = ExprStmtExtension
loopcontrols = LoopControlExtension
debug = DebugExtension
```

## Usage Examples

### Creating a Custom Extension

```python
from jinja2.ext import Extension
from jinja2 import nodes

class TimestampExtension(Extension):
    tags = {'timestamp'}
    
    def parse(self, parser):
        lineno = next(parser.stream).lineno
        return nodes.Output([
            nodes.Const(datetime.now().isoformat())
        ], lineno=lineno)

# Usage in template: {% timestamp %}
```

### Installing Extensions

```python
from jinja2 import Environment
from jinja2.ext import i18n, do, loopcontrols

env = Environment(extensions=[i18n, do, loopcontrols])
```

## Notes and Best Practices

- **Thread Safety**: Extensions should not store environment-specific data on `self`
- **Configuration**: Store configuration on the environment, use descriptive names
- **Error Handling**: Use appropriate Jinja exceptions (`