<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Native Template Rendering Module

## Overview

This Python module provides native template rendering capabilities for the Jinja2 templating engine. Instead of always returning strings like standard Jinja2 templates, this module renders templates to native Python data types (integers, lists, dictionaries, etc.) when possible.

## Purpose

The main purpose of this module is to:
- Render Jinja2 templates that produce native Python types instead of strings
- Automatically parse string results back to Python literals when possible
- Maintain backward compatibility with string-based templates
- Support both synchronous and asynchronous template rendering

## Key Components

### Functions

#### `native_concat(values: t.Iterable[t.Any]) -> t.Optional[t.Any]`

The core function that converts template output to native Python types.

**Behavior:**
- If no values provided, returns `None`
- If single value and not a string, returns the value as-is
- If multiple values or single string, concatenates all values as strings
- Attempts to parse the result using `ast.literal_eval()` to convert to native Python types
- Falls back to returning the string if parsing fails

```python
# Example usage
native_concat([1, 2, 3])  # Returns "123" or 123 if parseable
native_concat([42])       # Returns 42 (integer)
native_concat(["hello"])  # Returns "hello" (string)
```

### Classes

#### `NativeCodeGenerator(CodeGenerator)`

A specialized code generator that modifies template compilation to preserve native types.

**Key Features:**
- Overrides `_default_finalize()` to return values without string conversion
- Handles constant representation for native types
- Manages pre/post processing of template nodes

**Important Methods:**
- `_default_finalize()`: Returns values without converting to strings
- `_output_const_repr()`: Handles representation of constant values
- `_output_child_to_const()`: Processes child nodes while preserving types

#### `NativeEnvironment(Environment)`

An environment class configured for native template rendering.

**Configuration:**
- Uses `NativeCodeGenerator` as the code generator
- Uses `native_concat` as the concatenation function
- Inherits all other functionality from the base `Environment` class

#### `NativeTemplate(Template)`

The main template class for native rendering.

**Key Methods:**

##### `render(*args, **kwargs) -> t.Any`
Renders the template synchronously and returns native Python types.

```python
template = NativeTemplate("{{ [1, 2, 3] }}")
result = template.render()  # Returns [1, 2, 3] as a list
```

##### `render_async(*args, **kwargs) -> t.Any`
Renders the template asynchronously for async-enabled environments.

**Error Handling:**
- Raises `RuntimeError` if used with non-async environment
- Properly handles exceptions through the environment's exception handler

## Usage Examples

```python
# Creating a native template
env = NativeEnvironment()
template = env.from_string("{{ {'key': 'value'} }}")
result = template.render()  # Returns {'key': 'value'} as dict

# Rendering lists
template = env.from_string("{{ [1, 2, 3] }}")
result = template.render()  # Returns [1, 2, 3] as list

# Fallback to string for non-parseable content
template = env.from_string("Hello {{ name }}!")
result = template.render(name="World")  # Returns "Hello World!" as string
```

## Important Notes

### Compatibility Considerations
- **Python 3.10+ Compatibility**: The code includes special handling for `ast.literal_eval()` behavior changes in Python 3.10+ regarding leading whitespace
- **Memory Safety**: Catches `MemoryError` during parsing to prevent crashes with large inputs

### Performance Considerations
- Uses `islice()` to efficiently check for single vs. multiple values
- Handles generators properly to avoid unnecessary iteration
- Falls back gracefully when parsing fails

### Security Notes
- Uses `ast.literal_eval()` for safe evaluation of Python literals
- Only evaluates safe representations using `has_safe_repr()` checks
- No arbitrary code execution risks

## Dependencies

This module depends on:
- `ast` module for safe literal evaluation
- `itertools` for efficient iteration handling  
- `types` for generator type checking
- Local modules: `nodes`, `compiler`, `environment`

## Error Handling

The module includes robust error handling for:
- `ValueError`: Invalid literal syntax
- `SyntaxError`: Invalid Python syntax  
- `MemoryError`: Large input handling
- `RuntimeError`: Async/sync environment mismatches