<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python Markdown Block Processors Documentation

## Overview

This module contains block processors for the Python Markdown library. Block processors parse blocks of text separated by blank lines and convert them into appropriate XML/HTML elements in an ElementTree structure. Each processor handles a specific type of Markdown syntax like headers, lists, code blocks, blockquotes, etc.

## Purpose

Block processors are responsible for:
- Parsing different types of Markdown blocks (code, lists, headers, etc.)
- Converting Markdown syntax to structured XML elements
- Handling nested and complex block structures
- Managing the parsing state and priority order

## Key Functions

### `build_block_parser(md: Markdown, **kwargs: Any) -> BlockParser`

Creates and configures the default block parser with all standard processors registered in priority order.

**Processor Priority Order (highest to lowest):**
- `EmptyBlockProcessor` (100) - Handles empty blocks
- `ListIndentProcessor` (90) - Processes indented list items
- `CodeBlockProcessor` (80) - Handles code blocks
- `HashHeaderProcessor` (70) - Processes `# Header` syntax
- `SetextHeaderProcessor` (60) - Processes underlined headers
- `HRProcessor` (50) - Handles horizontal rules
- `OListProcessor` (40) - Processes ordered lists
- `UListProcessor` (30) - Processes unordered lists
- `BlockQuoteProcessor` (20) - Handles blockquotes
- `ReferenceProcessor` (15) - Processes link references
- `ParagraphProcessor` (10) - Default paragraph processor

## Core Classes

### `BlockProcessor` (Base Class)

The abstract base class that all block processors inherit from.

**Key Methods:**
- `test(parent, block)` - Determines if this processor should handle the block
- `run(parent, blocks)` - Processes the block and modifies the element tree
- `detab(text, length)` - Removes indentation from text
- `lastChild(parent)` - Returns the last child element

**Attributes:**
- `parser` - Reference to the BlockParser instance
- `tab_length` - Tab length setting from Markdown instance

### Major Block Processors

#### `CodeBlockProcessor`
Handles indented code blocks (4+ spaces or 1+ tabs).

```python
# Detects blocks like:
    def hello():
        print("Hello, World!")
```

#### `HashHeaderProcessor`
Processes ATX-style headers using `#` symbols.

```python
# Handles:
# Header 1
## Header 2
### Header 3
```

#### `SetextHeaderProcessor` 
Processes Setext-style headers with underlines.

```python
# Handles:
Header 1
========

Header 2
--------
```

#### `ListIndentProcessor`
Manages indented content within list items, handling nested structures.

#### `OListProcessor` & `UListProcessor`
Process ordered (numbered) and unordered (bulleted) lists respectively.

**Key Features:**
- Handles nested lists
- Manages list item indentation
- Supports mixed list types
- Tracks list numbering for ordered lists

#### `BlockQuoteProcessor`
Processes blockquotes using `>` prefix.

```python
# Handles:
> This is a blockquote
> with multiple lines
```

#### `ReferenceProcessor`
Processes link reference definitions.

```python
# Handles:
[link-id]: https://example.com "Optional Title"
```

## Important Notes

### Processing Order
Processors are executed in priority order (highest number first). This ensures that more specific patterns are matched before generic ones.

### State Management
The parser maintains state information to handle context-dependent parsing:
- `list` - Currently processing list items
- `looselist` - Processing loose list format
- `blockquote` - Inside a blockquote
- `detabbed` - Content has been detabbed

### Recursion Protection
Some processors include recursion limit checks to prevent infinite loops during complex nested parsing.

### Text Handling
- Uses `util.AtomicString` for text that shouldn't be further processed
- Handles whitespace preservation in code blocks
- Manages text vs. tail content in XML elements

## Usage Considerations

### Custom Processors
To create custom block processors:

1. Inherit from `BlockProcessor`
2. Implement `test()` and `run()` methods
3. Register with appropriate priority in the parser

### Performance
- Processors use regular expressions for pattern matching
- Higher priority processors are checked first
- Early return from `test()` methods improves performance

### Error Handling
- Most processors include fallback behavior
- Logging is used for debugging problematic blocks
- Invalid blocks typically fall through to paragraph processing

## Dependencies

- `xml.etree.ElementTree` - For XML/HTML element creation
- `re` - Regular expression processing
- `util` - Markdown utility functions
- `blockparser` - Core parsing framework