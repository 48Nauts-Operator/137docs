<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Attribute List Extension for Python-Markdown

## Overview

This Python-Markdown extension adds attribute list syntax to Markdown documents, allowing you to add HTML attributes (like classes, IDs, and other attributes) to Markdown elements. The implementation is inspired by [Maruku's attribute list feature](http://maruku.rubyforge.org/proposal.html#attribute_lists).

## Purpose

The extension enables you to write Markdown with HTML attributes using a special syntax:
- `{.class-name}` - adds CSS classes
- `{#id-name}` - adds ID attributes  
- `{key=value}` - adds arbitrary attributes
- `{key="quoted value"}` or `{key='quoted value'}` - adds attributes with quoted values

## Key Components

### 1. Attribute Parsing Functions

The extension uses several handler functions to parse different attribute formats:

```python
def _handle_double_quote(s, t):    # Handles key="value"
def _handle_single_quote(s, t):    # Handles key='value'  
def _handle_key_value(s, t):       # Handles key=value
def _handle_word(s, t):            # Handles .class and #id shorthand
```

### 2. Main Parsing Functions

#### `get_attrs_and_remainder(attrs_string: str)`
- **Purpose**: Parses an attribute string and returns parsed attributes plus any remaining text
- **Returns**: Tuple of `(list[tuple[str, str]], str)` - attributes and remainder text
- **Usage**: Primary function for parsing attribute lists

#### `get_attrs(str: str)` 
- **Status**: Soft-deprecated, use `get_attrs_and_remainder()` instead
- **Purpose**: Legacy function that only returns parsed attributes

### 3. AttrListTreeprocessor Class

The core processor that traverses the document tree and applies attributes:

#### Key Regular Expressions:
```python
BASE_RE = r'\{\:?[ ]*([^\}\n ][^\n]*)[ ]*\}'     # Base pattern for attributes
HEADER_RE = re.compile(r'[ ]+{}[ ]*$'.format(BASE_RE))   # For headers
BLOCK_RE = re.compile(r'\n[ ]*{}[ ]*$'.format(BASE_RE))  # For block elements  
INLINE_RE = re.compile(r'^{}'.format(BASE_RE))           # For inline elements
```

#### Key Methods:

**`run(doc: Element)`**
- Main processing method that iterates through all elements
- Handles different element types (block-level, inline, headers, lists, etc.)
- Applies appropriate regex patterns based on element context

**`assign_attrs(elem: Element, attrs_string: str, *, strict: bool = False)`**
- Assigns parsed attributes to HTML elements
- Handles class concatenation for multiple classes
- Sanitizes attribute names to be XML-compliant
- Returns any remaining unprocessed text

**`sanitize_name(name: str)`**
- Ensures attribute names comply with XML naming rules
- Replaces invalid characters with underscores

### 4. AttrListExtension Class

The main extension class that registers the tree processor with Python-Markdown.

## Usage Examples

```markdown
# Header with ID {#my-header}

Paragraph with class {.highlight}

[Link](http://example.com){.external target="_blank"}

> Blockquote with multiple attributes {.quote #special-quote data-author="John"}
```

## Technical Notes

### Processing Order
- The tree processor runs with priority 8 in the processing pipeline
- It handles both block-level and inline elements differently
- Special handling for list items, headers, and table cells

### Element Type Handling
- **Block elements**: Looks for attributes at the end of text content
- **Headers**: Searches at the end of the element, cleans up trailing `#` characters  
- **List items**: Complex logic to handle nested `ul`/`ol` elements
- **Inline elements**: Checks for attributes at the start of tail text

### Edge Cases
- **Strict mode**: When `strict=True`, attributes are not applied if there's remaining unparsed text
- **Name sanitization**: Invalid XML characters in attribute names are replaced with underscores
- **Class concatenation**: Multiple classes are properly joined with spaces

## Suggestions for Usage

1. **Testing**: Always test attribute parsing with complex nested structures
2. **Validation**: Be aware that attribute names are automatically sanitized
3. **Performance**: The extension uses regex scanning which is efficient for typical documents
4. **Compatibility**: Follows XML naming conventions for broad HTML/XML compatibility

## Installation

This extension is typically included with Python-Markdown installations. Enable it with:

```python
import markdown
md = markdown.Markdown(extensions=['attr_list'])
```