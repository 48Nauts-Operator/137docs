<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# CodeHilite Extension for Python-Markdown

This Python module provides syntax highlighting functionality for code blocks in Markdown documents using the Pygments library. It's an extension for the Python-Markdown package that automatically detects programming languages and applies appropriate syntax highlighting.

## Purpose

The CodeHilite extension enhances standard Markdown code blocks by:
- Adding syntax highlighting using Pygments
- Supporting automatic language detection
- Providing line numbering options
- Allowing custom styling and formatting
- Falling back to JavaScript-compatible markup when Pygments is unavailable

## Key Components

### Main Classes and Functions

#### `CodeHilite` Class

The core class responsible for processing and highlighting source code.

**Constructor Parameters:**
- `src` (str): The source code to highlight
- `lang` (str, optional): Programming language name
- `guess_lang` (bool, default=True): Enable automatic language detection
- `use_pygments` (bool, default=True): Use Pygments for highlighting
- `pygments_formatter` (str, default='html'): Pygments formatter to use
- `linenums` (bool, optional): Enable line numbers
- `css_class` (str, default='codehilite'): CSS class for styling
- `lang_prefix` (str, default='language-'): Prefix for language classes

**Key Methods:**

```python
def hilite(self, shebang: bool = True) -> str:
    """
    Highlight the source code and return HTML.
    
    Args:
        shebang: Whether to parse shebang lines for language detection
        
    Returns:
        HTML string with highlighted code
    """
```

#### `HiliteTreeprocessor` Class

A tree processor that finds code blocks in the Markdown document tree and applies highlighting.

**Key Methods:**

```python
def run(self, root: etree.Element) -> None:
    """Find code blocks and store highlighted HTML in htmlStash."""

def code_unescape(self, text: str) -> str:
    """Unescape HTML entities in code text."""
```

#### `CodeHiliteExtension` Class

The main extension class that integrates with Python-Markdown.

**Configuration Options:**
- `linenums`: Line numbering behavior
- `guess_lang`: Automatic language detection
- `css_class`: CSS class name
- `pygments_style`: Color scheme
- `noclasses`: Use inline styles vs CSS classes
- `use_pygments`: Enable/disable Pygments
- `lang_prefix`: Language class prefix
- `pygments_formatter`: Formatter selection

### Utility Functions

#### `parse_hl_lines(expr: str) -> list[int]`

Parses line highlighting expressions like "1 2 5" into a list of line numbers to emphasize.

```python
# Example usage
lines = parse_hl_lines("1 3 5")  # Returns [1, 3, 5]
```

#### `makeExtension(**kwargs)`

Factory function to create a CodeHiliteExtension instance.

## Usage Examples

### Basic Usage

```python
from markdown.extensions.codehilite import CodeHilite

# Simple highlighting
code = CodeHilite(src="print('Hello, World!')", lang='python')
html = code.hilite()
```

### Advanced Usage

```python
# With custom options
code = CodeHilite(
    src=some_php_code,
    lang='php',
    startinline=True,      # PHP lexer option
    linenostart=42,        # Start line numbering at 42
    hl_lines=[45, 49, 50], # Highlight specific lines
    linenos='inline'       # Inline line numbers
)
html = code.hilite()
```

### Markdown Extension Usage

```python
import markdown

md = markdown.Markdown(extensions=['codehilite'])
html = md.convert(markdown_text)
```

## Language Detection

The extension supports multiple methods for language detection:

1. **Explicit language specification:**
   ```markdown
   ```python
   print("Hello")
   ```
   ```

2. **Shebang lines:**
   ```markdown
   ```
   #!python
   print("Hello")
   ```
   ```

3. **Colon syntax with highlighting:**
   ```markdown
   ```
   :::python hl_lines="1 3"
   print("Hello")
   x = 1
   print(x)
   ```
   ```

## Dependencies and Fallbacks

- **With Pygments:** Full syntax highlighting with themes and advanced features
- **Without Pygments:** Falls back to basic HTML markup suitable for JavaScript highlighting libraries

## Notes and Suggestions

### Performance Considerations
- Language detection adds processing overhead
- Consider disabling `guess_lang` for better performance when language is known
- Cache highlighted results for frequently accessed content

### Styling
- Default CSS class is `codehilite` - ensure your CSS includes appropriate styles
- Use `noclasses=True` for inline styles if external CSS isn't available
- Consider using `pygments_style` parameter to match your site's theme

### Best Practices
- Always specify language when known to avoid detection overhead
- Use line highlighting sparingly for better readability
- Test fallback behavior when Pygments is unavailable
- Consider accessibility when choosing color schemes

### Configuration Tips
- Set `use_pygments=False` if using client-side highlighting libraries like Prism.js or highlight.js
- Adjust `lang_prefix` to match your JavaScript library's requirements
- Use `linenos='table'` for better copy-paste behavior with line numbers