<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# CodeHilite Extension for Python-Markdown

## Overview

The CodeHilite extension adds syntax highlighting capabilities to standard Python-Markdown code blocks. It integrates with the [Pygments](https://pygments.org/) library to provide rich syntax highlighting for various programming languages, with fallback support for JavaScript-based highlighting libraries when Pygments is not available.

## Purpose

This extension transforms plain code blocks in Markdown into beautifully highlighted HTML code with:
- Automatic language detection
- Line numbering support
- Customizable styling options
- Support for highlighting specific lines
- Flexible configuration options

## Key Components

### 1. `parse_hl_lines(expr: str) -> list[int]`

A utility function that parses line highlighting expressions.

```python
# Example usage
lines = parse_hl_lines("1 3 5")  # Returns [1, 3, 5]
```

**Parameters:**
- `expr`: Space-separated string of line numbers to highlight

**Returns:** List of integers representing line numbers to emphasize

### 2. `CodeHilite` Class

The main class responsible for code highlighting logic.

#### Constructor Parameters

```python
CodeHilite(src, **options)
```

**Key Parameters:**
- `src` (str): Source code to highlight
- `lang` (str): Programming language name for Pygments lexer
- `guess_lang` (bool): Enable automatic language detection (default: `True`)
- `use_pygments` (bool): Use Pygments for highlighting (default: `True`)
- `linenums` (bool): Enable line numbers
- `css_class` (str): CSS class for code blocks (default: `'codehilite'`)
- `lang_prefix` (str): Prefix for language classes (default: `'language-'`)

#### Key Methods

##### `hilite(shebang: bool = True) -> str`

Main method that performs the syntax highlighting.

```python
code = CodeHilite(src="print('Hello World')", lang='python')
html = code.hilite()
```

**Process:**
1. Strips whitespace from source
2. Parses shebang lines for language detection
3. Uses Pygments for highlighting (if available)
4. Falls back to plain HTML with CSS classes for JavaScript highlighters

##### `_parseHeader() -> None`

Parses shebang lines and language hints from code blocks.

**Supported formats:**
- `#!/usr/bin/python` - Real shebang (preserved)
- `#!python` - Mock shebang (removed, enables line numbers)
- `:::python` - Language hint (removed, preserves line number settings)
- `:::python hl_lines="1 3"` - With line highlighting

### 3. `HiliteTreeprocessor` Class

Processes the Markdown syntax tree to find and highlight code blocks.

#### Key Methods

##### `run(root: etree.Element) -> None`

- Finds `<pre><code>` blocks in the parsed Markdown
- Applies CodeHilite processing
- Stores results in Markdown's HTML stash

##### `code_unescape(text: str) -> str`

Unescapes HTML entities in code blocks before processing.

### 4. `CodeHiliteExtension` Class

The main extension class that integrates with Python-Markdown.

#### Configuration Options

| Option | Default | Description |
|--------|---------|-------------|
| `linenums` | `None` | Line numbers: `True`/`table`/`inline`=yes, `False`=no, `None`=auto |
| `guess_lang` | `True` | Automatic language detection |
| `css_class` | `"codehilite"` | CSS class for wrapper element |
| `pygments_style` | `'default'` | Pygments color scheme |
| `noclasses` | `False` | Use inline styles instead of CSS classes |
| `use_pygments` | `True` | Enable Pygments highlighting |
| `lang_prefix` | `'language-'` | Prefix for language CSS classes |
| `pygments_formatter` | `'html'` | Pygments formatter to use |

## Usage Examples

### Basic Usage

```python
import markdown

# Create markdown instance with CodeHilite
md = markdown.Markdown(extensions=['codehilite'])

# Convert markdown with code blocks
text = """
```python
def hello():
    print("Hello, World!")
```
"""

html = md.convert(text)
```

### Advanced Configuration

```python
md = markdown.Markdown(extensions=[
    'codehilite'
], extension_configs={
    'codehilite': {
        'linenums': True,
        'pygments_style': 'monokai',
        'css_class': 'highlight',
        'guess_lang': False
    }
})
```

### Code Block with Language and Line Highlighting

```markdown
:::python hl_lines="2 4"
def example():
    x = 1  # This line will be highlighted
    y = 2
    z = 3  # This line will be highlighted
    return x + y + z
```

## Dependencies

### Required
- Python-Markdown core library

### Optional
- **Pygments**: For syntax highlighting (highly recommended)
  ```bash
  pip install pygments
  ```

## Notes and Suggestions

### Performance Considerations
- Pygments highlighting can be CPU-intensive for large code blocks
- Consider caching highlighted output for frequently accessed content
- Use `use_pygments=False` for client-side highlighting in performance-critical applications

### Styling
- The extension only adds structural markup and CSS classes
- You must provide CSS styles for the generated classes
- Pygments can generate CSS stylesheets: `pygmentize -S default -f html > pygments.css`

### Language Detection
- Automatic language detection works best with longer code samples
- Explicitly specify languages for short snippets
- Use shebang lines or `:::language` syntax for reliable detection

### Browser Compatibility
- Generated HTML is compatible with all modern browsers
- JavaScript fallback mode works with libraries like Prism.js or highlight.js

### Security
- The extension properly escapes HTML entities in code blocks
- Safe to use with user-generated content

## Integration Notes

- Register priority: 30