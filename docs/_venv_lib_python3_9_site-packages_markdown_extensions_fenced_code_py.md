<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Fenced Code Extension for Python Markdown

## Overview

This extension adds support for **Fenced Code Blocks** to Python-Markdown, enabling the use of triple backticks (```) or tildes (~~~) to define code blocks with optional syntax highlighting and attributes.

## Purpose

The extension enhances Markdown processing by:
- Converting fenced code blocks into properly formatted HTML `<pre><code>` elements
- Supporting syntax highlighting through integration with the CodeHilite extension
- Allowing custom attributes and CSS classes on code blocks
- Providing backward compatibility with existing Markdown documents

## Main Classes

### `FencedCodeExtension`

The main extension class that registers the fenced code block functionality with Python-Markdown.

**Configuration Options:**
- `lang_prefix`: Prefix prepended to language classes (default: `"language-"`)

**Key Methods:**
- `extendMarkdown(md)`: Registers the `FencedBlockPreprocessor` with the Markdown instance

### `FencedBlockPreprocessor`

The core processor that finds, parses, and converts fenced code blocks into HTML.

**Key Features:**
- Uses regex pattern matching to identify fenced code blocks
- Supports both backtick (```) and tilde (~~~) fences
- Handles optional language specification and attributes
- Integrates with CodeHilite extension for syntax highlighting

## Important Methods

### `run(lines: list[str]) -> list[str]`

The main processing method that:
1. Searches for fenced code blocks in the text
2. Extracts language, attributes, and configuration
3. Applies syntax highlighting if CodeHilite is available
4. Generates appropriate HTML output
5. Stores processed blocks in the HTML stash

### `handle_attrs(attrs) -> tuple[str, list[str], dict[str, Any]]`

Processes attribute specifications and returns:
- `id`: Element ID
- `classes`: List of CSS classes  
- `configs`: Configuration dictionary

## Supported Syntax

### Basic Fenced Code Block
```markdown
```python
def hello():
    print("Hello, World!")
```
```

### With Attributes
```markdown
```{.python #mycode .highlight}
def hello():
    print("Hello, World!")
```
```

### With Highlight Lines (Legacy)
```markdown
```python hl_lines="1 3"
def hello():
    print("Hello, World!")
    return True
```
```

## Dependencies

The extension integrates with:
- **CodeHiliteExtension**: For syntax highlighting using Pygments
- **AttrListExtension**: For enhanced attribute processing

## Configuration Options

### Boolean Options
The following options can be set as boolean values:
- `linenums`: Show line numbers
- `guess_lang`: Automatically detect language
- `noclasses`: Use inline styles instead of CSS classes
- `use_pygments`: Enable/disable Pygments highlighting

## Usage Notes

### Installation
```python
import markdown
md = markdown.Markdown(extensions=['fenced_code'])
```

### With Custom Configuration
```python
md = markdown.Markdown(
    extensions=['fenced_code'],
    extension_configs={
        'fenced_code': {
            'lang_prefix': 'highlight-'
        }
    }
)
```

## Technical Details

### Regular Expression Pattern
The extension uses a complex regex pattern (`FENCED_BLOCK_RE`) that matches:
- Opening fence (3+ backticks or tildes)
- Optional attributes in curly braces `{}`
- Optional language specification
- Optional highlight lines specification
- Code content
- Closing fence matching the opening fence

### HTML Output
Generated HTML follows this structure:
```html
<pre class="language-python"><code>def hello():
    print("Hello, World!")
</code></pre>
```

## Security Considerations

The extension includes HTML escaping for:
- Code content (`_escape` method)
- HTML attributes (`_escape_attrib_html`)

This prevents XSS attacks through malicious code block content or attributes.

## Performance Notes

- The preprocessor processes the entire document text as a single string
- Uses `htmlStash` to store processed blocks, preventing interference with other processors
- Efficiently handles multiple code blocks through iterative processing