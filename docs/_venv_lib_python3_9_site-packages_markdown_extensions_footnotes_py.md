<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Footnotes Extension for Python-Markdown

## Overview

This file implements a footnote extension for Python-Markdown that adds support for footnote handling in Markdown documents. The extension allows users to create footnotes using the syntax `[^1]` for references and `[^1]: footnote content` for definitions.

## Purpose

The extension provides comprehensive footnote functionality including:
- Parsing footnote definitions and references
- Generating proper HTML with links between footnotes and their references
- Handling duplicate footnote references
- Customizable footnote placement and formatting
- Unique ID generation to avoid conflicts across multiple document processing

## Main Classes

### FootnoteExtension

The main extension class that coordinates all footnote processing.

**Key Configuration Options:**
- `PLACE_MARKER`: Text marker for footnote placement (default: `///Footnotes Go Here///`)
- `UNIQUE_IDS`: Avoid ID collisions across multiple calls (default: `False`)
- `BACKLINK_TEXT`: Text for footnote back-links (default: `&#8617;`)
- `SUPERSCRIPT_TEXT`: Format for footnote reference links (default: `{}`)
- `BACKLINK_TITLE`: Title attribute for back-links
- `SEPARATOR`: Footnote ID separator (default: `:`)

**Important Methods:**
```python
def extendMarkdown(self, md):
    """Registers all processors with the Markdown parser"""

def makeFootnoteId(self, id: str) -> str:
    """Generate unique footnote IDs"""

def makeFootnotesDiv(self, root: etree.Element) -> etree.Element:
    """Create the footnotes container div"""
```

### FootnoteBlockProcessor

Processes footnote definitions in the document.

- **Pattern**: `^[ ]{0,3}\[\^([^\]]*)\]:[ ]*(.*)$`
- **Function**: Finds and extracts footnote definitions, handling multi-line content and proper indentation
- **Processing**: Removes footnote definitions from the main text and stores them for later use

### FootnoteInlineProcessor

Handles footnote references within the document text.

- **Pattern**: `\[\^([^\]]*)\]`
- **Function**: Converts footnote references to HTML links with proper IDs and classes
- **Output**: Creates superscript links that point to the footnote definitions

### FootnoteTreeprocessor

Builds and places the footnote container in the document.

**Key Functions:**
- Creates the footnote `<div>` with proper HTML structure
- Places footnotes at the specified marker location or at document end
- Generates ordered list of footnotes with back-links

### FootnotePostTreeprocessor

Handles duplicate footnote references.

**Functionality:**
- Identifies footnotes referenced multiple times
- Adds additional back-links for each duplicate reference
- Ensures all references can navigate back to their original location

### FootnotePostprocessor

Final cleanup processor that replaces internal placeholders with actual HTML entities.

## Usage Example

```markdown
This is a sentence with a footnote[^1] and another[^2].

[^1]: This is the first footnote.
[^2]: This is the second footnote with **formatting**.

///Footnotes Go Here///
```

## Processing Flow

1. **Block Processing**: Finds and stores footnote definitions
2. **Inline Processing**: Converts footnote references to links
3. **Tree Processing**: Creates footnote container and places it in document
4. **Post-Tree Processing**: Handles duplicate references
5. **Post Processing**: Final cleanup of placeholders

## Important Notes

- **Indentation Handling**: Footnote content can be indented with 4 spaces for multi-line definitions
- **Duplicate References**: The extension automatically handles multiple references to the same footnote
- **Unique IDs**: When `UNIQUE_IDS` is enabled, footnotes get unique identifiers to prevent conflicts
- **Extensibility**: All processors are properly registered with appropriate priorities

## Suggestions

- Consider enabling `UNIQUE_IDS` when processing multiple documents to avoid ID conflicts
- The `PLACE_MARKER` can be customized to fit your document structure
- Footnote formatting can be customized through CSS using the generated classes (`footnote`, `footnote-ref`, `footnote-backref`)

## Dependencies

- Requires Python-Markdown base classes
- Uses `xml.etree.ElementTree` for HTML generation
- Utilizes `collections.OrderedDict` to maintain footnote order