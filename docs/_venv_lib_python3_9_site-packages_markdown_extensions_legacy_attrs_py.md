<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Legacy Attributes Extension for Python-Markdown

## Overview

This file implements a **legacy attributes extension** for Python-Markdown that provides backward compatibility with the deprecated `enable_attributes` feature from versions prior to 3.0.

## Purpose

- **Backward Compatibility**: Maintains support for documents that use the old `{@key=value}` attribute syntax
- **Migration Support**: Allows existing documents to continue rendering correctly without requiring immediate updates
- **Deprecation Bridge**: Provides a smooth transition path while encouraging use of the modern `attr_lists` extension

> **Note**: This extension is provided for legacy support only. New documents should use the modern `attr_lists` extension instead.

## Key Components

### 1. Regular Expression Pattern

```python
ATTR_RE = re.compile(r'\{@([^\}]*)=([^\}]*)}')  # {@id=123}
```

- Matches the legacy attribute format: `{@key=value}`
- Captures the attribute name and value for processing

### 2. LegacyAttrs Class

**Purpose**: Core tree processor that finds and processes legacy attribute definitions

**Key Methods**:

#### `run(doc: etree.Element) -> None`
- **Function**: Main processing method that traverses the document tree
- **Process**:
  - Iterates through all elements in the document
  - Checks `alt` attributes, text content, and tail content
  - Processes any legacy attribute definitions found

#### `handleAttributes(el: etree.Element, txt: str) -> str`
- **Function**: Extracts attribute definitions and applies them to elements
- **Parameters**:
  - `el`: The XML element to apply attributes to
  - `txt`: Text content that may contain attribute definitions
- **Returns**: Text content with attribute definitions removed
- **Process**:
  - Uses regex substitution to find `{@key=value}` patterns
  - Sets attributes on the element via `el.set()`
  - Replaces newlines in attribute values with spaces

### 3. LegacyAttrExtension Class

**Purpose**: Extension wrapper that integrates the processor with Markdown

#### `extendMarkdown(md)`
- Registers the `LegacyAttrs` tree processor
- Sets processing priority to `15`

### 4. Extension Factory

```python
def makeExtension(**kwargs):
    return LegacyAttrExtension(**kwargs)
```

- Standard factory function for creating extension instances
- Follows Python-Markdown extension conventions

## Usage Example

```python
import markdown

# Enable the legacy attributes extension
md = markdown.Markdown(extensions=['legacy_attrs'])

# Process markdown with legacy attributes
text = "This is a paragraph {@id=my-paragraph}."
html = md.convert(text)
```

## Migration Notes

### ⚠️ Deprecation Warning
- This extension is for **backward compatibility only**
- New projects should use the modern `attr_lists` extension
- Consider migrating existing documents when possible

### Syntax Differences
| Legacy Format | Modern Format |
|---------------|---------------|
| `{@id=value}` | `{: #value }` |
| `{@class=name}` | `{: .name }` |

## Technical Details

- **Processing Order**: Runs at priority `15` in the tree processor chain
- **Content Scope**: Processes `alt` attributes, element text, and tail content
- **Whitespace Handling**: Converts newlines in attribute values to spaces
- **Type Safety**: Includes type hints for better code maintainability

## Dependencies

- `markdown.treeprocessors`: For `Treeprocessor` base class and `isString` utility
- `markdown.extensions`: For `Extension` base class
- `re`: For regular expression pattern matching
- `xml.etree.ElementTree`: For XML element manipulation (type checking)