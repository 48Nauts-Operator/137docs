<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Legacy Em Extension for Python-Markdown

## Overview

This extension provides legacy behavior for underscore-based emphasis and strong text formatting in Python-Markdown. It handles patterns like `_emphasis_`, `__strong__`, and combined emphasis/strong formatting using underscores, maintaining backward compatibility with older Markdown parsing behavior.

## Purpose

The Legacy Em Extension addresses specific parsing behavior for underscore-delimited text formatting that may differ from standard Markdown implementations. It's particularly useful when you need to maintain compatibility with legacy documents or specific formatting requirements involving connected words with underscores.

## Key Components

### Classes

#### `LegacyUnderscoreProcessor`

**Inherits from:** `UnderscoreProcessor`

A specialized processor that handles emphasis and strong text patterns using underscores with legacy behavior.

**Key Features:**
- Processes multiple underscore patterns with specific precedence
- Handles nested emphasis and strong formatting
- Uses regex patterns with DOTALL and UNICODE flags for comprehensive matching

**Pattern Definitions:**
```python
PATTERNS = [
    EmStrongItem(re.compile(EM_STRONG2_RE, re.DOTALL | re.UNICODE), 'double', 'strong,em'),
    EmStrongItem(re.compile(STRONG_EM2_RE, re.DOTALL | re.UNICODE), 'double', 'em,strong'),
    EmStrongItem(re.compile(STRONG_EM_RE, re.DOTALL | re.UNICODE), 'double2', 'strong,em'),
    EmStrongItem(re.compile(STRONG_RE, re.DOTALL | re.UNICODE), 'single', 'strong'),
    EmStrongItem(re.compile(EMPHASIS_RE, re.DOTALL | re.UNICODE), 'single', 'em')
]
```

#### `LegacyEmExtension`

**Inherits from:** `Extension`

The main extension class that integrates the legacy underscore processor into Python-Markdown.

**Methods:**
- `extendMarkdown(md)`: Registers the `LegacyUnderscoreProcessor` with the Markdown instance

### Regular Expression Patterns

The extension defines several regex patterns for different formatting scenarios:

```python
# Basic emphasis: _text_
EMPHASIS_RE = r'(_)([^_]+)\1'

# Strong text: __text__
STRONG_RE = r'(_{2})(.+?)\1'

# Combined strong and emphasis: ___text___
STRONG_EM_RE = r'(_)\1(?!\1)([^_]+?)\1(?!\1)(.+?)\1{3}'
```

### Factory Function

#### `makeExtension(**kwargs)`

Creates and returns an instance of the `LegacyEmExtension`.

```python
def makeExtension(**kwargs):
    return LegacyEmExtension(**kwargs)
```

## Usage

### Installation and Setup

```python
import markdown

# Method 1: Using the factory function
md = markdown.Markdown(extensions=['legacy_em'])

# Method 2: Direct instantiation
from markdown.extensions.legacy_em import LegacyEmExtension
md = markdown.Markdown(extensions=[LegacyEmExtension()])
```

### Example Usage

```python
import markdown

md = markdown.Markdown(extensions=['legacy_em'])

text = """
_emphasized text_
__strong text__
___strong emphasized text___
"""

html = md.convert(text)
print(html)
```

## Important Notes

### Priority and Registration
- The processor is registered with priority `50` under the name `'em_strong2'`
- This priority ensures proper integration with other inline pattern processors

### Pattern Processing Order
The patterns are processed in a specific order to handle complex nested formatting:
1. Double patterns for strong+em combinations
2. Strong-only patterns
3. Emphasis-only patterns

### Compatibility Considerations
- **Legacy Support**: This extension specifically maintains backward compatibility
- **Unicode Support**: All patterns include Unicode flags for international character support
- **Multiline Support**: DOTALL flags allow patterns to match across line breaks

## Suggestions

### When to Use
- **Legacy Document Support**: When migrating from older Markdown processors
- **Specific Formatting Requirements**: When you need precise control over underscore-based formatting
- **Backward Compatibility**: When maintaining existing documentation that relies on specific underscore behavior

### Best Practices
- Test thoroughly with your specific content to ensure expected behavior
- Consider document migration strategies if moving away from legacy formatting
- Document the use of this extension for future maintainers

### Alternatives
Consider whether standard Markdown emphasis patterns meet your needs before implementing this legacy extension, as it may produce different results than expected in standard Markdown environments.