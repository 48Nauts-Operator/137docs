<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Python-Markdown HTML Extension Documentation

## Overview

This extension implements **Markdown in HTML** parsing functionality, based on [PHP Markdown Extra](http://michelf.com/projects/php-markdown/extra/). It allows Markdown syntax to be parsed within raw HTML blocks by using special `markdown` attributes on HTML elements.

## Purpose

The extension enables the parsing of Markdown content inside HTML elements, providing three parsing modes:
- **Block-level Markdown parsing** (`markdown="1"` or `markdown="block"`)
- **Span-level Markdown parsing** (`markdown="span"`)
- **Disabled parsing** (`markdown="0"` or default behavior)

## Key Classes and Functions

### `HTMLExtractorExtra`

Extends the base `HTMLExtractor` class to handle Markdown parsing within HTML elements.

**Key Features:**
- Categorizes HTML tags into different processing groups:
  - `block_level_tags`: All block-level HTML elements
  - `span_tags`: Block-level tags that only get span-level parsing
  - `raw_tags`: Tags that never get their content parsed
  - `block_tags`: Tags that get full block-level parsing

**Important Methods:**
- `get_state(tag, attrs)`: Determines parsing state based on tag and `markdown` attribute
- `handle_starttag()`, `handle_endtag()`: Process HTML tags with Markdown parsing logic
- `parse_element_content()`: Recursively parse Markdown content within elements

```python
# Example usage in HTML
<div markdown="1">
# This will be parsed as Markdown
- List item 1
- List item 2
</div>
```

### `HtmlBlockPreprocessor`

A preprocessor that removes HTML blocks from text and stores them for later processing.

```python
def run(self, lines: list[str]) -> list[str]:
    source = '\n'.join(lines)
    parser = HTMLExtractorExtra(self.md)
    parser.feed(source)
    parser.close()
    return ''.join(parser.cleandoc).split('\n')
```

### `MarkdownInHtmlProcessor`

A block processor that handles Markdown parsing inside stored HTML blocks.

**Key Methods:**
- `parse_element_content()`: Recursively processes element content based on `markdown` attribute value
- `run()`: Processes HTML placeholders and triggers Markdown parsing

### `MarkdownInHTMLPostprocessor`

Extends `RawHtmlPostprocessor` to handle `etree.Element` objects that may still be in the HTML stash.

### `MarkdownInHtmlExtension`

Main extension class that registers all processors with the Markdown parser.

```python
def extendMarkdown(self, md):
    # Register preprocessor at priority 20
    md.preprocessors.register(HtmlBlockPreprocessor(md), 'html_block', 20)
    # Register block processor at priority 105  
    md.parser.blockprocessors.register(
        MarkdownInHtmlProcessor(md.parser), 'markdown_block', 105
    )
    # Register postprocessor at priority 30
    md.postprocessors.register(MarkdownInHTMLPostprocessor(md), 'raw_html', 30)
```

## Usage Examples

### Block-level Parsing
```html
<div markdown="1">
# Heading
This **bold text** will be parsed as Markdown.
</div>
```

### Span-level Parsing
```html
<p markdown="span">This *italic text* will be parsed, but no block elements.</p>
```

### Disabled Parsing
```html
<div markdown="0">
This *text* will **not** be parsed as Markdown.
</div>
```

## Processing Flow

1. **Preprocessing**: `HtmlBlockPreprocessor` extracts HTML blocks and stores them
2. **Block Processing**: `MarkdownInHtmlProcessor` identifies stored HTML elements and parses their content
3. **Content Parsing**: Elements are processed based on their `markdown` attribute value
4. **Post-processing**: `MarkdownInHTMLPostprocessor` handles any remaining element objects

## Notes and Considerations

### Tag Categories
- **Block tags**: Get full Markdown parsing (e.g., `<div>`, `<section>`)
- **Span tags**: Only get inline Markdown parsing (e.g., `<p>`, `<h1>-<h6>`, `<li>`)
- **Raw tags**: Never parsed (e.g., `<pre>`, `<script>`, `<style>`)

### State Inheritance
- Child elements inherit parsing restrictions from parents
- `off` state cannot be overridden by children
- `span` state limits children to span-level parsing only

### Performance Considerations
- The extension processes HTML in multiple passes
- Complex nested structures may impact performance
- Use judiciously in performance-critical applications

## Installation

```python
import markdown

md = markdown.Markdown(extensions=['md_in_html'])
# or
from markdown.extensions.md_in_html import MarkdownInHtmlExtension
md = markdown.Markdown(extensions=[MarkdownInHtmlExtension()])
```

## Compatibility

- Compatible with Python-Markdown 3.x
- Follows PHP Markdown Extra specification
- Works with other Python-Markdown extensions