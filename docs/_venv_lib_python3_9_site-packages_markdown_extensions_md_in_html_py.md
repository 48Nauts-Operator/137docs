<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python-Markdown Markdown in HTML Extension

## Overview

This extension enables parsing of Markdown syntax within raw HTML elements, based on the implementation from [PHP Markdown Extra](http://michelf.com/projects/php-markdown/extra/). It allows you to use a `markdown` attribute on HTML elements to control how their content is processed.

## Purpose

The extension solves the problem of mixing HTML and Markdown by:
- Allowing Markdown syntax to be parsed inside HTML elements when explicitly enabled
- Providing fine-grained control over parsing behavior through HTML attributes
- Maintaining compatibility with existing raw HTML processing

## Key Classes and Functions

### `HTMLExtractorExtra`

The core HTML parser that extends `HTMLExtractor` to handle Markdown-enabled HTML elements.

**Key Features:**
- Categorizes HTML tags into different processing groups:
  - `block_tags`: Block-level elements that get full Markdown parsing
  - `span_tags`: Elements that only get span-level Markdown parsing  
  - `raw_tags`: Elements whose content is never parsed as Markdown
- Manages parsing state through `mdstack`, `mdstate`, and `mdstarted` attributes
- Creates `etree.Element` objects for elements that should have Markdown parsing

**Important Methods:**
- `get_state()`: Determines parsing mode ('block', 'span', 'off', or None) based on tag and `markdown` attribute
- `handle_starttag()`, `handle_endtag()`: Process HTML tags and manage parsing state
- `handle_data()`: Process text content within HTML elements

### `HtmlBlockPreprocessor`

A preprocessor that extracts HTML blocks from the source text for later processing.

```python
def run(self, lines: list[str]) -> list[str]:
    source = '\n'.join(lines)
    parser = HTMLExtractorExtra(self.md)
    parser.feed(source)
    parser.close()
    return ''.join(parser.cleandoc).split('\n')
```

### `MarkdownInHtmlProcessor`

A block processor that handles the actual Markdown parsing within stored HTML elements.

**Key Method:**
- `parse_element_content()`: Recursively parses element content based on the `markdown` attribute value:
  - `markdown="block"`: Full block-level Markdown parsing
  - `markdown="span"`: Span-level parsing only
  - `markdown="off"` or no attribute: No Markdown parsing (content wrapped in `AtomicString`)

### `MarkdownInHTMLPostprocessor`

Extends `RawHtmlPostprocessor` to handle `etree.Element` objects that may still be in the HTML stash.

### `MarkdownInHtmlExtension`

The main extension class that registers all components with the Markdown processor.

## Usage Examples

### Basic Block-Level Parsing
```html
<div markdown="1">
# This is a header
This is a paragraph with **bold text**.
</div>
```

### Span-Level Parsing
```html
<p markdown="span">This paragraph can contain *emphasis* and **strong** text.</p>
```

### Explicit Block Mode
```html
<section markdown="block">
## Section Header
- List item 1  
- List item 2
</section>
```

## Tag Categories

### Block Tags
Elements that support full Markdown parsing when `markdown="1"` or `markdown="block"`:
- All block-level elements except those in `span_tags` and `raw_tags`

### Span Tags  
Elements that only support span-level Markdown parsing:
- `address`, `dd`, `dt`, `h1`-`h6`, `legend`, `li`, `p`, `summary`, `td`, `th`

### Raw Tags
Elements whose content is never parsed as Markdown:
- `canvas`, `math`, `option`, `pre`, `script`, `style`, `textarea`

## Implementation Notes

- **State Management**: The extension carefully tracks parsing state to handle nested HTML elements correctly
- **Element Flattening**: HTML structures are flattened during processing to ensure consistent Markdown parsing behavior
- **Stash Integration**: Uses Markdown's HTML stash system to temporarily store and process HTML elements
- **Attribute Handling**: The `markdown` attribute is removed from final output after processing

## Suggestions for Usage

1. **Use Sparingly**: Only enable Markdown parsing where necessary, as it adds processing complexity
2. **Test Nested Structures**: Be careful with deeply nested HTML containing Markdown
3. **Consider Alternatives**: For simple cases, pure Markdown or pure HTML might be clearer
4. **Validate Output**: Always verify that the generated HTML is well-formed and semantically correct

## Integration

The extension integrates with Python-Markdown by:
- Replacing the default HTML block preprocessor (priority 20)
- Adding a block processor for Markdown-enabled HTML (priority 105)  
- Replacing the raw HTML postprocessor (priority 30)

To use this extension:

```python
import markdown
md = markdown.Markdown(extensions=['markdown_in_html'])
result = md.convert(your_markdown_text)
```