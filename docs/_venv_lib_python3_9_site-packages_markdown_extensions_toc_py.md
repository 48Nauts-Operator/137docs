<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Table of Contents Extension for Python-Markdown

## Overview

This extension adds Table of Contents (TOC) support to Python-Markdown. It automatically generates a hierarchical table of contents based on header elements (h1-h6) found in the document and provides various customization options for styling and behavior.

## Purpose

The TOC extension serves to:
- Automatically generate table of contents from document headers
- Create anchor links and permalinks for headers
- Provide customizable TOC styling and positioning
- Support Unicode slugification for URL-friendly anchors
- Handle nested header structures properly

## Key Components

### Main Classes

#### `TocExtension`
The main extension class that integrates with Python-Markdown.

**Configuration Options:**
- `marker`: Text to replace with TOC (default: `[TOC]`)
- `title`: Title for the TOC div
- `anchorlink`: Enable header self-links
- `permalink`: Add Sphinx-style permalinks
- `baselevel`: Base level for headers
- `toc_depth`: Range of header levels to include
- `slugify`: Function for generating URL-friendly anchors

#### `TocTreeprocessor`
The core processor that traverses the document tree and builds the TOC.

**Key Methods:**
- `run()`: Main processing method that scans headers and builds TOC
- `build_toc_div()`: Creates the HTML structure for the TOC
- `add_anchor()`: Adds anchor links to headers
- `add_permalink()`: Adds permalink elements to headers

### Utility Functions

#### Text Processing
```python
def slugify(value: str, separator: str, unicode: bool = False) -> str
```
Converts text to URL-friendly slugs by removing special characters and normalizing whitespace.

#### HTML Processing
```python
def strip_tags(text: str) -> str
def render_inner_html(el: etree.Element, md: Markdown) -> str
def remove_fnrefs(root: etree.Element) -> etree.Element
```
Functions for processing HTML content, removing tags, and handling footnote references.

#### TOC Structure
```python
def nest_toc_tokens(toc_list) -> list
def unique(id: str, ids: MutableSet[str]) -> str
```
Utilities for creating proper nested TOC structure and ensuring unique IDs.

## Usage Example

```python
import markdown

# Basic usage
md = markdown.Markdown(extensions=['toc'])
html = md.convert("""
# Header 1
## Header 2
### Header 3

[TOC]

Content here...
""")

# With custom configuration
md = markdown.Markdown(extensions=[
    'toc'
], extension_configs={
    'toc': {
        'title': 'Table of Contents',
        'anchorlink': True,
        'permalink': True,
        'toc_depth': '2-4'
    }
})
```

## Important Features

### Header Processing
- Automatically assigns unique IDs to headers
- Supports custom `data-toc-label` attribute for TOC display names
- Handles nested header levels properly
- Removes footnote references from TOC entries

### Customization Options
- **Anchor Links**: Make headers clickable self-links
- **Permalinks**: Add permanent link symbols (Â¶) to headers
- **TOC Depth**: Control which header levels appear in TOC
- **CSS Classes**: Customize styling with configurable CSS classes
- **Unicode Support**: Preserve Unicode characters in slugs

### TOC Placement
The TOC can be placed by:
1. Using the marker text (default: `[TOC]`)
2. Accessing `md.toc` after conversion for manual placement
3. Using `md.toc_tokens` for custom TOC rendering

## Notes and Suggestions

### Best Practices
- Use semantic header hierarchy (don't skip levels)
- Provide meaningful header text for better TOC readability
- Consider TOC placement in document flow
- Test with Unicode content if international support is needed

### Potential Issues
- **Nested TOCs**: The extension prevents infinite loops by not allowing markers inside headers
- **ID Conflicts**: Automatically handles duplicate IDs by appending numbers
- **HTML in Headers**: Complex HTML in headers is stripped for TOC display

### Performance Considerations
- The extension processes the entire document tree
- Large documents with many headers may see processing overhead
- Consider limiting TOC depth for very long documents

### Deprecation Warnings
Some functions are marked as deprecated:
- `get_name()` - Use `render_inner_html` and `striptags` instead
- `stashedHTML2text()` - Use newer HTML processing functions

## Dependencies

- `xml.etree.ElementTree` for XML/HTML tree processing
- `unicodedata` for Unicode normalization
- `re` for regular expression operations
- `html` for HTML entity handling

The extension integrates seamlessly with Python-Markdown's processing pipeline and follows the established extension patterns.