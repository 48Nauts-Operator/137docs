<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Table of Contents Extension for Python-Markdown

## Overview

This is a Python-Markdown extension that automatically generates a Table of Contents (TOC) for Markdown documents. The extension processes heading elements (`<h1>` through `<h6>`) in the document and creates a hierarchical table of contents with automatic anchor links and permalinks.

## Purpose

- **Automatic TOC Generation**: Scans the document for headers and builds a nested table of contents
- **Anchor Link Support**: Adds clickable links to headers for easy navigation
- **Permalink Generation**: Creates permanent links to sections (Sphinx-style)
- **Customizable Styling**: Configurable CSS classes and structure
- **URL-Friendly Slugs**: Generates clean, URL-safe anchor IDs from header text

## Key Components

### Main Classes

#### `TocExtension`
The main extension class that integrates with Python-Markdown.

**Key Configuration Options:**
- `marker`: Text to replace with TOC (default: `[TOC]`)
- `title`: Title for the TOC section
- `toc_class`: CSS class for TOC container
- `anchorlink`: Enable header self-links
- `permalink`: Add Sphinx-style permalinks
- `baselevel`: Base header level adjustment
- `toc_depth`: Range of header levels to include

#### `TocTreeprocessor`
The core processor that builds the table of contents by traversing the document tree.

**Key Methods:**
- `run()`: Main processing method that scans headers and builds TOC
- `build_toc_div()`: Creates the HTML structure for the TOC
- `add_anchor()`: Adds anchor links to headers
- `add_permalink()`: Adds permalink elements to headers

### Utility Functions

#### Text Processing
```python
def slugify(value: str, separator: str, unicode: bool = False) -> str
```
- Converts header text to URL-friendly slugs
- Handles Unicode characters when specified
- Removes special characters and normalizes spacing

#### HTML Processing
```python
def render_inner_html(el: etree.Element, md: Markdown) -> str
```
- Renders the inner HTML content of elements
- Processes Markdown postprocessors
- Handles escaped content properly

```python
def strip_tags(text: str) -> str
```
- Removes HTML tags while preserving text content
- Handles HTML comments and nested tags
- Collapses whitespace

#### ID Management
```python
def unique(id: str, ids: MutableSet[str]) -> str
```
- Ensures unique anchor IDs by appending numbers (`_1`, `_2`, etc.)
- Prevents duplicate IDs in the document

#### TOC Structure
```python
def nest_toc_tokens(toc_list)
```
- Converts flat list of headers into nested hierarchical structure
- Handles malformed header sequences gracefully
- Creates parent-child relationships based on header levels

## Usage Examples

### Basic Usage
```markdown
# Document Title

[TOC]

## Section 1
Content here...

### Subsection 1.1
More content...

## Section 2
More content...
```

### With Custom Configuration
```python
import markdown

md = markdown.Markdown(extensions=[
    'toc'
], extension_configs={
    'toc': {
        'title': 'Table of Contents',
        'anchorlink': True,
        'permalink': True,
        'baselevel': 2,
        'toc_depth': '2-4'
    }
})
```

## Important Features

### Footnote Handling
- Automatically removes footnote references from TOC entries
- Uses `remove_fnrefs()` to clean header content for TOC display

### Data Attributes
- Supports `data-toc-label` attribute for custom TOC text
- Allows different display text in TOC vs. actual header

### Flexible Depth Control
- Single number: Include headers from H1 to specified level
- Range format (`2-5`): Include only headers within specified range

### Anchor Link Options
- **Anchor Links**: Make entire header clickable
- **Permalinks**: Add separate permalink symbols (Â¶) to headers
- **Leading/Trailing**: Control permalink placement

## Notes and Suggestions

### Performance Considerations
- The extension processes the entire document tree multiple times
- Large documents with many headers may see some processing overhead

### Styling Recommendations
```css
.toc {
    border: 1px solid #ccc;
    padding: 10px;
    margin: 10px 0;
    background-color: #f9f9f9;
}

.toc ul {
    list-style-type: none;
    padding-left: 20px;
}

.headerlink {
    color: #ccc;
    text-decoration: none;
    margin-left: 5px;
}
```

### Best Practices
- Use consistent header hierarchy (don't skip levels)
- Keep header text concise for better TOC appearance
- Test with different `toc_depth` settings for optimal results
- Consider using `data-toc-label` for long headers

### Compatibility Notes
- Some functions are marked as deprecated (use newer alternatives)
- Works with Python-Markdown's tree processor system
- Compatible with other Markdown extensions

The extension provides a robust solution for automatic table of contents generation with extensive customization options for different use cases and styling requirements.