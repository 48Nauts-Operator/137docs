<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTML Parser Module Documentation

## Overview

This module provides a heavily modified version of Python's `html.parser.HTMLParser` specifically designed for Markdown processing. It imports a copy of the standard HTML parser library and applies extensive monkey-patches to customize its behavior for the Python-Markdown project.

## Purpose

The module serves as a critical component of the Python-Markdown library, responsible for:
- Extracting raw HTML from Markdown text
- Properly handling HTML blocks within Markdown content
- Maintaining compatibility with Markdown syntax rules
- Storing HTML content in a structured way for later processing

## Key Features

### Library Monkey-Patching

The module applies several monkey-patches to customize HTML parsing behavior:

```python
# Only accept '?>' to close Processing Instructions
htmlparser.piclose = re.compile(r'\?>')

# Only recognize entity references with closing semicolons
htmlparser.entityref = re.compile(r'&([a-zA-Z][-.a-zA-Z0-9]*);')

# Remove support for partial entities
htmlparser.incomplete = htmlparser.entityref

# Prevent backticks in tag names, attributes, or bare values
htmlparser.locatestarttagend_tolerant = re.compile(r"""...""", re.VERBOSE)
```

### Utility Patterns

- **`blank_line_re`**: Matches blank lines at the start of text blocks (two newlines with optional preceding whitespace)

## Main Class: HTMLExtractor

### Class Overview

```python
class HTMLExtractor(htmlparser.HTMLParser):
```

The `HTMLExtractor` class extends the modified HTML parser to extract raw HTML from Markdown text while preserving the document structure.

### Key Attributes

- **`empty_tags`**: Set of self-closing HTML tags (default: `{'hr'}`)
- **`inraw`**: Boolean flag indicating if currently inside a raw HTML block
- **`intail`**: Boolean flag for handling content after HTML blocks
- **`stack`**: List tracking nested HTML tags when in raw mode
- **`cleandoc`**: List storing processed text segments
- **`_cache`**: Temporary storage for HTML content being processed

### Important Methods

#### Initialization and Control

- **`__init__(md, *args, **kwargs)`**: Initializes the extractor with a Markdown instance
- **`reset()`**: Resets the parser state, clearing all buffers and flags
- **`close()`**: Handles any remaining buffered data and unclosed tags

#### Position and Line Tracking

- **`line_offset`** (property): Returns character index for the start of the current line
- **`at_line_start()`**: Checks if current position is at the start of a line (allows up to 3 leading spaces)

#### HTML Tag Handling

- **`handle_starttag(tag, attrs)`**: Processes opening HTML tags
- **`handle_endtag(tag)`**: Processes closing HTML tags  
- **`handle_startendtag(tag, attrs)`**: Processes self-closing tags
- **`handle_empty_tag(data, is_block)`**: Generic handler for empty/standalone tags

#### Content Handling

- **`handle_data(data)`**: Processes text content between HTML tags
- **`handle_charref(name)`**: Handles character references (e.g., `&#123;`)
- **`handle_entityref(name)`**: Handles entity references (e.g., `&amp;`)
- **`handle_comment(data)`**: Processes HTML comments
- **`handle_decl(data)`**: Processes HTML declarations
- **`handle_pi(data)`**: Processes XML processing instructions

#### Specialized Parsing

- **`parse_pi(i)`**: Custom processing instruction parser
- **`parse_html_declaration(i)`**: Custom HTML declaration parser
- **`parse_bogus_comment(i, report=0)`**: Handles malformed comments
- **`parse_starttag(i)`**: Enhanced start tag parser with improved CDATA handling

## Usage Notes

### Integration with Markdown

The extractor works closely with the main Markdown processor:
- Uses `md.htmlStash` to store extracted HTML content
- Relies on `md.is_block_level(tag)` to determine block-level elements
- Maintains proper spacing and line breaks for Markdown compatibility

### Raw HTML Block Detection

The parser identifies raw HTML blocks based on:
- Block-level tags at the start of lines
- Proper nesting of opening and closing tags
- Blank line patterns around HTML content

### State Management

The parser maintains several states:
- **Normal mode**: Regular text processing
- **Raw mode** (`inraw=True`): Inside an HTML block
- **Tail mode** (`intail=True`): Processing content after an HTML block

## Important Considerations

### Compatibility Notes

- The module includes a workaround for Python bug #41989
- Character reference conversion is disabled by default (`convert_charrefs=False`)
- The parser handles CDATA content elements specially for code spans

### Performance Considerations

- Uses caching for line position calculations
- Maintains separate buffers for different content types
- Processes content in chunks to handle large documents efficiently

## Suggestions for Usage

1. **Always use with Markdown instance**: The extractor requires a Markdown processor instance to function properly
2. **Handle edge cases**: Be aware of the special handling for processing instructions and declarations
3. **Monitor state flags**: The `inraw` and `intail` flags are crucial for understanding parser behavior
4. **Test with complex HTML**: The parser handles nested tags and mixed content scenarios

This module is essential for proper Markdown-to-HTML conversion and should be used as part of the larger Python-Markdown ecosystem rather than as a standalone component.