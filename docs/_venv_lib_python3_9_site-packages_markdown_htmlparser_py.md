<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTML Parser Module Documentation

## Overview

This module provides a custom HTML parser implementation for the Python Markdown library. It imports and heavily modifies Python's built-in `html.parser.HTMLParser` through monkey-patching to handle Markdown-specific HTML processing requirements.

## Purpose

The module serves two main purposes:

1. **HTML Extraction**: Separates raw HTML content from Markdown text during processing
2. **Custom HTML Parsing**: Provides specialized HTML parsing behavior tailored for Markdown processing while preserving the original `html.parser` functionality for other users

## Key Components

### Module-Level Modifications

The module applies several monkey-patches to the imported HTML parser:

```python
# Processing Instructions - only accept "?>" to close
htmlparser.piclose = re.compile(r'\?>')

# Entity References - require closing semicolon
htmlparser.entityref = re.compile(r'&([a-zA-Z][-.a-zA-Z0-9]*);')

# Tag Name Restrictions - prevent backticks in tag names, attributes, and values
htmlparser.locatestarttagend_tolerant = re.compile(r"""...""", re.VERBOSE)
```

### HTMLExtractor Class

The main class that extends the monkey-patched HTMLParser:

```python
class HTMLExtractor(htmlparser.HTMLParser):
```

#### Key Properties

- **`inraw`**: Boolean flag indicating if currently parsing raw HTML block
- **`intail`**: Boolean flag for content following a raw block
- **`stack`**: List of currently open HTML tags
- **`cleandoc`**: List of processed text strings
- **`empty_tags`**: Set of self-closing tags (e.g., `<hr>`)

#### Important Methods

##### `reset()`
Resets the parser instance and clears all internal state:
- Clears raw parsing flags
- Empties tag stack and cache
- Resets clean document list

##### `at_line_start()`
Determines if the current parsing position is at the start of a line:
- Allows up to 3 spaces of indentation
- Critical for identifying block-level HTML elements

##### `handle_starttag(tag, attrs)`
Processes HTML opening tags:
- Detects block-level elements at line start
- Manages the raw HTML parsing state
- Handles self-closing tags appropriately

##### `handle_endtag(tag)`
Processes HTML closing tags:
- Maintains tag stack for proper nesting
- Determines when raw HTML blocks end
- Preserves blank lines after HTML blocks

##### `handle_data(data)`
Processes text content:
- Routes content to appropriate storage (raw cache vs clean document)
- Manages transition states between raw and regular content

##### `handle_empty_tag(data, is_block)`
Handles various empty/standalone HTML elements:
- Comments, declarations, processing instructions
- Character and entity references
- Determines block vs inline treatment

## Usage Notes

### Integration with Markdown

The parser works closely with the main Markdown processor:

- Stores raw HTML in `md.htmlStash` for later processing
- Uses `md.is_block_level(tag)` to determine block-level elements
- Builds clean document as list of strings in `cleandoc`

### State Management

The parser maintains several important states:

- **Normal parsing**: Regular Markdown text processing
- **Raw block parsing**: Inside block-level HTML elements
- **Tail parsing**: Content immediately following raw HTML blocks

### Line Position Tracking

The parser includes sophisticated line position tracking:

```python
@property
def line_offset(self) -> int:
    """Returns char index for start of current line"""
```

This enables accurate determination of line starts, which is crucial for identifying block-level HTML.

## Technical Considerations

### Performance Notes

- Uses caching for line start positions to avoid repeated string searches
- Maintains separate cache for raw HTML content to minimize string concatenation

### Compatibility

- Includes workaround for Python bug #41989 in the `close()` method
- Preserves original `html.parser` functionality by importing a separate copy

### Error Handling

- Gracefully handles malformed HTML
- Provides fallback behavior when tag extraction fails
- Includes pragma comments to exclude certain edge cases from coverage

## Suggestions for Usage

1. **Extension Development**: When extending this parser, be aware of the state management complexity
2. **Testing**: Pay special attention to edge cases involving nested HTML and line boundaries  
3. **Performance**: Consider the line offset caching mechanism when modifying position-related methods
4. **Compatibility**: Test thoroughly with different HTML structures, especially self-closing and nested tags

## Dependencies

- `re`: Regular expression operations
- `importlib.util`: Dynamic module importing
- `sys`: System-specific parameters
- `typing`: Type hints (TYPE_CHECKING mode only)
- `markdown.Markdown`: Main Markdown processor class