<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python Markdown - Inline Patterns Module

## Overview

This module implements inline pattern processing for the Python Markdown library. It handles the conversion of inline Markdown syntax (like emphasis, links, images, code spans, etc.) into HTML elements during the parsing process.

## Purpose

The module provides two main approaches for processing inline patterns:

1. **Legacy Pattern class** - The original approach (maintained for backward compatibility)
2. **Modern InlineProcessor class** - A newer, more efficient and flexible approach

## Key Components

### Main Functions

#### `build_inlinepatterns(md: Markdown, **kwargs: Any) -> util.Registry[InlineProcessor]`

Builds the default set of inline patterns for Markdown processing. The function registers patterns in a specific order of precedence:

- **Priority 190-180**: Backticks and escaped characters (highest priority)
- **Priority 170-120**: Various link types (references, images, autolinks)
- **Priority 110-80**: Line breaks, HTML, and entities
- **Priority 70-50**: Text formatting (emphasis, strong) (lowest priority)

```python
# Example of pattern registration
inlinePatterns.register(BacktickInlineProcessor(BACKTICK_RE), 'backtick', 190)
inlinePatterns.register(EscapeInlineProcessor(ESCAPE_RE, md), 'escape', 180)
```

### Base Classes

#### `Pattern` (Legacy - Deprecated)

The original base class for inline patterns. 

**Key characteristics:**
- Requires patterns to match entire blocks
- Automatically wraps patterns with `^(.*)` and `(.*)$`
- Less efficient than newer `InlineProcessor`

**Important methods:**
- `handleMatch(m: re.Match[str]) -> etree.Element | str`
- `getCompiledRegExp() -> re.Pattern`

#### `InlineProcessor` (Recommended)

The modern base class providing enhanced functionality.

**Key improvements over Pattern:**
- More efficient - doesn't need to match entire blocks
- Flexible boundary control
- Better handling of complex constructs

**Important methods:**
- `handleMatch(m: re.Match[str], data: str) -> tuple[etree.Element | str | None, int | None, int | None]`

### Processor Classes

#### Text and Basic Processing

- **`SimpleTextInlineProcessor`** - Returns simple text content
- **`EscapeInlineProcessor`** - Handles backslash-escaped characters
- **`BacktickInlineProcessor`** - Processes code spans (`` `code` ``)

#### HTML Processing

- **`HtmlInlineProcessor`** - Stores raw HTML and returns placeholders
- **`SubstituteTagInlineProcessor`** - Creates empty HTML elements

#### Link Processing

- **`LinkInlineProcessor`** - Processes inline links `[text](url)`
- **`ImageInlineProcessor`** - Processes inline images `![alt](src)`
- **`ReferenceInlineProcessor`** - Handles reference links `[text][ref]`
- **`AutolinkInlineProcessor`** - Processes automatic links `<http://example.com>`
- **`AutomailInlineProcessor`** - Processes email links `<email@example.com>`

#### Emphasis Processing

- **`AsteriskProcessor`** - Handles emphasis with asterisks (`*em*`, `**strong**`)
- **`UnderscoreProcessor`** - Handles emphasis with underscores (`_em_`, `__strong__`)

## Regular Expression Patterns

The module defines numerous regex patterns for matching Markdown syntax:

```python
BACKTICK_RE = r'(?:(?<!\\)((?:\\{2})+)(?=`+)|(?<!\\)(`+)(.+?)(?<!`)\2(?!`))'
ESCAPE_RE = r'\\(.)'
LINK_RE = NOIMG + r'\['  # Matches start of links (not images)
IMAGE_LINK_RE = r'\!\['  # Matches start of image links
```

## Usage Examples

### Creating a Custom Processor

```python
class CustomInlineProcessor(InlineProcessor):
    def handleMatch(self, m, data):
        # Process the match and return element, start, end
        el = etree.Element('span')
        el.text = m.group(1)
        return el, m.start(0), m.end(0)

# Register the processor
md.inlinePatterns.register(CustomInlineProcessor(r'custom_pattern'), 'custom', 75)
```

## Important Notes

### Migration Recommendations

- **Use `InlineProcessor`** instead of the legacy `Pattern` class for new development
- The newer processor provides better performance and flexibility
- Legacy patterns are still supported but discouraged

### Processing Order

The order of pattern processing is crucial:

1. Escape sequences and code spans (prevent other processing)
2. Links and images 
3. HTML tags and entities
4. Text formatting (emphasis, strong)

### Performance Considerations

- `InlineProcessor` is more efficient as it doesn't require full block matching
- Pattern order affects performance - more common patterns should have higher priority
- Complex patterns like emphasis processing use sophisticated algorithms to handle nested cases

### Extension Development

When creating extensions:
- Inherit from `InlineProcessor` for new processors
- Choose appropriate priority values to ensure correct processing order
- Handle the `ANCESTOR_EXCLUDES` attribute to prevent processing in unwanted contexts
- Return `None` boundaries if no valid match is found

This module forms a critical part of the Markdown parsing pipeline, converting inline syntax into structured HTML elements while maintaining proper precedence and handling edge cases.