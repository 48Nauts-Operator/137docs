<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Postprocessors Module Documentation

## Overview

This module contains the postprocessor components for the Python Markdown library. Postprocessors are the final stage in the Markdown processing pipeline, running on the complete HTML document after it has been serialized into a string. They are primarily used to:

- Restore content that was temporarily extracted during preprocessing
- Fix output encodings
- Wrap or modify the entire document
- Perform final cleanup operations

## Key Components

### `build_postprocessors(md: Markdown, **kwargs: Any) -> util.Registry[Postprocessor]`

**Purpose:** Factory function that creates and registers the default postprocessors for a Markdown instance.

**Returns:** A `Registry` containing the default postprocessors with their priorities:
- `RawHtmlPostprocessor` (priority: 30)
- `AndSubstitutePostprocessor` (priority: 20)

### Base Class

#### `Postprocessor`

**Purpose:** Abstract base class for all postprocessors.

**Key Methods:**
- `run(text: str) -> str`: Must be implemented by subclasses to process the HTML text

**Usage:**
```python
class CustomPostprocessor(Postprocessor):
    def run(self, text: str) -> str:
        # Modify text as needed
        return modified_text
```

## Default Postprocessors

### `RawHtmlPostprocessor`

**Purpose:** Restores raw HTML that was temporarily stored in the HTML stash during processing.

**Key Features:**
- Processes HTML placeholders and replaces them with actual HTML content
- Determines if HTML blocks are block-level or inline elements
- Wraps inline HTML in `<p>` tags when appropriate

**Key Methods:**
- `run(text: str) -> str`: Main processing method that restores stashed HTML
- `isblocklevel(html: str) -> bool`: Determines if HTML content is block-level
- `stash_to_string(text: str) -> str`: Converts stashed objects to strings

**Implementation Details:**
- Uses regex pattern matching to find HTML placeholders
- Handles both wrapped (`<p>placeholder</p>`) and unwrapped placeholders
- Recursively processes nested placeholders

### `AndSubstitutePostprocessor`

**Purpose:** Restores valid ampersand (`&`) entities that were temporarily substituted during processing.

**Key Methods:**
- `run(text: str) -> str`: Replaces `AMP_SUBSTITUTE` tokens with actual `&` characters

**Usage Example:**
```python
# Before: "AT&amp;T" might be stored as "AT{AMP_SUBSTITUTE}T"
# After: Restored to "AT&T"
```

### `UnescapePostprocessor` ⚠️ **Deprecated**

**Status:** This class is deprecated and will be removed in future versions.

**Replacement:** Use `UnescapeTreeprocessor` instead.

**Purpose:** Restores escaped characters using STX/ETX markers.

## Usage Notes

### Processing Order

Postprocessors run in order of their registered priority (higher numbers first):
1. `RawHtmlPostprocessor` (priority: 30)
2. `AndSubstitutePostprocessor` (priority: 20)

### Creating Custom Postprocessors

```python
class MyCustomPostprocessor(Postprocessor):
    def run(self, text: str) -> str:
        # Your custom processing logic here
        return text.replace("old", "new")

# Register with custom priority
md.postprocessors.register(MyCustomPostprocessor(), 'my_custom', 25)
```

### Important Considerations

- **Performance:** Postprocessors operate on the entire document string, so be mindful of performance with large documents
- **Order Dependency:** Some postprocessors may depend on others running first or last
- **HTML Safety:** When modifying HTML content, ensure you maintain valid HTML structure
- **Encoding:** Be careful with character encoding when processing text

## Dependencies

- `re`: Regular expression operations
- `util`: Internal utility functions and classes
- `typing`: Type hints for better code documentation

## Best Practices

1. **Inherit from Postprocessor:** Always extend the base `Postprocessor` class
2. **Handle Edge Cases:** Consider empty strings, malformed HTML, and special characters
3. **Test Thoroughly:** Postprocessors affect the final output, so comprehensive testing is crucial
4. **Document Dependencies:** If your postprocessor depends on specific preprocessors or other components, document this clearly