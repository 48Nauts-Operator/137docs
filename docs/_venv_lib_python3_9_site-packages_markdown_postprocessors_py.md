<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python Markdown - Postprocessors Module

## Overview

This module contains the postprocessors for the Python Markdown library. Postprocessors are the final stage in the Markdown to HTML conversion pipeline, running on the complete HTML document after it has been serialized into a string. They perform final text manipulations just before output, such as restoring extracted HTML sections, fixing encodings, or wrapping the entire document.

## Purpose

Postprocessors serve several key functions:
- **Restore extracted content**: Add back HTML sections that were temporarily removed during preprocessing
- **Final text cleanup**: Fix character encodings and entity references
- **Document wrapping**: Apply final formatting to the complete document
- **Post-serialization fixes**: Handle any issues that arise after the document tree is converted to text

## Key Components

### Factory Function

#### `build_postprocessors(md: Markdown, **kwargs: Any) -> util.Registry[Postprocessor]`

Creates and registers the default postprocessors used by the Markdown parser.

**Default processors registered:**
- `RawHtmlPostprocessor` (priority: 30)
- `AndSubstitutePostprocessor` (priority: 20)

### Base Class

#### `Postprocessor`

The abstract base class that all postprocessors must extend.

**Key method:**
- `run(text: str) -> str`: Must be implemented by subclasses to process the HTML text

```python
class CustomPostprocessor(Postprocessor):
    def run(self, text: str) -> str:
        # Modify text as needed
        return modified_text
```

### Core Postprocessors

#### `RawHtmlPostprocessor`

Restores raw HTML content that was temporarily stored in the HTML stash during preprocessing.

**Key features:**
- Iterates through the HTML stash to restore preserved HTML
- Determines if HTML blocks are block-level or inline
- Wraps inline HTML in `<p>` tags when appropriate
- Handles nested placeholders recursively

**Important methods:**
- `run(text: str) -> str`: Main processing method
- `isblocklevel(html: str) -> bool`: Determines if HTML is block-level
- `stash_to_string(text: str) -> str`: Converts stashed objects to strings

#### `AndSubstitutePostprocessor`

Restores valid ampersand entities by converting temporary substitutes back to proper `&` characters.

**Functionality:**
- Replaces `util.AMP_SUBSTITUTE` placeholders with actual `&` characters
- Ensures proper HTML entity encoding in the final output

#### `UnescapePostprocessor` (Deprecated)

⚠️ **Deprecated**: This class will be removed in future versions. Use `UnescapeTreeprocessor` instead.

Restores escaped characters using STX/ETX delimiters.

## Usage Examples

### Creating a Custom Postprocessor

```python
from markdown.postprocessors import Postprocessor

class WrapperPostprocessor(Postprocessor):
    def run(self, text: str) -> str:
        return f'<div class="markdown-content">{text}</div>'

# Register with markdown instance
md.postprocessors.register(WrapperPostprocessor(), 'wrapper', 10)
```

### Integration with Markdown

```python
import markdown

# Postprocessors are automatically applied during conversion
md = markdown.Markdown()
html = md.convert("# Hello World")
# Postprocessors run after this conversion
```

## Important Notes

### Processing Order
- Postprocessors run in **priority order** (higher numbers first)
- Default priorities: `RawHtmlPostprocessor` (30) → `AndSubstitutePostprocessor` (20)

### HTML Stash Integration
- Works closely with the HTML stash system to restore preserved content
- Handles both block-level and inline HTML appropriately

### Performance Considerations
- Postprocessors operate on the complete document string
- Keep processing efficient as this is the final stage before output

## Dependencies

- `util` module for Registry and utility functions
- `re` module for regular expression operations
- Type hints from `typing` module

## See Also

- [Python Markdown Documentation](https://python-markdown.github.io/)
- [Preprocessors](./preprocessors.md) - Earlier stage text processing
- [Treeprocessors](./treeprocessors.md) - Document tree processing