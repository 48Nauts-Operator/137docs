<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Python Markdown Preprocessors Module

## Overview

This module contains preprocessor classes for the Python Markdown library. Preprocessors are the first stage in the Markdown processing pipeline, working on the raw source text before it gets parsed into individual Markdown elements.

**Purpose**: Clean up and normalize text input, extract problematic content (like HTML blocks), and prepare the text for subsequent parsing stages.

## Key Components

### Functions

#### `build_preprocessors(md: Markdown, **kwargs: Any) -> util.Registry[Preprocessor]`

Builds and returns the default set of preprocessors used by Markdown processing.

**Default preprocessors registered:**
- `NormalizeWhitespace` (priority: 30)
- `HtmlBlockPreprocessor` (priority: 20)

**Returns**: A registry containing the configured preprocessors in execution order.

### Classes

#### `Preprocessor` (Base Class)

Abstract base class for all preprocessors.

**Key Method:**
```python
def run(self, lines: list[str]) -> list[str]:
    """
    Process document lines and return modified list.
    Must be implemented by subclasses.
    """
```

**Usage**: All custom preprocessors must inherit from this class and implement the `run` method.

#### `NormalizeWhitespace`

Normalizes whitespace throughout the document for consistent parsing.

**Operations performed:**
- Removes special control characters (STX, ETX)
- Normalizes line endings (`\r\n` and `\r` â†’ `\n`)
- Expands tabs to spaces based on configured tab length
- Removes trailing spaces from empty lines
- Ensures document ends with double newline

**Example transformation:**
```python
# Input with mixed line endings and tabs
"Line 1\r\nLine 2\r\n\tIndented\r\n"

# Output with normalized whitespace  
"Line 1\nLine 2\n    Indented\n\n"
```

#### `HtmlBlockPreprocessor`

Extracts and temporarily removes HTML blocks from the document to prevent interference with Markdown parsing.

**Process:**
1. Identifies HTML block elements in the source
2. Stores raw HTML in the Markdown instance's `htmlStash`
3. Replaces HTML blocks with placeholder text
4. Returns cleaned document for further processing

**Benefits:**
- Prevents HTML from being incorrectly processed as Markdown
- Preserves original HTML formatting
- HTML gets reinserted later in the pipeline

## Architecture Notes

### Processing Pipeline Order

1. **NormalizeWhitespace** (priority 30) - Runs first to clean up text
2. **HtmlBlockPreprocessor** (priority 20) - Runs second to extract HTML

Higher priority numbers execute first.

### Design Patterns

- **Registry Pattern**: Uses `util.Registry` for managing preprocessor order and configuration
- **Template Method**: Base `Preprocessor` class defines interface, subclasses implement specific logic
- **Pipeline Pattern**: Each preprocessor transforms the input and passes it to the next stage

## Usage Examples

### Creating Custom Preprocessors

```python
class CustomPreprocessor(Preprocessor):
    """Remove all exclamation marks from text."""
    
    def run(self, lines: list[str]) -> list[str]:
        source = '\n'.join(lines)
        cleaned = source.replace('!', '')
        return cleaned.split('\n')

# Register custom preprocessor
preprocessors = build_preprocessors(md)
preprocessors.register(CustomPreprocessor(md), 'custom', 25)
```

## Dependencies

- `util` module: Provides `Registry` and `Processor` base classes
- `htmlparser.HTMLExtractor`: Handles HTML parsing and extraction
- `re` module: Regular expression support for text processing

## Notes and Considerations

- Preprocessors modify the entire document before any Markdown parsing begins
- Order matters: whitespace normalization should typically happen before other text processing
- HTML extraction prevents conflicts between HTML and Markdown syntax
- Custom preprocessors should be carefully tested to avoid breaking subsequent parsing stages