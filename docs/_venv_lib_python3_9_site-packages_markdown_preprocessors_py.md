<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python Markdown Preprocessors Module

## Overview

This module is part of the Python Markdown library, which provides a Python implementation of John Gruber's Markdown specification. The preprocessors module handles the initial processing of source text before it gets parsed into individual Markdown elements.

## Purpose

Preprocessors work on the raw source text before it is broken down into its individual parts. This stage is ideal for:
- Cleaning up problematic characters
- Normalizing text formatting
- Extracting HTML blocks that might interfere with Markdown parsing
- Preparing the text for consistent parsing

## Key Functions

### `build_preprocessors(md: Markdown, **kwargs: Any) -> util.Registry[Preprocessor]`

Creates and returns the default set of preprocessors used by the Markdown parser.

**Default preprocessors registered:**
- `NormalizeWhitespace` (priority: 30)
- `HtmlBlockPreprocessor` (priority: 20)

**Parameters:**
- `md`: The Markdown instance
- `**kwargs`: Additional keyword arguments

**Returns:** A registry containing the default preprocessors

## Core Classes

### `Preprocessor` (Base Class)

The abstract base class that all preprocessors must extend.

**Key Method:**
- `run(lines: list[str]) -> list[str]`: Must be overridden by subclasses to process the document lines

### `NormalizeWhitespace`

Normalizes whitespace in the source text for consistent parsing.

**Processing steps:**
1. Joins all lines into a single source string
2. Removes special STX and ETX characters
3. Normalizes line endings (`\r\n` and `\r` â†’ `\n`)
4. Expands tabs based on the configured tab length
5. Removes trailing spaces from empty lines
6. Splits back into individual lines

**Purpose:** Ensures consistent whitespace handling across different platforms and input sources.

### `HtmlBlockPreprocessor`

Extracts and temporarily removes HTML blocks from the text to prevent interference with Markdown parsing.

**Process:**
1. Uses `HTMLExtractor` to identify HTML blocks
2. Stores raw HTML in the Markdown instance's `htmlStash`
3. Returns cleaned document with HTML blocks removed

**Purpose:** Prevents HTML blocks from being processed as Markdown, preserving them for later reinsertion.

## Usage Notes

- Preprocessors run in order of priority (higher numbers run first)
- Each preprocessor receives a list of lines and returns a modified list of lines
- The processing is sequential - output from one preprocessor becomes input for the next
- HTML extraction happens after whitespace normalization to ensure clean processing

## Integration

This module integrates with:
- `markdown.util`: For registry management and special characters
- `markdown.htmlparser.HTMLExtractor`: For HTML block extraction
- Main `Markdown` class: For configuration and HTML stashing

## Development Notes

- All preprocessors should extend the `Preprocessor` base class
- Custom preprocessors can be added to the registry with appropriate priorities
- The module uses type hints and supports Python 3.7+
- HTML processing relies on the `htmlStash` mechanism for temporary storage