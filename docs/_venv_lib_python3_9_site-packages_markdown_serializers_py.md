<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# ElementTree HTML/XHTML Serialization Module

## Overview

This module extends Python's `ElementTree` functionality by providing HTML and XHTML serialization capabilities. It allows you to convert `ElementTree.Element` objects into properly formatted HTML5 or XHTML strings with appropriate escaping and formatting rules.

## Purpose

The module addresses the need to serialize XML/HTML document trees into string format while handling:
- Proper character escaping for HTML/XHTML output
- Different formatting rules between HTML5 and XHTML
- Boolean attributes handling
- Self-closing tags formatting
- Namespace support

## Key Differences Between HTML and XHTML Output

| Feature | HTML5 | XHTML |
|---------|-------|-------|
| Empty tags | `<tag>` | `<tag />` |
| Boolean attributes | `checked` | `checked="checked"` |
| Self-closing tags | Not self-closed | Self-closed with `/>` |

## Public Functions

### `to_html_string(element: Element) -> str`

Serializes an ElementTree Element and its children to an HTML5 string.

**Parameters:**
- `element`: An `xml.etree.ElementTree.Element` object to serialize

**Returns:**
- A string containing the HTML5 representation of the element

**Example:**
```python
from xml.etree.ElementTree import Element
from your_module import to_html_string

# Create an element
div = Element('div')
div.set('class', 'container')
div.text = 'Hello World'

# Serialize to HTML5
html_output = to_html_string(div)
# Output: <div class="container">Hello World</div>
```

### `to_xhtml_string(element: Element) -> str`

Serializes an ElementTree Element and its children to an XHTML string.

**Parameters:**
- `element`: An `xml.etree.ElementTree.Element` object to serialize

**Returns:**
- A string containing the XHTML representation of the element

**Example:**
```python
from xml.etree.ElementTree import Element
from your_module import to_xhtml_string

# Create a self-closing element
img = Element('img')
img.set('src', 'image.jpg')
img.set('alt', 'An image')

# Serialize to XHTML
xhtml_output = to_xhtml_string(img)
# Output: <img alt="An image" src="image.jpg" />
```

## Internal Functions

### Character Escaping Functions

- **`_escape_cdata(text) -> str`**: Escapes character data for HTML content
  - Escapes: `&`, `<`, `>`
  
- **`_escape_attrib(text: str) -> str`**: Escapes attribute values for XHTML
  - Escapes: `&`, `<`, `>`, `"`, `\n` (as `&#10;`)
  
- **`_escape_attrib_html(text: str) -> str`**: Escapes attribute values for HTML
  - Escapes: `&`, `<`, `>`, `"`

### Core Serialization Functions

- **`_serialize_html(write, elem, format)`**: Main recursive serialization function
- **`_write_html(root, format)`**: Orchestrates the serialization process

## Special Handling

### Entity Preservation
The module uses a regex pattern (`RE_AMP`) to avoid double-escaping existing HTML entities:
```python
RE_AMP = re.compile(r'&(?!(?:\#[0-9]+|\#x[0-9a-f]+|[0-9a-z]+);)', re.I)
```

### Script and Style Tags
Content within `<script>` and `<style>` tags is not escaped to preserve functionality.

### QName Support
The module handles XML QName objects for namespace-aware serialization.

## Notes and Recommendations

### Performance Considerations
- The escaping functions include optimizations for strings shorter than 500 characters
- Only performs replacements when necessary (checks for presence of characters first)

### Error Handling
- Includes proper error handling for unsupported data types
- Raises `TypeError` with descriptive messages for serialization errors

### Usage in Python-Markdown
This module is specifically designed for use with Python-Markdown but can be used independently for any ElementTree serialization needs.

### Compatibility
- Supports Python 3.7+ (uses `from __future__ import annotations`)
- Based on ElementTree 1.3 preview with modifications

## Example Usage

```python
from xml.etree.ElementTree import Element, SubElement
from your_module import to_html_string, to_xhtml_string

# Create a complex element structure
article = Element('article')
article.set('class', 'post')

header = SubElement(article, 'h1')
header.text = 'My Blog Post'

content = SubElement(article, 'p')
content.text = 'This is some content with <special> characters & entities.'

# Generate HTML5
html5_output = to_html_string(article)
print("HTML5:", html5_output)

# Generate XHTML
xhtml_output = to_xhtml_string(article)
print("XHTML:", xhtml_output)
```

This module provides a robust solution for converting ElementTree structures to web-ready HTML and XHTML formats with proper character encoding and format-specific conventions.