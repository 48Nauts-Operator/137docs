<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Python Markdown Utilities Module

This module (`util.py`) provides core constants, utility functions, and classes that are used throughout the Python Markdown library. It serves as a foundational component containing shared functionality for parsing and processing Markdown text.

## Overview

The module contains:
- HTML element constants and placeholders
- Utility functions for extension management, deprecation handling, and text processing
- Core classes for HTML processing and registry management

## Constants

### Block-Level Elements

```python
BLOCK_LEVEL_ELEMENTS: list[str]
```

A comprehensive list of HTML tags that are treated as block-level elements. These elements are invalid to wrap in `<p>` tags according to HTML specifications.

**Notable elements include:**
- Structural: `div`, `section`, `article`, `aside`, `header`, `footer`
- Text blocks: `h1`-`h6`, `p`, `blockquote`, `pre`
- Lists: `ul`, `ol`, `li`
- Tables: `table`, `tbody`, `thead`, `tr`, `td`, `th`

### Placeholder Constants

The module defines several placeholder templates used internally:

- `STX` / `ETX`: Start/End of Text markers (`\u0002` / `\u0003`)
- `INLINE_PLACEHOLDER`: Template for stashed inline text
- `HTML_PLACEHOLDER`: Template for raw HTML content
- `TAG_PLACEHOLDER`: Template for HTML tags
- `AMP_SUBSTITUTE`: Template for HTML entities

## Key Functions

### Extension Management

#### `get_installed_extensions()`

```python
@lru_cache(maxsize=None)
def get_installed_extensions():
```

Returns all available Markdown extensions from the `markdown.extensions` entry point group. Uses LRU caching for performance.

### Utility Functions

#### `deprecated(message: str, stacklevel: int = 2)`

A decorator that raises deprecation warnings when wrapped functions are called.

**Usage:**
```python
@deprecated("This method will be removed in version X; use Y instead.")
def some_method():
    pass
```

#### `parseBoolValue(value, fail_on_errors=True, preserve_none=False)`

Parses string representations of boolean values with flexible input handling.

**Accepted values:**
- `True`: "true", "yes", "y", "on", "1"
- `False`: "false", "no", "n", "off", "0", "none"
- `None`: "none" (when `preserve_none=True`)

#### `code_escape(text: str) -> str`

HTML-escapes code content by replacing `&`, `<`, and `>` with their HTML entities.

#### `nearing_recursion_limit() -> bool`

Safety function that returns `True` if the current stack depth is within 100 calls of Python's recursion limit.

## Core Classes

### `AtomicString`

```python
class AtomicString(str):
```

A string subclass that indicates the content should not be further processed by Markdown parsers.

### `Processor`

```python
class Processor:
    def __init__(self, md: Markdown | None = None):
```

Base class for all Markdown processors. Stores a reference to the parent `Markdown` instance.

### `HtmlStash`

```python
class HtmlStash:
```

Manages temporary storage of HTML content during Markdown processing.

**Key methods:**
- `store(html)`: Stores HTML content and returns a placeholder string
- `store_tag(tag, attrs, left_index, right_index)`: Stores tag data with position info
- `reset()`: Clears all stored content
- `get_placeholder(key)`: Generates placeholder strings

**Use case:** Temporarily removes HTML from Markdown text to prevent interference during processing, then restores it later.

### `Registry[T]`

```python
class Registry(Generic[_T]):
```

A generic priority-sorted registry that maintains items in order of priority (highest to lowest).

**Key features:**
- **Registration**: `register(item, name, priority)` - Add items with string names and numeric priorities
- **Deregistration**: `deregister(name, strict=True)` - Remove items by name
- **Access**: Supports both index-based (`registry[0]`) and name-based (`registry['name']`) access
- **Iteration**: Supports standard Python iteration and container operations
- **Slicing**: Returns new Registry instances when sliced

**Example usage:**
```python
registry = Registry()
registry.register(some_processor, 'my_processor', 100)
registry.register(other_processor, 'other', 50)

# Access by index (sorted by priority)
first_item = registry[0]  # Returns some_processor (priority 100)

# Access by name
item = registry['my_processor']

# Check membership
if 'my_processor' in registry:
    print("Found!")
```

## Notes and Suggestions

- **Thread Safety**: The module is not explicitly thread-safe. Consider synchronization if used in multi-threaded environments.
- **Performance**: The `Registry` class lazy-sorts items only when accessed, which is efficient for write-heavy scenarios.
- **Extensions**: When creating custom Markdown extensions, inherit from `Processor` for consistency.
- **HTML Handling**: Use `HtmlStash` when you need to temporarily preserve HTML content during text processing.

## Dependencies

- **Python 3.10+**: Uses `importlib.metadata`
- **Python <3.10**: Falls back to `importlib_metadata` package
- **Type Checking**: Extensive use of type hints for better IDE support and code maintainability