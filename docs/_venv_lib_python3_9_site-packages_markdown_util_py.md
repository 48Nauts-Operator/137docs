<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Python Markdown - Utility Module Documentation

## Overview

This module contains core utilities, constants, classes, and functions that are referenced throughout the Python Markdown codebase. It serves as a foundational module providing essential building blocks for the Markdown parsing and processing system.

**Purpose:**
- Define constants and placeholders used in Markdown processing
- Provide utility classes for HTML handling and registry management  
- Implement helper functions for common operations
- Establish base classes for processors

## Constants

### Block-Level Elements
```python
BLOCK_LEVEL_ELEMENTS: list[str]
```
- Contains HTML tags that are treated as block-level elements
- Elements that should not be wrapped in `<p>` tags
- Based on W3C HTML specification for valid paragraph content

### Placeholder Constants

The module defines several placeholder markers used during processing:

| Constant | Purpose |
|----------|---------|
| `STX` | Start of Text marker (`\u0002`) |
| `ETX` | End of Text marker (`\u0003`) |
| `INLINE_PLACEHOLDER` | Template for stashed inline text |
| `HTML_PLACEHOLDER` | Template for raw HTML content |
| `TAG_PLACEHOLDER` | Template for HTML tags |
| `AMP_SUBSTITUTE` | Template for HTML entities |

## Key Classes

### `Processor`
Base class for all Markdown processors.

```python
class Processor:
    def __init__(self, md: Markdown | None = None):
        self.md = md
```

**Attributes:**
- `md`: Reference to the parent Markdown instance

### `AtomicString`
```python
class AtomicString(str):
    """A string which should not be further processed."""
    pass
```
- Inherits from `str` but marks content as "atomic"
- Prevents further Markdown processing on the string content

### `HtmlStash`
Manages temporary storage of HTML content during processing.

**Key Methods:**
- `store(html)`: Saves HTML segment and returns placeholder
- `reset()`: Clears the stash
- `store_tag()`: Stores tag data with placeholder
- `get_placeholder(key)`: Generates placeholder string

**Usage Example:**
```python
stash = HtmlStash()
placeholder = stash.store("<div>Raw HTML</div>")
# Returns: '\u0002wzxhzdk:0\u0003'
```

### `Registry[T]`
A priority-sorted generic registry for managing collections of items.

**Key Features:**
- Automatic sorting by priority (highest to lowest)
- Support for both name-based and index-based access
- Generic type support with TypeVar `_T`

**Methods:**
- `register(item, name, priority)`: Add item with priority
- `deregister(name, strict=True)`: Remove item by name
- `get_index_for_name(name)`: Get index from name
- Supports `len()`, `in`, iteration, and indexing

**Usage Example:**
```python
registry = Registry()
registry.register(my_processor, 'processor1', 100)
registry.register(other_processor, 'processor2', 50)

# Access by name or index
item = registry['processor1']  # by name
item = registry[0]            # by index (highest priority first)
```

## Utility Functions

### `deprecated(message, stacklevel=2)`
Decorator for marking functions as deprecated.

```python
@deprecated("Use new_function() instead.")
def old_function():
    pass
```

### `parseBoolValue(value, fail_on_errors=True, preserve_none=False)`
Parses string representations of boolean values.

**Supported Values:**
- **True**: 'true', 'yes', 'y', 'on', '1'
- **False**: 'false', 'no', 'n', 'off', '0', 'none'
- **None**: 'none' (when `preserve_none=True`)

### `code_escape(text)`
HTML-escapes code content by replacing:
- `&` ‚Üí `&amp;`
- `<` ‚Üí `&lt;`
- `>` ‚Üí `&gt;`

### Performance Utilities

- `nearing_recursion_limit()`: Checks if stack depth is near Python's recursion limit
- `_get_stack_depth()`: Efficiently calculates current stack depth

### Extension Management

- `get_installed_extensions()`: Returns all available Markdown extensions via entry points

## Notes and Suggestions

### ‚ö†Ô∏è Important Notes

1. **Placeholder System**: The placeholder constants use Unicode control characters (STX/ETX) to avoid conflicts with user content
2. **Thread Safety**: Classes like `HtmlStash` are not thread-safe and should be used per-processing instance
3. **Registry Sorting**: The Registry automatically sorts on access, not on registration, for performance

### üí° Best Practices

1. **Use AtomicString** for content that should bypass further Markdown processing
2. **Registry Priorities** should use meaningful ranges (e.g., 0-100) for clarity
3. **Error Handling** with `parseBoolValue` - consider using `fail_on_errors=False` for user input
4. **Extension Development** - inherit from `Processor` class for consistency

### üîß Extension Development Tips

```python
# Example processor implementation
class MyProcessor(Processor):
    def __init__(self, md=None):
        super().__init__(md)
        # Initialize processor-specific attributes
    
    def run(self, text):
        # Process the text
        return modified_text
```

This module provides the essential foundation for the Python Markdown library and is crucial for understanding how the parsing system works internally.