<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# PEP 656 Support Module

This module implements support for PEP 656, which defines the `musllinux` platform tag for Python packages. It provides functionality to detect if the currently running Python interpreter is linked against musl libc and determines the musl version being used.

## Purpose

The primary purpose of this module is to:
- Detect whether Python is running on a musl-based Linux system
- Determine the version of musl libc being used
- Generate appropriate `musllinux` platform tags for package compatibility

This is particularly important for Python package distribution on Alpine Linux and other musl-based distributions.

## Classes

### `_MuslVersion`

```python
class _MuslVersion(NamedTuple):
    major: int
    minor: int
```

A named tuple that represents a musl version with major and minor version numbers.

**Attributes:**
- `major`: Major version number
- `minor`: Minor version number

## Functions

### `_parse_musl_version(output: str) -> _MuslVersion | None`

Parses musl version information from loader output.

**Parameters:**
- `output`: String output from the musl loader

**Returns:**
- `_MuslVersion` object if parsing succeeds
- `None` if the output doesn't match expected musl format

**Expected Input Format:**
```
musl libc (x86_64)
Version 1.2.2
Dynamic Program Loader
```

### `_get_musl_version(executable: str) -> _MuslVersion | None`

**Cached function** that detects the musl runtime version for a given executable.

**Parameters:**
- `executable`: Path to the executable to analyze

**Returns:**
- `_MuslVersion` object if musl is detected
- `None` if not using musl or detection fails

**Process:**
1. Opens the executable as an ELF file
2. Extracts the dynamic loader path
3. Checks if the loader contains "musl"
4. Executes the loader to get version information
5. Parses the version from stderr output

### `platform_tags(archs: Sequence[str]) -> Iterator[str]`

Generates musllinux platform tags compatible with the current platform.

**Parameters:**
- `archs`: Sequence of compatible architectures (e.g., `["x86_64", "i686"]`)
  - First architecture should be the closest to actual architecture
  - Used as suffix after `musllinux_` prefix

**Returns:**
- Iterator of compatible musllinux tag strings

**Tag Format:** `musllinux_{major}_{minor}_{arch}`

**Example Output:**
```
musllinux_1_2_x86_64
musllinux_1_1_x86_64
musllinux_1_0_x86_64
```

## Dependencies

- `functools`: For LRU caching
- `re`: Regular expression parsing
- `subprocess`: Executing the musl loader
- `sys`: System-specific parameters
- `typing`: Type hints
- `._elffile.ELFFile`: ELF file parsing (internal module)

## Usage Example

```python
from packaging._musllinux import platform_tags, _get_musl_version
import sys

# Check if running on musl
musl_version = _get_musl_version(sys.executable)
if musl_version:
    print(f"Running on musl {musl_version.major}.{musl_version.minor}")
    
    # Generate platform tags
    tags = list(platform_tags(["x86_64"]))
    print("Compatible tags:", tags)
else:
    print("Not running on musl")
```

## Notes and Considerations

### Performance
- `_get_musl_version()` is cached using `@functools.lru_cache` to avoid repeated filesystem and subprocess operations

### Error Handling
- Functions gracefully handle various failure modes:
  - File access errors when reading executables
  - Invalid ELF files
  - Missing or non-musl loaders
  - Subprocess execution failures

### Compatibility
- Generates backward-compatible tags (newer musl versions are compatible with older versions)
- Tags are generated from current version down to 0

### Security
- Uses `subprocess.run()` to execute the dynamic loader
- Only executes if "musl" is found in the loader path

## Testing

The module includes a `__main__` section for basic testing:

```bash
python -m packaging._musllinux
```

This will display:
- Current platform information
- Detected musl version
- Generated platform tags