<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# PEP 656 Musl Linux Support Module

## Overview

This module implements support for **PEP 656** (Platform Tag for Linux distributions using musl). It provides functionality to detect if the currently running Python interpreter is linked against the musl C library and determines the musl version being used. This information is crucial for generating appropriate platform tags for Python packages on musl-based Linux distributions.

## Purpose

- Detect musl libc runtime version in the current Python environment
- Generate compatible `musllinux` platform tags for package distribution
- Support proper wheel compatibility on musl-based Linux distributions (like Alpine Linux)

## Classes

### `_MuslVersion`

```python
class _MuslVersion(NamedTuple):
    major: int
    minor: int
```

A named tuple representing a musl version with major and minor version numbers.

**Attributes:**
- `major`: Major version number
- `minor`: Minor version number

## Functions

### `_parse_musl_version(output: str) -> _MuslVersion | None`

Parses musl version information from loader output.

**Parameters:**
- `output`: Raw output string from the musl loader

**Returns:**
- `_MuslVersion` object if parsing succeeds
- `None` if the output doesn't contain valid musl version information

**Expected Input Format:**
```
musl libc (x86_64)
Version 1.2.2
Dynamic Program Loader
```

### `_get_musl_version(executable: str) -> _MuslVersion | None`

**Main detection function** - Detects the musl runtime version for a given executable.

**Parameters:**
- `executable`: Path to the executable to analyze (typically `sys.executable`)

**Returns:**
- `_MuslVersion` object if musl is detected
- `None` if not linked against musl or detection fails

**Process:**
1. Opens the executable as an ELF file
2. Extracts the dynamic loader path
3. Checks if the loader path contains "musl"
4. Invokes the loader to get version information
5. Parses the version from stderr output

**Note:** This function is cached using `@functools.lru_cache` for performance.

### `platform_tags(archs: Sequence[str]) -> Iterator[str]`

**Primary public function** - Generates musllinux platform tags compatible with the current platform.

**Parameters:**
- `archs`: Sequence of compatible architectures (e.g., `["x86_64", "i686"]`)
  - First architecture should be the closest to actual architecture
  - Used in the platform tag after `musllinux_` prefix

**Returns:**
- Iterator yielding compatible musllinux tag strings

**Tag Format:** `musllinux_{major}_{minor}_{arch}`

**Example Output:**
```
musllinux_1_2_x86_64
musllinux_1_1_x86_64
musllinux_1_0_x86_64
```

## Dependencies

- `_elffile.ELFFile`: For parsing ELF executable files
- Standard library modules: `functools`, `re`, `subprocess`, `sys`, `typing`

## Usage Example

```python
from musllinux import platform_tags

# Generate tags for current platform
archs = ["x86_64"]
tags = list(platform_tags(archs))
print(tags)  # ['musllinux_1_2_x86_64', 'musllinux_1_1_x86_64', ...]
```

## Command Line Usage

The module can be run directly to display platform information:

```bash
python musllinux.py
```

**Example Output:**
```
plat: linux-x86_64
musl: _MuslVersion(major=1, minor=2)
tags: musllinux_1_2_x86_64
      musllinux_1_1_x86_64
      musllinux_1_0_x86_64
```

## Important Notes

- **Platform Detection**: Only works on Linux platforms where Python is dynamically linked against musl
- **Backward Compatibility**: Generated tags include all compatible minor versions down to 0
- **Error Handling**: Gracefully handles cases where musl is not present (returns empty iterator)
- **Performance**: Version detection is cached to avoid repeated expensive operations
- **ELF Dependency**: Requires the `_elffile` module to parse executable format

## Limitations

- Only works on musl-based Linux distributions
- Requires Python executable to be dynamically linked against musl
- Depends on musl loader being invokable and producing expected output format