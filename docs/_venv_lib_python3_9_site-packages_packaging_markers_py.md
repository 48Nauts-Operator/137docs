<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Marker Module Documentation

This module provides functionality for parsing, evaluating, and working with Python package environment markers as defined in [PEP 508](https://peps.python.org/pep-0508/). Environment markers allow packages to specify conditional dependencies based on the target environment (Python version, operating system, architecture, etc.).

## Purpose

The primary purpose of this module is to:
- Parse marker expressions from strings
- Evaluate markers against current or specified environments
- Provide environment information for marker evaluation
- Handle normalization of marker values (especially for extras)

## Key Classes and Types

### `Marker`

The main class for working with environment markers.

```python
marker = Marker("python_version >= '3.8'")
result = marker.evaluate()  # Returns True/False based on current Python version
```

**Methods:**
- `__init__(marker: str)` - Parse a marker string
- `evaluate(environment=None, context="metadata")` - Evaluate the marker
- `__str__()` - Get string representation of the marker

### Exception Classes

#### `InvalidMarker(ValueError)`
Raised when a marker string cannot be parsed according to PEP 508 specifications.

#### `UndefinedComparison(ValueError)`
Raised when an invalid operation is attempted on incompatible values.

#### `UndefinedEnvironmentName(ValueError)`
Raised when referencing an environment variable that doesn't exist.

### Type Definitions

#### `Environment(TypedDict)`
Defines the structure of environment information used for marker evaluation:

```python
{
    'implementation_name': str,        # e.g., 'cpython'
    'implementation_version': str,     # e.g., '3.13.0a2'
    'os_name': str,                   # e.g., 'posix'
    'platform_machine': str,          # e.g., 'x86_64'
    'platform_release': str,          # e.g., '2.2.0'
    'platform_system': str,           # e.g., 'Linux'
    'platform_version': str,          # System version details
    'python_full_version': str,       # e.g., '3.9.7'
    'platform_python_implementation': str,  # e.g., 'CPython'
    'python_version': str,            # e.g., '3.9'
    'sys_platform': str              # e.g., 'linux'
}
```

#### `EvaluateContext`
Literal type defining evaluation contexts: `"metadata"`, `"lock_file"`, or `"requirement"`.

## Important Functions

### `default_environment() -> Environment`

Returns the current system's environment information for marker evaluation.

```python
env = default_environment()
print(env['python_version'])  # e.g., '3.9'
```

### Internal Helper Functions

- `_evaluate_markers()` - Core marker evaluation logic
- `_normalize()` - Normalizes marker values (especially for extras)
- `_format_marker()` - Formats markers back to string representation
- `_eval_op()` - Evaluates individual comparison operations

## Usage Examples

### Basic Marker Evaluation

```python
from packaging.markers import Marker

# Simple version check
marker = Marker("python_version >= '3.8'")
if marker.evaluate():
    print("Python 3.8+ detected")

# Platform-specific marker
marker = Marker("sys_platform == 'win32'")
is_windows = marker.evaluate()
```

### Custom Environment

```python
# Evaluate against custom environment
custom_env = {'python_version': '3.7'}
marker = Marker("python_version >= '3.8'")
result = marker.evaluate(environment=custom_env)  # False
```

### Complex Markers

```python
# Multiple conditions
marker = Marker("python_version >= '3.8' and sys_platform != 'win32'")
result = marker.evaluate()

# Extra dependencies
marker = Marker("extra == 'dev'")
result = marker.evaluate(environment={'extra': 'dev'})  # True
```

## Important Notes

### Evaluation Contexts

The `context` parameter affects marker evaluation:
- `"metadata"` (default): For core metadata, sets `extra` to empty string
- `"lock_file"`: Sets `extras` and `dependency_groups` to empty frozensets
- `"requirement"`: Standard evaluation for requirements

### Extra Name Normalization

Following PEP 685, extra names are normalized using PEP 503 semantics:
- `Marker("extra == 'Test-Extra'")` matches `extra == 'test-extra'`

### Version Comparison

The module supports both string comparison and PEP 440 version specification matching for version-related markers.

## Supported Operators

- `==`, `!=` - Equality comparison
- `<`, `<=`, `>`, `>=` - Ordering comparison  
- `in`, `not in` - Membership testing
- `and`, `or` - Logical operators

## Dependencies

This module depends on:
- `._parser` - Marker parsing functionality
- `._tokenizer` - Tokenization and syntax error handling
- `.specifiers` - Version specification handling
- `.utils` - Name canonicalization utilities

## Thread Safety

The module is thread-safe. `Marker` objects are immutable after creation and can be safely shared between threads.