<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Marker Module Documentation

## Overview

This module provides functionality for parsing, evaluating, and working with environment markers as defined in PEP 508. Environment markers are expressions used in Python packaging to specify conditions under which dependencies should be installed or metadata should be applied.

## Purpose

The primary purpose of this module is to:
- Parse marker strings into structured data
- Evaluate markers against the current or specified environment
- Provide a standardized way to work with dependency markers in Python packaging

## Key Classes and Functions

### Exception Classes

#### `InvalidMarker(ValueError)`
Raised when an invalid marker string is encountered that doesn't conform to PEP 508 specifications.

#### `UndefinedComparison(ValueError)`
Raised when an invalid operation is attempted on a value that doesn't support it.

#### `UndefinedEnvironmentName(ValueError)`
Raised when attempting to use an environment variable name that doesn't exist.

### Type Definitions

#### `Environment(TypedDict)`
Defines the structure of environment information used for marker evaluation:

```python
{
    'implementation_name': str,        # e.g., 'cpython'
    'implementation_version': str,     # e.g., '3.13.0a2'
    'os_name': str,                   # e.g., 'posix'
    'platform_machine': str,         # e.g., 'i386'
    'platform_release': str,         # e.g., '2.2.0'
    'platform_system': str,          # e.g., 'Linux'
    'platform_version': str,         # e.g., '#3 on degas'
    'python_full_version': str,      # e.g., '3.9.7'
    'platform_python_implementation': str, # e.g., 'CPython'
    'python_version': str,           # e.g., '3.9'
    'sys_platform': str             # e.g., 'linux'
}
```

#### `EvaluateContext`
A literal type defining valid evaluation contexts: `"metadata"`, `"lock_file"`, or `"requirement"`.

### Main Classes

#### `Marker`

The primary class for working with environment markers.

**Constructor:**
```python
Marker(marker: str)
```

**Key Methods:**

##### `evaluate(environment=None, context="metadata") -> bool`
Evaluates the marker against the given or current environment.

**Parameters:**
- `environment`: Optional dictionary to override environment values
- `context`: Evaluation context (`"metadata"`, `"lock_file"`, or `"requirement"`)

**Returns:** Boolean result of marker evaluation

**Example:**
```python
marker = Marker("python_version >= '3.8'")
result = marker.evaluate()  # True if Python >= 3.8
```

### Utility Functions

#### `default_environment() -> Environment`
Returns the current system's environment information as an `Environment` dictionary.

#### `format_full_version(info: sys._version_info) -> str`
Formats version information into a standardized string format.

## Important Internal Functions

### `_evaluate_markers(markers, environment) -> bool`
Core evaluation logic that processes parsed marker structures against environment data.

### `_normalize(lhs, rhs, key) -> tuple`
Normalizes marker values according to PEP standards, particularly for extra names (PEP 685).

### `_eval_op(lhs, op, rhs) -> bool`
Evaluates individual operations within markers, handling both standard comparisons and version specifiers.

## Usage Examples

### Basic Marker Evaluation
```python
from packaging.markers import Marker

# Create a marker
marker = Marker("python_version >= '3.8' and sys_platform == 'linux'")

# Evaluate against current environment
if marker.evaluate():
    print("Marker conditions are met")

# Evaluate with custom environment
custom_env = {"python_version": "3.9", "sys_platform": "darwin"}
result = marker.evaluate(environment=custom_env)
```

### Working with Different Contexts
```python
# For package metadata
marker.evaluate(context="metadata")

# For lock files (includes extras and dependency_groups)
marker.evaluate(context="lock_file")

# For requirements
marker.evaluate(context="requirement")
```

## Notes and Considerations

### Important Behaviors
- Extra names are automatically normalized according to PEP 503/685
- The module handles backward compatibility for legacy extra handling
- Version comparisons support PEP 440 version specifiers
- The `python_full_version` field is automatically repaired for non-standard Python builds

### Supported Operators
- Comparison: `<`, `<=`, `==`, `!=`, `>=`, `>`
- Membership: `in`, `not in`
- Logical: `and`, `or`

### Special Marker Keys
The following keys have special handling:
- `extra`: Normalized according to PEP 685
- `dependency_groups`: Allows set values and normalization
- `extras`: Allows set values and normalization

## Dependencies

This module relies on:
- `._parser`: For parsing marker strings
- `._tokenizer`: For tokenization and syntax error handling  
- `.specifiers`: For version specifier handling
- `.utils`: For name canonicalization

## License

This file is dual licensed under Apache License 2.0 and BSD License terms.