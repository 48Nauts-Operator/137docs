<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP Caching Heuristics Module

This module provides heuristic-based HTTP response caching strategies for the `pip` package manager. It implements various caching policies that can be applied to HTTP responses when explicit cache headers are missing or insufficient.

## Overview

The module contains utility functions and classes that implement different caching heuristics to determine how long HTTP responses should be cached. These heuristics are used when responses don't have explicit cache control headers, helping to reduce unnecessary network requests and improve performance.

## Key Components

### Utility Functions

#### `expire_after(delta: timedelta, date: datetime | None = None) -> datetime`
Calculates an expiration datetime by adding a time delta to a given date.

**Parameters:**
- `delta`: Time duration to add
- `date`: Base date (defaults to current UTC time)

**Returns:** Future datetime when the cache should expire

#### `datetime_to_header(dt: datetime) -> str`
Converts a datetime object to a properly formatted HTTP header date string.

**Parameters:**
- `dt`: Datetime to convert

**Returns:** RFC-compliant date string for HTTP headers

### Base Class

#### `BaseHeuristic`
Abstract base class for all caching heuristics.

**Key Methods:**
- `warning(response)`: Returns appropriate warning header for cached responses
- `update_headers(response)`: Updates response headers with caching information
- `apply(response)`: Applies the heuristic to a response and returns the modified response

### Heuristic Implementations

#### `OneDayCache`
```python
class OneDayCache(BaseHeuristic):
```
**Purpose:** Caches responses for exactly 24 hours when no explicit expiration is set.

**Behavior:**
- Only adds expiration if `expires` header is missing
- Sets cache duration to 1 day from the response date
- Marks response as publicly cacheable

#### `ExpiresAfter`
```python
class ExpiresAfter(BaseHeuristic):
```
**Purpose:** Caches all requests for a user-defined time period.

**Usage:**
```python
# Cache for 2 hours
heuristic = ExpiresAfter(hours=2)

# Cache for 30 minutes
heuristic = ExpiresAfter(minutes=30)
```

**Features:**
- Accepts any keyword arguments valid for `timedelta`
- Provides custom warning messages indicating cache duration
- Always sets expiration from current time

#### `LastModified`
```python
class LastModified(BaseHeuristic):
```
**Purpose:** Implements RFC 7234 compliant heuristic caching based on the Last-Modified header.

**Algorithm:**
- Uses 10% of the age between `Last-Modified` and `Date` headers
- Maximum cache time limited to 24 hours
- Only applies to responses with specific cacheable status codes

**Cacheable Status Codes:**
- `200` (OK)
- `203` (Non-Authoritative Information)
- `204` (No Content)
- `206` (Partial Content)
- `300` (Multiple Choices)
- `301` (Moved Permanently)
- `404` (Not Found)
- `405` (Method Not Allowed)
- `410` (Gone)
- `414` (URI Too Long)
- `501` (Not Implemented)

**Conditions for Application:**
- No existing `expires` header
- No restrictive `cache-control` header
- Response status is cacheable
- Both `date` and `last-modified` headers present
- Calculated freshness lifetime is valid

## Usage Examples

```python
# Apply one-day caching
cache = OneDayCache()
cached_response = cache.apply(response)

# Cache for custom duration
cache = ExpiresAfter(hours=6)
cached_response = cache.apply(response)

# Use Last-Modified heuristic
cache = LastModified()
cached_response = cache.apply(response)
```

## Important Notes

### Warning Headers
- All heuristics add appropriate `Warning` headers to indicate cached responses
- Warning code `110` is used to indicate stale responses
- Custom warnings provided for time-based heuristics

### RFC Compliance
- `LastModified` heuristic follows RFC 7234 guidelines
- Date formatting complies with HTTP header standards
- Cache control headers follow HTTP caching specifications

### Limitations
- `LastModified` heuristic has a 24-hour maximum cache time
- Only specific HTTP status codes are considered cacheable by default
- All times are handled in UTC to avoid timezone issues

## Dependencies

This module relies on:
- Python standard library (`datetime`, `email.utils`, `calendar`, `time`)
- `pip._vendor.urllib3.HTTPResponse` for type hints