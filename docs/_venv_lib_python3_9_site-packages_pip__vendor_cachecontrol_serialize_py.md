<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP Response Serializer Documentation

## Overview

This module provides a `Serializer` class for caching HTTP responses in pip's caching control system. It handles the serialization and deserialization of HTTP requests and responses, allowing them to be stored and retrieved from cache storage backends.

## Purpose

The serializer is designed to:
- Convert HTTP responses and related metadata into a storable format using MessagePack
- Reconstruct HTTP responses from cached data
- Handle HTTP `Vary` headers for proper cache validation
- Maintain compatibility with different serialization versions

## Classes

### `Serializer`

The main class responsible for serializing and deserializing HTTP response data.

#### Class Attributes

- `serde_version`: Current serialization version (`"4"`)

#### Methods

##### `dumps(request, response, body=None) -> bytes`

Serializes an HTTP request/response pair into bytes for storage.

**Parameters:**
- `request` (`PreparedRequest`): The HTTP request object
- `response` (`HTTPResponse`): The HTTP response object  
- `body` (`bytes | None`): Optional response body (will be read from response if not provided)

**Returns:** Serialized data as bytes with version prefix

**Key Features:**
- Extracts response metadata (headers, status, version, reason)
- Handles `Vary` headers for cache validation
- Automatically reads response body if not provided
- Resets response file pointer after reading

##### `loads(request, data, body_file=None) -> HTTPResponse | None`

Deserializes cached data back into an HTTP response object.

**Parameters:**
- `request` (`PreparedRequest`): The original HTTP request
- `data` (`bytes`): Serialized response data
- `body_file` (`IO[bytes] | None`): Optional file-like object for response body

**Returns:** Reconstructed `HTTPResponse` object or `None` if invalid

**Behavior:**
- Returns `None` for empty data
- Only processes data with correct version prefix (`cc=4,`)
- Delegates to version-specific loader methods

##### `prepare_response(request, cached, body_file=None) -> HTTPResponse | None`

Validates cached response data and constructs a new HTTPResponse object.

**Parameters:**
- `request` (`PreparedRequest`): The current HTTP request
- `cached` (`Mapping[str, Any]`): Deserialized cache data
- `body_file` (`IO[bytes] | None`): Optional file for response body

**Returns:** Valid `HTTPResponse` object or `None` if validation fails

**Validation Logic:**
- Rejects responses with `Vary: *` (uncacheable)
- Validates that `Vary` headers match between cached response and current request
- Handles transfer-encoding cleanup
- Provides fallback for encoding issues from older Python versions

##### `serialize(data) -> bytes`

Low-level serialization using MessagePack.

**Parameters:**
- `data` (`dict[str, Any]`): Data dictionary to serialize

**Returns:** Serialized bytes using MessagePack format

##### `_loads_v4(request, data, body_file=None) -> HTTPResponse | None`

Version 4 specific deserialization implementation.

**Parameters:**
- `request` (`PreparedRequest`): The HTTP request
- `data` (`bytes`): Raw serialized data (without version prefix)
- `body_file` (`IO[bytes] | None`): Optional body file

**Returns:** `HTTPResponse` object or `None` on error

## Data Format

The serialized data structure includes:

```python
{
    "response": {
        "body": bytes,           # Response body content
        "headers": dict,         # Response headers as string pairs
        "status": int,           # HTTP status code
        "version": int,          # HTTP version
        "reason": str,           # HTTP reason phrase
        "decode_content": bool   # Content decoding flag
    },
    "vary": {
        # Vary header validation data
        "header_name": "header_value"
    }
}
```

## Usage Notes

### Important Considerations

- **Version Compatibility**: Only processes data with matching `serde_version`
- **Vary Header Handling**: Properly validates cache entries against `Vary` headers
- **Error Resilience**: Returns `None` for invalid data rather than raising exceptions
- **Memory Management**: Handles response body reading efficiently with proper file pointer management

### Dependencies

- `msgpack`: For efficient binary serialization
- `urllib3.HTTPResponse`: For HTTP response objects
- `requests.structures.CaseInsensitiveDict`: For header handling

### Best Practices

1. Always handle `None` returns from `loads()` and `prepare_response()`
2. Consider providing `body_file` for large responses to avoid memory issues
3. The serializer handles encoding issues transparently for older cached data

## Example Usage

```python
# Serializing a response
serializer = Serializer()
cached_data = serializer.dumps(request, response)

# Deserializing from cache
restored_response = serializer.loads(request, cached_data)
if restored_response:
    # Use the restored response
    content = restored_response.read()
```