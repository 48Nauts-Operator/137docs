<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# PEP 376 Implementation Documentation

This module provides a Python implementation of **PEP 376** (Database of Installed Python Distributions), which defines standards for tracking installed Python packages and their metadata.

## Overview

The module handles:
- **Distribution discovery** and metadata parsing from `.dist-info` and `.egg-info` directories
- **Package installation tracking** through RECORD files
- **Dependency graph management** between distributions
- **Export entry point management**
- **Legacy package format support** (setuptools/distribute)

## Key Classes

### `Distribution`
Base class for all distributions, whether installed or from indexes.

**Key Properties:**
- `name`, `version`: Package identification
- `metadata`: Associated `Metadata` instance
- `run_requires`, `build_requires`, etc.: Dependency requirements
- `provides`: What this distribution provides

**Important Methods:**
- `matches_requirement(req)`: Check if distribution fulfills a requirement

### `InstalledDistribution`
Represents PEP 376 compliant installed distributions (`.dist-info` directories).

**Key Features:**
- Uses SHA-256 hashing by default
- Reads metadata from `METADATA`, `WHEEL_METADATA_FILENAME`, or legacy files
- Manages RECORD files for tracking installed files

**Important Methods:**
```python
# File management
list_installed_files()          # Returns (path, hash, size) tuples
write_installed_files(paths)    # Creates RECORD file
check_installed_files()         # Validates file integrity

# Export management  
read_exports()                  # Read entry points
write_exports(exports)          # Write entry points

# Resource access
get_resource_path(relative_path) # Get absolute path to resource
```

### `EggInfoDistribution`
Handles legacy setuptools/distribute packages (`.egg-info` directories/files).

**Key Features:**
- Backward compatibility with older package formats
- Reads from `PKG-INFO`, `requires.txt`, `top_level.txt`
- Limited functionality compared to PEP 376 distributions

### `DistributionPath`
Manages a collection of distributions on a search path (typically `sys.path`).

**Key Features:**
- **Caching system** for performance
- **Dual format support** (PEP 376 and legacy)
- **Distribution discovery** and lookup

**Important Methods:**
```python
# Discovery
get_distributions()              # Iterator over all distributions
get_distribution(name)           # Find specific distribution
provides_distribution(name, ver) # Find providers of a requirement

# Utilities
get_exported_entries(category)   # Get entry points by category
clear_cache()                   # Reset internal cache
```

**Usage Example:**
```python
# Create path manager
dp = DistributionPath(include_egg=True)

# Find all distributions
for dist in dp.get_distributions():
    print(f"{dist.name} {dist.version}")

# Find specific package
requests_dist = dp.get_distribution('requests')
```

### `DependencyGraph`
Creates and manages dependency relationships between distributions.

**Key Features:**
- **Adjacency list representation** of dependencies
- **Missing dependency tracking**
- **Topological sorting** for installation order
- **DOT format export** for visualization

**Important Methods:**
```python
add_distribution(dist)          # Add distribution to graph
add_edge(x, y, label)          # Add dependency relationship
topological_sort()             # Get installation order
to_dot(file)                   # Export to DOT format
```

## Key Functions

### `make_graph(dists, scheme='default')`
Creates a dependency graph from a list of distributions.

```python
dists = list(dp.get_distributions())
graph = make_graph(dists)
install_order, cycles = graph.topological_sort()
```

### `get_dependent_dists(dists, dist)`
Find all distributions that depend on a given distribution.

### `get_required_dists(dists, dist)`
Find all distributions required by a given distribution.

## Constants

- `DISTINFO_EXT = '.dist-info'`: PEP 376 directory extension
- `DIST_FILES`: Tuple of valid files in `.dist-info` directories
- `EXPORTS_FILENAME = 'pydist-exports.json'`: Entry points file
- `COMMANDS_FILENAME = 'pydist-commands.json'`: Commands file

## Usage Notes

### Caching
- **Enable caching** for better performance: `dp.cache_enabled = True`
- **Clear cache** when filesystem changes: `dp.clear_cache()`

### File Integrity
The module provides robust file integrity checking:
```python
dist = dp.get_distribution('mypackage')
mismatches = dist.check_installed_files()
for path, issue, expected, actual in mismatches:
    print(f"File {path} has {issue}: expected {expected}, got {actual}")
```

### Legacy Support
Include legacy packages with:
```python
dp = DistributionPath(include_egg=True)
```

## Error Handling

- **`DistlibException`**: Raised for distribution-related errors
- **`UnsupportedVersionError`**: Raised for unsupported version schemes
- **`LookupError`**: Raised when distributions are not found

## Performance Considerations

- Use caching for repeated operations
- The `@cached_property` decorator is used extensively for lazy loading
- File system operations are minimized through intelligent caching

This module forms the core of Python package management and provides the foundation for tools like pip to track and manage installed packages.