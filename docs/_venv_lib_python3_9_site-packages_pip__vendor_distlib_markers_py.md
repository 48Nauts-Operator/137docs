<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Environment Markers Parser

This module provides functionality to parse and evaluate environment markers as defined in PEP 508. Environment markers are expressions used in Python packaging to specify conditions under which a package dependency should be installed.

## Purpose

The primary purpose of this module is to:
- Parse environment marker expressions (e.g., `python_version >= "3.8"`)
- Evaluate these expressions against the current Python environment
- Determine whether package dependencies should be installed based on environment conditions

## Background

According to PEP 345, the original micro-language was Python-compatible and could use the `ast` module. However, PEP 508 introduced non-Python operators like `~=` and `===`, requiring a custom parsing approach.

## Key Components

### Constants and Patterns

```python
_VERSION_PATTERN = re.compile(r'((\d+(\.\d+)*\w*)|\'(\d+(\.\d+)*\w*)\'|\"(\d+(\.\d+)*\w*)\")')
_VERSION_MARKERS = {'python_version', 'python_full_version'}
```

- **`_VERSION_PATTERN`**: Regular expression to match version strings in various formats
- **`_VERSION_MARKERS`**: Set of marker names that represent version information

### Core Classes

#### `Evaluator`

The main class responsible for evaluating marker expressions.

**Key Features:**
- Supports standard comparison operators (`==`, `!=`, `<`, `<=`, `>`, `>=`)
- Supports PEP 508 specific operators (`===`, `~=`)
- Handles logical operators (`and`, `or`)
- Supports membership operators (`in`, `not in`)

**Methods:**

##### `evaluate(expr, context)`
Evaluates a parsed marker expression within a given context.

**Parameters:**
- `expr`: The expression to evaluate (string or dict)
- `context`: Dictionary containing environment variables

**Returns:** Boolean result of the evaluation

**Example Usage:**
```python
evaluator = Evaluator()
context = default_context()
result = evaluator.evaluate(parsed_expr, context)
```

### Utility Functions

#### `default_context()`
Generates a dictionary containing the current Python environment information.

**Returns:** Dictionary with keys including:
- `implementation_name`: Python implementation name
- `implementation_version`: Implementation version
- `os_name`: Operating system name
- `platform_machine`: Machine type
- `platform_python_implementation`: Python implementation
- `python_version`: Python version (major.minor)
- `python_full_version`: Full Python version
- `sys_platform`: System platform identifier

#### `interpret(marker, execution_context=None)`
**Main entry point** for interpreting environment markers.

**Parameters:**
- `marker` (str): The marker expression to interpret
- `execution_context` (dict, optional): Additional context variables

**Returns:** Boolean indicating whether the marker condition is met

**Raises:**
- `SyntaxError`: If the marker syntax is invalid or contains unexpected data

**Example Usage:**
```python
# Check if Python version is >= 3.8
result = interpret('python_version >= "3.8"')

# Use custom context
custom_context = {'extra_var': 'value'}
result = interpret('python_version >= "3.8"', custom_context)
```

## Usage Examples

```python
from distlib.markers import interpret

# Basic version check
is_compatible = interpret('python_version >= "3.7"')

# Platform-specific check
is_windows = interpret('sys_platform == "win32"')

# Complex expression
is_dev_env = interpret('python_version >= "3.8" and platform_system == "Linux"')
```

## Important Notes

### Version Handling
- Version comparisons automatically convert strings to `LegacyVersion` objects
- The `~=` operator implements "compatible release" semantics
- Version markers in `in`/`not in` operations are handled specially

### Error Handling
- Invalid syntax raises `SyntaxError`
- Unknown variables in expressions raise `SyntaxError`
- Unsupported operations raise `NotImplementedError`

### Performance Considerations
- The default context is computed once and cached in `DEFAULT_CONTEXT`
- Custom execution contexts are merged with the default context for each evaluation

## Dependencies

This module depends on:
- `.compat`: For string type compatibility
- `.util`: For `in_venv()` function and `parse_marker()` function
- `.version`: For `LegacyVersion` class

## Public API

The module exports only one function:
- `interpret`: Main function for evaluating environment markers