<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# PEP 656 Support - Musl Detection Module

## Overview

This module implements **PEP 656** support for detecting musl-based Linux systems and generating appropriate platform tags. It provides functionality to:

- Detect if the currently running Python is linked against musl libc
- Determine the musl version being used
- Generate compatible `musllinux` platform tags for package distribution

## Purpose

The module addresses the need to distinguish between glibc-based and musl-based Linux distributions (like Alpine Linux) for Python package compatibility. This is crucial for:

- **Package managers** (like pip) to select appropriate wheel distributions
- **Build systems** to generate correct platform-specific packages
- **Distribution tools** to ensure compatibility across different Linux variants

## Classes

### `_MuslVersion`

```python
class _MuslVersion(NamedTuple):
    major: int
    minor: int
```

A named tuple representing musl version information with major and minor version numbers.

**Fields:**
- `major`: Major version number (e.g., 1 in version 1.2.2)
- `minor`: Minor version number (e.g., 2 in version 1.2.2)

## Functions

### `_parse_musl_version(output: str) -> _MuslVersion | None`

Parses musl version information from loader output.

**Parameters:**
- `output`: String output from the musl loader

**Returns:**
- `_MuslVersion` object if parsing succeeds
- `None` if output doesn't match expected musl format

**Expected Input Format:**
```
musl libc (x86_64)
Version 1.2.2
Dynamic Program Loader
```

### `_get_musl_version(executable: str) -> _MuslVersion | None`

**üîß Core Function** - Detects musl runtime version for a given executable.

**Process:**
1. Opens the executable as an ELF file
2. Extracts the dynamic loader path
3. Checks if the loader contains "musl"
4. Executes the loader to get version information
5. Parses the output for version details

**Parameters:**
- `executable`: Path to executable (typically `sys.executable`)

**Returns:**
- `_MuslVersion` if musl is detected
- `None` if not musl-based or detection fails

**Features:**
- Uses `@functools.lru_cache` for performance optimization
- Handles various error conditions gracefully

### `platform_tags(archs: Sequence[str]) -> Iterator[str]`

**üè∑Ô∏è Main Public Function** - Generates musllinux platform tags.

**Parameters:**
- `archs`: Sequence of compatible architectures (e.g., `["x86_64", "i686"]`)
  - First architecture should be the closest to actual architecture
  - Used in the platform tag after `musllinux_` prefix

**Returns:**
- Iterator yielding compatible musllinux tags in priority order

**Tag Format:** `musllinux_{major}_{minor}_{arch}`

**Example Output:**
```
musllinux_1_2_x86_64
musllinux_1_1_x86_64
musllinux_1_0_x86_64
```

## Dependencies

- `_elffile.ELFFile`: For parsing ELF executable format
- Standard library modules: `functools`, `re`, `subprocess`, `sys`

## Usage Example

```python
from packaging._musllinux import platform_tags

# Generate tags for current system
archs = ["x86_64"]
tags = list(platform_tags(archs))
print(tags)
# Output: ['musllinux_1_2_x86_64', 'musllinux_1_1_x86_64', 'musllinux_1_0_x86_64']
```

## Command Line Usage

The module can be executed directly for debugging:

```bash
python -m packaging._musllinux
```

**Sample Output:**
```
plat: linux-x86_64
musl: _MuslVersion(major=1, minor=2)
tags: musllinux_1_2_x86_64
      musllinux_1_1_x86_64
      musllinux_1_0_x86_64
```

## Notes and Considerations

### ‚ö†Ô∏è Important Notes

- **Linux Prerequisite**: Only works on Linux systems (requires `linux-` platform prefix)
- **ELF Dependency**: Relies on ELF file format parsing
- **Performance**: Uses caching to avoid repeated subprocess calls
- **Error Handling**: Gracefully handles missing/invalid executables

### üîç Technical Details

- **Version Compatibility**: Generates tags for current version and all lower minor versions
- **Architecture Support**: Supports multiple architectures in priority order
- **Subprocess Safety**: Uses `stderr` capture to get loader version information

### üí° Suggestions

1. **Error Logging**: Consider adding logging for debugging detection failures
2. **Architecture Validation**: Could benefit from architecture name validation
3. **Caching Strategy**: The LRU cache is effective but consider cache size limits for long-running applications
4. **Testing**: Ensure thorough testing across different musl versions and architectures

## Related Standards

- **PEP 656**: Platform Tag for Linux Distributions Using Musl
- **ELF Format**: Executable and Linkable Format specification
- **Platform Tags**: Python packaging platform identification system