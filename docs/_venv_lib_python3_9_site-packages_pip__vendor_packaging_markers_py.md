<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Marker Module Documentation

## Overview

This module implements Python package dependency markers as defined in [PEP 508](https://peps.python.org/pep-0508/). Markers are used to specify conditional dependencies that should only be installed when certain conditions are met (e.g., specific Python versions, operating systems, or extras).

## Purpose

The primary purpose of this module is to:
- Parse and validate marker strings from package specifications
- Evaluate markers against the current environment or a custom environment
- Provide utilities for working with environment markers in Python packaging

## Key Classes and Functions

### Classes

#### `Marker`

The main class for working with dependency markers.

```python
marker = Marker("python_version >= '3.8'")
```

**Methods:**
- `__init__(marker: str)` - Creates a marker from a string expression
- `evaluate(environment=None, context="metadata")` - Evaluates the marker against an environment
- `__str__()` - Returns the normalized string representation
- `__eq__()` - Compares markers for equality

#### Exception Classes

- **`InvalidMarker(ValueError)`** - Raised when an invalid marker string is provided
- **`UndefinedComparison(ValueError)`** - Raised when an invalid operation is attempted
- **`UndefinedEnvironmentName(ValueError)`** - Raised when referencing a non-existent environment variable

### Type Definitions

#### `Environment`

A TypedDict that defines all available environment variables for marker evaluation:

```python
class Environment(TypedDict):
    implementation_name: str          # e.g., 'cpython'
    implementation_version: str       # e.g., '3.13.0a2'
    os_name: str                     # e.g., 'posix'
    platform_machine: str           # e.g., 'x86_64'
    platform_release: str           # e.g., '5.4.0'
    platform_system: str            # e.g., 'Linux'
    platform_version: str           # e.g., '#1 SMP Wed Mar 2 00:30:59 UTC 2022'
    python_full_version: str        # e.g., '3.11.2'
    platform_python_implementation: str  # e.g., 'CPython'
    python_version: str             # e.g., '3.11'
    sys_platform: str               # e.g., 'linux'
```

#### `EvaluateContext`

Defines the context in which markers are evaluated:
- `"metadata"` - For core metadata (default)
- `"lock_file"` - For lock files
- `"requirement"` - For all other situations

### Key Functions

#### `default_environment() -> Environment`

Returns the current Python environment as an `Environment` dictionary.

```python
env = default_environment()
print(env['python_version'])  # e.g., '3.11'
```

#### `format_full_version(info: sys._version_info) -> str`

Formats a version info tuple into a full version string.

## Usage Examples

### Basic Marker Creation and Evaluation

```python
from packaging.markers import Marker

# Create a marker
marker = Marker("python_version >= '3.8'")

# Evaluate against current environment
result = marker.evaluate()  # Returns True/False

# Evaluate with custom environment
custom_env = {"python_version": "3.7"}
result = marker.evaluate(environment=custom_env)  # False
```

### Complex Marker Expressions

```python
# Multiple conditions
marker = Marker("python_version >= '3.8' and sys_platform == 'linux'")

# With extras
marker = Marker("extra == 'dev'")

# Combined conditions
marker = Marker("python_version >= '3.8' or (python_version == '3.7' and platform_system == 'Windows')")
```

### Working with Different Contexts

```python
marker = Marker("extra == 'test'")

# For package metadata
result = marker.evaluate(context="metadata")

# For lock files
result = marker.evaluate(context="lock_file")
```

## Internal Implementation Details

### Key Internal Functions

- **`_evaluate_markers()`** - Core evaluation logic for parsed marker expressions
- **`_normalize_extra_values()`** - Normalizes extra names according to PEP 503
- **`_format_marker()`** - Converts parsed markers back to string format
- **`_eval_op()`** - Evaluates individual comparison operations

### Supported Operators

The module supports standard comparison operators:
- `in`, `not in` - Set membership
- `<`, `<=`, `==`, `!=`, `>=`, `>` - Version and string comparisons

## Notes and Suggestions

### Best Practices

1. **Always handle exceptions** when creating markers from user input:
   ```python
   try:
       marker = Marker(user_input)
   except InvalidMarker as e:
       print(f"Invalid marker: {e}")
   ```

2. **Use appropriate context** when evaluating markers:
   - Use `"metadata"` for package metadata
   - Use `"lock_file"` for dependency resolution
   - Use `"requirement"` for general dependency checking

3. **Cache marker objects** when possible, as parsing can be expensive for complex expressions.

### Compatibility Notes

- The module handles backwards compatibility for `extra` values that might be `None`
- Python version strings are automatically repaired for non-standard builds (e.g., development builds with `+` suffix)
- Extra names are automatically normalized according to PEP 503 and PEP 685

### Dependencies

This module depends on:
- `._parser` - For parsing marker expressions
- `._tokenizer` - For tokenization and syntax error handling
- `.specifiers` - For version specifier handling
- `.utils` - For name canonicalization