<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# requests._internal_utils

## Overview

This module provides internal utility functions for the Requests library that handle string encoding, decoding, and HTTP header validation. It is designed to depend on minimal external helpers and focuses on low-level string manipulation tasks that are commonly needed throughout the Requests codebase.

## Purpose

The module serves as a collection of internal utilities for:
- Converting strings between different encodings
- Validating HTTP header names and values
- Checking ASCII compatibility of Unicode strings

## Constants

### Header Validation Regular Expressions

The module defines several regular expressions for validating HTTP headers:

```python
_VALID_HEADER_NAME_RE_BYTE = re.compile(rb"^[^:\s][^:\r\n]*$")
_VALID_HEADER_NAME_RE_STR = re.compile(r"^[^:\s][^:\r\n]*$")
_VALID_HEADER_VALUE_RE_BYTE = re.compile(rb"^\S[^\r\n]*$|^$")
_VALID_HEADER_VALUE_RE_STR = re.compile(r"^\S[^\r\n]*$|^$")
```

#### Header Name Validation Rules
- Must not start with a colon (`:`) or whitespace
- Must not contain colons, carriage returns (`\r`), or newlines (`\n`)

#### Header Value Validation Rules
- Must start with a non-whitespace character OR be empty
- Must not contain carriage returns (`\r`) or newlines (`\n`)

### HEADER_VALIDATORS Dictionary

```python
HEADER_VALIDATORS = {
    bytes: _HEADER_VALIDATORS_BYTE,
    str: _HEADER_VALIDATORS_STR,
}
```

Maps data types (`bytes`, `str`) to their corresponding header validation regex patterns, allowing type-appropriate validation.

## Functions

### `to_native_string(string, encoding="ascii")`

Converts any string type to the native string type for the current Python version.

**Parameters:**
- `string`: Input string (can be bytes or str)
- `encoding`: Character encoding to use for decoding (default: "ascii")

**Returns:**
- Native string representation

**Usage Example:**
```python
# Convert bytes to string
result = to_native_string(b"hello")  # Returns "hello"

# Already a string
result = to_native_string("hello")   # Returns "hello"
```

### `unicode_is_ascii(u_string)`

Determines whether a Unicode string contains only ASCII characters.

**Parameters:**
- `u_string` (str): Unicode string to check

**Returns:**
- `bool`: True if string contains only ASCII characters, False otherwise

**Usage Example:**
```python
unicode_is_ascii("hello")      # Returns True
unicode_is_ascii("h√©llo")      # Returns False
unicode_is_ascii("Hello123!")  # Returns True
```

## Dependencies

- `re`: Standard library regular expressions module
- `.compat.builtin_str`: Compatibility helper for string types across Python versions

## Notes and Suggestions

### Security Considerations
- The header validation regexes help prevent HTTP header injection attacks by ensuring headers conform to expected formats
- Always validate headers before sending HTTP requests

### Performance Notes
- Regular expressions are compiled at module import time for better performance
- The `unicode_is_ascii()` function uses exception handling for control flow, which is acceptable since ASCII-only strings are common

### Usage Guidelines
- This module is intended for internal use within the Requests library
- External users should prefer the public API functions rather than these internal utilities
- The `to_native_string()` function is particularly useful for Python 2/3 compatibility scenarios

### Potential Improvements
- Consider adding type hints for better IDE support and documentation
- The `unicode_is_ascii()` function could benefit from input validation to handle None values gracefully