<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Requests Transport Adapters

This module contains the transport adapters that Requests uses to define and maintain connections. It provides the core HTTP connection handling functionality for the Requests library.

## Purpose

The adapters module serves as an abstraction layer between the high-level Requests API and the underlying urllib3 connection management. It handles:

- HTTP/HTTPS connection pooling
- SSL/TLS certificate verification
- Proxy support (HTTP, HTTPS, SOCKS)
- Request/response lifecycle management
- Error handling and exception translation

## Key Components

### Constants

```python
DEFAULT_POOLBLOCK = False
DEFAULT_POOLSIZE = 10
DEFAULT_RETRIES = 0
DEFAULT_POOL_TIMEOUT = None
```

These constants define default values for connection pool behavior.

### Helper Functions

#### `_urllib3_request_context()`

```python
def _urllib3_request_context(request, verify, client_cert, poolmanager):
```

**Purpose**: Builds the context parameters needed for urllib3 connections, including SSL/TLS settings.

**Parameters**:
- `request`: The PreparedRequest object
- `verify`: SSL verification setting (bool or CA bundle path)
- `client_cert`: Client certificate for mTLS
- `poolmanager`: The urllib3 PoolManager instance

**Returns**: Tuple of (host_params, pool_kwargs) dictionaries

## Main Classes

### `BaseAdapter`

**Purpose**: Abstract base class for all transport adapters.

**Key Methods**:
- `send()`: Must be implemented by subclasses to handle request sending
- `close()`: Must be implemented to clean up adapter resources

### `HTTPAdapter`

**Purpose**: The main HTTP/HTTPS transport adapter using urllib3.

#### Constructor Parameters

```python
def __init__(
    self,
    pool_connections=DEFAULT_POOLSIZE,    # Number of connection pools to cache
    pool_maxsize=DEFAULT_POOLSIZE,        # Max connections per pool
    max_retries=DEFAULT_RETRIES,          # Retry configuration
    pool_block=DEFAULT_POOLBLOCK          # Whether to block when pool is full
):
```

#### Key Methods

##### Connection Management

- **`init_poolmanager()`**: Initializes the urllib3 PoolManager
- **`get_connection_with_tls_context()`**: Returns a connection with proper TLS settings
- **`get_connection()`**: ⚠️ **DEPRECATED** - Use `get_connection_with_tls_context()` instead

##### SSL/TLS Handling

- **`cert_verify()`**: Configures SSL certificate verification
- **`build_connection_pool_key_attributes()`**: Builds pool key attributes for connection reuse

##### Proxy Support

- **`proxy_manager_for()`**: Returns appropriate proxy manager (HTTP/HTTPS/SOCKS)
- **`proxy_headers()`**: Adds authentication headers for proxies

##### Request/Response Processing

- **`send()`**: Main method that sends requests and returns responses
- **`build_response()`**: Converts urllib3 response to Requests Response object
- **`request_url()`**: Determines the final URL to use for the request
- **`add_headers()`**: Hook for adding custom headers (no-op by default)

## Usage Examples

### Basic Usage

```python
import requests

# HTTPAdapter is used automatically by Sessions
session = requests.Session()
response = session.get('https://httpbin.org/get')
```

### Custom Adapter Configuration

```python
import requests
from requests.adapters import HTTPAdapter

# Create adapter with custom settings
adapter = HTTPAdapter(
    pool_connections=20,
    pool_maxsize=20,
    max_retries=3
)

# Mount adapter to session
session = requests.Session()
session.mount('https://', adapter)
session.mount('http://', adapter)
```

### Subclassing HTTPAdapter

```python
class CustomHTTPAdapter(HTTPAdapter):
    def add_headers(self, request, **kwargs):
        # Add custom headers to all requests
        request.headers['X-Custom-Header'] = 'MyValue'
        super().add_headers(request, **kwargs)
```

## Error Handling

The adapter translates urllib3 exceptions to Requests exceptions:

- `MaxRetryError` → `ConnectionError`, `ConnectTimeout`, `RetryError`
- `SSLError` → `SSLError`
- `ProxyError` → `ProxyError`
- `ReadTimeoutError` → `ReadTimeout`
- `InvalidHeader` → `InvalidHeader`

## Important Notes

### SSL Context Optimization

The module pre-loads an SSL context (`_preloaded_ssl_context`) with default CA certificates to optimize performance for standard HTTPS requests.

### Proxy Support

- Supports HTTP, HTTPS, and SOCKS proxies
- SOCKS support requires additional dependencies
- Automatic proxy authentication from URL credentials

### Connection Pooling

- Uses urllib3's connection pooling for efficiency
- Pools are reused based on host, port, and SSL settings
- Proper cleanup via `close()` method

### Deprecation Warning

⚠️ **The `get_connection()` method is deprecated**. When subclassing `HTTPAdapter`, use `get_connection_with_tls_context()` instead for Requests >= 2.32.2.

## Dependencies

This module requires:
- `urllib3` (via pip._vendor.urllib3)
- `ssl` module (for SSL/TLS support)
- Optional: SOCKS proxy dependencies for SOCKS support