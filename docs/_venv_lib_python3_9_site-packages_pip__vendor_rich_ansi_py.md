<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# ANSI Decoder Module

This module provides functionality to parse and decode ANSI escape sequences from terminal output, converting them into styled text objects that can be rendered with proper formatting.

## Purpose

The module is designed to:
- Parse ANSI escape codes from terminal text
- Convert ANSI styling codes into Rich library's `Text` objects with appropriate styling
- Handle various ANSI features including colors, text styles, and hyperlinks
- Provide a way to capture and convert terminal output for display or storage

## Key Components

### Regular Expression Pattern

```python
re_ansi = re.compile(
    r"""
(?:\x1b[0-?])|
(?:\x1b\](.*?)\x1b\\)|
(?:\x1b([(@-Z\\-_]|\[[0-?]*[ -/]*[@-~]))
""",
    re.VERBOSE,
)
```

This regex pattern matches various ANSI escape sequences including:
- Basic escape sequences
- OSC (Operating System Command) sequences for hyperlinks
- SGR (Select Graphic Rendition) sequences for styling

### Classes and Data Structures

#### `_AnsiToken` (NamedTuple)

A simple data structure representing a tokenized piece of ANSI text:

```python
class _AnsiToken(NamedTuple):
    plain: str = ""        # Plain text content
    sgr: Optional[str] = "" # SGR (styling) codes
    osc: Optional[str] = "" # OSC (operating system command) codes
```

#### `AnsiDecoder` Class

The main class that handles ANSI code translation:

```python
class AnsiDecoder:
    def __init__(self) -> None:
        self.style = Style.null()
```

**Key Methods:**

- **`decode(terminal_text: str) -> Iterable[Text]`**
  - Decodes multiple lines of ANSI text
  - Splits input by lines and processes each one
  - Returns an iterable of `Text` objects

- **`decode_line(line: str) -> Text`**
  - Processes a single line of ANSI text
  - Handles various ANSI codes including colors, styles, and links
  - Returns a single `Text` object with appropriate styling

### Helper Functions

#### `_ansi_tokenize(ansi_text: str) -> Iterable[_AnsiToken]`

Tokenizes ANSI text into components:
- Separates plain text from ANSI escape sequences
- Identifies SGR and OSC codes
- Yields `_AnsiToken` objects for processing

### Style Mapping

The `SGR_STYLE_MAP` dictionary maps ANSI SGR codes to Rich library style strings:

```python
SGR_STYLE_MAP = {
    1: "bold",
    2: "dim",
    3: "italic",
    # ... more mappings for colors and styles
}
```

**Supported Features:**
- Text styles (bold, italic, underline, etc.)
- 16 basic colors (both foreground and background)
- 256-color palette support
- 24-bit RGB color support
- Hyperlinks via OSC sequences

## Usage Example

```python
decoder = AnsiDecoder()

# Decode a single line
ansi_text = "\x1b[1;31mBold Red Text\x1b[0m"
styled_text = decoder.decode_line(ansi_text)

# Decode multiple lines
multi_line_text = "Line 1\nLine 2 with \x1b[32mgreen\x1b[0m text"
for line in decoder.decode(multi_line_text):
    print(line)
```

## Command Line Usage

When run as a script on non-Windows platforms, the module can capture terminal output:

```bash
python -m ansi_module command_to_run
```

This will:
- Execute the specified command in a pseudo-terminal
- Capture the ANSI output
- Convert it to styled text
- Save the result as HTML

## Notes and Considerations

### Limitations
- **Windows Compatibility**: The command-line functionality is disabled on Windows due to `pty` module limitations
- **Error Handling**: The decoder is designed to be lenient with invalid ANSI codes
- **Performance**: Uses iterators for memory efficiency with large text inputs

### Dependencies
- Requires Rich library components (`Color`, `Style`, `Text`)
- Uses Python standard library modules (`re`, `sys`, `contextlib`)

### Best Practices
- Create a single `AnsiDecoder` instance and reuse it for consistent styling state
- The decoder maintains internal state, so the order of processing matters
- Use `Style.null()` to reset styling when needed

## Technical Details

The decoder handles complex ANSI sequences including:
- **Reset codes** (code 0): Clears all styling
- **256-color mode** (codes 38;5;n and 48;5;n): Extended color palette
- **RGB mode** (codes 38;2;r;g;b and 48;2;r;g;b): True color support
- **Hyperlinks** (OSC 8): Terminal hyperlink support
- **Carriage returns**: Handles `\r` characters for terminal overwrites