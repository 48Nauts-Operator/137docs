<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Cell Width Utilities

This module provides utilities for calculating and manipulating text display widths in terminal or console environments, with special handling for Unicode characters that may occupy different cell widths (like CJK characters and emojis).

## Purpose

The module addresses the challenge of properly measuring and formatting text that contains characters with varying display widths:
- **Single-width characters**: Most Latin characters, numbers, symbols (1 cell)
- **Double-width characters**: CJK characters, some emojis (2 cells) 
- **Zero-width characters**: Control characters, combining characters (0 cells)

This is essential for creating properly aligned text output in terminals and console applications.

## Key Components

### Constants and Data Structures

#### `_SINGLE_CELL_UNICODE_RANGES`
```python
_SINGLE_CELL_UNICODE_RANGES: list[tuple[int, int]]
```
- Defines Unicode ranges for characters that occupy exactly 1 cell
- Covers common Western characters, Greek, Cyrillic, box drawing, and Braille
- **Note**: Non-exhaustive list focusing on most common single-width characters

#### `_SINGLE_CELLS`
```python
_SINGLE_CELLS = frozenset([...])
```
- Pre-computed set of all single-cell characters for fast lookup
- Used for optimization when checking if entire strings contain only single-width characters

### Core Functions

#### `get_character_cell_size(character: str) -> int`
```python
@lru_cache(maxsize=4096)
def get_character_cell_size(character: str) -> int:
```
- **Purpose**: Determines the display width of a single character
- **Returns**: 0, 1, or 2 (number of cells occupied)
- **Implementation**: Uses binary search on `CELL_WIDTHS` table for efficiency
- **Caching**: LRU cache with 4096 entries for performance optimization

#### `cell_len(text: str) -> int`
```python
def cell_len(text: str, _cell_len: Callable[[str], int] = cached_cell_len) -> int:
```
- **Purpose**: Calculates total display width of a text string
- **Optimization**: 
  - For strings < 512 characters: uses cached version
  - For longer strings: avoids caching to prevent memory issues
  - Fast path for single-cell-only text

#### `cached_cell_len(text: str) -> int`
```python
@lru_cache(4096)
def cached_cell_len(text: str) -> int:
```
- **Purpose**: Cached version of cell length calculation
- **Warning**: Always caches results - may consume significant memory
- **Recommendation**: Use `cell_len()` instead for general purposes

### Text Manipulation Functions

#### `set_cell_size(text: str, total: int) -> str`
```python
def set_cell_size(text: str, total: int) -> str:
```
- **Purpose**: Adjusts text to fit exactly within specified cell width
- **Behavior**:
  - Pads with spaces if text is shorter than target width
  - Truncates if text is longer than target width
  - Handles double-width characters properly (replaces with space if cut in half)
- **Algorithm**: Uses binary search for efficient truncation

#### `chop_cells(text: str, width: int) -> list[str]`
```python
def chop_cells(text: str, width: int) -> list[str]:
```
- **Purpose**: Splits text into lines that fit within specified cell width
- **Returns**: List of strings, each fitting within the width constraint
- **Use Case**: Text wrapping for fixed-width displays

## Usage Examples

```python
# Get character width
width = get_character_cell_size("A")      # Returns 1
width = get_character_cell_size("ä¸­")     # Returns 2
width = get_character_cell_size("ðŸ˜½")     # Returns 2

# Calculate text width
total = cell_len("Hello ä¸–ç•Œ")            # Returns 9 (5 + 1 + 2 + 2)

# Fit text to specific width
fitted = set_cell_size("Hello", 10)       # Returns "Hello     "
fitted = set_cell_size("Very long text", 5)  # Returns "Very "

# Split text into lines
lines = chop_cells("Helloä¸–ç•ŒTest", 6)     # Split to fit 6-cell width
```

## Performance Considerations

- **Caching**: Functions use LRU caching for frequently accessed characters
- **Memory**: Be cautious with `cached_cell_len()` on large datasets
- **Optimization**: Fast path detection for single-width text
- **Binary Search**: Efficient character width lookup

## Dependencies

- `._cell_widths.CELL_WIDTHS`: External table containing Unicode width data
- Requires Python 3.9+ (uses `from __future__ import annotations`)

## Notes and Suggestions

- **Memory Usage**: Monitor memory consumption when processing large amounts of text
- **Accuracy**: Width calculations depend on the completeness of `CELL_WIDTHS` data
- **Terminal Compatibility**: Results may vary between different terminal implementations
- **Testing**: Test with your target terminal/console for accurate results