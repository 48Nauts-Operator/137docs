<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# backports.makefile

## Overview

This module provides a backport of Python 3's `socket.makefile()` method, enabling compatibility with older Python versions or custom socket-like objects that need file-like interface capabilities.

## Purpose

The `backports.makefile` module allows you to:
- Create file-like objects from socket objects
- Maintain compatibility across different Python versions
- Enable buffered I/O operations on socket connections
- Support both text and binary modes with proper encoding handling

## Functions

### `backport_makefile()`

```python
def backport_makefile(
    self, mode="r", buffering=None, encoding=None, errors=None, newline=None
):
```

Backports the `socket.makefile()` functionality from Python 3.5, converting a socket object into a file-like object.

#### Parameters

- **`self`** - The socket object to convert
- **`mode`** (str, optional) - File access mode. Default: `"r"`
  - `"r"` - Read mode
  - `"w"` - Write mode  
  - `"b"` - Binary mode
  - Can be combined (e.g., `"rb"`, `"wb"`)
- **`buffering`** (int, optional) - Buffer size control
  - `None` - Use default buffering
  - `-1` - Use `io.DEFAULT_BUFFER_SIZE`
  - `0` - Unbuffered (binary mode only)
  - `> 0` - Specific buffer size
- **`encoding`** (str, optional) - Text encoding for text mode
- **`errors`** (str, optional) - Error handling scheme for encoding/decoding
- **`newline`** (str, optional) - Newline handling for text mode

#### Returns

Returns different types of file-like objects based on the mode:
- **Binary mode**: Raw `SocketIO` or buffered binary stream
- **Text mode**: `TextIOWrapper` around buffered stream
- **Read/Write**: `BufferedRWPair`, `BufferedReader`, or `BufferedWriter`

#### Raises

- **`ValueError`**: 
  - Invalid mode characters (only `r`, `w`, `b` allowed)
  - Unbuffered streams in text mode

## Implementation Details

### Mode Processing
```python
writing = "w" in mode
reading = "r" in mode or not writing
binary = "b" in mode
```

### Buffer Management
- Creates appropriate buffered I/O objects based on read/write requirements
- Handles special case of unbuffered binary streams
- Uses `io.DEFAULT_BUFFER_SIZE` when buffering is unspecified

### Stream Types
- **Read-only**: `io.BufferedReader`
- **Write-only**: `io.BufferedWriter` 
- **Read-write**: `io.BufferedRWPair`
- **Text mode**: `io.TextIOWrapper` wrapping buffered streams

## Usage Notes

⚠️ **Important Considerations**:

- The socket object must have a `_makefile_refs` attribute that gets incremented
- This function is designed to be used as a method on socket-like objects
- Unbuffered mode (`buffering=0`) only works with binary mode
- The returned file object maintains a reference to the original socket

## Example Usage

```python
# Typical usage as a socket method
socket_obj._makefile_refs = 0  # Initialize reference counter
file_obj = backport_makefile(socket_obj, mode="r", encoding="utf-8")

# Binary mode
binary_file = backport_makefile(socket_obj, mode="rb", buffering=4096)

# Write mode
write_file = backport_makefile(socket_obj, mode="w", encoding="utf-8")
```

## Dependencies

- `io` - Python's core I/O library
- `socket.SocketIO` - Low-level socket I/O implementation