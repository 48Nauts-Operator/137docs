<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# B64 Extension for Python Markdown

## Overview

The B64 extension for Python Markdown automatically converts local image references in HTML to base64-encoded data URIs. This allows images to be embedded directly into HTML documents, eliminating the need for separate image files.

## Purpose

- **Embed Images**: Converts local image file references to base64-encoded data URIs
- **Self-contained Documents**: Creates HTML documents with embedded images that don't require external files
- **Markdown Processing**: Integrates seamlessly with Python Markdown's processing pipeline

## Supported Image Formats

The extension supports the following image formats:

- **PNG** (`.png`) → `image/png`
- **JPEG** (`.jpg`, `.jpeg`) → `image/jpeg`
- **GIF** (`.gif`) → `image/gif`
- **SVG** (`.svg`) → `image/svg+xml`

## Key Components

### Classes

#### `B64Extension`

The main extension class that integrates with Python Markdown.

**Configuration:**
- `base_path`: Base directory path for resolving relative image paths (default: `"."`)

**Methods:**
- `extendMarkdown(md)`: Registers the B64 postprocessor with the Markdown instance

#### `B64Postprocessor`

Handles the actual processing of HTML content to replace image sources with base64 data.

**Methods:**
- `run(text)`: Processes HTML text and replaces local image references with base64 data URIs

### Key Functions

#### `repl_path(m, base_path)`

Replaces an image path with base64-encoded data.

**Parameters:**
- `m`: Regex match object containing the image path
- `base_path`: Base directory for resolving relative paths

**Process:**
1. Parses the image URL/path
2. Resolves absolute file path
3. Checks if file exists and has supported extension
4. Reads file and encodes as base64
5. Returns data URI string

#### `repl(m, base_path)`

Main replacement function that processes entire image tags.

**Parameters:**
- `m`: Regex match object for HTML image tag
- `base_path`: Base directory for path resolution

## Usage

### Basic Usage

```python
import markdown
from b64 import B64Extension

# Create Markdown instance with B64 extension
md = markdown.Markdown(extensions=[B64Extension()])

# Process markdown with local images
text = '![Alt text](./images/photo.jpg)'
html = md.convert(text)
```

### With Custom Base Path

```python
md = markdown.Markdown(extensions=[B64Extension(base_path='/path/to/images')])
```

### Using makeExtension Function

```python
from b64 import makeExtension

md = markdown.Markdown(extensions=[makeExtension(base_path='/custom/path')])
```

## Example Transformation

**Before:**
```html
<img src="./images/photo.jpg" alt="Photo">
```

**After:**
```html
<img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD..." alt="Photo">
```

## Important Notes

### Security Considerations

- ⚠️ **File Access**: The extension reads files from the local filesystem based on image paths
- ⚠️ **Path Traversal**: Ensure `base_path` is properly configured to prevent unauthorized file access
- ⚠️ **File Size**: Base64 encoding increases file size by ~33%, which can significantly impact document size

### Performance Considerations

- **Large Images**: Embedding large images can create very large HTML files
- **Memory Usage**: All image data is loaded into memory during processing
- **Processing Time**: File I/O operations may slow down Markdown processing

### Limitations

- **Local Files Only**: Only processes local image files, not remote URLs
- **File Extensions**: Only processes files with recognized image extensions
- **Error Handling**: Silently ignores files that can't be processed (file not found, permission errors, etc.)

## Regular Expressions

The extension uses sophisticated regex patterns:

- `RE_TAG_HTML`: Matches HTML image tags while avoiding script/style tags and comments
- `RE_TAG_LINK_ATTR`: Extracts the `src` attribute from image tags
- `RE_SLASH_WIN_DRIVE`: Handles Windows drive letter paths

## License

MIT License - See file header for full license text.

## Dependencies

- `markdown`: Python Markdown library
- `base64`: Python standard library
- `os`: Python standard library  
- `re`: Python standard library