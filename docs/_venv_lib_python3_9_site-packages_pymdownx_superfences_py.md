<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# SuperFences Extension Documentation

## Overview

The **SuperFences** extension is a modified version of Python Markdown's Fenced Code Blocks extension that provides enhanced functionality for nested fenced code blocks. It allows fenced blocks to be used within blockquotes, lists, and other nested structures, while also supporting special UML fences for diagrams.

## Purpose

This extension extends the standard fenced code block functionality by:

- Supporting nested fenced blocks in blockquotes, lists, and other structures
- Providing custom fence validators and formatters
- Handling special UML fences (e.g., 'flow' for flowcharts, 'sequence' for sequence diagrams)
- Offering enhanced syntax highlighting capabilities
- Supporting tab preservation and relaxed header parsing

## Key Components

### Classes

#### `SuperFencesCodeExtension`
The main extension class that configures and registers the SuperFences functionality.

**Configuration Options:**
- `disable_indented_code_blocks`: Disable standard indented code blocks (default: False)
- `custom_fences`: Specify custom fence configurations (default: [])
- `css_class`: Set CSS class name for wrapper elements (default: '')
- `preserve_tabs`: Preserve tabs in fences (default: False)
- `relaxed_headers`: Allow relaxed fenced code headers (default: False)

#### `SuperFencesBlockPreprocessor`
Preprocessor that finds and processes fenced code blocks before other markdown processing.

**Key Methods:**
- `search_nested()`: Main method for finding nested fenced blocks
- `highlight()`: Syntax highlighting for code blocks
- `parse_options()`: Parse fence header options and validate them

#### `CodeStash`
Utility class for temporarily storing code blocks that may need to be restored if processing was too aggressive.

**Methods:**
- `store(key, code, indent_level)`: Store code with its indentation level
- `get(key, default=None)`: Retrieve stored code
- `remove(key)`: Remove code from stash
- `clear_stash()`: Clear all stored code

#### `SuperFencesCodeBlockProcessor`
Handles indented code blocks and can revert prematurely processed fenced blocks.

### Important Functions

#### `fence_code_format(source, language, class_name, options, md, **kwargs)`
Default formatter for code blocks that outputs HTML `<pre><code>` structure.

```python
# Example output:
<pre class="highlight"><code class="language-python">print("Hello World")</code></pre>
```

#### `fence_div_format(source, language, class_name, options, md, **kwargs)`
Alternative formatter that wraps content in `<div>` tags instead of `<pre><code>`.

#### `highlight_validator(language, inputs, options, attrs, md)`
Validator for syntax highlighting options like `hl_lines`, `linenums`, and `title`.

#### `default_validator(language, inputs, options, attrs, md)`
Default validator that accepts all inputs as attributes.

## Usage Examples

### Basic Fenced Code Block
```markdown
```python
print("Hello World")
```
```

### With Syntax Highlighting Options
```markdown
```python hl_lines="1 3" linenums="1"
def hello():
    print("Hello")
    return True
```
```

### Custom Fence Configuration
```python
extension_configs = {
    'pymdownx.superfences': {
        'custom_fences': [
            {
                'name': 'mermaid',
                'class': 'mermaid',
                'format': custom_mermaid_formatter
            }
        ]
    }
}
```

### In Blockquotes
```markdown
> Here's some code in a blockquote:
> 
> ```python
> print("This works!")
> ```
```

## Regular Expressions

The extension uses several important regex patterns:

- `RE_NESTED_FENCE_START`: Matches the start of fenced blocks with optional language and attributes
- `RE_HL_LINES`: Validates highlight line specifications
- `RE_LINENUMS`: Parses line numbering options
- `RE_OPTIONS`: Extracts key-value options from fence headers

## Error Handling

The extension includes a custom `SuperFencesException` for handling fence processing failures and implements graceful fallbacks when validation fails.

## Integration Notes

- Works with the `pymdownx.highlight` extension for advanced syntax highlighting
- Supports attribute lists when the `attr_list` extension is enabled  
- Can preserve tabs when `preserve_tabs` is enabled
- Integrates with blockquote and list processing

## Suggestions

1. **Performance**: For documents with many code blocks, consider enabling `disable_indented_code_blocks` if you only use fenced blocks
2. **Customization**: Use custom fences for specialized content like diagrams or math expressions
3. **Validation**: Implement custom validators for strict option parsing in custom fences
4. **CSS**: Set appropriate CSS classes for styling different fence types

## Dependencies

- `markdown.extensions.Extension`
- `markdown.preprocessors.Preprocessor` 
- `markdown.blockprocessors.CodeBlockProcessor`
- `markdown.extensions.attr_list.get_attrs` (optional)
- `pymdownx.highlight` (for syntax highlighting)