<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# requests._internal_utils

## Overview

This module provides internal utility functions for the Requests library that handle string encoding, decoding, and HTTP header validation. It is designed to have minimal external dependencies and focuses on core string manipulation and validation tasks needed throughout the Requests codebase.

## Purpose

The module serves as a collection of low-level utility functions that:
- Handle string type conversions between bytes and unicode
- Validate HTTP header names and values according to HTTP specifications
- Provide ASCII encoding validation for unicode strings
- Maintain compatibility across different Python versions

## Constants and Regular Expressions

### Header Validation Patterns

The module defines several compiled regular expressions for validating HTTP headers:

```python
_VALID_HEADER_NAME_RE_BYTE = re.compile(rb"^[^:\s][^:\r\n]*$")
_VALID_HEADER_NAME_RE_STR = re.compile(r"^[^:\s][^:\r\n]*$")
_VALID_HEADER_VALUE_RE_BYTE = re.compile(rb"^\S[^\r\n]*$|^$")
_VALID_HEADER_VALUE_RE_STR = re.compile(r"^\S[^\r\n]*$|^$")
```

**Header Name Validation Rules:**
- Must not start with a colon (`:`) or whitespace
- Must not contain colons, carriage returns (`\r`), or newlines (`\n`)

**Header Value Validation Rules:**
- Must start with a non-whitespace character OR be empty
- Must not contain carriage returns (`\r`) or newlines (`\n`)

### Header Validators Dictionary

```python
HEADER_VALIDATORS = {
    bytes: _HEADER_VALIDATORS_BYTE,
    str: _HEADER_VALIDATORS_STR,
}
```

This dictionary maps Python types (`bytes` and `str`) to their corresponding validation regex patterns, allowing the validation logic to work with both string types.

## Functions

### `to_native_string(string, encoding="ascii")`

Converts any string type to the native string type for the current Python version.

**Parameters:**
- `string`: Input string (can be bytes or str)
- `encoding` (optional): Encoding to use for decoding bytes (default: "ascii")

**Returns:**
- Native string representation

**Usage Example:**
```python
# Convert bytes to string
result = to_native_string(b"hello")  # Returns "hello"

# String input returns unchanged
result = to_native_string("hello")   # Returns "hello"

# Custom encoding
result = to_native_string(b"caf\xe9", encoding="latin1")  # Returns "café"
```

### `unicode_is_ascii(u_string)`

Determines whether a unicode string contains only ASCII characters.

**Parameters:**
- `u_string` (str): Unicode string to validate (must be `str` type)

**Returns:**
- `bool`: `True` if string contains only ASCII characters, `False` otherwise

**Usage Example:**
```python
unicode_is_ascii("hello")      # Returns True
unicode_is_ascii("héllo")      # Returns False
unicode_is_ascii("123!@#")     # Returns True
```

**Note:** This function includes an assertion to ensure the input is a `str` type, not bytes.

## Dependencies

- `re`: Standard library regular expression module
- `.compat.builtin_str`: Internal compatibility helper for string type handling

## Usage Notes

### Important Considerations

- **Internal Use Only**: This module is designed for internal use within the Requests library
- **Minimal Dependencies**: Intentionally keeps external dependencies to a minimum
- **Type Safety**: Functions include type checking and assertions to prevent misuse
- **HTTP Compliance**: Header validation follows HTTP specification requirements

### Best Practices

- Use `to_native_string()` when you need consistent string type handling across Python versions
- Use `unicode_is_ascii()` to validate that strings can be safely encoded as ASCII before transmission
- The header validators are designed to work with the broader Requests header validation system

### Potential Issues

- The `unicode_is_ascii()` function will raise an `AssertionError` if passed a non-string type
- Default ASCII encoding in `to_native_string()` may cause issues with non-ASCII byte strings
- Header validation patterns are strict and may reject some edge cases that could be technically valid

## Related Modules

This utility module works in conjunction with:
- `requests.compat` - Compatibility layer for different Python versions
- Other internal Requests modules that handle HTTP headers and string processing