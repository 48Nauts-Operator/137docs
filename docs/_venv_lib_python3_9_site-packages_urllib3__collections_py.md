<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTTP Data Structures Documentation

This Python module provides specialized data structures for HTTP-related operations, including a recently-used cache container and an HTTP header dictionary with case-insensitive operations.

## Overview

The module contains two main classes:
- `RecentlyUsedContainer`: A thread-safe LRU (Least Recently Used) cache implementation
- `HTTPHeaderDict`: A specialized dictionary for HTTP headers with case-insensitive key handling

## Classes

### RecentlyUsedContainer

A thread-safe dictionary-like container that maintains a maximum number of items while automatically evicting the least recently used entries.

#### Purpose
- Provides LRU caching functionality
- Thread-safe operations using `RLock`
- Optional cleanup callback for evicted items
- Generic implementation supporting any key-value types

#### Constructor Parameters
```python
RecentlyUsedContainer(maxsize: int = 10, dispose_func: Callable[[_VT], None] | None = None)
```

- **maxsize**: Maximum number of items to retain (default: 10)
- **dispose_func**: Optional callback function called when items are evicted

#### Key Features
- **Thread Safety**: All operations are protected by an `RLock`
- **LRU Behavior**: Accessing an item moves it to the end of the eviction queue
- **Automatic Cleanup**: Calls `dispose_func` on evicted values if provided
- **Standard Dict Interface**: Implements `MutableMapping` protocol

#### Important Methods
- `__getitem__()`: Retrieves item and marks it as recently used
- `__setitem__()`: Adds/updates item, potentially evicting oldest item
- `clear()`: Removes all items and calls dispose function on each
- `keys()`: Returns a set of current keys (thread-safe snapshot)

#### Notes
⚠️ **Warning**: Iteration is not implemented as it would likely be unsafe in a multithreaded environment.

### HTTPHeaderDict

A specialized dictionary for HTTP headers that handles case-insensitive operations while preserving the original case of header names.

#### Purpose
- Case-insensitive header name comparison (RFC 7230 compliant)
- Support for multiple values per header name
- Flexible construction from various data sources
- Standard dictionary interface with HTTP-specific extensions

#### Constructor
```python
HTTPHeaderDict(headers: ValidHTTPHeaderSource | None = None, **kwargs: str)
```

#### Key Features

##### Case-Insensitive Operations
```python
headers = HTTPHeaderDict()
headers['Content-Type'] = 'application/json'
print(headers['content-type'])  # Returns: 'application/json'
print(headers['CONTENT-TYPE'])  # Returns: 'application/json'
```

##### Multiple Values Support
```python
headers = HTTPHeaderDict()
headers.add('Set-Cookie', 'foo=bar')
headers.add('Set-Cookie', 'baz=quxx')
print(headers['Set-Cookie'])  # Returns: 'foo=bar, baz=quxx'
```

##### Value Combination
```python
headers.add('X-Custom', 'value1')
headers.add('X-Custom', 'value2', combine=True)
# Results in a single header with combined value: 'value1, value2'
```

#### Important Methods

##### `add(key: str, val: str, *, combine: bool = False)`
Adds a header value without overwriting existing values.
- **combine=False** (default): Creates separate header entries
- **combine=True**: Appends to existing value with comma separation

##### `getlist(key: str, default=None) -> list[str]`
Returns all values for a header as a list.

##### `extend(*args, **kwargs)`
Bulk import from various header sources (dictionaries, iterables, etc.).

##### `iteritems() -> Iterator[tuple[str, str]]`
Iterates over all header name-value pairs, including duplicates.

##### `itermerged() -> Iterator[tuple[str, str]]`
Iterates over headers with duplicate values merged using commas.

#### Supported Input Types
The `ValidHTTPHeaderSource` type union accepts:
- Another `HTTPHeaderDict`
- `Mapping[str, str]` (regular dictionaries)
- `Iterable[tuple[str, str]]` (list of tuples)
- Objects with `keys()` and `__getitem__` methods

#### Special Features

##### Method Preparation
```python
headers._prepare_for_method_change()
```
Removes content-specific headers when changing HTTP methods to GET/HEAD (RFC 9110 compliant).

##### Operator Support
```python
# Merging headers
new_headers = headers1 | headers2
headers1 |= headers2  # In-place merge
```

## Helper Classes

### HTTPHeaderDictItemView
A specialized view class that provides the items interface for `HTTPHeaderDict`, handling the unique iteration behavior where duplicate keys may be present.

## Type Definitions

### ValidHTTPHeaderSource
Union type defining acceptable input sources for HTTP headers:
```python
ValidHTTPHeaderSource = Union[
    HTTPHeaderDict,
    Mapping[str, str],
    Iterable[tuple[str, str]],
    HasGettableStringKeys,
]
```

## Usage Examples

### Basic HTTPHeaderDict Usage
```python
# Create and populate headers
headers = HTTPHeaderDict()
headers['Content-Type'] = 'application/json'
headers.add('Accept', 'application/json')
headers.add('Accept', 'text/html')

# Access headers (case-insensitive)
content_type = headers['content-type']
accept_values = headers.getlist('accept')
```

### RecentlyUsedContainer Usage
```python
def cleanup_callback(value):
    print(f"Evicting: {value}")

cache = RecentlyUsedContainer(maxsize=3, dispose_func=cleanup_callback)
cache['key1'] = 'value1'
cache['key2'] = 'value2'
cache['key3'] = 'value3'
cache['key4'] = 'value4'  # This will evict 'key1'
```

## Notes and Considerations

- **Thread Safety**: `RecentlyUsedContainer` is fully thread-safe, while `HTTPHeaderDict` is not explicitly thread-safe
-