<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP Header and Container Utilities Documentation

This Python module provides two main utility classes for handling HTTP headers and implementing a recently-used cache container. It's designed to be thread-safe and handle HTTP header semantics properly.

## Overview

The module contains:
- **RecentlyUsedContainer**: A thread-safe LRU (Least Recently Used) cache implementation
- **HTTPHeaderDict**: A specialized dictionary for handling HTTP headers with case-insensitive keys and multi-value support

## Classes

### RecentlyUsedContainer

A thread-safe dictionary-like container that maintains a maximum number of items while automatically evicting the least recently used entries.

#### Key Features
- **Thread-safe**: Uses `RLock` for concurrent access
- **LRU eviction**: Automatically removes oldest items when capacity is exceeded
- **Custom disposal**: Optional callback function for cleanup when items are evicted
- **Generic typing**: Supports any key-value types

#### Constructor Parameters
```python
def __init__(self, maxsize: int = 10, dispose_func: Callable[[_VT], None] | None = None)
```
- `maxsize`: Maximum number of items to retain (default: 10)
- `dispose_func`: Optional callback called when items are evicted

#### Important Methods
- **Standard dict operations**: `__getitem__`, `__setitem__`, `__delitem__`, `__len__`
- **`clear()`**: Removes all items and calls dispose_func on each
- **`keys()`**: Returns a set of all current keys

#### Notes
- **No iteration support**: `__iter__` is disabled for thread safety
- **Access updates order**: Getting an item moves it to the end of the eviction queue

### HTTPHeaderDict

A specialized dictionary for HTTP headers that handles case-insensitive keys and supports multiple values per header.

#### Key Features
- **Case-insensitive**: Header names are compared case-insensitively per RFC 7230
- **Multi-value support**: Can store multiple values for the same header
- **Flexible input**: Accepts various input formats during construction
- **HTTP semantics**: Proper handling of header concatenation and iteration

#### Constructor
```python
def __init__(self, headers: ValidHTTPHeaderSource | None = None, **kwargs: str)
```

Accepts:
- `HTTPHeaderDict` instances
- `Mapping[str, str]` objects
- `Iterable[tuple[str, str]]` sequences
- Objects with `keys()` and `__getitem__` methods

#### Important Methods

##### Adding Headers
```python
def add(self, key: str, val: str, *, combine: bool = False) -> None
```
- Adds a header without overwriting existing values
- `combine=True`: Concatenates with existing values using comma separation
- `combine=False`: Keeps as separate values during iteration

##### Getting Values
```python
def getlist(self, key: str, default=None) -> list[str]
```
- Returns all values for a header as a list
- Use `dict[key]` syntax to get comma-separated concatenated values

##### Iteration Methods
- **`iteritems()`**: Yields all header-value pairs, including duplicates
- **`itermerged()`**: Yields headers with values concatenated by commas
- **`items()`**: Returns custom view supporting both behaviors

#### Usage Examples

```python
# Basic usage
headers = HTTPHeaderDict()
headers['Content-Type'] = 'application/json'
headers.add('Set-Cookie', 'session=abc123')
headers.add('Set-Cookie', 'theme=dark')

# Case-insensitive access
print(headers['content-type'])  # 'application/json'
print(headers['SET-COOKIE'])    # 'session=abc123, theme=dark'

# Multiple values
cookies = headers.getlist('Set-Cookie')  # ['session=abc123', 'theme=dark']

# Combining values
headers.add('X-Custom', 'value1')
headers.add('X-Custom', 'value2', combine=True)  # Results in 'value1, value2'
```

## Type Definitions

### ValidHTTPHeaderSource
Union type accepting various header sources:
```python
ValidHTTPHeaderSource = Union[
    HTTPHeaderDict,
    Mapping[str, str],
    Iterable[tuple[str, str]],
    HasGettableStringKeys,
]
```

## Utility Functions

### ensure_can_construct_http_header_dict()
Validates and converts input to a valid header source format. Returns `None` if the input cannot be converted.

## Important Notes

### Thread Safety
- **RecentlyUsedContainer**: Fully thread-safe with RLock protection
- **HTTPHeaderDict**: Not explicitly thread-safe; use external synchronization if needed

### Performance Considerations
- Type checking for complex inputs uses casting instead of full validation for performance
- Header lookups are optimized using lowercase key storage

### HTTP Compliance
- Follows RFC 7230 for case-insensitive header handling
- Properly handles header value concatenation with comma separation
- Supports method-specific header cleanup with `_prepare_for_method_change()`

### Backward Compatibility
The HTTPHeaderDict includes several alias methods for compatibility:
- `getheaders`, `getallmatchingheaders`, `iget` → `getlist`
- `get_all` → `getlist` (for http.cookiejar compatibility)

## Suggestions for Usage

1. **Use RecentlyUsedContainer** for caching expensive-to-create objects with automatic cleanup
2. **Use HTTPHeaderDict** when working with HTTP libraries that need proper header semantics
3. **Consider thread safety** requirements when choosing between classes
4. **Use the `add()` method** instead of assignment when you need to preserve multiple header values
5. **Leverage the `combine` parameter** in `add()` when you want to merge header values instead of keeping them separate