<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTTP Connection Module Documentation

This Python module provides HTTP and HTTPS connection classes built on top of Python's standard `http.client` module, with enhanced features for urllib3. It handles connection management, SSL/TLS configuration, proxy support, and HTTP/2 probing.

## Overview

The module extends the standard library's HTTP connection classes to provide:
- Enhanced SSL/TLS configuration and certificate verification
- Proxy support (both tunneling and forwarding)
- HTTP/2 protocol probing
- Connection pooling compatibility
- Custom timeout handling
- Request chunking capabilities

## Key Classes

### HTTPConnection

```python
class HTTPConnection(_HTTPConnection):
```

Enhanced HTTP connection class that extends `http.client.HTTPConnection` with additional features:

**Key Features:**
- Custom socket options configuration
- Proxy support
- Enhanced timeout handling
- Connection state tracking
- Custom user agent handling

**Important Attributes:**
- `default_port`: Default HTTP port (80)
- `default_socket_options`: TCP socket options (disables Nagle's algorithm by default)
- `is_verified`: Whether the connection is verified (always False for HTTP)
- `proxy_is_verified`: Proxy verification status

**Constructor Parameters:**
- `host`: Target hostname
- `port`: Target port (optional)
- `timeout`: Connection timeout
- `source_address`: Source address for connection
- `blocksize`: Block size for data transfer
- `socket_options`: Custom socket options
- `proxy`: Proxy configuration
- `proxy_config`: Detailed proxy configuration

### HTTPSConnection

```python
class HTTPSConnection(HTTPConnection):
```

HTTPS connection class with comprehensive SSL/TLS support:

**Key Features:**
- SSL context configuration
- Certificate verification
- Hostname validation
- Fingerprint verification
- TLS-in-TLS for HTTPS proxies
- HTTP/2 protocol probing

**Additional SSL Parameters:**
- `cert_reqs`: Certificate verification requirements
- `ssl_context`: Custom SSL context
- `ca_certs`: CA certificate file path
- `cert_file`/`key_file`: Client certificate files
- `assert_hostname`: Hostname to verify
- `assert_fingerprint`: Certificate fingerprint to verify
- `server_hostname`: SNI hostname

## Important Methods

### Connection Management

#### `connect()`
Establishes the connection to the target server:
- Creates socket connection
- Handles proxy tunneling
- Performs SSL/TLS handshake (HTTPS)
- Probes for HTTP/2 support
- Sets verification status

#### `close()`
Closes the connection and resets all stateful properties:
- Closes underlying socket
- Resets verification flags
- Clears proxy connection state
- Resets tunnel configuration

### Request Methods

#### `request(method, url, body=None, headers=None, **kwargs)`
Enhanced request method with additional features:

**Parameters:**
- `method`: HTTP method (GET, POST, etc.)
- `url`: Request URL path
- `body`: Request body data
- `headers`: HTTP headers dictionary
- `chunked`: Use chunked transfer encoding
- `preload_content`: Whether to preload response content
- `decode_content`: Whether to decode response content
- `enforce_content_length`: Enforce content-length validation

**Features:**
- Automatic chunked encoding detection
- Custom user agent handling
- Header validation
- Content-length calculation

#### `putrequest(method, url, **kwargs)`
Validates HTTP method for control characters and delegates to parent class.

#### `putheader(header, *values)`
Handles special SKIP_HEADER values for conditional header inclusion.

### Response Handling

#### `getresponse()`
Returns an enhanced HTTPResponse object:
- Validates response headers
- Creates HTTPResponse with additional metadata
- Handles connection cleanup
- Preserves request context

## Utility Functions

### `_ssl_wrap_socket_and_match_hostname()`
Comprehensive SSL socket wrapping function:
- Creates SSL context with proper configuration
- Performs SSL handshake
- Validates certificates and hostnames
- Handles fingerprint verification
- Returns wrapped socket with verification status

### `_match_hostname()`
Custom hostname matching with enhanced error handling:
- Normalizes IP addresses
- Validates certificates against hostnames
- Provides detailed error information

### `_wrap_proxy_error()`
Wraps proxy connection errors with helpful diagnostic information:
- Detects common HTTP/HTTPS proxy misconfigurations
- Provides actionable error messages

## Properties

### Connection State Properties

- `is_closed`: Returns True if connection is closed
- `is_connected`: Returns True if connection is active
- `has_connected_to_proxy`: Returns True if connected through proxy
- `proxy_is_forwarding`: Returns True for forwarding proxy configuration
- `proxy_is_tunneling`: Returns True for tunneling proxy configuration

### Host Property

```python
@property
def host(self) -> str:
    """Returns hostname with trailing dots removed for SSL compatibility"""
```

## Configuration

### Default Socket Options

```python
default_socket_options = [(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)]
```

Disables Nagle's algorithm by default for better performance.

### Port Mapping

```python
port_by_scheme = {"http": 80, "https": 443}
```

## Usage Notes

### SSL/TLS Configuration

- Always use `HTTPSConnection` for HTTPS endpoints
- Configure certificate verification appropriately for your security requirements
- Use `ssl_context` parameter for advanced SSL configuration
- Consider fingerprint verification for additional security

### Proxy Configuration

- Use `proxy` parameter for basic proxy configuration
- Use `proxy_config` for advanced proxy settings including SSL
- Tunneling proxies are preferred for HTTPS targets
- Forwarding proxies cannot verify target certificates

### Error Handling

The module raises specific exceptions for different error conditions:
- `NameResolutionError`: DNS resolution failures
- `ConnectTimeoutError`: Connection timeout
- `NewConnectionError`: General connection failures
- `ProxyError`: Proxy-related errors
- `HeaderParsingError`: Invalid response headers

### Deprecation Warnings

- `request_chunked()`: Use `request(..., chunked=True)` instead
- `set_cert()`: Provide SSL parameters to constructor instead

## Thread Safety

The module includes HTTP/2 probing functionality that uses thread-safe mechanisms