<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP Connection Pool Documentation

## Overview

This file implements HTTP connection pooling functionality for urllib3, providing efficient connection reuse and management for HTTP and HTTPS requests. The connection pool maintains a pool of reusable connections to minimize the overhead of establishing new connections for each request.

## Purpose

- **Connection Reuse**: Maintains a pool of HTTP/HTTPS connections that can be reused across multiple requests
- **Thread Safety**: Provides thread-safe connection pooling for concurrent applications
- **Resource Management**: Automatically manages connection lifecycle, including creation, validation, and cleanup
- **Retry Logic**: Implements sophisticated retry mechanisms for failed requests
- **Proxy Support**: Handles HTTP and HTTPS proxy configurations

## Key Classes

### ConnectionPool

Base class for all connection pools.

```python
class ConnectionPool:
    """
    Base class for all connection pools, such as
    HTTPConnectionPool and HTTPSConnectionPool.
    """
```

**Key Features:**
- Context manager support (`__enter__`/`__exit__`)
- Host normalization and validation
- Basic pool structure definition

### HTTPConnectionPool

Main connection pool implementation for HTTP connections.

```python
class HTTPConnectionPool(ConnectionPool, RequestMethods):
    """
    Thread-safe connection pool for one host.
    """
```

**Constructor Parameters:**
- `host`: Target host for connections
- `port`: Port number (defaults to 80 for HTTP)
- `timeout`: Socket timeout configuration
- `maxsize`: Maximum number of connections to pool (default: 1)
- `block`: Whether to block when pool is full (default: False)
- `headers`: Default headers for all requests
- `retries`: Retry configuration
- `_proxy`: Proxy configuration (internal use)

**Key Methods:**

#### `_new_conn()`
Creates a fresh HTTP connection when needed.

#### `_get_conn(timeout=None)`
Retrieves a connection from the pool or creates a new one.

#### `_put_conn(conn)`
Returns a connection to the pool for reuse.

#### `_make_request()`
Performs the actual HTTP request using a pooled connection.

#### `urlopen()`
Main method for making HTTP requests with full retry and redirect support.

**Parameters:**
- `method`: HTTP method (GET, POST, etc.)
- `url`: Request URL
- `body`: Request body data
- `headers`: Request headers
- `retries`: Retry configuration
- `redirect`: Enable automatic redirects
- `timeout`: Request timeout
- `preload_content`: Whether to preload response body
- `decode_content`: Whether to decode response content

### HTTPSConnectionPool

Specialized connection pool for HTTPS connections.

```python
class HTTPSConnectionPool(HTTPConnectionPool):
    """
    Same as HTTPConnectionPool, but HTTPS.
    """
```

**Additional SSL Parameters:**
- `key_file`: Client certificate key file
- `cert_file`: Client certificate file
- `cert_reqs`: Certificate verification requirements
- `ca_certs`: CA certificate bundle
- `ssl_version`: SSL/TLS version
- `assert_hostname`: Hostname verification
- `assert_fingerprint`: Certificate fingerprint verification

**Key Methods:**

#### `_prepare_proxy(conn)`
Establishes HTTP CONNECT tunnel for HTTPS through proxy.

#### `_validate_conn(conn)`
Validates SSL/TLS connections and issues security warnings for unverified connections.

## Utility Functions

### `connection_from_url(url, **kw)`

Convenience function to create a connection pool from a URL.

```python
conn = connection_from_url('https://example.com/')
response = conn.request('GET', '/')
```

### `_normalize_host(host, scheme)`

Normalizes hostnames for consistent comparison and socket usage.

### `_close_pool_connections(pool)`

Safely drains and closes all connections in a pool queue.

## Usage Examples

### Basic HTTP Pool

```python
# Create a connection pool
pool = HTTPConnectionPool('example.com', port=80, maxsize=10)

# Make requests
response = pool.urlopen('GET', '/api/data')

# Pool automatically manages connections
pool.close()  # Clean up when done
```

### HTTPS with SSL Configuration

```python
# HTTPS pool with SSL verification
pool = HTTPSConnectionPool(
    'secure-api.com',
    port=443,
    cert_reqs='CERT_REQUIRED',
    ca_certs='/path/to/ca-bundle.crt'
)

response = pool.urlopen('GET', '/secure-endpoint')
```

### Context Manager Usage

```python
with HTTPConnectionPool('api.example.com') as pool:
    response = pool.urlopen('GET', '/data')
    # Pool automatically closed when exiting context
```

## Important Notes

### Thread Safety
- Connection pools are thread-safe and can be shared across multiple threads
- The `maxsize` parameter controls the maximum number of concurrent connections

### Connection Lifecycle
- Connections are automatically validated before use
- Dropped connections are detected and replaced
- Pool cleanup happens automatically via weak references

### Error Handling
- Comprehensive retry logic with exponential backoff
- Automatic handling of connection errors, timeouts, and SSL issues
- Proper exception wrapping for proxy-related errors

### Performance Considerations
- **Connection Reuse**: Significantly reduces connection establishment overhead
- **Blocking Behavior**: Set `block=True` to limit concurrent connections
- **Pool Size**: Adjust `maxsize` based on expected concurrent load

### Security Notes
- HTTPS pools validate SSL certificates by default
- Warnings are issued for unverified HTTPS connections
- Support for client certificate authentication
- Proper proxy tunnel establishment for HTTPS

## Dependencies

This module relies on several urllib3 components:
- Connection classes (`HTTPConnection`, `HTTPSConnection`)
- Retry utilities (`Retry`)
- Timeout handling (`Timeout`)
- URL parsing and validation
- SSL utilities and certificate validation

The connection pool is a core component of urllib3's architecture, providing the foundation for efficient and reliable HTTP client functionality.