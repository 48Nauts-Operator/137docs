<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Emscripten HTTP Streaming Support

This module provides HTTP request streaming support for Python running in WebAssembly/Emscripten environments (browsers and Node.js). It handles the complexities of making HTTP requests in constrained WebAssembly environments where traditional networking isn't available.

## Purpose

The module enables HTTP requests in Emscripten by:
- Using JavaScript's `fetch` API when WebAssembly JavaScript Promise Integration (JSPI) is available
- Falling back to `XMLHttpRequest` with web workers for streaming when JSPI isn't available
- Providing both streaming and non-streaming request capabilities

## Key Features

- **Streaming HTTP requests** via web workers and SharedArrayBuffer
- **JSPI support** for modern browsers with WebAssembly Promise Integration
- **Automatic fallback** to XMLHttpRequest when streaming isn't available
- **Timeout handling** and error management
- **Cross-origin isolation** support for enhanced streaming capabilities

## Important Classes

### `_ReadStream`

A streaming reader that implements `io.RawIOBase` for traditional web worker-based streaming.

```python
class _ReadStream(io.RawIOBase):
    def __init__(self, int_buffer, byte_buffer, timeout, worker, connection_id, request):
        # Manages streaming data from web worker
```

**Key Methods:**
- `readinto(byte_obj)` - Reads data into a buffer from the web worker
- `close()` - Properly closes the stream and cleans up resources

### `_JSPIReadStream`

A streaming reader for JSPI-enabled environments that can use JavaScript's native fetch streaming.

```python
class _JSPIReadStream(io.RawIOBase):
    def __init__(self, js_read_stream, timeout, request, response, js_abort_controller):
        # Manages streaming via JavaScript Promise Integration
```

### `_StreamingFetcher`

Manages the web worker that performs streaming HTTP requests.

```python
class _StreamingFetcher:
    def send(self, request: EmscriptenRequest) -> EmscriptenResponse:
        # Sends request via web worker and returns streaming response
```

## Key Functions

### `send_streaming_request(request)`

Main entry point for streaming HTTP requests. Automatically chooses the best available method (JSPI or web worker).

```python
def send_streaming_request(request: EmscriptenRequest) -> EmscriptenResponse | None:
    # Returns None if streaming isn't available
```

### `send_request(request)`

Sends non-streaming HTTP requests using XMLHttpRequest or JSPI.

```python
def send_request(request: EmscriptenRequest) -> EmscriptenResponse:
    # Always returns a response with buffered body
```

### `send_jspi_request(request, streaming)`

Handles requests using WebAssembly JavaScript Promise Integration.

```python
def send_jspi_request(request: EmscriptenRequest, streaming: bool) -> EmscriptenResponse:
    # Uses modern JSPI for async JavaScript fetch API
```

## Environment Detection Functions

### `has_jspi()`
Checks if WebAssembly JavaScript Promise Integration is available and usable.

### `is_cross_origin_isolated()`
Determines if the page has cross-origin isolation enabled (required for SharedArrayBuffer).

### `streaming_ready()`
Checks if the streaming web worker is ready to handle requests.

### `wait_for_streaming_ready()`
Async function that waits for the streaming worker to be ready.

## Requirements and Limitations

### For Streaming to Work

1. **Cross-Origin Isolation** must be enabled with these headers:
   ```
   Cross-Origin-Opener-Policy: same-origin
   Cross-Origin-Embedder-Policy: require-corp
   ```

2. **Web Worker Environment** - Streaming doesn't work in the main browser thread due to `Atomics.wait` restrictions

3. **SharedArrayBuffer Support** - Required for worker communication

### JSPI Requirements

- Browser support for WebAssembly JavaScript Promise Integration
- Python launched via `pyodide.runPythonAsync`
- Node.js requires `--experimental-wasm-stack-switching` flag (for versions < 24)

## Error Handling

The module defines several custom exceptions:

- `_RequestError` - General request failures
- `_StreamingError` - Streaming-specific errors  
- `_TimeoutError` - Request timeout errors

## Configuration Constants

```python
HEADERS_TO_IGNORE = ("user-agent",)  # Headers that trigger CORS preflight
SUCCESS_HEADER = -1    # Worker communication codes
SUCCESS_EOF = -2
ERROR_TIMEOUT = -3
ERROR_EXCEPTION = -4
```

## Usage Notes

⚠️ **Important Considerations:**

1. **Timeouts** don't work in the main browser thread with XMLHttpRequest
2. **Streaming** requires running in a web worker, not the main thread
3. **CORS headers** may be filtered to avoid preflight requests
4. **Memory management** is important - streams should be properly closed

## Browser Compatibility

- **Modern browsers** with JSPI support: Full streaming via fetch API
- **Older browsers** with SharedArrayBuffer: Streaming via web workers
- **Fallback mode**: Non-streaming XMLHttpRequest

The module automatically detects capabilities and uses the best available method for each environment.