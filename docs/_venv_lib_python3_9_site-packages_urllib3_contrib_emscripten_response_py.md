<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# EmscriptenResponse Module Documentation

## Overview

This module provides HTTP response handling specifically for the Emscripten environment (WebAssembly). It contains classes and utilities for wrapping and managing HTTP responses when running Python code compiled to WebAssembly in a browser environment.

## Purpose

- **Browser Compatibility**: Adapts urllib3's response interface to work with browser-based HTTP requests
- **Response Wrapping**: Provides a unified interface for handling HTTP responses in WebAssembly environments
- **Error Handling**: Translates Emscripten-specific errors to standard urllib3 exceptions
- **Stream Management**: Handles response body streaming with proper connection management

## Classes

### `EmscriptenResponse`

A simple dataclass that represents the raw response data from an Emscripten HTTP request.

```python
@dataclass
class EmscriptenResponse:
    status_code: int
    headers: dict[str, str]
    body: IOBase | bytes
    request: EmscriptenRequest
```

**Fields:**
- `status_code`: HTTP status code
- `headers`: Response headers as key-value pairs
- `body`: Response body (either bytes or IO stream)
- `request`: Associated request object

### `EmscriptenHttpResponseWrapper`

The main response wrapper class that extends `BaseHTTPResponse` and provides urllib3-compatible interface for Emscripten responses.

#### Key Methods

##### `__init__(internal_response, url=None, connection=None)`
Initializes the response wrapper with proper urllib3 compatibility.

##### `stream(amt=2**16, decode_content=None)`
```python
def stream(self, amt: int | None = 2**16, decode_content: bool | None = None) -> typing.Generator[bytes]
```
Provides a generator for streaming response data in chunks.

- **Parameters:**
  - `amt`: Chunk size (default: 65536 bytes)
  - `decode_content`: Whether to decode content (ignored in browser environment)
- **Returns:** Generator yielding bytes chunks

##### `read(amt=None, decode_content=None, cache_content=False)`
```python
def read(self, amt: int | None = None, decode_content: bool | None = None, cache_content: bool = False) -> bytes
```
Reads response body data.

- **Parameters:**
  - `amt`: Number of bytes to read (None = read all)
  - `decode_content`: Ignored (browser handles decoding)
  - `cache_content`: Whether to cache the full response body
- **Returns:** Response data as bytes

##### `json()`
Deserializes the response body as JSON.

- **Returns:** Parsed Python object
- **Raises:** `UnicodeDecodeError`, `json.JSONDecodeError`

##### `close()`
Closes the response and releases associated resources.

## Key Features

### Content Length Handling
The `_init_length()` method properly handles:
- Multiple Content-Length headers (RFC 7230 compliance)
- Responses that shouldn't have bodies (204, 304, HEAD requests)
- Invalid or negative content lengths

### Error Management
The `_error_catcher()` context manager:
- Catches Emscripten-specific exceptions
- Translates them to standard urllib3 exceptions
- Ensures proper resource cleanup
- Manages connection pooling

### Browser-Specific Adaptations
- Content decoding is handled by the browser
- Chunked transfer encoding is managed by browser APIs
- Response bodies are pre-loaded as strings by XMLHttpRequest

## Properties

- `url`: Response URL (getter/setter)
- `connection`: Associated HTTP connection
- `retries`: Retry configuration
- `data`: Full response body as bytes

## Usage Notes

### ‚ö†Ô∏è Important Considerations

1. **Browser Environment Only**: This module is specifically designed for WebAssembly/Emscripten environments
2. **Automatic Decoding**: Content decoding is handled by the browser, so `decode_content` parameters are ignored
3. **Pre-loaded Bodies**: Response bodies are typically pre-loaded by XMLHttpRequest as strings
4. **Connection Management**: Proper connection pooling and cleanup is handled automatically

### üí° Best Practices

- Always use context managers or explicitly call `close()` to ensure proper resource cleanup
- Use `stream()` for large responses to avoid memory issues
- Handle `TimeoutError` and `HTTPException` appropriately
- Cache content only when reading the full response body

### üîó Dependencies

- Requires `EmscriptenRequest` from the request module
- Depends on fetch module for error types (imported dynamically to avoid circular imports)
- Extends urllib3's `BaseHTTPResponse` for compatibility