<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# EmscriptenResponse Module Documentation

## Overview

This module provides HTTP response handling functionality specifically designed for Emscripten environments (WebAssembly runtime). It implements a wrapper around browser-based HTTP responses to provide a consistent interface with urllib3's response handling system.

## Purpose

The module serves as a bridge between browser-based HTTP responses (via XMLHttpRequest/fetch API) and urllib3's response interface, allowing urllib3 to work in WebAssembly environments where traditional socket-based HTTP clients are not available.

## Classes

### `EmscriptenResponse`

A simple dataclass that represents the raw response data from browser APIs.

**Attributes:**
- `status_code: int` - HTTP status code
- `headers: dict[str, str]` - Response headers
- `body: IOBase | bytes` - Response body (can be bytes or stream)
- `request: EmscriptenRequest` - The original request object

### `EmscriptenHttpResponseWrapper`

The main response wrapper class that extends `BaseHTTPResponse` to provide urllib3-compatible response handling.

#### Constructor

```python
def __init__(
    self,
    internal_response: EmscriptenResponse,
    url: str | None = None,
    connection: BaseHTTPConnection | BaseHTTPSConnection | None = None,
):
```

**Parameters:**
- `internal_response` - The raw EmscriptenResponse object
- `url` - Request URL (optional)
- `connection` - Connection object (optional)

#### Key Methods

##### `stream(amt: int | None = 2**16, decode_content: bool | None = None)`

Generator that yields chunks of response data.

- **Parameters:**
  - `amt` - Bytes to read per iteration (default: 64KB)
  - `decode_content` - Whether to decode content (handled by browser)
- **Returns:** Generator yielding bytes chunks

##### `read(amt: int | None = None, decode_content: bool | None = None, cache_content: bool = False)`

Reads response data with support for partial reads and caching.

- **Parameters:**
  - `amt` - Number of bytes to read (None = read all)
  - `decode_content` - Ignored (browser handles decoding)
  - `cache_content` - Whether to cache the full response
- **Returns:** Response data as bytes

##### `json()`

Deserializes the response body as JSON.

- **Returns:** Parsed JSON object
- **Raises:** `UnicodeDecodeError`, `json.JSONDecodeError`

##### `read_chunked(amt: int | None = None, decode_content: bool | None = None)`

Generator for reading chunked transfer encoding (handled by browser).

- **Returns:** Generator yielding bytes chunks

#### Properties

- `url` - Request URL (read/write)
- `connection` - HTTP connection object (read-only)
- `retries` - Retry configuration (read/write)
- `data` - Complete response body as bytes

## Key Features

### Content-Length Handling

The `_init_length()` method implements RFC 7230 compliant Content-Length parsing:
- Handles multiple Content-Length values
- Validates header format
- Sets appropriate length for HEAD requests and status codes that shouldn't have bodies

### Error Handling

The `_error_catcher()` context manager converts Emscripten-specific exceptions to urllib3 exceptions:
- `_TimeoutError` → `TimeoutError`
- `_RequestError` → `HTTPException`

### Resource Management

- Automatic connection release via `release_conn()`
- Proper stream closure in `close()`
- Connection pooling support

## Usage Notes

### Browser Integration
- Response decoding is handled by the browser, so `decode_content` parameters are ignored
- Chunked transfer encoding is automatically handled by browser APIs
- XMLHttpRequest preloads response bodies as strings

### Performance Considerations
- Large responses are wrapped in `BytesIO` for streaming
- Partial reads disable content caching
- Connection pooling is supported for reuse

### Error Handling
- Closed responses return empty bytes
- Invalid Content-Length headers raise `InvalidHeader`
- Network errors are converted to appropriate urllib3 exceptions

## Dependencies

- `BaseHTTPResponse` - Parent class from urllib3
- `EmscriptenRequest` - Request object from sibling module
- `fetch` module - For browser API integration (circular import avoided)

## Suggestions

1. **Error Logging**: Consider adding more detailed logging for debugging network issues in WebAssembly environments

2. **Performance Monitoring**: Add metrics for response processing times and memory usage

3. **Caching Strategy**: Implement more sophisticated caching for frequently accessed responses

4. **Stream Processing**: Consider adding support for server-sent events or WebSocket upgrades where supported