<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# filepost.py Documentation

## Overview

This module provides functionality for encoding multipart/form-data MIME format, commonly used for HTTP file uploads and form submissions. It handles the creation of properly formatted multipart bodies with boundaries and appropriate headers.

## Purpose

The primary purpose of this module is to:
- Generate multipart/form-data encoded content for HTTP requests
- Support various field types including files, strings, and custom data
- Provide a simple interface for creating form boundaries
- Handle encoding of field data with proper MIME formatting

## Type Definitions

The module defines several type aliases for better type safety:

```python
_TYPE_FIELDS_SEQUENCE = typing.Sequence[
    typing.Union[tuple[str, _TYPE_FIELD_VALUE_TUPLE], RequestField]
]
_TYPE_FIELDS = typing.Union[
    _TYPE_FIELDS_SEQUENCE,
    typing.Mapping[str, _TYPE_FIELD_VALUE_TUPLE],
]
```

These types support:
- Sequences of field tuples or `RequestField` objects
- Mapping/dictionary structures
- Mixed field value types

## Functions

### `choose_boundary()`

```python
def choose_boundary() -> str
```

**Purpose**: Generates a random boundary string for multipart data separation.

**Returns**: A 32-character hexadecimal string

**Implementation**: Uses `os.urandom(16)` for cryptographically secure randomness, then converts to hexadecimal.

**Example**:
```python
boundary = choose_boundary()
# Returns something like: "a1b2c3d4e5f6789012345678abcdef01"
```

### `iter_field_objects()`

```python
def iter_field_objects(fields: _TYPE_FIELDS) -> typing.Iterable[RequestField]
```

**Purpose**: Normalizes different field input formats into `RequestField` objects.

**Parameters**:
- `fields`: Can be a mapping (dict), sequence of tuples, or sequence of `RequestField` objects

**Returns**: Iterator of `RequestField` objects

**Behavior**:
- Converts dictionaries to key-value pairs
- Transforms tuples into `RequestField` objects using `RequestField.from_tuples()`
- Passes through existing `RequestField` objects unchanged

### `encode_multipart_formdata()`

```python
def encode_multipart_formdata(
    fields: _TYPE_FIELDS, boundary: str | None = None
) -> tuple[bytes, str]
```

**Purpose**: Main function that encodes fields into multipart/form-data format.

**Parameters**:
- `fields`: Dictionary of fields or list of field tuples/RequestField objects
- `boundary`: Optional custom boundary string (auto-generated if not provided)

**Returns**: Tuple containing:
1. `bytes`: The encoded multipart body
2. `str`: The complete Content-Type header value

**Process**:
1. Creates or uses provided boundary
2. Iterates through normalized field objects
3. Writes boundary separators and field headers
4. Handles different data types (int, str, bytes)
5. Adds final boundary terminator
6. Returns encoded body and content type

## Usage Examples

### Basic Usage

```python
fields = {
    'name': 'John Doe',
    'email': 'john@example.com',
    'file': ('document.txt', b'file content', 'text/plain')
}

body, content_type = encode_multipart_formdata(fields)
```

### With Custom Boundary

```python
custom_boundary = "my-custom-boundary-123"
body, content_type = encode_multipart_formdata(fields, boundary=custom_boundary)
```

## Important Notes

### Encoding Considerations
- Uses UTF-8 encoding for text data via `codecs.lookup("utf-8")[3]`
- Boundary markers use latin-1 encoding
- Maintains backward compatibility by converting integers to strings

### Data Type Support
- **Integers**: Automatically converted to strings for backward compatibility
- **Strings**: Encoded using UTF-8 writer
- **Bytes**: Written directly to output stream
- **Files**: Handled through `RequestField` objects

### MIME Compliance
- Follows RFC 2388 for multipart/form-data format
- Uses CRLF (`\r\n`) line endings as required by HTTP standards
- Properly formats boundary markers with `--` prefix and `--` suffix for termination

## Dependencies

- `binascii`: For hexadecimal encoding of random boundaries
- `codecs`: For UTF-8 text encoding
- `os`: For secure random number generation
- `io.BytesIO`: For efficient binary data buffering
- `.fields`: Local module providing `RequestField` class and type definitions

## Security Considerations

- Uses `os.urandom()` for cryptographically secure boundary generation
- Prevents boundary collision through sufficient randomness (128 bits)
- Properly handles different data types to prevent encoding issues