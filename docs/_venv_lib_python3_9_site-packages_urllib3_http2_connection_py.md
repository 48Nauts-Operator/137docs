<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP/2 Connection Module

## Overview

This module implements HTTP/2 client functionality for urllib3, providing classes to establish HTTP/2 connections and handle responses. It extends the existing HTTPS connection infrastructure to support the HTTP/2 protocol using the `h2` library.

## Purpose

- Provides HTTP/2 client connection capabilities
- Handles HTTP/2 protocol specifics like header validation and stream management
- Maintains compatibility with existing urllib3 connection interfaces
- Implements thread-safe access to HTTP/2 connection objects

## Key Components

### Classes

#### `_LockedObject[T]`

A generic wrapper class that provides thread-safe access to objects using a context manager pattern.

```python
class _LockedObject(typing.Generic[T]):
    def __init__(self, obj: T):
        self.lock = threading.RLock()
        self._obj = obj
```

**Purpose**: Protects HTTP/2 connection objects from concurrent access across multiple threads.

**Usage**:
```python
with locked_object as obj:
    # Safe access to the protected object
    obj.some_method()
```

#### `HTTP2Connection`

Main class extending `HTTPSConnection` to provide HTTP/2 functionality.

**Key Features**:
- Inherits from `HTTPSConnection` but replaces HTTP/1.1 with HTTP/2 protocol
- Manages HTTP/2 streams and connection state
- Handles HTTP/2 specific headers (pseudo-headers like `:method`, `:path`)
- Provides thread-safe connection management

**Important Methods**:

- `connect()`: Establishes HTTP/2 connection and sends connection preface
- `putrequest()`: Initiates HTTP/2 request with pseudo-headers
- `putheader()`: Adds headers with HTTP/2 validation
- `endheaders()`: Sends headers to server
- `send()`: Sends request body data
- `getresponse()`: Receives and processes HTTP/2 response
- `request()`: High-level method to send complete HTTP/2 request

#### `HTTP2Response`

Simplified response class for HTTP/2 responses.

**Features**:
- Stores response status, headers, and body data
- Compatible with `BaseHTTPResponse` interface
- Currently supports non-streaming responses only

### Utility Functions

#### `_is_legal_header_name(name: bytes) -> bool`

Validates HTTP/2 header names according to RFC 9113 specifications.

**Validation Rules**:
- Must match pattern: `^[!#$%&'*+\-.^_`|~0-9a-z]+$`
- No uppercase characters allowed
- Does not validate pseudo-headers (those starting with `:`)

#### `_is_illegal_header_value(value: bytes) -> bool`

Validates HTTP/2 header values according to RFC 9113 specifications.

**Validation Rules**:
- Must not contain: NUL (0x00), LF (0x0a), CR (0x0d)
- Must not start/end with whitespace (SP, HTAB)

## Usage Example

```python
conn = HTTP2Connection("example.com", 443)
conn.connect()
conn.request("GET", "/", headers={"User-Agent": "MyClient/1.0"})
response = conn.getresponse()
print(f"Status: {response.status}")
print(f"Data: {response.data}")
conn.close()
```

## Limitations and Notes

### Current Limitations

- **No Proxy Support**: HTTP/2 connections through proxies are not implemented
- **No Tunneling**: HTTP tunneling is not supported
- **No Streaming**: Response handling is currently non-streaming only
- **Incomplete Response Object**: The `HTTP2Response` class lacks full feature parity with HTTP/1.1 responses

### Important Notes

- The module uses the `h2` library for HTTP/2 protocol implementation
- Thread safety is provided through the `_LockedObject` wrapper
- Header validation is stricter than HTTP/1.1 to comply with HTTP/2 specifications
- Connection reuse and multiplexing capabilities of HTTP/2 are supported through the underlying `h2` library

### TODO Items

Several areas are marked for future improvement:
- Support for content decoding in responses
- Implementation of streaming response handling
- Better handling of upstream headers (SKIPPABLE_HEADERS)
- Configurable read buffer sizes
- Enhanced error handling and recovery

## Dependencies

- `h2`: HTTP/2 protocol implementation
- `urllib3`: Base connection and response classes
- Standard library: `threading`, `logging`, `re`, `typing`

This module provides a foundation for HTTP/2 support in urllib3 while maintaining compatibility with existing interfaces and patterns.