<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTTP/2 Connection Module Documentation

## Overview

This module provides HTTP/2 connection functionality for the urllib3 library. It implements HTTP/2 protocol support using the `h2` library, extending the existing HTTPS connection infrastructure to support HTTP/2 features while maintaining compatibility with the urllib3 API.

## Purpose

- **HTTP/2 Protocol Support**: Enables HTTP/2 connections in urllib3
- **Thread Safety**: Provides thread-safe access to HTTP/2 connection objects
- **Header Validation**: Implements strict HTTP/2 header validation according to RFC 9113
- **Stream Management**: Handles HTTP/2 stream lifecycle and multiplexing

## Key Components

### Classes

#### `_LockedObject[T]`

A generic thread-safe wrapper class that protects objects from concurrent access.

```python
class _LockedObject(typing.Generic[T]):
```

**Features:**
- Uses `threading.RLock()` for reentrant locking
- Context manager support for safe object access
- Generic type support for type safety

**Usage:**
```python
locked_obj = _LockedObject(some_object)
with locked_obj as obj:
    # Safe access to the protected object
    obj.some_method()
```

#### `HTTP2Connection`

Main HTTP/2 connection class that extends `HTTPSConnection`.

```python
class HTTP2Connection(HTTPSConnection):
```

**Key Attributes:**
- `_h2_conn`: Locked H2Connection instance
- `_h2_stream`: Current stream ID
- `_headers`: List of header tuples for the current request

**Important Methods:**

##### `connect()`
Establishes the HTTP/2 connection and initiates the protocol handshake.

##### `putrequest(method: str, url: str, **kwargs)`
Begins an HTTP/2 request by setting up pseudo-headers:
- `:scheme` - Always "https"
- `:method` - HTTP method
- `:authority` - Host and port
- `:path` - Request path

##### `putheader(header: str | bytes, *values: str | bytes)`
Adds headers to the current request with validation:
- Converts headers to lowercase bytes
- Validates header names and values according to HTTP/2 specs
- Accumulates headers for batch sending

##### `send(data: typing.Any)`
Sends request body data supporting multiple formats:
- String data (converted to bytes)
- Byte data
- File-like objects with `.read()` method
- Iterables of data chunks

##### `getresponse() -> HTTP2Response`
Receives and parses the HTTP/2 response:
- Handles multiple H2 events (ResponseReceived, DataReceived, StreamEnded)
- Processes flow control acknowledgments
- Returns complete response object

#### `HTTP2Response`

HTTP/2-specific response class extending `BaseHTTPResponse`.

```python
class HTTP2Response(BaseHTTPResponse):
```

**Features:**
- Stores complete response data in memory
- Sets HTTP version to 20 (HTTP/2)
- No reason phrase (HTTP/2 doesn't use them)
- Provides access to response data via `.data` property

### Utility Functions

#### `_is_legal_header_name(name: bytes) -> bool`

Validates HTTP/2 header names according to RFC 9113:
- Must match pattern: `^[!#$%&'*+\-.^_`|~0-9a-z]+$`
- No uppercase characters allowed
- Does not validate pseudo-headers (starting with `:`)

#### `_is_illegal_header_value(value: bytes) -> bool`

Validates HTTP/2 header values:
- No null bytes, line feeds, or carriage returns
- Cannot start or end with ASCII whitespace

### Constants

```python
RE_IS_LEGAL_HEADER_NAME = re.compile(rb"^[!#$%&'*+\-.^_`|~0-9a-z]+$")
RE_IS_ILLEGAL_HEADER_VALUE = re.compile(rb"[\0\x00\x0a\x0d\r\n]|^[ \r\n\t]|[ \r\n\t]$")
```

## Limitations and Notes

### Current Limitations

- **No Proxy Support**: Proxies and tunneling are not implemented
- **No Streaming**: Responses are loaded completely into memory
- **No Content Decoding**: Automatic content decoding is not yet supported
- **Incomplete Response Object**: Some response features may be missing

### Important Notes

- **Thread Safety**: All H2Connection access is protected by locks
- **Connection Reuse**: Connection state is reset after each close
- **Error Handling**: Strict header validation prevents invalid requests
- **Flow Control**: Properly handles HTTP/2 flow control acknowledgments

## Usage Example

```python
# Create HTTP/2 connection
conn = HTTP2Connection("httpbin.org", 443)
conn.connect()

# Send request
conn.request("GET", "/get", headers={"Custom-Header": "value"})

# Get response
response = conn.getresponse()
print(f"Status: {response.status}")
print(f"Data: {response.data}")

# Clean up
conn.close()
```

## Dependencies

- `h2`: HTTP/2 protocol implementation
- `threading`: Thread safety support
- `re`: Regular expressions for validation
- `logging`: Debug and error logging

## Suggestions for Future Development

1. **Implement streaming responses** for better memory efficiency
2. **Add proxy and tunneling support** for enterprise environments
3. **Implement content decoding** (gzip, deflate, etc.)
4. **Add connection pooling** for better performance
5. **Improve error handling** with more specific HTTP/2 exceptions
6. **Add server push support** for advanced HTTP/2 features