<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTTP/2 Probe Cache Module

## Overview

This module implements a thread-safe caching mechanism for HTTP/2 protocol support detection. It provides a singleton cache that stores whether specific host-port combinations support HTTP/2, preventing redundant protocol probes and improving performance in multi-threaded environments.

## Purpose

- **Cache HTTP/2 Support Status**: Stores boolean values indicating whether a host:port supports HTTP/2
- **Thread Safety**: Ensures safe concurrent access across multiple threads
- **Prevent Duplicate Probes**: Avoids redundant HTTP/2 capability checks for the same endpoints
- **Synchronization**: Coordinates between threads when probing is in progress

## Key Components

### `_HTTP2ProbeCache` Class

The core caching implementation with thread-safe operations.

#### Attributes

- `_lock`: Main threading lock for cache access coordination
- `_cache_locks`: Dictionary mapping (host, port) tuples to individual RLocks
- `_cache_values`: Dictionary storing actual HTTP/2 support status

#### Methods

##### `acquire_and_get(host: str, port: int) -> bool | None`

Retrieves the cached HTTP/2 support status for a host-port combination.

**Parameters:**
- `host`: Target hostname
- `port`: Target port number

**Returns:**
- `True`: HTTP/2 is supported
- `False`: HTTP/2 is not supported  
- `None`: Status unknown/probe in progress

**Behavior:**
- Returns immediately if value is cached
- Acquires lock if probe is needed
- Coordinates with other threads doing the same probe

##### `set_and_release(host: str, port: int, supports_http2: bool | None) -> None`

Updates the cache with HTTP/2 support status and releases the associated lock.

**Parameters:**
- `host`: Target hostname
- `port`: Target port number
- `supports_http2`: HTTP/2 support status to cache

**Notes:**
- Cannot reset a previously set non-None value to None
- Releases the lock to unblock waiting threads

## Module Interface

### Public Functions

```python
# Get cached HTTP/2 status (may acquire lock)
status = acquire_and_get("example.com", 443)

# Set HTTP/2 status and release lock  
set_and_release("example.com", 443, True)
```

### Testing Functions

- `_values()`: Returns current cache state (testing only)
- `_reset()`: Clears all cache data (testing only)

## Usage Pattern

```python
# Thread 1: Check if HTTP/2 support is known
status = acquire_and_get("api.example.com", 443)
if status is None:
    # Perform HTTP/2 probe here
    supports_h2 = perform_http2_probe("api.example.com", 443)
    set_and_release("api.example.com", 443, supports_h2)
else:
    # Use cached result
    use_http2 = status
```

## Important Notes

### Thread Safety Considerations

- Uses a two-level locking mechanism for efficiency
- Main lock (`_lock`) protects cache structure
- Individual RLocks per host-port prevent blocking unrelated probes
- Proper exception handling prevents deadlocks

### Design Decisions

- **Singleton Pattern**: Single global cache instance via `_HTTP2_PROBE_CACHE`
- **Lazy Initialization**: Cache entries created on first access
- **RLock Usage**: Allows same thread to acquire lock multiple times safely

### Potential Issues

- **Memory Growth**: Cache grows indefinitely (no expiration/eviction)
- **Lock Contention**: High concurrency on same endpoints may cause blocking
- **Error Handling**: Defensive programming against unexpected exceptions

## Recommendations

1. **Monitor Memory Usage**: Consider adding cache size limits or TTL
2. **Error Logging**: Add logging for debugging cache behavior
3. **Metrics**: Track cache hit/miss ratios for performance monitoring
4. **Documentation**: Consider adding type hints for better IDE support