<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP/2 Probe Cache Module

## Overview

This module implements a thread-safe caching mechanism for HTTP/2 protocol support detection. It provides a way to cache and retrieve the HTTP/2 capability status of various host-port combinations, preventing redundant protocol probes across multiple threads.

## Purpose

- **Avoid redundant HTTP/2 probes**: Cache the results of HTTP/2 support detection for specific origins
- **Thread-safe operations**: Ensure multiple threads can safely access and modify the cache
- **Synchronization**: Coordinate between threads to prevent duplicate probes for the same origin

## Main Components

### Class: `_HTTP2ProbeCache`

A thread-safe cache implementation that stores HTTP/2 support information for host-port pairs.

#### Attributes

- `_lock`: Main threading lock for protecting cache initialization
- `_cache_locks`: Dictionary mapping origin keys to individual RLocks for fine-grained locking
- `_cache_values`: Dictionary storing the actual HTTP/2 support status for each origin

#### Key Methods

##### `acquire_and_get(host: str, port: int) -> bool | None`

Retrieves cached HTTP/2 support status for a given origin and acquires a lock for that origin.

**Parameters:**
- `host`: Target hostname
- `port`: Target port number

**Returns:**
- `True`: HTTP/2 is supported
- `False`: HTTP/2 is not supported  
- `None`: Status unknown/being probed

**Behavior:**
- If value exists in cache, returns immediately
- If value doesn't exist, initializes cache entry and acquires origin-specific lock
- Designed to coordinate with other threads probing the same origin

##### `set_and_release(host: str, port: int, supports_http2: bool | None) -> None`

Updates the cache with HTTP/2 support status and releases the origin-specific lock.

**Parameters:**
- `host`: Target hostname
- `port`: Target port number
- `supports_http2`: HTTP/2 support status to cache

**Behavior:**
- Updates cache value
- Releases the origin-specific lock acquired by `acquire_and_get`
- Includes defensive check against resetting already-determined values

##### Testing Methods

- `_values()`: Returns current cache state (testing only)
- `_reset()`: Clears all cache data (testing only)

## Module-Level Interface

The module exposes a singleton cache instance through these functions:

```python
# Public interface
set_and_release(host, port, supports_http2)
acquire_and_get(host, port)

# Private/testing interface  
_values()
_reset()
```

## Usage Pattern

```python
# Thread 1: Check cache and acquire lock
status = acquire_and_get("example.com", 443)
if status is None:
    # Perform HTTP/2 probe
    result = perform_http2_probe("example.com", 443)
    # Update cache and release lock
    set_and_release("example.com", 443, result)
else:
    # Use cached result
    use_cached_status(status)
```

## Thread Safety Notes

- Uses a two-level locking strategy:
  - Main lock (`_lock`) protects cache structure modifications
  - Per-origin locks (`RLock`) coordinate probing for specific origins
- RLock allows the same thread to acquire the lock multiple times
- Defensive exception handling prevents lock leaks

## Recommendations

- **Error Handling**: Always wrap probe operations in try-catch blocks
- **Lock Management**: Ensure `set_and_release` is called after `acquire_and_get` to prevent deadlocks
- **Testing**: Use `_reset()` method to clean cache state between tests
- **Monitoring**: Consider adding metrics/logging for cache hit rates and probe frequency

## Potential Improvements

- Add cache expiration/TTL functionality
- Implement cache size limits to prevent unbounded growth
- Add metrics for cache performance monitoring
- Consider using `weakref` for automatic cleanup of unused entries