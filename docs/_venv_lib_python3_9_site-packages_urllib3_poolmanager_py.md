<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# PoolManager Documentation

## Overview

This module provides connection pool management functionality for urllib3, allowing efficient HTTP/HTTPS request handling with automatic connection pooling and proxy support. The main classes manage multiple connection pools transparently, reusing connections when possible and handling redirects, retries, and proxy configurations.

## Purpose

- **Connection Pool Management**: Automatically manages multiple HTTP/HTTPS connection pools
- **Resource Optimization**: Reuses connections to reduce overhead and improve performance
- **Proxy Support**: Handles HTTP and HTTPS proxies with tunneling support
- **Request Routing**: Routes requests to appropriate connection pools based on host, port, and scheme

## Key Classes

### PoolKey

A `NamedTuple` that serves as a unique identifier for connection pools.

```python
class PoolKey(typing.NamedTuple):
    key_scheme: str
    key_host: str  
    key_port: int | None
    # ... additional SSL, proxy, and connection parameters
```

**Purpose**: Creates immutable keys for caching connection pools based on connection parameters.

### PoolManager

The main class for managing multiple connection pools automatically.

```python
class PoolManager(RequestMethods):
    def __init__(
        self,
        num_pools: int = 10,
        headers: typing.Mapping[str, str] | None = None,
        **connection_pool_kw: typing.Any,
    ) -> None:
```

#### Key Features:
- **Automatic Pool Management**: Creates and caches connection pools as needed
- **LRU Cache**: Uses `RecentlyUsedContainer` to limit pool count and evict old pools
- **Context Manager**: Supports `with` statement for automatic cleanup
- **Thread-Safe**: Uses locking for concurrent access to pools

#### Important Methods:

##### `urlopen(method, url, redirect=True, **kw)`
Main method for making HTTP requests.

```python
# Example usage
http = urllib3.PoolManager(num_pools=2)
resp = http.request("GET", "https://google.com/")
```

- Handles redirects automatically (when `redirect=True`)
- Manages cross-host redirects
- Processes 303 redirects per RFC 9110

##### `connection_from_host(host, port=None, scheme="http", pool_kwargs=None)`
Gets or creates a connection pool for a specific host.

##### `connection_from_url(url, pool_kwargs=None)`
Convenience method to get a connection pool from a URL string.

##### `clear()`
Closes all connection pools and clears the cache.

### ProxyManager

Extends `PoolManager` to route all requests through a proxy server.

```python
class ProxyManager(PoolManager):
    def __init__(
        self,
        proxy_url: str,
        proxy_headers: typing.Mapping[str, str] | None = None,
        proxy_ssl_context: ssl.SSLContext | None = None,
        use_forwarding_for_https: bool = False,
        # ... additional proxy parameters
    ) -> None:
```

#### Key Features:
- **HTTP/HTTPS Proxy Support**: Works with both HTTP and HTTPS proxies
- **CONNECT Tunneling**: Uses HTTP CONNECT for HTTPS requests through HTTP proxies
- **Proxy Authentication**: Supports proxy headers for authentication
- **SSL Context**: Configurable SSL context for HTTPS proxies

#### Important Parameters:
- `use_forwarding_for_https`: When `True`, forwards HTTPS requests instead of tunneling (⚠️ **Security Warning**: Headers and content visible to proxy)
- `proxy_headers`: Headers sent to proxy (authentication, etc.)
- `proxy_ssl_context`: SSL configuration for HTTPS proxy connections

## Important Functions

### `proxy_from_url(url, **kw)`
Convenience function to create a `ProxyManager` from a URL string.

```python
proxy = urllib3.proxy_from_url("https://proxy.example.com:8080/")
```

### `_default_key_normalizer(key_class, request_context)`
Creates standardized pool keys from request context:
- Normalizes scheme and host to lowercase (per RFC 3986)
- Converts mutable types (dicts, lists) to immutable types (frozensets, tuples)
- Handles default values and key prefixing

## Configuration

### Global Configuration
```python
# Modify global pool class mapping
pool_classes_by_scheme = {"http": HTTPConnectionPool, "https": HTTPSConnectionPool}

# Modify global key generation
key_fn_by_scheme = {
    "http": functools.partial(_default_key_normalizer, PoolKey),
    "https": functools.partial(_default_key_normalizer, PoolKey),
}
```

### SSL Keywords
The following SSL-related parameters are recognized:
- `ssl_context`, `cert_file`, `key_file`, `ca_certs`
- `ssl_version`, `ssl_minimum_version`, `ssl_maximum_version`
- `cert_reqs`, `ca_cert_dir`, `server_hostname`

## Usage Examples

### Basic Usage
```python
import urllib3

# Create pool manager
http = urllib3.PoolManager(num_pools=10)

# Make requests - pools created automatically  
resp1 = http.request("GET", "https://httpbin.org/get")
resp2 = http.request("POST", "https://httpbin.org/post", fields={'key': 'value'})

# Clean up
http.clear()
```

### Proxy Usage
```python
import urllib3

# Create proxy manager
proxy = urllib3.ProxyManager(
    "https://proxy.example.com:8080/",
    proxy_headers={'Proxy-Authorization': 'Basic dXNlcjpwYXNz'}
)

resp = proxy.request("GET", "https://httpbin.org/ip")
```

### Context Manager
```python
with urllib3.PoolManager() as http:
    resp = http.request("GET", "https://httpbin.org/get")
    # Automatically cleaned up when exiting context
```

## Notes and Recommendations

### Security Considerations
- ⚠️ **ProxyManager with `use_forwarding_for_https=True`**: Request/response