<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Socket Utilities Module (`util/connection.py`)

## Overview

This module provides low-level socket connection utilities for urllib3. It handles the creation of socket connections with enhanced features like IPv6 support detection, socket options configuration, and connection state management.

## Purpose

The primary purpose of this module is to:
- Create robust TCP socket connections with proper error handling
- Detect and handle IPv6 availability
- Manage socket-level options and timeouts
- Provide connection state utilities for HTTP connections

## Type Definitions

```python
_TYPE_SOCKET_OPTIONS = list[tuple[int, int, typing.Union[int, bytes]]]
```

- **`_TYPE_SOCKET_OPTIONS`**: Defines the structure for socket options as a list of tuples containing socket level, option name, and option value.

## Functions

### `is_connection_dropped(conn: BaseHTTPConnection) -> bool`

Checks if an HTTP connection has been dropped and should be closed.

**Parameters:**
- `conn`: A BaseHTTPConnection object to check

**Returns:**
- `bool`: True if the connection is dropped, False otherwise

**Usage:**
```python
if is_connection_dropped(my_connection):
    # Handle dropped connection
    my_connection.close()
```

### `create_connection(address, timeout, source_address, socket_options) -> socket.socket`

The main function for creating socket connections with enhanced features.

**Parameters:**
- `address`: Tuple of `(host, port)` to connect to
- `timeout`: Connection timeout (defaults to `_DEFAULT_TIMEOUT`)
- `source_address`: Optional tuple of `(host, port)` for binding source address
- `socket_options`: Optional list of socket options to apply

**Returns:**
- `socket.socket`: Connected socket object

**Features:**
- IPv6 bracket notation support (strips `[]` from hostnames)
- IDNA encoding validation for international domain names
- Automatic IPv4/IPv6 family selection
- Socket option configuration
- Proper error handling and cleanup

**Example:**
```python
# Basic connection
sock = create_connection(('example.com', 80))

# With timeout and source binding
sock = create_connection(
    ('example.com', 443),
    timeout=30.0,
    source_address=('', 0)
)
```

### `allowed_gai_family() -> socket.AddressFamily`

Determines the appropriate address family for `getaddrinfo()` calls.

**Returns:**
- `socket.AF_INET`: If IPv6 is not available
- `socket.AF_UNSPEC`: If IPv6 is available (allows both IPv4 and IPv6)

### `_has_ipv6(host: str) -> bool`

**Internal function** that tests IPv6 availability by attempting to bind to an IPv6 address.

**Parameters:**
- `host`: IPv6 address to test binding (typically `"::1"`)

**Returns:**
- `bool`: True if IPv6 is supported and available

### `_set_socket_options(sock: socket.socket, options: _TYPE_SOCKET_OPTIONS | None) -> None`

**Internal function** that applies socket-level options to a socket.

**Parameters:**
- `sock`: Socket object to configure
- `options`: List of socket options or None

## Global Variables

### `HAS_IPV6`

A boolean constant that indicates whether the system supports IPv6. It's determined at module import time by testing IPv6 binding capability.

## Error Handling

The module handles several types of errors:

- **`LocationParseError`**: Raised when hostname cannot be encoded as IDNA
- **`OSError`**: Caught and re-raised for connection failures
- **`UnicodeError`**: Caught when IDNA encoding fails

## Notes and Suggestions

### Important Notes

1. **IPv6 Detection**: The module performs runtime IPv6 detection rather than relying solely on compile-time flags
2. **Reference Cycles**: The code explicitly breaks reference cycles in exception handling to prevent memory leaks
3. **Platform Compatibility**: Based on Python 2.7 standard library implementation with urllib3-specific enhancements

### Usage Recommendations

- Always handle potential `LocationParseError` when dealing with user-provided hostnames
- Consider the timeout parameter for network reliability
- Use source_address binding when you need to control the outgoing interface
- The module automatically handles IPv6 bracket notation, so `[::1]` becomes `::1`

### Dependencies

- Requires `socket` (standard library)
- Imports from `..exceptions.LocationParseError`
- Imports timeout-related types from `.timeout`
- Uses `BaseHTTPConnection` type for connection checking