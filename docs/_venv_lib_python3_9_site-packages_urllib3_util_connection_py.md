<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Connection Utilities Module

## Overview

This module provides low-level socket connection utilities for the urllib3 library. It handles the creation and management of socket connections with support for both IPv4 and IPv6, custom socket options, timeouts, and connection state detection.

## Purpose

The primary purpose of this module is to:
- Create socket connections with enhanced configuration options
- Detect dropped connections
- Handle IPv6 availability detection
- Provide a robust connection establishment process with proper error handling

## Key Functions

### `create_connection(address, timeout, source_address, socket_options)`

The main function for establishing socket connections with enhanced features.

```python
def create_connection(
    address: tuple[str, int],
    timeout: _TYPE_TIMEOUT = _DEFAULT_TIMEOUT,
    source_address: tuple[str, int] | None = None,
    socket_options: _TYPE_SOCKET_OPTIONS | None = None,
) -> socket.socket:
```

**Parameters:**
- `address`: A tuple of (host, port) to connect to
- `timeout`: Connection timeout value
- `source_address`: Optional tuple of (host, port) for binding the socket before connecting
- `socket_options`: Optional list of socket options to apply

**Features:**
- Handles IPv6 bracket notation in hostnames
- Uses IDNA encoding for international domain names
- Automatically selects appropriate address family (IPv4/IPv6)
- Applies custom socket options before connecting
- Includes proper error handling and resource cleanup

### `is_connection_dropped(conn)`

Checks if a connection has been dropped and should be closed.

```python
def is_connection_dropped(conn: BaseHTTPConnection) -> bool:
```

**Parameters:**
- `conn`: HTTP connection object to check

**Returns:** Boolean indicating if the connection is dropped

### `allowed_gai_family()`

Determines the appropriate address family for `getaddrinfo()` calls.

```python
def allowed_gai_family() -> socket.AddressFamily:
```

**Returns:** 
- `socket.AF_UNSPEC` if IPv6 is available (allows both IPv4 and IPv6)
- `socket.AF_INET` if only IPv4 is available

## Helper Functions

### `_set_socket_options(sock, options)`

Internal function that applies socket options to a socket.

### `_has_ipv6(host)`

Tests IPv6 availability by attempting to bind to an IPv6 address.

## Type Definitions

```python
_TYPE_SOCKET_OPTIONS = list[tuple[int, int, typing.Union[int, bytes]]]
```

Defines the structure for socket options as a list of tuples containing:
- Socket level (int)
- Option name (int) 
- Option value (int or bytes)

## Module Constants

- `HAS_IPV6`: Boolean constant indicating IPv6 availability on the system

## Important Notes

### IPv6 Handling
- The module automatically detects IPv6 availability at import time
- IPv6 addresses in brackets (e.g., `[::1]`) are properly handled
- Falls back to IPv4-only if IPv6 is not available

### Error Handling
- Raises `LocationParseError` for invalid hostnames (empty labels or too long)
- Properly handles and re-raises `OSError` exceptions during connection attempts
- Includes explicit reference cycle breaking to prevent memory leaks

### Socket Management
- Automatically closes sockets on connection failure
- Applies custom socket options before attempting connection
- Supports binding to specific source addresses

## Usage Examples

```python
# Basic connection
sock = create_connection(('example.com', 80))

# With timeout and source address
sock = create_connection(
    ('example.com', 80),
    timeout=30,
    source_address=('192.168.1.100', 0)
)

# With custom socket options
socket_opts = [(socket.SOL_SOCKET, socket.SO_KEEPALIVE, 1)]
sock = create_connection(
    ('example.com', 80),
    socket_options=socket_opts
)
```

## Dependencies

- Standard library `socket` module
- Custom timeout utilities (`timeout` module)
- Custom exception classes (`LocationParseError`)