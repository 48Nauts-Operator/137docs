<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Connection Tunnel Utility

## Overview

This module provides utility functions for determining when HTTP tunneling is required for proxy connections. It's part of a larger HTTP client library and helps decide whether to establish an HTTP CONNECT tunnel through a proxy server or to forward requests directly.

## Purpose

The primary purpose of this module is to encapsulate the logic for determining when an HTTP CONNECT tunnel is necessary when routing requests through a proxy server. This decision depends on several factors including:

- The presence of a proxy
- The destination protocol scheme
- Proxy configuration settings
- The proxy's own protocol scheme

## Dependencies

```python
from __future__ import annotations
import typing
from .url import Url
```

- Uses future annotations for improved type hinting
- Imports `Url` class from local url module
- Conditionally imports `ProxyConfig` type for type checking only

## Functions

### `connection_requires_http_tunnel()`

```python
def connection_requires_http_tunnel(
    proxy_url: Url | None = None,
    proxy_config: ProxyConfig | None = None,
    destination_scheme: str | None = None,
) -> bool:
```

**Purpose**: Determines whether an HTTP CONNECT tunnel is required for a proxy connection.

**Parameters**:
- `proxy_url` (Url | None): The URL of the proxy server
- `proxy_config` (ProxyConfig | None): Proxy configuration object containing settings
- `destination_scheme` (str | None): The protocol scheme of the destination (e.g., "http", "https")

**Returns**: 
- `bool`: `True` if HTTP tunneling is required, `False` otherwise

**Logic Flow**:

1. **No Proxy Check**: Returns `False` if no proxy is configured
   ```python
   if proxy_url is None:
       return False
   ```

2. **HTTP Destination Check**: Returns `False` for HTTP destinations (always forwarded)
   ```python
   if destination_scheme == "http":
       return False
   ```

3. **HTTPS Proxy Forwarding**: Returns `False` if using HTTPS proxy with forwarding enabled
   ```python
   if (proxy_url.scheme == "https" and 
       proxy_config and 
       proxy_config.use_forwarding_for_https):
       return False
   ```

4. **Default Behavior**: Returns `True` for all other cases (tunnel required)

## Usage Examples

```python
# No proxy - no tunnel needed
requires_tunnel = connection_requires_http_tunnel(
    proxy_url=None,
    destination_scheme="https"
)
# Returns: False

# HTTP destination - no tunnel needed  
requires_tunnel = connection_requires_http_tunnel(
    proxy_url=Url("http://proxy:8080"),
    destination_scheme="http"
)
# Returns: False

# HTTPS destination through HTTP proxy - tunnel needed
requires_tunnel = connection_requires_http_tunnel(
    proxy_url=Url("http://proxy:8080"),
    destination_scheme="https"
)
# Returns: True
```

## Notes and Considerations

- **Security**: HTTP destinations never require tunneling as they can be safely forwarded through proxies
- **HTTPS Support**: The module supports special handling for HTTPS proxies with forwarding capabilities
- **Default Behavior**: When in doubt, the function defaults to requiring a tunnel for maximum security
- **Type Safety**: Uses modern Python type hints with union syntax (`|`) for better code clarity

## Integration Notes

This utility is typically used by:
- Connection pool managers
- HTTP client implementations  
- Proxy configuration systems

The function helps ensure proper security practices by defaulting to tunneling when handling encrypted connections through proxies.