<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# HTTP Request Utilities Module

This module provides utilities for handling HTTP request headers, body content, and file positioning for the urllib3 library. It's primarily used internally by urllib3 to prepare and manage HTTP requests, especially for handling redirects, retries, and various body types.

## Purpose

The module serves several key functions:

- **Header generation**: Creates common HTTP headers with proper formatting
- **Body processing**: Converts different body types (strings, files, iterables) into chunked data suitable for HTTP transmission
- **File positioning**: Manages file pointer positions for request body rewinding during redirects/retries
- **Content encoding**: Automatically detects available compression libraries and sets appropriate accept-encoding headers

## Constants

### Header Management
- `SKIP_HEADER`: Special token (`"@@@SKIP_HEADER@@@"`) used to skip automatic header emission
- `SKIPPABLE_HEADERS`: Headers that can be skipped (`accept-encoding`, `host`, `user-agent`)

### Content Encoding
- `ACCEPT_ENCODING`: Dynamically built string of supported encodings
  - Base: `"gzip,deflate"`
  - Adds `",br"` if Brotli is available
  - Adds `",zstd"` if Zstandard is available

### HTTP Methods
- `_METHODS_NOT_EXPECTING_BODY`: Set of HTTP methods that typically don't include a request body

## Key Functions

### `make_headers()`

Generates HTTP request headers with common options.

```python
def make_headers(
    keep_alive: bool | None = None,
    accept_encoding: bool | list[str] | str | None = None,
    user_agent: str | None = None,
    basic_auth: str | None = None,
    proxy_basic_auth: str | None = None,
    disable_cache: bool | None = None,
) -> dict[str, str]:
```

**Parameters:**
- `keep_alive`: Adds `Connection: keep-alive` header
- `accept_encoding`: Sets compression preferences (boolean, list, or string)
- `user_agent`: Custom user agent string
- `basic_auth`: Username:password for basic authentication
- `proxy_basic_auth`: Username:password for proxy authentication
- `disable_cache`: Adds `Cache-Control: no-cache` header

**Example:**
```python
headers = make_headers(
    keep_alive=True, 
    user_agent="MyApp/1.0",
    accept_encoding=True
)
# Returns: {'connection': 'keep-alive', 'user-agent': 'MyApp/1.0', 'accept-encoding': 'gzip,deflate'}
```

### `body_to_chunks()`

Converts various body types into chunks suitable for HTTP transmission.

```python
def body_to_chunks(
    body: typing.Any | None, 
    method: str, 
    blocksize: int
) -> ChunksAndContentLength:
```

**Handles:**
- `None`: No body
- `str`/`bytes`: Direct conversion
- File-like objects: Chunked reading
- Buffer protocol objects: Memory views
- Iterables: Direct iteration

**Returns:** `ChunksAndContentLength` named tuple with chunks and content length

### `set_file_position()` & `rewind_body()`

Manage file positioning for request body rewinding during redirects/retries.

```python
def set_file_position(body: typing.Any, pos: _TYPE_BODY_POSITION | None) -> _TYPE_BODY_POSITION | None:
def rewind_body(body: typing.IO[typing.AnyStr], body_pos: _TYPE_BODY_POSITION) -> None:
```

- `set_file_position()`: Records or sets file position
- `rewind_body()`: Attempts to rewind file to previous position

## Classes and Types

### `ChunksAndContentLength`
Named tuple containing:
- `chunks`: Iterable of bytes or None
- `content_length`: Integer length or None (indicating chunked encoding needed)

### `_TYPE_FAILEDTELL`
Enum used as a sentinel value when `tell()` operations fail on file-like objects.

## Error Handling

The module raises `UnrewindableBodyError` when:
- File seek operations fail during rewind attempts
- File position cannot be determined for rewinding

## Notes and Suggestions

### For Library Users
- Use `make_headers()` for consistent header generation
- The module automatically detects available compression libraries
- Basic auth credentials are automatically base64-encoded

### For Contributors
- The module uses duck typing extensively for body type detection
- File positioning logic handles edge cases where `tell()` may fail
- Content-Length is intelligently set based on HTTP method and body type
- Consider the security implications of basic auth (credentials in memory)

### Dependencies
Optional compression libraries enhance functionality:
- `brotli` or `brotlicffi` for Brotli compression
- `zstandard` for Zstandard compression

The module gracefully degrades when these libraries are unavailable.