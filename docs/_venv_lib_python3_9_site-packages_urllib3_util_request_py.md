<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# HTTP Request Utilities Module

This module provides utility functions and constants for handling HTTP requests, including header generation, body processing, and file position management. It's part of a larger HTTP client library (likely urllib3) and focuses on request preparation and body handling.

## Purpose

The module serves as a collection of helper functions for:
- Generating common HTTP headers
- Managing request body positioning for retries/redirects
- Converting various body types into chunks suitable for network transmission
- Handling encoding detection based on available compression libraries

## Constants

### Header Management
- `SKIP_HEADER`: Special marker (`"@@@SKIP_HEADER@@@"`) to skip automatic header emission
- `SKIPPABLE_HEADERS`: Set of headers that can be skipped (`accept-encoding`, `host`, `user-agent`)

### Encoding Support
- `ACCEPT_ENCODING`: Dynamically built string of supported encodings
  - Base: `"gzip,deflate"`
  - Adds `",br"` if Brotli libraries are available
  - Adds `",zstd"` if Zstandard library is available

### HTTP Methods
- `_METHODS_NOT_EXPECTING_BODY`: HTTP methods that typically don't have request bodies

## Key Functions

### `make_headers()`

Generates HTTP headers based on provided parameters.

```python
def make_headers(
    keep_alive: bool | None = None,
    accept_encoding: bool | list[str] | str | None = None,
    user_agent: str | None = None,
    basic_auth: str | None = None,
    proxy_basic_auth: str | None = None,
    disable_cache: bool | None = None,
) -> dict[str, str]:
```

**Parameters:**
- `keep_alive`: Adds connection keep-alive header
- `accept_encoding`: Configures compression acceptance (bool/list/string)
- `user_agent`: Sets custom user agent string
- `basic_auth`: Username:password for basic authentication
- `proxy_basic_auth`: Username:password for proxy authentication
- `disable_cache`: Adds no-cache directive

**Example:**
```python
headers = make_headers(keep_alive=True, user_agent="MyApp/1.0")
# {'connection': 'keep-alive', 'user-agent': 'MyApp/1.0'}
```

### `body_to_chunks()`

Converts request bodies into chunks suitable for network transmission.

```python
def body_to_chunks(
    body: typing.Any | None, method: str, blocksize: int
) -> ChunksAndContentLength:
```

**Handles multiple body types:**
- `None`: No body (sets appropriate Content-Length based on HTTP method)
- `str/bytes`: Direct conversion to bytes
- File-like objects: Streaming read with specified blocksize
- Buffer protocol objects: Direct memory view
- Iterables: Passes through as chunk iterator

**Returns:** `ChunksAndContentLength` named tuple with chunks and content length

### File Position Management

#### `set_file_position()`
Records or sets file position for potential rewinding during retries/redirects.

#### `rewind_body()`
Attempts to rewind a file-like body to a previous position.

```python
def rewind_body(body: typing.IO[typing.AnyStr], body_pos: _TYPE_BODY_POSITION) -> None:
```

**Raises:** `UnrewindableBodyError` if rewinding fails

## Classes and Types

### `ChunksAndContentLength`
Named tuple containing:
- `chunks`: Iterable of bytes or None
- `content_length`: Integer length or None (indicates chunked encoding needed)

### `_TYPE_FAILEDTELL`
Enum used as a sentinel value when `tell()` operations fail on file objects.

## Important Notes

### ‚ö†Ô∏è Encoding Detection
The module dynamically detects available compression libraries at import time:
- Tries `brotlicffi` first, falls back to `brotli`
- Checks for `zstandard` availability
- Gracefully handles missing optional dependencies

### üîÑ Body Handling Strategy
The `body_to_chunks()` function uses a progressive approach:
1. Check for None/empty body
2. Handle simple string/bytes
3. Check for file-like objects (`.read()` method)
4. Try buffer protocol (`memoryview()`)
5. Fall back to iteration
6. Raise TypeError if none work

### üö® Error Handling
- File positioning failures raise `UnrewindableBodyError`
- Invalid body types raise `TypeError` with descriptive messages
- Failed tell operations are tracked separately from None positions

## Dependencies

- `base64`: For authentication header encoding
- `io`: For text stream detection
- `typing`: For type hints
- Custom exceptions: `UnrewindableBodyError`
- Utility functions: `to_bytes`

This module is designed to be robust and handle various edge cases in HTTP request preparation while maintaining good performance for common use cases.