<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# SSL Utilities Module Documentation

## Overview

This module provides SSL/TLS utilities and helper functions for urllib3. It handles SSL context creation, certificate validation, socket wrapping, and various SSL-related operations with support for different Python implementations and OpenSSL versions.

## Purpose

- Create and configure SSL contexts with secure defaults
- Wrap sockets with SSL/TLS encryption
- Validate SSL certificates and fingerprints
- Handle compatibility issues across different Python versions and SSL implementations
- Support TLS-in-TLS scenarios for proxy connections

## Key Components

### Constants and Configuration

#### Hash Function Mapping
```python
HASHFUN_MAP = {
    32: hashlib.md5,    # MD5 fingerprints
    40: hashlib.sha1,   # SHA1 fingerprints  
    64: hashlib.sha256  # SHA256 fingerprints
}
```

#### SSL Protocol Settings
- `ALPN_PROTOCOLS = ["http/1.1"]` - Application Layer Protocol Negotiation
- Various SSL option flags (`OP_NO_SSLv2`, `OP_NO_SSLv3`, etc.)
- Protocol version mappings

### Important Functions

#### `assert_fingerprint(cert: bytes | None, fingerprint: str) -> None`

Validates that a certificate matches the expected fingerprint.

**Parameters:**
- `cert`: Certificate as bytes object
- `fingerprint`: Expected fingerprint as hex string (colons optional)

**Raises:**
- `SSLError`: If certificate is None, fingerprint format is invalid, or fingerprints don't match

**Example:**
```python
assert_fingerprint(cert_bytes, "sha256:1234567890abcdef...")
```

#### `create_urllib3_context(...) -> ssl.SSLContext`

Creates and configures an SSL context with secure defaults for urllib3.

**Key Parameters:**
- `ssl_minimum_version`: Minimum TLS version (recommended over `ssl_version`)
- `ssl_maximum_version`: Maximum TLS version  
- `cert_reqs`: Certificate verification requirements
- `options`: OpenSSL-specific options
- `ciphers`: Allowed cipher suites
- `verify_flags`: Certificate verification flags

**Returns:** Configured `SSLContext` object

**Security Features:**
- Disables SSLv2 and SSLv3 by default
- Disables compression to prevent CRIME attacks
- Sets minimum TLS version to 1.2
- Enables post-handshake authentication for TLS 1.3

#### `ssl_wrap_socket(...) -> ssl.SSLSocket | SSLTransportType`

Wraps a socket with SSL/TLS encryption.

**Key Parameters:**
- `sock`: Socket to wrap
- `server_hostname`: Expected hostname for SNI
- `ssl_context`: Pre-configured SSL context (optional)
- `tls_in_tls`: Enable TLS-in-TLS for proxy scenarios
- `ca_certs`, `ca_cert_dir`, `ca_cert_data`: Certificate authority options
- `keyfile`, `certfile`, `key_password`: Client certificate options

**Returns:** SSL-wrapped socket or SSLTransport for TLS-in-TLS

#### `resolve_cert_reqs(candidate: None | int | str) -> VerifyMode`

Resolves certificate requirement specifications to SSL constants.

**Parameters:**
- `candidate`: Can be None, int constant, or string name

**Examples:**
```python
resolve_cert_reqs("REQUIRED")     # -> ssl.CERT_REQUIRED
resolve_cert_reqs("CERT_NONE")    # -> ssl.CERT_NONE
resolve_cert_reqs(None)           # -> ssl.CERT_REQUIRED (default)
```

#### `is_ipaddress(hostname: str | bytes) -> bool`

Detects if a hostname is an IP address (IPv4 or IPv6).

**Returns:** True if hostname is an IP address, False otherwise

### Compatibility Functions

#### `_is_bpo_43522_fixed(...) -> bool`

Checks if the Python implementation has the fix for BPO-43522 (hostname checking issue).

#### `_is_has_never_check_common_name_reliable(...) -> bool`

Determines if the `HAS_NEVER_CHECK_COMMON_NAME` feature works reliably in the current environment.

## Usage Examples

### Basic SSL Context Creation
```python
# Create context with secure defaults
context = create_urllib3_context(
    ssl_minimum_version=ssl.TLSVersion.TLSv1_2,
    cert_reqs=ssl.CERT_REQUIRED
)
```

### Wrapping a Socket
```python
# Wrap socket with SSL
ssl_socket = ssl_wrap_socket(
    sock,
    server_hostname="example.com",
    cert_reqs=ssl.CERT_REQUIRED
)
```

### Certificate Fingerprint Validation
```python
# Validate certificate fingerprint
assert_fingerprint(cert_der_bytes, "sha256:abcd1234...")
```

## Important Notes

### Security Considerations
- Always use `ssl_minimum_version` instead of deprecated `ssl_version`
- The module automatically disables insecure SSL/TLS versions
- Certificate verification is enabled by default
- Compression is disabled to prevent CRIME attacks

### Compatibility Issues
- **LibreSSL**: May not properly reject certificates with only common names
- **PyOpenSSL**: Requires special handling for hostname verification
- **Python < 3.9.3**: Has limitations with `hostname_checks_common_name`

### Environment Variables
- `SSLKEYLOGFILE`: If set, SSL keys will be logged to the specified file for debugging

### Error Handling
The module raises `SSLError` exceptions for SSL-related problems and `ProxySchemeUnsupported` for unsupported proxy configurations.

## Dependencies

- `ssl` module (optional, with fallback constants)
- `hashlib` for fingerprint validation
- `hmac` for secure comparisons
- Custom `.ssltransport` module for TLS-in-TLS support

## Deprecation Warnings

- The `ssl_version` parameter is deprecated in favor of `ssl_minimum_version`
- Users should migrate to using TLS version enums instead of protocol constants