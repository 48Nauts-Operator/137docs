<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# SSL Hostname Matching Module

This module provides SSL certificate hostname verification functionality, implementing the `match_hostname()` function from Python 3.5. It's essential for secure SSL/TLS connections to verify that the certificate presented by a server matches the hostname being connected to.

## Purpose

- **SSL Certificate Verification**: Validates that SSL certificates match the intended hostname
- **RFC Compliance**: Implements RFC 2818 and RFC 6125 standards for hostname matching
- **Security Enhancement**: Prevents man-in-the-middle attacks by ensuring certificate validity
- **Compatibility**: Provides Python 3.5+ functionality for older Python versions

## Key Components

### Exception Classes

#### `CertificateError`
```python
class CertificateError(ValueError):
    pass
```
- Custom exception raised when certificate hostname verification fails
- Inherits from `ValueError`

### Core Functions

#### `match_hostname(cert, hostname, hostname_checks_common_name=False)`

The main function for certificate hostname verification.

**Parameters:**
- `cert`: Certificate dictionary returned by `SSLSocket.getpeercert()`
- `hostname`: Target hostname to verify against
- `hostname_checks_common_name`: Whether to check the certificate's commonName field (default: False)

**Behavior:**
- Returns `None` on successful match
- Raises `CertificateError` on verification failure
- Raises `ValueError` if certificate is empty or None

**Example Usage:**
```python
import ssl
import socket

# Get certificate from SSL connection
sock = socket.create_connection(('example.com', 443))
context = ssl.create_default_context()
ssock = context.wrap_socket(sock, server_hostname='example.com')
cert = ssock.getpeercert()

# Verify hostname matches certificate
match_hostname(cert, 'example.com')
```

#### `_dnsname_match(dn, hostname, max_wildcards=1)`

Internal function for DNS name pattern matching according to RFC 6125.

**Features:**
- Supports wildcard certificates (e.g., `*.example.com`)
- Limits wildcards to prevent denial-of-service attacks
- Handles internationalized domain names (IDN)
- Case-insensitive matching

**Parameters:**
- `dn`: DNS name from certificate
- `hostname`: Hostname to match against
- `max_wildcards`: Maximum allowed wildcards (default: 1)

#### `_ipaddress_match(ipname, host_ip)`

Internal function for exact IP address matching according to RFC 9110.

**Features:**
- Supports both IPv4 and IPv6 addresses
- Performs exact binary comparison of IP addresses
- Handles trailing newlines from OpenSSL

## Security Features

### Wildcard Restrictions
- **Limited Wildcards**: Maximum of 1 wildcard per DNS name fragment
- **Leftmost Only**: Wildcards only allowed in the leftmost label
- **IDN Protection**: No wildcards in internationalized domain names

### IP Address Handling
- **Binary Comparison**: Uses packed IP address format for exact matching
- **IPv6 Scope Support**: Strips zone IDs for compatibility
- **No Common Name**: IP addresses aren't checked against commonName field

## Implementation Notes

### License and Origin
- **PSF License**: Code derived from Python standard library
- **Modified Version**: CommonName support removed by default
- **Version**: 3.5.0.1

### Compatibility Considerations
```python
# IPv6 scoped address handling for Python < 3.9
if "%" in hostname:
    host_ip = ipaddress.ip_address(hostname[: hostname.rfind("%")])
```

### Certificate Structure Expected
The function expects certificates in the format returned by `ssl.SSLSocket.getpeercert()`:
```python
{
    'subjectAltName': (('DNS', 'example.com'), ('IP Address', '192.0.2.1')),
    'subject': ((('commonName', 'example.com'),),)
}
```

## Usage Recommendations

### Best Practices
- **Use subjectAltName**: Prefer SAN over commonName for modern certificates
- **Disable commonName**: Keep `hostname_checks_common_name=False` for security
- **Handle Exceptions**: Always catch `CertificateError` for proper error handling
- **Validate Input**: Ensure certificates are properly decoded before verification

### Error Handling
```python
try:
    match_hostname(cert, hostname)
    print("Certificate matches hostname")
except CertificateError as e:
    print(f"Certificate verification failed: {e}")
except ValueError as e:
    print(f"Invalid certificate or parameters: {e}")
```

### Common Issues
- **Empty Certificates**: Ensure SSL context uses `CERT_OPTIONAL` or `CERT_REQUIRED`
- **IP Address Hostnames**: Use proper IP address format for numeric hostnames
- **Wildcard Certificates**: Understand wildcard limitations and security implications

## Dependencies

- `ipaddress`: For IP address parsing and validation
- `re`: For regular expression pattern matching
- `typing`: For type hints and annotations