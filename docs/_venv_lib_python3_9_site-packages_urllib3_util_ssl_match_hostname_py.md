<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# SSL Hostname Matching Module

## Overview

This module provides SSL certificate hostname verification functionality, implementing a Python 3.5-compatible version of the `match_hostname()` function. It's essential for secure SSL/TLS connections by ensuring that the certificate presented by a server matches the hostname being connected to.

**Key Features:**
- RFC 6125 compliant DNS name matching
- Wildcard certificate support with security restrictions
- IPv4 and IPv6 address matching
- Subject Alternative Name (SAN) verification
- Optional Common Name fallback support

## License and Origin

- **License**: Python Software Foundation (PSF) License
- **Source**: Modified from Python 3 standard library
- **Modifications**: Removed default commonName support for enhanced security
- **Version**: 3.5.0.1

## Classes

### `CertificateError`

```python
class CertificateError(ValueError):
    pass
```

Custom exception raised when certificate hostname verification fails.

**Inheritance**: Extends `ValueError`  
**Usage**: Thrown by `match_hostname()` when certificate validation fails

## Functions

### `_dnsname_match(dn, hostname, max_wildcards=1)`

Internal function that performs DNS name matching according to RFC 6125, section 6.4.3.

**Parameters:**
- `dn` (Any): DNS name from certificate
- `hostname` (str): Target hostname to match against
- `max_wildcards` (int): Maximum allowed wildcards (default: 1)

**Returns:**
- `Match[str] | None | bool`: Match object if successful, None/False if no match

**Key Features:**
- Wildcard support with security limits
- Case-insensitive matching
- Internationalized domain name handling
- Protection against wildcard DoS attacks

**Security Notes:**
- Limits wildcards to prevent denial of service attacks
- Refuses wildcards in internationalized domain labels (xn--)
- Only allows wildcards in leftmost label

### `_ipaddress_match(ipname, host_ip)`

Performs exact IP address matching for certificate verification.

**Parameters:**
- `ipname` (str): IP address from certificate
- `host_ip` (IPv4Address | IPv6Address): Target IP address

**Returns:**
- `bool`: True if addresses match exactly

**Implementation Details:**
- Handles trailing newlines from OpenSSL
- Compares packed byte representation for accuracy
- Supports both IPv4 and IPv6 addresses

### `match_hostname(cert, hostname, hostname_checks_common_name=False)`

Main function that verifies a certificate matches the given hostname.

**Parameters:**
- `cert`: Certificate dictionary from `SSLSocket.getpeercert()`
- `hostname` (str): Target hostname or IP address
- `hostname_checks_common_name` (bool): Whether to check commonName field (default: False)

**Returns:**
- `None`: Returns nothing on success

**Raises:**
- `ValueError`: If certificate is empty or None
- `CertificateError`: If hostname verification fails

## Verification Process

The function follows this verification order:

1. **Certificate Validation**: Ensures certificate is present
2. **IP Address Detection**: Determines if hostname is an IP address
3. **Subject Alternative Name (SAN) Check**:
   - DNS entries for hostnames
   - IP Address entries for IP addresses
4. **Common Name Fallback** (if enabled):
   - Only for hostnames (not IP addresses)
   - Only if no SAN entries found

## Usage Example

```python
import ssl
from urllib3.util.ssl_match_hostname import match_hostname, CertificateError

# Get certificate from SSL socket
sock = ssl.create_connection(('example.com', 443))
ssl_sock = ssl.wrap_socket(sock)
cert = ssl_sock.getpeercert()

try:
    match_hostname(cert, 'example.com')
    print("Certificate matches hostname")
except CertificateError as e:
    print(f"Certificate verification failed: {e}")
```

## Security Considerations

- **Wildcard Limitations**: Maximum of 1 wildcard per DNS label
- **No Common Name by Default**: Reduces attack surface by not checking commonName
- **IP Address Restrictions**: IP addresses not accepted in commonName field
- **Internationalized Domains**: Proper handling of xn-- prefixed domains

## Compatibility Notes

- **Python Version**: Compatible with Python 3.5+
- **IPv6 Scoped Addresses**: Zone IDs are stripped for compatibility with Python < 3.9
- **Type Hints**: Uses modern Python type annotations with `from __future__ import annotations`

## Dependencies

- `ipaddress`: For IP address parsing and validation
- `re`: For regular expression pattern matching
- `typing`: For type hints and annotations