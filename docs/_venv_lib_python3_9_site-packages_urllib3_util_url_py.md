<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# URL Parsing and Normalization Module

This module provides comprehensive URL parsing, validation, and normalization functionality for HTTP/HTTPS URLs. It implements RFC 3986 and RFC 6874 compliant URL parsing with support for IPv4, IPv6, and internationalized domain names (IDN).

## Purpose

The module's primary purposes are:
- Parse URL strings into structured components
- Normalize and validate URL components according to RFC standards
- Handle complex URL scenarios including IPv6 addresses with zone IDs
- Provide percent-encoding for invalid characters
- Support internationalized domain names (IDNA encoding)

## Main Classes

### `Url`

A `NamedTuple` that represents a parsed URL with the following components:

```python
Url(scheme, auth, host, port, path, query, fragment)
```

#### Fields
- `scheme`: Protocol (http, https, etc.)
- `auth`: Authentication information (username:password)
- `host`: Hostname or IP address
- `port`: Port number (integer)
- `path`: URL path
- `query`: Query string
- `fragment`: Fragment identifier

#### Key Properties

- **`hostname`**: Alias for `host` (backwards compatibility with `urlparse`)
- **`request_uri`**: Returns the absolute path including query string
- **`authority`**: Returns the full authority component (`userinfo@host:port`)
- **`netloc`**: Returns network location (`host:port`)
- **`url`**: Reconstructs the complete URL string

#### Example Usage

```python
import urllib3

# Parse a URL
parsed = urllib3.util.parse_url("https://user:pass@example.com:8080/path?query=1#fragment")
print(parsed.host)      # "example.com"
print(parsed.port)      # 8080
print(parsed.url)       # Reconstructed URL string
```

## Key Functions

### `parse_url(url: str) -> Url`

The main parsing function that converts a URL string into a `Url` object.

**Features:**
- Handles incomplete URLs with best-effort parsing
- Normalizes scheme and host components
- Validates port numbers (0-65535)
- Supports IPv4, IPv6, and IPv6 with zone IDs
- Percent-encodes invalid characters
- Removes dot segments from paths (`.` and `..`)

**Examples:**

```python
# Complete URL
parse_url('http://google.com/mail/')
# Url(scheme='http', host='google.com', port=None, path='/mail/', ...)

# Host with port only
parse_url('google.com:80')
# Url(scheme=None, host='google.com', port=80, path=None, ...)

# Path only
parse_url('/foo?bar')
# Url(scheme=None, host=None, port=None, path='/foo', query='bar', ...)
```

### `_normalize_host(host: str | None, scheme: str | None) -> str | None`

Normalizes hostname according to the URL scheme:
- Converts IPv6 addresses to lowercase
- Handles IPv6 zone IDs (RFC 6874)
- Applies IDNA encoding for internationalized domain names
- Preserves IPv4 addresses as-is

### `_encode_invalid_chars(component: str | None, allowed_chars) -> str | None`

Percent-encodes invalid characters in URL components while preserving existing valid percent-encodings.

### `_remove_path_dot_segments(path: str) -> str`

Implements RFC 3986 dot-segment removal algorithm to normalize paths by resolving `.` and `..` segments.

## Regular Expressions

The module defines comprehensive regex patterns for:

- **IPv4 addresses**: `_IPV4_RE`
- **IPv6 addresses**: `_IPV6_RE` (supports all IPv6 formats)
- **IPv6 with zone IDs**: `_IPV6_ADDRZ_RE`
- **URI components**: `_URI_RE` (scheme, authority, path, query, fragment)
- **Host and port**: `_HOST_PORT_RE`
- **Percent encoding**: `_PERCENT_RE`

## Character Sets

Predefined character sets for validation:
- `_UNRESERVED_CHARS`: Safe characters that don't need encoding
- `_SUB_DELIM_CHARS`: Sub-delimiter characters
- `_USERINFO_CHARS`: Valid characters in user info
- `_PATH_CHARS`: Valid characters in paths
- `_QUERY_CHARS` / `_FRAGMENT_CHARS`: Valid characters in queries/fragments

## Error Handling

- Raises `LocationParseError` for:
  - Invalid URL formats
  - Invalid port numbers
  - Missing IDNA module for internationalized domains
  - Invalid IDNA labels
  - Invalid request URIs

## Notes and Suggestions

### ‚ö†Ô∏è Important Considerations

1. **IDNA Dependency**: Parsing internationalized domain names requires the `idna` package
2. **Backwards Compatibility**: Empty path handling maintains compatibility with older versions
3. **Normalization**: Only HTTP/HTTPS URLs are normalized; other schemes are preserved as-is

### üí° Best Practices

- Always handle `LocationParseError` exceptions when parsing user input
- Use the `url` property to reconstruct normalized URLs
- Consider the difference between `netloc` and `authority` properties
- Validate that required URL components are present for your use case

### üîß Performance Notes

- The module uses compiled regex patterns for efficient parsing
- IDNA encoding is only applied when necessary (non-ASCII hostnames)
- Percent-encoding preserves existing valid encodings to avoid double-encoding