<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# URL Parsing Module Documentation

## Overview

This module provides robust URL parsing functionality for HTTP/HTTPS URLs. It implements RFC 3986 and RFC 6874 compliant URL parsing with support for IPv4, IPv6, and internationalized domain names (IDN). The module is designed to handle incomplete URLs with best-effort parsing and provides URL normalization capabilities.

## Purpose

- Parse URLs into structured components
- Normalize URL components according to RFC standards
- Handle IPv4 and IPv6 addresses with zone identifiers
- Support internationalized domain names
- Provide URL reconstruction from parsed components
- Ensure proper percent-encoding of URL components

## Main Classes

### `Url`

A `NamedTuple` representing a parsed URL with the following components:

```python
Url(scheme, auth, host, port, path, query, fragment)
```

#### Fields
- `scheme`: Protocol (http, https, etc.)
- `auth`: Authentication information (username:password)
- `host`: Hostname or IP address
- `port`: Port number (integer)
- `path`: URL path
- `query`: Query string
- `fragment`: Fragment identifier

#### Properties

- **`hostname`**: Alias for `host` (backwards compatibility with `urlparse`)
- **`request_uri`**: Returns the absolute path including query string
- **`authority`**: Returns the authority component (userinfo@host:port)
- **`netloc`**: Returns network location (host:port)
- **`url`**: Reconstructs the complete URL string

#### Example Usage

```python
import urllib3

# Parse a URL
parsed = urllib3.util.parse_url("https://user:pass@example.com:8080/path?query=1#fragment")
print(parsed.scheme)    # "https"
print(parsed.host)      # "example.com"
print(parsed.port)      # 8080
print(parsed.url)       # Reconstructed URL
```

## Main Functions

### `parse_url(url: str) -> Url`

Main parsing function that converts a URL string into a `Url` object.

**Parameters:**
- `url`: URL string to parse

**Returns:**
- `Url` object with parsed components

**Features:**
- Handles incomplete URLs (missing scheme, etc.)
- Normalizes components according to RFC standards
- Supports IPv6 addresses with zone identifiers
- Handles internationalized domain names

**Example:**

```python
# Complete URL
url1 = parse_url('https://google.com/mail/')
# Url(scheme='https', host='google.com', port=None, path='/mail/', ...)

# Host with port only
url2 = parse_url('google.com:80')
# Url(scheme=None, host='google.com', port=80, path=None, ...)

# Path only
url3 = parse_url('/foo?bar')
# Url(scheme=None, host=None, port=None, path='/foo', query='bar', ...)
```

## Helper Functions

### `_encode_invalid_chars(component, allowed_chars)`
- Percent-encodes URI components while preserving existing valid encodings
- Handles UTF-8 encoding and surrogate pairs

### `_normalize_host(host, scheme)`
- Normalizes hostnames according to scheme requirements
- Handles IPv6 address formatting and zone identifiers
- Processes internationalized domain names (IDNA)

### `_remove_path_dot_segments(path)`
- Implements RFC 3986 dot-segment removal algorithm
- Resolves relative path components (`.` and `..`)

### `_encode_target(target)`
- Encodes request targets for safe HTTP transmission
- Ensures proper encoding of path and query components

## Regular Expression Patterns

The module defines comprehensive regex patterns for:

- **IPv4 addresses**: `_IPV4_RE`
- **IPv6 addresses**: `_IPV6_RE` with zone identifier support
- **URI components**: `_URI_RE` for complete URL parsing
- **Host/port combinations**: `_HOST_PORT_RE`
- **Percent encoding**: `_PERCENT_RE`

## Character Sets

Defines character sets for different URL components:
- `_UNRESERVED_CHARS`: Safe characters that don't need encoding
- `_USERINFO_CHARS`: Valid characters in userinfo component
- `_PATH_CHARS`: Valid characters in path component
- `_QUERY_CHARS` / `_FRAGMENT_CHARS`: Valid characters in query/fragment

## Error Handling

- Raises `LocationParseError` for invalid URLs
- Handles missing dependencies (like `idna` module for internationalized domains)
- Validates port ranges (0-65535)

## Notes and Suggestions

### üîß **Dependencies**
- Optional dependency on `idna` module for internationalized domain name support
- Import `idna` if working with non-ASCII domain names

### ‚ö†Ô∏è **Important Considerations**
- The module only normalizes HTTP/HTTPS URLs (see `_NORMALIZABLE_SCHEMES`)
- IPv6 addresses with zone identifiers are supported per RFC 6874
- Empty paths are converted to `"/"` when other URL components are present

### üí° **Best Practices**
- Use `parse_url()` for parsing any URL string
- Check for `None` values in returned `Url` components
- Use the `url` property to reconstruct normalized URLs
- Handle `LocationParseError` exceptions for invalid input

### üîÑ **Backwards Compatibility**
- Maintains compatibility with `urllib.parse` where possible
- Some behaviors may change in future versions (see TODO comments in code)