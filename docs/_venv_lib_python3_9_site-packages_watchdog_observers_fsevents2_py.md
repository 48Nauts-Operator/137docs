<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# FSEvents Observer Module (Deprecated)

## Overview

This module provides a macOS-specific file system event monitoring implementation using Apple's FSEvents API. It is part of the `watchdog` library and offers low-level file system event detection capabilities.

> ⚠️ **DEPRECATION WARNING**: This module is deprecated and will be removed in a future release.

## Platform Support

- **Platform**: macOS only
- **Dependencies**: PyObjC framework
- **API**: Apple FSEvents

## Key Classes

### `FSEventsQueue`

A low-level FSEvents client that runs in a separate thread to monitor file system changes.

**Key Features:**
- Inherits from `Thread` for asynchronous operation
- Creates and manages FSEvents stream
- Handles Unicode normalization for paths
- Provides event buffering through a queue

**Important Methods:**
```python
def __init__(self, path: bytes | str) -> None
def run(self) -> None
def stop(self) -> None
def read_events(self) -> list[NativeEvent] | None
```

**Configuration:**
- Latency: 1.0 second
- Flags: `kFSEventStreamCreateFlagNoDefer | kFSEventStreamCreateFlagFileEvents`

### `NativeEvent`

Represents a single file system event with detailed flag information.

**Properties:**
- `path`: File/directory path
- `flags`: Raw FSEvents flags
- `event_id`: Unique event identifier
- `is_created`: File/directory creation flag
- `is_removed`: File/directory removal flag
- `is_renamed`: File/directory rename flag
- `is_modified`: File/directory modification flag
- `is_directory`: Directory flag
- `is_symlink`: Symbolic link flag

**Additional Metadata Flags:**
- `is_change_owner`: Ownership change
- `is_inode_meta_mod`: Inode metadata modification
- `is_finder_info_mod`: Finder info modification
- `is_xattr_mod`: Extended attributes modification

### `FSEventsEmitter`

High-level event emitter that converts native FSEvents to watchdog events.

**Features:**
- Converts native events to standard watchdog events
- Handles move operation detection
- Supports event filtering
- Manages parent directory modification events

**Event Mapping:**
- `FileCreatedEvent` / `DirCreatedEvent`
- `FileDeletedEvent` / `DirDeletedEvent`
- `FileModifiedEvent` / `DirModifiedEvent`
- `FileMovedEvent` / `DirMovedEvent`

### `FSEventsObserver2`

Main observer class that orchestrates the monitoring process.

```python
observer = FSEventsObserver2(timeout=DEFAULT_OBSERVER_TIMEOUT)
```

## Event Processing Logic

### Move Detection
The emitter implements sophisticated move detection by:
- Checking for consecutive rename events
- Comparing event IDs (differ by exactly 1 for internal moves)
- Falling back to existence checks for external moves

### Event Prioritization
Events are processed with the following priority:
1. **Rename events** (highest priority)
2. **Modification events** (including metadata and extended attributes)
3. **Creation events**
4. **Removal events**

## Usage Notes

### Best Practices
- Use `FSEventsObserver2` as the main entry point
- Handle the deprecation warning appropriately
- Consider migrating to alternative implementations

### Limitations
- macOS only
- Requires PyObjC framework
- Move detection may not work perfectly in all scenarios
- Event ID wrapping is not handled (TODO item)

### Performance Considerations
- 1-second latency built into the FSEvents stream
- Uses separate thread for event processing
- Memory pool management for Objective-C objects

## Migration Recommendations

Since this module is deprecated:

1. **Update Code**: Migrate to the recommended FSEvents implementation
2. **Test Thoroughly**: Ensure event detection still works correctly
3. **Monitor Warnings**: Watch for deprecation warnings in logs
4. **Plan Migration**: Prepare for future removal of this module

## Dependencies

```python
# Required imports
import AppKit
from FSEvents import *
from watchdog.events import *
from watchdog.observers.api import *
```

## Error Handling

The module includes error handling for:
- FSEvents stream creation failures
- Stream start failures  
- Proper cleanup of resources on thread termination