<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# FSEvents Observer Module Documentation

## Overview

This module provides a macOS-specific file system monitoring implementation using the FSEvents API. It's part of the watchdog library and offers efficient, native file system event monitoring on macOS platforms.

## Purpose

The `watchdog.observers.fsevents` module:
- Monitors file system changes on macOS using the native FSEvents API
- Converts low-level FSEvents into high-level watchdog events
- Handles recursive and non-recursive directory watching
- Manages event filtering and history suppression
- Provides Unicode path normalization for macOS compatibility

## Key Classes

### FSEventsEmitter

The main emitter class that interfaces with the native FSEvents API.

#### Constructor Parameters

```python
def __init__(
    self,
    event_queue: EventQueue,
    watch: ObservedWatch,
    *,
    timeout: float = DEFAULT_EMITTER_TIMEOUT,
    event_filter: list[type[FileSystemEvent]] | None = None,
    suppress_history: bool = False,
) -> None:
```

**Parameters:**
- `event_queue`: Queue to store filesystem events
- `watch`: Directory watch configuration
- `timeout`: Event reading timeout in seconds
- `event_filter`: Optional list of event types to emit
- `suppress_history`: Whether to suppress historic events (up to 30 seconds before watch start)

#### Important Methods

##### `queue_events(timeout: float, events: list[_fsevents.NativeEvent]) -> None`

Processes native FSEvents and converts them to watchdog events. Handles:
- Event coalescing logic
- Created/deleted/modified/renamed event detection
- Historic event filtering
- Sub-event generation for moves and creations

##### `events_callback(paths: list[bytes], inodes: list[int], flags: list[int], ids: list[int]) -> None`

Callback function passed to the FSEvents API that receives raw filesystem events and queues them for processing.

##### `run() -> None`

Main execution method that:
- Initializes the FSEvents stream
- Starts monitoring the specified path
- Handles exceptions during monitoring

### FSEventsObserver

High-level observer class that manages FSEventsEmitter instances.

#### Constructor

```python
def __init__(self, *, timeout: float = DEFAULT_OBSERVER_TIMEOUT) -> None:
```

#### Key Method

##### `schedule(event_handler, path, *, recursive=False, event_filter=None) -> ObservedWatch`

Schedules a path for monitoring with Unicode normalization for macOS compatibility.

## Important Features

### Event Processing Logic

The module handles complex FSEvents scenarios:

- **Event Coalescing**: FSEvents may combine multiple operations into single events
- **Historic Events**: Filters out events that occurred before monitoring started
- **Rename Handling**: Detects moves within watched directories vs. moves in/out
- **Recursive Filtering**: Drops events outside the watch scope for non-recursive watches

### Path Handling

- Normalizes Unicode paths using NFC normalization
- Handles both string and bytes path representations
- Resolves absolute paths for accurate event filtering

### Memory Management

- Clears historic state after 60 seconds to free memory
- Uses inode tracking to avoid duplicate events
- Maintains filesystem view state for accurate event detection

## Usage Example

```python
from watchdog.observers.fsevents import FSEventsObserver
from watchdog.events import FileSystemEventHandler

class MyHandler(FileSystemEventHandler):
    def on_modified(self, event):
        print(f"Modified: {event.src_path}")

observer = FSEventsObserver()
observer.schedule(MyHandler(), "/path/to/watch", recursive=True)
observer.start()
```

## Important Notes

### Platform Compatibility
- **macOS only**: This module only works on macOS systems
- Requires the `_watchdog_fsevents` native extension

### Performance Considerations
- `suppress_history=True` may use significant memory for large directories
- FSEvents is inherently recursive; non-recursive filtering happens at the application level
- Event processing includes complex logic to handle FSEvents coalescing

### Threading
- Uses thread-safe locking for event processing
- Runs monitoring in separate threads
- Properly handles thread cleanup on stop

### Limitations
- Historic events can appear up to 30 seconds after stream creation
- Root path changes will stop the observer
- Some metadata-only changes may generate spurious events

## Dependencies

- `_watchdog_fsevents`: Native FSEvents interface
- `watchdog.events`: Event type definitions  
- `watchdog.observers.api`: Base observer classes
- `watchdog.utils.dirsnapshot`: Directory state snapshots