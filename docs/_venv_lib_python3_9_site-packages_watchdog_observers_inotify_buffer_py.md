<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# InotifyBuffer Module

## Overview

The `watchdog.observers.inotify_buffer` module provides a wrapper around the Linux `inotify` system for file system event monitoring. This module is specifically designed to handle the pairing of move events (`IN_MOVED_FROM` and `IN_MOVED_TO`) by introducing a buffering delay mechanism.

**Platform Support:** Linux only

## Purpose

The primary purpose of this module is to:
- Buffer inotify events for a short period to allow proper pairing of move operations
- Convert separate `IN_MOVED_FROM` and `IN_MOVED_TO` events into paired tuples when they represent the same file move
- Provide a cleaner interface for consuming file system events where moves are represented as atomic operations

## Main Class

### `InotifyBuffer`

A thread-based wrapper that extends `BaseThread` and buffers inotify events with intelligent move event pairing.

#### Class Attributes

- **`delay`**: `float = 0.5` - The buffer delay in seconds for holding events to allow move event pairing

#### Constructor

```python
def __init__(self, path: bytes, *, recursive: bool = False, event_mask: int | None = None) -> None
```

**Parameters:**
- `path`: The filesystem path to monitor (as bytes)
- `recursive`: Whether to monitor subdirectories recursively
- `event_mask`: Optional mask to filter specific inotify events

## Key Methods

### `read_event()`

```python
def read_event(self) -> InotifyEvent | tuple[InotifyEvent, InotifyEvent] | None
```

Returns the next available event from the buffer.

**Returns:**
- Single `InotifyEvent` for regular events
- Tuple of `(from_event, to_event)` for paired move events  
- `None` if the buffer has been closed

### `close()`

```python
def close(self) -> None
```

Cleanly shuts down the buffer by stopping the thread and waiting for completion.

### `_group_events()` (Internal)

```python
def _group_events(self, event_list: list[InotifyEvent]) -> list[InotifyEvent | tuple[InotifyEvent, InotifyEvent]]
```

Groups matching move events by pairing `IN_MOVED_FROM` and `IN_MOVED_TO` events with the same cookie.

## How It Works

1. **Event Collection**: The `run()` method continuously reads events from the underlying `Inotify` instance
2. **Move Event Pairing**: When an `IN_MOVED_TO` event is received, the buffer searches for a matching `IN_MOVED_FROM` event with the same cookie
3. **Delayed Queuing**: Unpaired `IN_MOVED_FROM` events are held in the queue with a delay to allow time for the corresponding `IN_MOVED_TO` event
4. **Event Delivery**: Paired events are delivered as tuples, while other events are delivered individually

## Important Notes

### Thread Safety
- The class runs in its own thread and handles concurrent access to the event queue
- The buffer automatically starts when instantiated and should be properly closed when done

### Move Event Handling
- Move events within the same filesystem are paired using cookies provided by inotify
- If a matching move event isn't found within the delay period, events are delivered separately
- This prevents loss of move events while providing better semantic meaning when possible

### Cleanup Behavior
- The buffer automatically stops when the watched directory is deleted
- It handles both explicit watch removal and automatic cleanup scenarios
- Always call `close()` to ensure proper resource cleanup

### Usage Example

```python
# Create buffer for monitoring a directory
buffer = InotifyBuffer(b'/path/to/watch', recursive=True)

try:
    while True:
        event = buffer.read_event()
        if event is None:
            break
            
        if isinstance(event, tuple):
            # Paired move event
            from_event, to_event = event
            print(f"File moved from {from_event.src_path} to {to_event.src_path}")
        else:
            # Single event
            print(f"Event: {event}")
finally:
    buffer.close()
```

## Dependencies

- `watchdog.observers.inotify_c`: Low-level inotify interface
- `watchdog.utils.BaseThread`: Threading utilities
- `watchdog.utils.delayed_queue.DelayedQueue`: Queue with delay support