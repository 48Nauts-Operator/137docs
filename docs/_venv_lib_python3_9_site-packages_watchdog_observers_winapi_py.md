<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Windows API Interface for Watchdog

## Overview

This module (`watchdog.observers.winapi`) provides a pure Python interface to Windows API functions for file system monitoring, eliminating the dependency on `pywin32`. It implements low-level Windows API calls using `ctypes` to monitor file and directory changes on Windows platforms.

## Purpose

- **Primary Goal**: Monitor file system changes on Windows without requiring external dependencies
- **Key Feature**: Uses Windows' `ReadDirectoryChangesW` API to detect file/directory modifications, creations, deletions, and renames
- **Integration**: Serves as the backend for the Watchdog library's Windows observer implementation

## Important Constants

### File Notification Flags
```python
FILE_NOTIFY_CHANGE_FILE_NAME = 0x01      # File name changes
FILE_NOTIFY_CHANGE_DIR_NAME = 0x02       # Directory name changes
FILE_NOTIFY_CHANGE_ATTRIBUTES = 0x04     # File attribute changes
FILE_NOTIFY_CHANGE_SIZE = 0x08           # File size changes
FILE_NOTIFY_CHANGE_LAST_WRITE = 0x010    # Last write time changes
```

### File Action Types
```python
FILE_ACTION_CREATED = 1                  # File/directory created
FILE_ACTION_DELETED = 2                  # File/directory deleted
FILE_ACTION_MODIFIED = 3                 # File/directory modified
FILE_ACTION_RENAMED_OLD_NAME = 4         # Old name in rename operation
FILE_ACTION_RENAMED_NEW_NAME = 5         # New name in rename operation
```

## Key Classes

### `OVERLAPPED`
```python
class OVERLAPPED(ctypes.Structure)
```
Windows OVERLAPPED structure for asynchronous I/O operations.

### `FileNotifyInformation`
```python
class FileNotifyInformation(ctypes.Structure)
```
Structure representing file change notifications returned by Windows API.

### `WinAPINativeEvent`
```python
@dataclass(unsafe_hash=True)
class WinAPINativeEvent:
    action: int
    src_path: str
```
Represents a file system event with convenient property methods:
- `is_added` - File/directory was created
- `is_removed` - File/directory was deleted  
- `is_modified` - File/directory was modified
- `is_renamed_old` - Old name in rename operation
- `is_renamed_new` - New name in rename operation
- `is_removed_self` - Watched directory itself was deleted

## Important Functions

### `get_directory_handle(path: str) -> HANDLE`
```python
def get_directory_handle(path: str) -> HANDLE:
```
Opens a Windows handle to the specified directory for monitoring.

**Parameters:**
- `path`: Directory path to monitor

**Returns:** Windows HANDLE object

### `close_directory_handle(handle: HANDLE) -> None`
```python  
def close_directory_handle(handle: HANDLE) -> None:
```
Safely closes a directory handle and cancels any pending I/O operations.

**Parameters:**
- `handle`: Windows HANDLE to close

### `read_directory_changes(handle: HANDLE, path: str, *, recursive: bool) -> tuple[bytes, int]`
```python
def read_directory_changes(handle: HANDLE, path: str, *, recursive: bool) -> tuple[bytes, int]:
```
Reads file system changes using Windows `ReadDirectoryChangesW` API.

**Parameters:**
- `handle`: Directory handle obtained from `get_directory_handle()`
- `path`: Directory path being monitored
- `recursive`: Whether to monitor subdirectories

**Returns:** Tuple of (raw_buffer_data, bytes_returned)

### `read_events(handle: HANDLE, path: str, *, recursive: bool) -> list[WinAPINativeEvent]`
```python
def read_events(handle: HANDLE, path: str, *, recursive: bool) -> list[WinAPINativeEvent]:
```
High-level function that reads and parses file system events.

**Parameters:**
- `handle`: Directory handle
- `path`: Directory path being monitored  
- `recursive`: Whether to monitor subdirectories

**Returns:** List of `WinAPINativeEvent` objects

## Configuration

### Buffer Sizes
- `BUFFER_SIZE = 64000` - Main buffer for `ReadDirectoryChangesW` (maximum safe size)
- `PATH_BUFFER_SIZE = 2048` - Buffer for path-related operations

### Pre-calculated Flags
- `WATCHDOG_FILE_FLAGS` - File access flags for directory handles
- `WATCHDOG_FILE_SHARE_FLAGS` - File sharing permissions
- `WATCHDOG_FILE_NOTIFY_FLAGS` - Combined notification filter flags

## Usage Notes

### ‚ö†Ô∏è Platform Limitations
- **Windows Only**: This module only works on Windows platforms
- **Network Monitoring**: Buffer size limited to 64KB when monitoring network directories due to file sharing protocol limitations
- **Handle Management**: Always pair `get_directory_handle()` with `close_directory_handle()` to prevent resource leaks

### üîß Error Handling
- Functions use custom error checking (`_errcheck_*`) that automatically raise `ctypes.WinError` on API failures
- Special handling for deleted root directories via `_is_observed_path_deleted()`
- Graceful handling of operation cancellation (`ERROR_OPERATION_ABORTED`)

### üí° Best Practices
```python
# Example usage pattern
handle = get_directory_handle(r"C:\path\to\watch")
try:
    events = read_events(handle, r"C:\path\to\watch", recursive=True)
    for event in events:
        if event.is_added:
            print(f"File created: {event.src_path}")
        elif event.is_modified:
            print(f"File modified: {event.src_path}")
finally:
    close_directory_handle(handle)
```

## Dependencies

- `ctypes` (built-in)
- `contextlib` (built-in)  
- `dataclasses` (Python 3.7+)
- `functools` (built-in)