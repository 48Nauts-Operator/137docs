<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# DelayedQueue Module

## Overview

The `watchdog.utils.delayed_queue` module provides a thread-safe queue implementation that supports delayed element retrieval. This queue is designed for scenarios where you need to process items after a specified delay, with the ability to bypass delays when necessary.

**Authors:**
- Thomas Amland (thomas.amland@gmail.com)
- MickaÃ«l Schoentgen (contact@tiger-222.fr)

## Purpose

This module is typically used in file system monitoring applications where you want to:
- Batch operations that occur in rapid succession
- Implement debouncing mechanisms for file system events
- Process items only after a "settling" period to avoid duplicate processing

## Classes

### `DelayedQueue[T]`

A generic, thread-safe queue that can delay the retrieval of elements based on insertion time and delay requirements.

#### Constructor

```python
def __init__(self, delay: float) -> None
```

**Parameters:**
- `delay`: Default delay in seconds for items marked as delayed

#### Methods

##### `put(element: T, *, delay: bool = False) -> None`

Adds an element to the queue.

**Parameters:**
- `element`: The item to add to the queue
- `delay`: Whether this element should be subject to the delay mechanism (default: `False`)

**Example:**
```python
queue = DelayedQueue[str](2.0)  # 2-second delay
queue.put("immediate_item")           # No delay
queue.put("delayed_item", delay=True) # Will be delayed
```

##### `get() -> T | None`

Removes and returns an element from the queue. This method:
- Blocks until an element is available
- Respects delay settings for delayed elements
- Returns `None` if the queue has been closed

**Returns:**
- The next available element, or `None` if the queue is closed

##### `close() -> None`

Closes the queue, indicating no more items will be added. This will cause any blocking `get()` calls to return `None`.

##### `remove(predicate: Callable[[T], bool]) -> T | None`

Removes and returns the first item matching the predicate, ignoring any delay requirements.

**Parameters:**
- `predicate`: A function that returns `True` for the item to remove

**Returns:**
- The removed element, or `None` if no matching element is found

**Example:**
```python
# Remove all items containing "error"
removed_item = queue.remove(lambda x: "error" in x)
```

## Thread Safety

This class is fully thread-safe and uses:
- `threading.Lock()` for protecting internal state
- `threading.Condition()` for coordinating between threads
- Proper acquire/release patterns for all critical sections

## Internal Structure

The queue stores elements as tuples containing:
- `element`: The actual item
- `insert_time`: Timestamp when the item was added
- `delay`: Boolean indicating if delay should be applied

## Usage Example

```python
import time
from watchdog.utils.delayed_queue import DelayedQueue

# Create a queue with 1-second delay
queue = DelayedQueue[str](1.0)

# Add items
queue.put("immediate")
queue.put("delayed", delay=True)

# Get items (delayed item won't be available immediately)
item1 = queue.get()  # Returns "immediate" right away
item2 = queue.get()  # Returns "delayed" after 1 second

# Clean up
queue.close()
```

## Notes and Considerations

- **Memory Usage**: Items remain in the queue until retrieved, so ensure proper consumption to avoid memory leaks
- **Timing Precision**: The delay mechanism uses `time.sleep()` and may not be perfectly precise due to system scheduling
- **Element Identity**: The `get()` method uses identity comparison (`is`) to ensure elements haven't been removed by other operations
- **Graceful Shutdown**: Always call `close()` to properly shut down any threads waiting on the queue

## Use Cases

This queue is particularly useful for:
- **File System Monitoring**: Debouncing rapid file change events
- **Event Processing**: Batching similar events that occur in quick succession  
- **Rate Limiting**: Ensuring minimum time intervals between processing similar items
- **Cleanup Operations**: Delaying destructive operations to allow for cancellation