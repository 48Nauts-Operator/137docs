<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# DelayedQueue Module Documentation

## Overview

The `DelayedQueue` module provides a thread-safe queue implementation that supports delayed processing of items. This queue allows elements to be added with an optional delay mechanism, where items marked for delay will only be retrievable after a specified time period has elapsed.

**Module Path:** `watchdog.utils.delayed_queue`  
**Authors:** 
- Thomas Amland (thomas.amland@gmail.com)
- MickaÃ«l Schoentgen (contact@tiger-222.fr)

## Purpose

This module is designed for scenarios where you need to:
- Queue items for processing with optional time delays
- Implement debouncing or throttling mechanisms
- Handle time-sensitive operations in a thread-safe manner
- Process items only after a certain "settling" period

## Classes

### DelayedQueue[T]

A generic, thread-safe queue that supports delayed item retrieval.

#### Constructor

```python
DelayedQueue(delay: float)
```

**Parameters:**
- `delay` (float): Default delay time in seconds for items marked with delay

#### Attributes

- `delay_sec` (float): The delay time in seconds
- `_lock` (threading.Lock): Thread synchronization lock
- `_not_empty` (threading.Condition): Condition variable for queue state
- `_queue` (deque): Internal storage for queue items
- `_closed` (bool): Flag indicating if the queue is closed

## Methods

### put(element: T, *, delay: bool = False) -> None

Adds an element to the queue.

**Parameters:**
- `element` (T): The item to add to the queue
- `delay` (bool, optional): Whether this item should be subject to delay. Defaults to `False`

**Usage:**
```python
queue = DelayedQueue[str](delay=2.0)
queue.put("immediate_item")  # No delay
queue.put("delayed_item", delay=True)  # Will be delayed by 2 seconds
```

### get() -> T | None

Removes and returns an element from the queue. If the element was added with `delay=True`, this method will block until the delay period has elapsed.

**Returns:**
- `T`: The next available element from the queue
- `None`: If the queue has been closed

**Behavior:**
- Blocks until an item is available
- Respects delay timing for items marked with delay
- Returns `None` when queue is closed

### close() -> None

Closes the queue, indicating that no more items will be added. This will cause any blocking `get()` calls to return `None`.

**Usage:**
```python
queue.close()  # Signal that no more items will be added
```

### remove(predicate: Callable[[T], bool]) -> T | None

Removes and returns the first item that matches the given predicate function, ignoring any delay restrictions.

**Parameters:**
- `predicate` (Callable[[T], bool]): Function that takes an element and returns `True` if it should be removed

**Returns:**
- `T`: The first matching element
- `None`: If no element matches the predicate

**Usage:**
```python
# Remove first string that starts with "error"
removed_item = queue.remove(lambda x: x.startswith("error"))
```

## Thread Safety

This class is fully thread-safe and can be used safely across multiple threads:
- Uses `threading.Lock` for protecting internal state
- Uses `threading.Condition` for efficient blocking/notification
- All public methods are properly synchronized

## Example Usage

```python
import time
from watchdog.utils.delayed_queue import DelayedQueue

# Create a queue with 1-second delay
queue = DelayedQueue[str](delay=1.0)

# Add items
queue.put("immediate", delay=False)
queue.put("delayed", delay=True)

# Get items
item1 = queue.get()  # Returns "immediate" immediately
item2 = queue.get()  # Returns "delayed" after ~1 second delay

# Close queue when done
queue.close()
```

## Notes and Suggestions

### Performance Considerations
- The `get()` method uses active waiting (`time.sleep()`) for delay implementation, which may not be the most efficient for very precise timing requirements
- Consider the trade-off between delay precision and CPU usage

### Best Practices
- Always call `close()` when finished with the queue to prevent resource leaks
- Use the `remove()` method sparingly as it performs linear search through the queue
- Consider the delay value carefully based on your use case requirements

### Potential Use Cases
- File system event debouncing in file watchers
- Rate limiting for API calls
- Implementing "settle time" for batch operations
- User input debouncing in interactive applications