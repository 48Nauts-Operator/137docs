<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# watchdog.utils.dirsnapshot

## Overview

This module provides functionality for creating directory snapshots and comparing them to detect changes in file systems. It's part of the watchdog library and is primarily used for monitoring directory changes by taking snapshots at different points in time and analyzing the differences.

## Important Limitations

⚠️ **Partition Boundary Warning**: This implementation does not handle partition boundaries correctly. It relies on inode numbers for file identification, which can break when crossing file system boundaries. In such cases, file/directory movements will be incorrectly reported as separate delete and create events.

## Classes

### DirectorySnapshot

The main class for capturing a snapshot of a directory's state, including file metadata and structure.

#### Constructor Parameters
- `path` (str): Directory path to snapshot
- `recursive` (bool): Whether to include entire directory tree (default: True)
- `stat` (Callable): Custom stat function (default: os.stat)
- `listdir` (Callable): Custom directory listing function (default: os.scandir)

#### Key Methods and Properties

```python
# Create a snapshot
snapshot = DirectorySnapshot("/path/to/directory")

# Access snapshot data
paths = snapshot.paths  # Set of all paths in snapshot
is_directory = snapshot.isdir(path)  # Check if path is directory
modification_time = snapshot.mtime(path)  # Get modification time
file_size = snapshot.size(path)  # Get file size
inode_info = snapshot.inode(path)  # Get inode tuple (ino, dev)
```

#### Internal Implementation
- Stores stat information in `_stat_info` dictionary
- Maintains inode-to-path mapping in `_inode_to_path`
- Handles various OS errors gracefully (missing files, permission issues)

### DirectorySnapshotDiff

Compares two DirectorySnapshot instances and identifies changes between them.

#### Constructor Parameters
- `ref` (DirectorySnapshot): Reference (baseline) snapshot
- `snapshot` (DirectorySnapshot): Current snapshot to compare
- `ignore_device` (bool): Whether to ignore device ID in comparisons (default: False)

#### Properties for Change Detection

```python
diff = DirectorySnapshotDiff(old_snapshot, new_snapshot)

# File changes
created_files = diff.files_created      # List[str]
deleted_files = diff.files_deleted      # List[str] 
modified_files = diff.files_modified    # List[str]
moved_files = diff.files_moved          # List[Tuple[str, str]]

# Directory changes  
created_dirs = diff.dirs_created        # List[str]
deleted_dirs = diff.dirs_deleted        # List[str]
modified_dirs = diff.dirs_modified      # List[str]
moved_dirs = diff.dirs_moved            # List[Tuple[str, str]]
```

#### Change Detection Logic
1. **Created/Deleted**: Files present in one snapshot but not the other
2. **Modified**: Files with same inode but different mtime or size
3. **Moved**: Files with same inode but different paths

### EmptyDirectorySnapshot

A special implementation representing an empty directory state, useful for detecting all files in a directory as "created" when compared against.

```python
empty = EmptyDirectorySnapshot()
diff = DirectorySnapshotDiff(empty, current_snapshot)
# All files in current_snapshot will appear as "created"
```

### DirectorySnapshotDiff.ContextManager

A context manager for automatically creating before/after snapshots and generating a diff.

```python
with DirectorySnapshotDiff.ContextManager("/path/to/watch") as cm:
    # Perform operations that modify the directory
    pass

# Access results
diff = cm.diff
pre_snapshot = cm.pre_snapshot  
post_snapshot = cm.post_snapshot
```

## Usage Examples

### Basic Directory Monitoring

```python
# Take initial snapshot
before = DirectorySnapshot("/my/directory")

# ... time passes, files change ...

# Take second snapshot
after = DirectorySnapshot("/my/directory") 

# Compare snapshots
diff = DirectorySnapshotDiff(before, after)

print(f"Created files: {diff.files_created}")
print(f"Modified files: {diff.files_modified}")
```

### Using Context Manager

```python
with DirectorySnapshotDiff.ContextManager("/my/directory") as monitor:
    # Perform file operations
    with open("/my/directory/newfile.txt", "w") as f:
        f.write("Hello world")

# Check what changed
print(f"Files created: {monitor.diff.files_created}")
```

## Technical Notes

### Device ID Handling
- By default, files are identified by `(inode, device_id)` tuple
- Set `ignore_device=True` if device IDs might change between boots
- Only use `ignore_device=True` when certain all files are on same device

### Error Handling
- Gracefully handles deleted directories during traversal
- Manages permission errors when accessing subdirectories  
- Treats inaccessible directories as empty rather than failing

### Performance Considerations
- Recursive snapshots can be expensive for large directory trees
- Consider non-recursive snapshots for performance-critical applications
- Stat information is cached within snapshot objects

## Integration with Watchdog

This module serves as a foundation for watchdog's file system monitoring capabilities, providing the core logic for detecting and categorizing file system changes in a cross-platform manner.