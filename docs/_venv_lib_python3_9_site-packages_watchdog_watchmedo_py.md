<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# `watchmedo` - Watchdog Shell Script Utility

## Overview

The `watchmedo` module provides a command-line interface for the Python Watchdog library, allowing users to monitor file system events and perform automated actions. This utility offers various commands for watching directories, executing shell commands, auto-restarting processes, and managing "tricks" (predefined event handlers) through YAML configuration files.

## Purpose

- **File System Monitoring**: Watch directories for file changes, creations, deletions, and moves
- **Automated Actions**: Execute shell commands or Python code in response to file system events
- **Process Management**: Auto-restart long-running processes when files change
- **Configuration Management**: Load and execute multiple monitoring configurations from YAML files
- **Cross-Platform Support**: Works across different operating systems with platform-specific optimizations

## Key Components

### Command Decorator System

The module uses a decorator-based approach to define CLI commands:

```python
@command([
    argument("files", nargs="*", help="perform tricks from given file"),
    # ... more arguments
])
def tricks_from(args: Namespace) -> None:
    """Command to execute tricks from a tricks configuration file."""
```

### Custom Help Formatter

```python
class HelpFormatter(RawDescriptionHelpFormatter):
    """A nicer help formatter with better indentation and readability."""
```

- Provides better formatting for command help text
- Supports indented and multi-line argument descriptions
- Separates arguments with blank lines for readability

## Main Commands

### 1. `tricks-from` (alias: `tricks`)

Executes monitoring configurations from YAML files.

**Key Features:**
- Load multiple trick configurations from files
- Support for custom Python paths
- Platform-specific observer selection
- Recursive directory watching

**Usage Example:**
```bash
watchmedo tricks-from config.yaml --recursive
```

### 2. `tricks-generate-yaml` (alias: `generate-tricks-yaml`)

Generates YAML configuration files for specified trick classes.

**Key Features:**
- Auto-generate configuration templates
- Support for multiple trick paths
- Append to existing files or output to stdout

**Usage Example:**
```bash
watchmedo tricks-generate-yaml MyTrick.ClassName --append-to-file config.yaml
```

### 3. `log`

Logs file system events to the console.

**Key Features:**
- Pattern matching for file paths
- Ignore patterns support
- Directory event filtering
- Multiple debug observer options

**Usage Example:**
```bash
watchmedo log --patterns="*.py;*.txt" --recursive /path/to/watch
```

### 4. `shell-command`

Executes shell commands in response to file system events.

**Key Features:**
- Template variable substitution (`${watch_src_path}`, `${watch_dest_path}`, etc.)
- Process synchronization options
- Event filtering and pattern matching

**Usage Example:**
```bash
watchmedo shell-command --command='echo "File changed: ${watch_src_path}"' --patterns="*.py"
```

### 5. `auto-restart`

Automatically restarts long-running processes when files change.

**Key Features:**
- Configurable stop signals
- Debounce intervals to prevent rapid restarts
- Graceful shutdown handling
- Signal management for clean termination

**Usage Example:**
```bash
watchmedo auto-restart --directory=/src --patterns="*.py" -- python myapp.py
```

## Utility Functions

### Path and Configuration Management

- **`path_split()`**: Splits OS-dependent path specifications
- **`add_to_sys_path()`**: Dynamically adds paths to Python's sys.path
- **`load_config()`**: Loads YAML configuration files
- **`parse_patterns()`**: Parses pattern specifications for file matching

### Observer Management

- **`observe_with()`**: Sets up and runs a single observer with event handler
- **`schedule_tricks()`**: Schedules multiple tricks with an observer

## Platform Support

The utility automatically detects the best file system observer for each platform:

- **Linux**: inotify
- **macOS**: FSEvents  
- **Windows**: ReadDirectoryChanges API
- **BSD**: kqueue
- **Fallback**: Polling observer

Debug flags allow forcing specific observers:
- `--debug-force-polling`
- `--debug-force-kqueue` 
- `--debug-force-winapi`
- `--debug-force-fsevents`
- `--debug-force-inotify`

## Configuration Format

YAML configuration files use this structure:

```yaml
python-path: ["/custom/path"]
tricks:
- watchdog.tricks.LoggerTrick:
    patterns: ["*.py"]
    ignore_patterns: ["*.pyc"]
```

## Usage Notes

### Signal Handling
- The utility properly handles termination signals (SIGTERM, SIGINT, SIGHUP)
- Graceful shutdown ensures observers are properly stopped and joined

### Verbosity Control
- `-q/--quiet`: Reduce output (ERROR level)
- `-v/--verbose`: Increase output (DEBUG level)  
- `-vv`: Maximum verbosity

### Pattern Matching
- Patterns use shell-style wildcards (`*`, `?`, `[seq]`)
- Multiple patterns separated by semicolons (`;`)
- Support for both include and ignore patterns

## Error Handling

The utility includes robust error handling for:
- Missing configuration files
- Invalid YAML syntax
- Signal interruption (KeyboardInterrupt returns exit code 130)
- Invalid verbosity levels
- Missing required configuration keys

## Entry Point

The module can be executed directly or used as a console script:

```python
if __name__ == "__main__":
    sys.exit(main())
```

The `main()` function returns appropriate exit codes:
- `0`: Success
- `1`: General error or help displayed
- `130`: Keyboard interrupt (Ctrl+C)