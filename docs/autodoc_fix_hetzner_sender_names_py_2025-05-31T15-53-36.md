<!--
This documentation was auto-generated by Claude on 2025-05-31T15-53-36.
Source file: ./fix_hetzner_sender_names.py
-->

# Hetzner Invoice Sender Name Fix Script

## Overview

This script is designed to clean up malformed sender names in Hetzner invoice documents stored in the database. It identifies documents where the sender field contains JSON strings instead of clean company names and converts them to properly formatted sender names.

## Purpose

- **Problem**: Some Hetzner invoice documents have sender fields containing JSON data instead of clean company names
- **Solution**: Parse JSON data and extract the actual company name, typically "Hetzner Online GmbH"
- **Scope**: Only processes documents with sender names containing "Hetzner" (case-insensitive)

## Prerequisites

- Python 3.7+
- Access to the application database via SQLAlchemy async engine
- Required dependencies:
  - `asyncio`
  - `sqlalchemy` (with async support)
  - Application modules: `app.database`, `app.models`

## Functions

### `extract_sender_name(sender_data)`

Extracts a clean company name from potentially malformed sender data.

**Parameters:**
- `sender_data` (str|any): Raw sender data that may contain JSON strings

**Returns:**
- `str`: Clean, formatted sender name

**Logic:**
1. Returns empty string for falsy input
2. For string input that looks like JSON:
   - Attempts JSON parsing
   - Searches for common name fields: `name`, `company`, `sender`, `company_name`
   - Falls back to first non-empty string value if no standard fields found
3. For non-JSON strings, returns trimmed input
4. For non-string types, converts to string and trims

### `fix_hetzner_sender_names()`

Main async function that processes and fixes Hetzner document sender names.

**Process:**
1. Queries database for documents with sender names containing "hetzner"
2. Iterates through each document
3. Applies `extract_sender_name()` to clean the sender field
4. Updates database records where changes are needed
5. Commits all changes in a single transaction
6. Provides detailed console output showing progress

**Output:**
- Progress information for each document processed
- Summary of total documents fixed
- Visual indicators (âœ… for fixed, âœ“ for already clean)

## Usage

### Command Line Execution

```bash
python3 fix_hetzner_sender_names.py
```

### Programmatic Usage

```python
import asyncio
from fix_hetzner_sender_names import fix_hetzner_sender_names

# Run the fix process
await fix_hetzner_sender_names()
```

## Example Output

```
Found 3 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

Document ID 125:
  Original: {"name": "Hetzner Online GmbH"}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

ðŸŽ‰ Successfully fixed 2 Hetzner invoice sender names!
```

## Error Handling

- **JSON Parse Errors**: Gracefully handled with fallback to original string
- **Database Errors**: Will propagate up from SQLAlchemy operations
- **Missing Data**: Empty or null sender data returns empty string

## Safety Features

- **Preview Mode**: Shows original vs. cleaned data before making changes
- **Targeted Updates**: Only modifies documents that actually need fixing
- **Transaction Safety**: All changes committed in a single transaction
- **Selective Processing**: Only processes Hetzner-related documents

## Database Impact

- **Tables Modified**: `Document` table only
- **Fields Modified**: `sender` field only
- **Query Pattern**: Uses ILIKE for case-insensitive Hetzner matching
- **Transaction Model**: Single commit for all changes

## Notes

- Script adds `/app` to Python path for module imports
- Designed to be run as a one-time maintenance script
- Safe to run multiple times (idempotent operation)
- Provides clear feedback on what changes were made