<!--
This documentation was auto-generated by Claude on 2025-06-01T06-14-00.
Source file: ./fix_hetzner_sender_names.py
-->

# Hetzner Invoice Sender Name Cleanup Script

## Overview

This script is designed to clean up and standardize sender names in Hetzner invoices stored in a database. It identifies documents with sender names that contain JSON strings and extracts clean company names from them.

## Purpose

The script addresses a data quality issue where Hetzner invoice sender names may contain JSON-formatted data instead of clean company names. It processes these entries to extract and store properly formatted sender names like "Hetzner Online GmbH".

## Dependencies

- Python 3.x
- SQLAlchemy (async)
- asyncio
- json
- re

### Required Modules

```python
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from app.database import async_engine
from app.models import Document
```

## Functions

### `extract_sender_name(sender_data)`

Extracts a clean company name from sender data that may contain JSON strings.

**Parameters:**
- `sender_data` (str): Raw sender data that may contain JSON or plain text

**Returns:**
- `str`: Clean, extracted sender name

**Logic:**
1. Returns empty string if no data provided
2. For string inputs, checks if data appears to be JSON (starts with `{` and ends with `}`)
3. If JSON detected, attempts to parse and extract name from common fields:
   - `name`
   - `company`
   - `sender`
   - `company_name`
4. Falls back to first non-empty string value if standard fields not found
5. Returns original string if JSON parsing fails
6. Strips whitespace from all results

### `fix_hetzner_sender_names()`

Main async function that processes all Hetzner documents in the database.

**Process:**
1. Creates database session using `async_engine`
2. Queries for all documents where sender contains "hetzner" (case-insensitive)
3. Processes each document:
   - Extracts clean sender name using `extract_sender_name()`
   - Compares original vs. cleaned version
   - Updates database if changes are needed
   - Provides console output for each document processed
4. Commits changes if any fixes were made
5. Reports summary of operations

**Output:**
- Lists all documents found and processed
- Shows before/after comparison for each document
- Indicates whether each document was fixed or already clean
- Provides final summary of total fixes applied

## Usage

### Command Line Execution

```bash
python3 hetzner_sender_cleanup.py
```

### Example Output

```
Found 5 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

ðŸŽ‰ Successfully fixed 1 Hetzner invoice sender names!
```

## Configuration

The script includes a hardcoded path addition to `sys.path`:

```python
sys.path.insert(0, '/app')
```

This allows import of application modules. Modify this path as needed for your environment.

## Database Requirements

- The script expects a `Document` model with the following fields:
  - `id`: Document identifier
  - `sender`: Sender name field (string)
- Database connection is handled through `async_engine` from `app.database`

## Error Handling

- JSON parsing errors are caught and handled gracefully
- Malformed JSON data falls back to original string
- Database operations use async context managers for proper session handling

## Safety Features

- **Read-first approach**: Script queries and analyzes before making changes
- **Detailed logging**: Shows exactly what changes will be made
- **Conditional updates**: Only modifies records that actually need changes
- **Transaction safety**: Uses database transactions with commit only after successful processing

## Notes

- The script is specifically designed for Hetzner invoices but the `extract_sender_name()` function is generic enough to handle various JSON formats
- All database operations are asynchronous for better performance
- The script provides comprehensive console output for monitoring and debugging