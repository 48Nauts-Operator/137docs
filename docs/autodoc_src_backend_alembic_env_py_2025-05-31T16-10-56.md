<!--
This documentation was auto-generated by Claude on 2025-05-31T16-10-56.
Source file: ./src/backend/alembic/env.py
-->

# Alembic Environment Configuration (Async)

This module configures the Alembic migration environment for asynchronous database operations using SQLAlchemy's async engine.

## Overview

This Alembic environment script enables database migrations in both offline and online modes with support for asynchronous database connections. It automatically configures the database URL and sets up the necessary metadata for migration autogeneration.

## Dependencies

- `asyncio`: For asynchronous operation support
- `logging.config`: For configuring Python logging
- `sqlalchemy`: Database toolkit and ORM
- `sqlalchemy.ext.asyncio`: Async SQLAlchemy support
- `alembic`: Database migration tool

## Configuration

### Database URL Configuration

The script automatically configures the database URL using the following priority:

1. `settings.DATABASE_URL` (if available)
2. Fallback: `sqlite+aiosqlite:///{settings.DATABASE_PATH}`

### Python Path Setup

The script ensures the project root is available on `PYTHONPATH` to enable proper module imports:

```python
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
```

## Functions

### `run_migrations_offline() -> None`

Executes database migrations in offline mode without requiring an active database connection.

**Features:**
- Uses literal SQL binds for parameter binding
- Configures named parameter style for SQL dialect
- Runs migrations within a transaction context

**Usage:**
Typically used for generating SQL scripts that can be executed manually.

### `do_run_migrations(connection)`

Helper function that configures and executes migrations using an existing database connection.

**Parameters:**
- `connection`: Active database connection object

**Features:**
- Configures Alembic context with the provided connection
- Executes migrations within a transaction

### `run_migrations_online() -> None`

Executes database migrations in online mode with an active asynchronous database connection.

**Features:**
- Creates async engine from configuration
- Uses `NullPool` for connection pooling to avoid connection management issues
- Handles async/sync bridge using `connection.run_sync()`

**Process:**
1. Creates an async engine from Alembic configuration
2. Establishes async database connection
3. Executes migrations synchronously within the async context

## Execution Flow

The script automatically determines the execution mode:

```python
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

## Configuration Objects

### `config`
Alembic configuration object that:
- Loads settings from `alembic.ini`
- Sets the SQLAlchemy database URL
- Manages migration configuration

### `target_metadata`
SQLAlchemy metadata object (`Base.metadata`) used for:
- Autogeneration of migrations
- Schema comparison
- Model introspection

## Usage Examples

### Running Migrations

```bash
# Online mode (default)
alembic upgrade head

# Offline mode (generate SQL)
alembic upgrade head --sql
```

### Generating Migrations

```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "Description of changes"
```

## Notes

- The `# noqa: E402` comments suppress linting warnings for imports after path manipulation
- Uses `NullPool` to prevent connection pool issues in migration context
- Supports both SQLite (via aiosqlite) and other async database drivers
- Logging configuration is loaded from the Alembic INI file

## Error Handling

The script relies on Alembic's built-in error handling mechanisms. Ensure that:
- Database connection settings are properly configured
- Required database drivers are installed
- Model imports are accessible from the configured path