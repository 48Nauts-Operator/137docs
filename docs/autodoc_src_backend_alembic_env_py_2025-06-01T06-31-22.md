<!--
This documentation was auto-generated by Claude on 2025-06-01T06-31-22.
Source file: ./src/backend/alembic/env.py
-->

# Alembic Environment Configuration (Async)

This module configures the Alembic environment for running database migrations with asynchronous SQLAlchemy support.

## Overview

This is an Alembic environment configuration file that enables database schema migrations for applications using async SQLAlchemy. It supports both offline and online migration modes and automatically configures the database connection using application settings.

## Dependencies

- `asyncio`: For asynchronous operation support
- `logging.config`: For configuring Python logging
- `sqlalchemy`: Database toolkit and ORM
- `sqlalchemy.ext.asyncio`: Async SQLAlchemy extensions
- `alembic`: Database migration tool

## Configuration

### Database Connection

The module automatically configures the database connection using:
- `settings.DATABASE_URL` (primary) - Full database connection URL
- `settings.DATABASE_PATH` (fallback) - Path for SQLite database with aiosqlite driver

### Path Configuration

```python
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
```

Ensures the project root directory is available for importing application modules.

## Functions

### `run_migrations_offline()`

Executes database migrations in offline mode without requiring an active database connection.

**Parameters:** None

**Returns:** `None`

**Usage:**
- Generates SQL migration scripts without executing them
- Uses literal binds and named parameter style
- Suitable for generating migration SQL for manual execution

**Configuration:**
- `literal_binds=True`: Renders bound parameters as literal values
- `dialect_opts={"paramstyle": "named"}`: Uses named parameter style

### `do_run_migrations(connection)`

Helper function that executes migrations using a provided database connection.

**Parameters:**
- `connection`: Active database connection object

**Returns:** `None`

**Purpose:**
- Configures Alembic context with the provided connection
- Executes migrations within a transaction context

### `run_migrations_online()`

Executes database migrations in online mode with an active database connection.

**Parameters:** None

**Returns:** `None`

**Features:**
- Creates async SQLAlchemy engine from configuration
- Uses `NullPool` for connection pooling (recommended for migrations)
- Runs migrations asynchronously using `asyncio.run()`

**Implementation Details:**
```python
async def run_async_migrations():
    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)
```

## Execution Flow

The module automatically determines the execution mode:

```python
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

- **Offline Mode**: Generates SQL without database connection
- **Online Mode**: Connects to database and executes migrations directly

## Configuration Objects

### `config`
- Alembic configuration object
- Automatically sets SQLAlchemy URL from application settings
- Configures logging from INI file

### `target_metadata`
- References `Base.metadata` from application models
- Used by Alembic for autogenerate functionality
- Enables automatic detection of model changes

## Usage

This file is typically executed by Alembic commands:

```bash
# Run migrations online (default)
alembic upgrade head

# Generate migration offline
alembic upgrade head --sql

# Create new migration
alembic revision --autogenerate -m "description"
```

## Notes

- The `# noqa: E402` comments suppress linting warnings for imports after path modification
- Uses `NullPool` to avoid connection pool issues during migrations
- Supports both SQLite (with aiosqlite) and other async database drivers
- Maintains compatibility with standard Alembic workflow while adding async support