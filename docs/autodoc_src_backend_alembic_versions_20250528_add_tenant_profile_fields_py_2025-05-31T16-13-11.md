<!--
This documentation was auto-generated by Claude on 2025-05-31T16-13-11.
Source file: ./src/backend/alembic/versions/20250528_add_tenant_profile_fields.py
-->

# Database Migration: Add Tenant Profile Fields to Entity Model

## Overview

This Alembic migration adds tenant profile fields to the Entity model, enhancing the system's ability to store detailed tenant information including address components and operational status.

**Migration ID:** `20250528_tenant_profile`  
**Parent Migration:** `20250525_llm_config`  
**Created:** May 28, 2025

## Changes Summary

This migration introduces comprehensive tenant profiling capabilities by adding new fields to both the `entities` and `user_entities` tables.

### Tables Modified

- `entities` - Enhanced with profile and address fields
- `user_entities` - Added default entity designation capability

## Schema Changes

### Entities Table

The following columns are added to the `entities` table:

| Column | Type | Length | Nullable | Default | Description |
|--------|------|--------|----------|---------|-------------|
| `alias` | String | 100 | No | 'Default' | Display name or alias for the entity |
| `street` | String | 255 | Yes | NULL | Street address |
| `house_number` | String | 20 | Yes | NULL | House or building number |
| `apartment` | String | 50 | Yes | NULL | Apartment, suite, or unit number |
| `area_code` | String | 20 | Yes | NULL | Postal or area code |
| `county` | String | 100 | Yes | NULL | County or administrative region |
| `country` | String | 100 | Yes | NULL | Country name |
| `is_active` | Boolean | - | Yes | true | Entity activation status |
| `updated_at` | DateTime | - | Yes | CURRENT_TIMESTAMP | Last modification timestamp |

### User Entities Table

The following column is added to the `user_entities` table:

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `is_default` | Boolean | Yes | false | Indicates if this is the user's default entity |

## Migration Functions

### upgrade()

Executes the forward migration by:

1. **Entities Table Enhancement**
   - Adds tenant identification field (`alias`)
   - Adds comprehensive address fields (`street`, `house_number`, `apartment`, `area_code`, `county`, `country`)
   - Adds operational status tracking (`is_active`, `updated_at`)

2. **User Entities Relationship Enhancement**
   - Adds default entity designation capability (`is_default`)

### downgrade()

Executes the reverse migration by:

1. Removing the `is_default` column from `user_entities` table
2. Removing all newly added columns from `entities` table in reverse order

## Usage Implications

### Business Logic Impact

- **Tenant Management**: Enables comprehensive tenant profiling with detailed address information
- **Multi-tenancy**: Support for tenant aliases and activation status
- **User Experience**: Default entity selection for improved user workflows
- **Data Integrity**: Automatic timestamp tracking for entity modifications

### Application Code Considerations

After applying this migration, application code should:

- Update Entity model definitions to include new fields
- Implement tenant address management features
- Handle default entity selection logic
- Consider validation rules for address components

## Rollback Considerations

- **Data Loss Warning**: Rolling back this migration will permanently delete all data stored in the new columns
- **Application Compatibility**: Ensure application code can handle the absence of these fields before rollback
- **Foreign Key Dependencies**: Verify no dependent features rely on the new fields before downgrading

## Dependencies

- **Requires**: Migration `20250525_llm_config`
- **SQLAlchemy**: Compatible with batch operations for table alterations
- **Database**: Supports boolean data types and datetime functions

---

*This migration is part of the tenant profiling enhancement initiative and should be thoroughly tested in staging environments before production deployment.*