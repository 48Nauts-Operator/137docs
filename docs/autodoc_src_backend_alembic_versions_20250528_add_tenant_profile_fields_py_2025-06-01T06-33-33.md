<!--
This documentation was auto-generated by Claude on 2025-06-01T06-33-33.
Source file: ./src/backend/alembic/versions/20250528_add_tenant_profile_fields.py
-->

# Database Migration: Add Tenant Profile Fields to Entity Model

## Overview

This Alembic database migration adds tenant profile fields to the Entity model, enhancing the system's ability to store detailed tenant information including address components and metadata.

## Migration Details

| Property | Value |
|----------|-------|
| **Revision ID** | `20250528_tenant_profile` |
| **Revises** | `20250525_llm_config` |
| **Created** | 2025-05-28 |
| **Type** | Schema Enhancement |

## Changes Summary

This migration enhances two existing tables by adding new columns to support comprehensive tenant profiling:

### `entities` Table Modifications

The following columns are added to the `entities` table:

| Column Name | Data Type | Constraints | Default Value | Purpose |
|-------------|-----------|-------------|---------------|---------|
| `alias` | VARCHAR(100) | NOT NULL | 'Default' | Human-readable entity identifier |
| `street` | VARCHAR(255) | NULLABLE | NULL | Street address |
| `house_number` | VARCHAR(20) | NULLABLE | NULL | House/building number |
| `apartment` | VARCHAR(50) | NULLABLE | NULL | Apartment/unit number |
| `area_code` | VARCHAR(20) | NULLABLE | NULL | Postal/ZIP code |
| `county` | VARCHAR(100) | NULLABLE | NULL | County/region |
| `country` | VARCHAR(100) | NULLABLE | NULL | Country |
| `is_active` | BOOLEAN | NULLABLE | TRUE | Entity status flag |
| `updated_at` | DATETIME | NULLABLE | CURRENT_TIMESTAMP | Last modification timestamp |

### `user_entities` Table Modifications

| Column Name | Data Type | Constraints | Default Value | Purpose |
|-------------|-----------|-------------|---------------|---------|
| `is_default` | BOOLEAN | NULLABLE | FALSE | Default entity flag for user |

## Implementation Details

### Upgrade Function

The `upgrade()` function performs the following operations:

1. **Entities Table Enhancement**: Uses batch operations to add nine new columns supporting:
   - Entity identification (`alias`)
   - Complete address information (`street`, `house_number`, `apartment`, `area_code`, `county`, `country`)
   - Status tracking (`is_active`, `updated_at`)

2. **User-Entity Relationship Enhancement**: Adds the `is_default` flag to track which entity serves as a user's primary/default entity.

### Downgrade Function

The `downgrade()` function provides complete rollback capability by:

1. Removing the `is_default` column from `user_entities` table
2. Removing all nine added columns from `entities` table in reverse order

## Usage Impact

### Benefits

- **Enhanced Address Management**: Complete address storage with granular components
- **Improved User Experience**: Default entity selection for streamlined workflows  
- **Better Data Organization**: Entity aliasing and status tracking
- **Audit Trail**: Automatic timestamp tracking for entity modifications

### Considerations

- **Storage Requirements**: Additional columns will increase table size
- **Application Updates**: Client applications may need updates to utilize new fields
- **Data Validation**: Consider implementing application-level validation for address components
- **Migration Time**: Large `entities` tables may require extended migration time

## Dependencies

- **Previous Migration**: `20250525_llm_config`
- **Alembic Version**: Compatible with standard Alembic operations
- **Database Engine**: Uses SQLAlchemy standard column types for cross-database compatibility

## Rollback Instructions

To rollback this migration:

```bash
alembic downgrade 20250525_llm_config
```

⚠️ **Warning**: Rollback will permanently delete all data stored in the newly added columns.