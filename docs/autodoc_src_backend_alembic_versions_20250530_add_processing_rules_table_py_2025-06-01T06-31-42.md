<!--
This documentation was auto-generated by Claude on 2025-06-01T06-31-42.
Source file: ./src/backend/alembic/versions/20250530_add_processing_rules_table.py
-->

# Database Migration: Processing Rules Table

## Overview

This Alembic migration creates the `processing_rules` table to support document automation functionality. The table stores configurable rules that can be applied to documents based on various criteria such as vendor information.

## Migration Details

- **Revision ID**: `20250530_processing_rules`
- **Previous Revision**: `20250529_final_cleanup`
- **Created**: 2025-05-30
- **Purpose**: Add processing rules table for document automation

## Table Schema: `processing_rules`

### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | Integer | Primary Key | Unique identifier for each processing rule |
| `name` | String(255) | NOT NULL | Human-readable name for the rule |
| `description` | Text | NULL | Optional detailed description of the rule's purpose |
| `vendor` | String(255) | NULL | Vendor name for rule matching criteria |
| `preferred_tenant_id` | Integer | Foreign Key to `entities.id` | Associated tenant entity |
| `conditions` | Text | NOT NULL | JSON string defining rule matching conditions |
| `actions` | Text | NOT NULL | JSON string defining actions to execute when rule matches |
| `priority` | Integer | Default: 0 | Rule execution priority (higher values = higher priority) |
| `enabled` | Boolean | Default: True | Whether the rule is active |
| `matches_count` | Integer | Default: 0 | Number of times this rule has been matched |
| `last_matched_at` | DateTime | NULL | Timestamp of the most recent rule match |
| `created_at` | DateTime | Server Default: `now()` | Record creation timestamp |
| `updated_at` | DateTime | Server Default: `now()` | Record last modification timestamp |

### Indexes

The following indexes are created for optimal query performance:

- `ix_processing_rules_id` - Primary key index
- `ix_processing_rules_vendor` - Vendor lookup optimization
- `ix_processing_rules_priority` - Priority-based sorting
- `ix_processing_rules_enabled` - Active rules filtering

### Foreign Key Relationships

- `preferred_tenant_id` â†’ `entities.id`: Links processing rules to tenant entities

## JSON Field Structure

### Conditions Field
The `conditions` column stores JSON data that defines when a rule should be applied. Expected structure:
```json
{
  "field_matches": {},
  "document_type": "string",
  "custom_criteria": {}
}
```

### Actions Field
The `actions` column stores JSON data that defines what actions to perform when the rule matches. Expected structure:
```json
{
  "field_mappings": {},
  "transformations": [],
  "notifications": []
}
```

## Usage Examples

### Querying Active Rules by Priority
```sql
SELECT * FROM processing_rules 
WHERE enabled = true 
ORDER BY priority DESC, created_at ASC;
```

### Finding Rules by Vendor
```sql
SELECT * FROM processing_rules 
WHERE vendor = 'Acme Corp' 
AND enabled = true;
```

## Migration Operations

### Upgrade
- Creates the `processing_rules` table with all specified columns
- Establishes foreign key relationship to `entities` table
- Creates performance indexes

### Downgrade
- Removes all indexes in reverse order
- Drops the `processing_rules` table completely

## Performance Considerations

- The table includes indexes on frequently queried columns (`vendor`, `priority`, `enabled`)
- JSON fields (`conditions`, `actions`) may benefit from database-specific JSON indexing in future migrations
- Consider partitioning strategies if the table grows to millions of records

## Security Notes

- The `conditions` and `actions` JSON fields should be validated before storage
- Access to processing rules should be restricted based on tenant permissions
- Rule execution should include proper error handling and logging