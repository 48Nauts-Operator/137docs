<!--
This documentation was auto-generated by Claude on 2025-06-01T06-32-50.
Source file: ./src/backend/alembic/versions/2025_05_21_add_users_table.py
-->

# Database Migration: Add Users Table

## Overview

This Alembic database migration adds a `users` table to support user authentication and authorization functionality. The migration uses raw SQL with `IF NOT EXISTS` clauses to ensure idempotency.

## Migration Details

- **Revision ID**: `2025_05_21_add_users_table`
- **Parent Revision**: `0001_baseline`
- **Created**: 2025-05-21 00:00:00.000000
- **Type**: Schema addition

## Changes

### Upgrade Operation

Creates a new `users` table with the following structure:

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | `SERIAL` | PRIMARY KEY | Auto-increment | Unique user identifier |
| `username` | `VARCHAR(50)` | UNIQUE, NOT NULL | - | User's login name |
| `email` | `VARCHAR(100)` | UNIQUE, NOT NULL | - | User's email address |
| `full_name` | `VARCHAR(100)` | - | - | User's display name |
| `role` | `VARCHAR(20)` | NOT NULL | `'viewer'` | User's authorization role |
| `hashed_password` | `VARCHAR(255)` | NOT NULL | - | Encrypted password |
| `disabled` | `BOOLEAN` | - | `FALSE` | Account status flag |
| `created_at` | `TIMESTAMP WITHOUT TIME ZONE` | - | `NOW()` | Record creation timestamp |

### Downgrade Operation

Removes the `users` table completely.

## Key Features

### Idempotency
- Uses `CREATE TABLE IF NOT EXISTS` to prevent errors on repeated runs
- Uses `DROP TABLE IF EXISTS` for safe rollback operations

### Security Considerations
- Passwords are stored in hashed format (`hashed_password` field)
- Role-based access control support via `role` field
- Account disable functionality via `disabled` field

### Data Integrity
- Unique constraints on both `username` and `email`
- NOT NULL constraints on critical fields
- Default role assignment for new users

## Usage

### Apply Migration
```bash
alembic upgrade head
```

### Rollback Migration
```bash
alembic downgrade 0001_baseline
```

### Check Migration Status
```bash
alembic current
alembic history
```

## Dependencies

- **Alembic**: Database migration tool
- **SQLAlchemy**: SQL toolkit (imported but not directly used)
- **PostgreSQL**: Target database (inferred from SERIAL type usage)

## Notes

- This migration uses raw SQL instead of SQLAlchemy's schema definition methods
- The `role` field defaults to `'viewer'` - ensure your application defines appropriate role values
- Timestamps are stored without timezone information
- The migration is designed to be safe for production deployment due to its idempotent nature