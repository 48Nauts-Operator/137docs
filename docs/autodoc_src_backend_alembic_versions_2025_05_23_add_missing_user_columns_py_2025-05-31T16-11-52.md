<!--
This documentation was auto-generated by Claude on 2025-05-31T16-11-52.
Source file: ./src/backend/alembic/versions/2025_05_23_add_missing_user_columns.py
-->

# Database Migration: User Columns Enhancement

## Overview

This Alembic migration adds missing `full_name` and `role` columns to the `users` table for installations that were created before version 0.08 of the application.

## Migration Details

| Property | Value |
|----------|-------|
| **Revision ID** | `20250523_user_cols` |
| **Previous Revision** | `2025_05_22_add_settings_table` |
| **Created** | 2025-05-23 00:00:00.000000 |
| **Branch Labels** | None |
| **Dependencies** | None |

## Purpose

This migration patches older installations where the `users` table was created before v0.08 and therefore lacks the `full_name` and `role` columns that are now required by the authentication logic.

## Changes Made

### Upgrade Operations

The migration adds two new columns to the `users` table:

1. **`full_name`** 
   - Type: `VARCHAR(100)`
   - Nullable: Yes
   - Default: None

2. **`role`**
   - Type: `VARCHAR(20)`
   - Nullable: No
   - Default: `'viewer'`

### Implementation Notes

- **SQLite Compatibility**: The migration uses a try/catch approach because SQLite doesn't support `IF NOT EXISTS` with `ADD COLUMN` statements
- **Idempotent Design**: If columns already exist, the migration will continue without errors
- **Safe Defaults**: The `role` column defaults to `'viewer'` to ensure existing users maintain access

## Database Schema Impact

### Before Migration
```sql
CREATE TABLE users (
    -- existing columns without full_name and role
);
```

### After Migration
```sql
CREATE TABLE users (
    -- existing columns
    full_name VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'viewer'
);
```

## Rollback Limitations

### Downgrade Operations

⚠️ **Important**: This migration cannot be easily rolled back due to SQLite limitations.

- SQLite doesn't support `DROP COLUMN` operations
- Rolling back would require recreating the entire table
- The `downgrade()` function is intentionally left empty

## Running the Migration

### Apply Migration
```bash
alembic upgrade 20250523_user_cols
```

### Check Current Version
```bash
alembic current
```

### View Migration History
```bash
alembic history
```

## Compatibility

- **Database**: SQLite (primary), adaptable to other databases
- **Application Version**: Required for v0.08 and later
- **Python**: Compatible with Python 3.6+
- **Alembic**: Compatible with Alembic 1.0+

## Error Handling

The migration includes robust error handling:

- **Column Exists**: If columns already exist, exceptions are caught and ignored
- **Connection Issues**: Uses Alembic's connection binding for reliability
- **Transaction Safety**: Operations are wrapped in Alembic's transaction context

## Testing Recommendations

Before applying to production:

1. **Backup Database**: Always backup your database before running migrations
2. **Test Environment**: Run the migration in a test environment first
3. **Verify Schema**: Confirm the columns were added correctly
4. **Application Testing**: Ensure the application works with the new schema

## Related Migrations

- **Previous**: `2025_05_22_add_settings_table` - Added settings table
- **Context**: Part of the v0.08 authentication system upgrade