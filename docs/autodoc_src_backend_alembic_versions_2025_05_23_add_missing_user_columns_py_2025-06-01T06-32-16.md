<!--
This documentation was auto-generated by Claude on 2025-06-01T06-32-16.
Source file: ./src/backend/alembic/versions/2025_05_23_add_missing_user_columns.py
-->

# Database Migration: Add User Columns

## Overview

This Alembic migration adds missing `full_name` and `role` columns to the `users` table for installations that were created before version 0.08 of the application.

## Migration Details

- **Revision ID**: `20250523_user_cols`
- **Revises**: `2025_05_22_expand_address_book`
- **Create Date**: 2025-05-23 00:00:00.000000
- **Purpose**: Patch legacy installations missing required user authentication columns

## Schema Changes

### Added Columns

| Column Name | Data Type | Constraints | Default Value | Description |
|-------------|-----------|-------------|---------------|-------------|
| `full_name` | `VARCHAR(100)` | None | `NULL` | User's complete display name |
| `role` | `VARCHAR(20)` | `NOT NULL` | `'viewer'` | User's permission role in the system |

## Functions

### `upgrade()`

Adds the missing columns to the `users` table with error handling for existing columns.

**Behavior:**
- Attempts to add `full_name` column as nullable `VARCHAR(100)`
- Attempts to add `role` column as non-nullable `VARCHAR(20)` with default value `'viewer'`
- Uses exception handling to gracefully skip columns that already exist
- Compatible with SQLite's limitations (no `IF NOT EXISTS` support for `ADD COLUMN`)

**Error Handling:**
- Catches and ignores exceptions when columns already exist
- Safe for running on databases in various states

### `downgrade()`

Currently implements a no-op downgrade due to SQLite limitations.

**Limitations:**
- SQLite does not support `DROP COLUMN` operations
- Full downgrade would require recreating the entire table
- Left as placeholder for potential future implementation

## Database Compatibility

### SQLite Considerations

- **ADD COLUMN**: Supported but without `IF NOT EXISTS` clause
- **DROP COLUMN**: Not supported (affects downgrade implementation)
- **Exception Handling**: Used to work around conditional column addition

## Usage Notes

### Prerequisites

- Database must have existing `users` table
- Previous migration `2025_05_22_expand_address_book` must be applied

### Post-Migration

After running this migration:
- All existing users will have `role` set to `'viewer'` by default
- All existing users will have `full_name` set to `NULL`
- New authentication logic requiring these columns will function properly

### Safety

- **Idempotent**: Safe to run multiple times
- **Non-destructive**: Only adds columns, never removes or modifies existing data
- **Backward Compatible**: Existing application code will continue to function

## Example Usage

```bash
# Apply migration
alembic upgrade head

# Check migration status
alembic current

# View migration history
alembic history
```

## Related Migrations

- **Previous**: `2025_05_22_expand_address_book`
- **Next**: TBD

## Notes

This migration specifically addresses installations that were created before the introduction of the enhanced user authentication system in version 0.08. The default role assignment ensures that existing users maintain access while administrators can update roles as needed.