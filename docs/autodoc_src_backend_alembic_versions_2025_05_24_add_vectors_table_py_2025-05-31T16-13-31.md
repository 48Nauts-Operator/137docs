<!--
This documentation was auto-generated by Claude on 2025-05-31T16-13-31.
Source file: ./src/backend/alembic/versions/2025_05_24_add_vectors_table.py
-->

# Database Migration: ColPali Vectors Table

## Overview

This Alembic migration creates a `vectors` table to support ColPali patch-id mapping functionality. The table stores vector identifiers associated with document pages for document processing and retrieval operations.

## Migration Details

- **Revision ID**: `20250524_vectors`
- **Previous Revision**: `20250524_user_disabled`
- **Created**: 2025-05-24 12:00:00 UTC
- **Purpose**: Create vectors table for ColPali patch-id mapping

## Database Schema Changes

### Table: `vectors`

Creates a new table to store vector mapping data for document pages.

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `SERIAL` | `PRIMARY KEY` | Auto-incrementing unique identifier |
| `doc_id` | `INTEGER` | `NOT NULL`, `FOREIGN KEY` | References `documents(id)` with cascade delete |
| `page` | `INTEGER` | `NOT NULL` | Page number within the document |
| `vector_ids` | `TEXT` | `NOT NULL` | Serialized vector identifiers for the page |

#### Indexes

- `ix_vectors_doc_id`: Index on `doc_id` column for efficient document-based queries

#### Foreign Key Constraints

- `doc_id` â†’ `documents(id)` with `ON DELETE CASCADE`
  - When a document is deleted, all associated vector records are automatically removed

## Migration Functions

### `upgrade()`

Executes the forward migration:

1. Creates the `vectors` table with all specified columns and constraints
2. Creates an index on the `doc_id` column for query optimization
3. Uses `IF NOT EXISTS` clauses to ensure idempotent execution

### `downgrade()`

Executes the rollback migration:

1. Drops the `vectors` table completely
2. Uses `IF EXISTS` clause to prevent errors if table doesn't exist

## Usage Notes

- The `vector_ids` column stores serialized data (likely JSON or comma-separated values)
- The table supports multiple vector entries per document through the `page` column
- Cascade deletion ensures data consistency when documents are removed
- The migration is designed to be safe for re-execution

## Dependencies

- Requires `alembic` for migration execution
- Requires `sqlalchemy` for database operations
- Depends on the existence of a `documents` table with an `id` column