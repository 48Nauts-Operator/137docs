<!--
This documentation was auto-generated by Claude on 2025-06-01T06-33-53.
Source file: ./src/backend/alembic/versions/2025_05_24_add_vectors_table.py
-->

# Database Migration: Vectors Table Creation

## Overview

This Alembic migration creates a `vectors` table designed to store ColPali patch-id mappings for document processing and vector storage operations.

## Migration Details

- **Revision ID**: `20250524_vectors`
- **Previous Revision**: `20250524_user_disabled`
- **Created**: 2025-05-24 12:00:00
- **Purpose**: Create vectors table for ColPali patch-id mapping

## Schema Changes

### Table Creation: `vectors`

The migration creates a new table with the following structure:

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | SERIAL | PRIMARY KEY | Auto-incrementing unique identifier |
| `doc_id` | INTEGER | NOT NULL, FOREIGN KEY | References `documents(id)` with cascade delete |
| `page` | INTEGER | NOT NULL | Page number within the document |
| `vector_ids` | TEXT | NOT NULL | Serialized patch-id mappings for ColPali |

### Indexes

- **`ix_vectors_doc_id`**: Index on `doc_id` column for optimized document-based queries

### Foreign Key Relationships

- `doc_id` â†’ `documents(id)` with `ON DELETE CASCADE`
  - When a document is deleted, all associated vector records are automatically removed

## Functions

### `upgrade()`

Executes the forward migration:

1. Creates the `vectors` table with all specified columns and constraints
2. Creates an index on the `doc_id` column for query optimization

**SQL Operations:**
- Creates table with SERIAL primary key and foreign key constraint
- Adds performance index for document-based lookups

### `downgrade()`

Executes the reverse migration:

1. Drops the `vectors` table entirely
2. All associated data and indexes are automatically removed

**Note**: This operation is destructive and will permanently delete all vector mapping data.

## Usage Context

This table is specifically designed for ColPali (Contextualized Late Interaction via Pairwise Late Interaction) document processing, storing:

- Document-to-vector mappings
- Page-level vector associations
- Patch-id serialization for efficient retrieval

## Safety Features

- Uses `IF NOT EXISTS` and `IF EXISTS` clauses to prevent errors on repeated execution
- Implements cascade deletion to maintain referential integrity
- Includes proper indexing for performance optimization

## Dependencies

- Requires the `documents` table to exist (referenced by foreign key)
- Depends on previous migration: `20250524_user_disabled`