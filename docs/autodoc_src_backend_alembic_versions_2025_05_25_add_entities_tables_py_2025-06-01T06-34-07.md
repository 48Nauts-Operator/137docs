<!--
This documentation was auto-generated by Claude on 2025-06-01T06-34-07.
Source file: ./src/backend/alembic/versions/2025_05_25_add_entities_tables.py
-->

# Database Migration: Add Entities Tables and Columns

## Overview

This Alembic migration script adds entity management functionality to the database schema by creating new tables for entities and user-entity relationships, and adding related columns to existing tables.

**Migration Details:**
- **Revision ID:** `20250525_entities`
- **Previous Revision:** `20250524_vectors`
- **Created:** 2025-05-25

## Schema Changes

### New Tables

#### `entities`
Stores information about business entities (companies, organizations, etc.).

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | Integer | Primary Key | Auto-increment | Unique entity identifier |
| `name` | String(255) | NOT NULL | - | Entity name |
| `type` | String(20) | - | 'company' | Entity type classification |
| `address_json` | Text | Nullable | - | JSON-formatted address data |
| `vat_id` | String(50) | Nullable | - | VAT identification number |
| `iban` | String(50) | Nullable | - | International Bank Account Number |
| `aliases` | String[] | Nullable | - | Array of alternative entity names |
| `created_at` | DateTime | - | `now()` | Record creation timestamp |

#### `user_entities`
Junction table linking users to entities with role-based access.

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `user_id` | Integer | Primary Key, Foreign Key | - | Reference to users.id |
| `entity_id` | Integer | Primary Key, Foreign Key | - | Reference to entities.id |
| `role` | String(20) | - | 'owner' | User's role for the entity |

**Foreign Key Relationships:**
- `user_id` → `users.id`
- `entity_id` → `entities.id`

### Modified Tables

#### `documents`
**Added Column:**
- `entity_id` (Integer, Nullable) - Links documents to entities
- **Index:** `ix_documents_entity_id` for query optimization
- **Foreign Key:** References `entities.id`

#### `settings`
**Added Column:**
- `tos_accepted_at` (DateTime, Nullable) - Timestamp of Terms of Service acceptance

## Database Operations

### Upgrade Operations
1. Create `entities` table with all specified columns and constraints
2. Create `user_entities` junction table with composite primary key
3. Add `entity_id` column to `documents` table
4. Create index on `documents.entity_id` for performance
5. Establish foreign key relationship between documents and entities
6. Add `tos_accepted_at` column to `settings` table

### Downgrade Operations
1. Remove `tos_accepted_at` column from `settings` table
2. Drop foreign key constraint between documents and entities
3. Remove index on `documents.entity_id`
4. Remove `entity_id` column from `documents` table
5. Drop `user_entities` table
6. Drop `entities` table

## Usage Notes

- The migration uses PostgreSQL-specific data types (`postgresql.ARRAY`)
- Entity types default to 'company' but can be customized
- User-entity relationships default to 'owner' role
- Address data is stored as JSON text for flexibility
- All timestamp fields use server-side `now()` function

## Dependencies

- **Python Packages:** `alembic`, `sqlalchemy`
- **Database:** PostgreSQL (required for array column type)
- **Previous Migration:** `20250524_vectors`

## Running the Migration

```bash
# Apply migration
alembic upgrade head

# Rollback migration
alembic downgrade 20250524_vectors
```