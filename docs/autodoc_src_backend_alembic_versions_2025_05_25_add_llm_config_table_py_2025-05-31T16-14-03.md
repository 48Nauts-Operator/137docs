<!--
This documentation was auto-generated by Claude on 2025-05-31T16-14-03.
Source file: ./src/backend/alembic/versions/2025_05_25_add_llm_config_table.py
-->

# Database Migration: LLM Configuration Table

## Overview

This Alembic migration script creates a comprehensive configuration table for Local Language Model (LLM) integration, enabling local-first AI processing capabilities within the application.

**Migration Details:**
- **Revision ID:** `20250525_llm_config`
- **Previous Revision:** `20250525_entities`
- **Created:** 2025-05-25
- **Purpose:** Add LLM configuration management for local-first AI integration

## Table Schema: `llm_config`

### Primary Key
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `INTEGER` | Primary Key | Unique identifier for configuration records |

### Provider Configuration
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `provider` | `VARCHAR(50)` | `'local'` | No | LLM service provider (local, openai, anthropic, etc.) |
| `api_key` | `VARCHAR(255)` | None | Yes | Authentication key for external providers |
| `api_url` | `VARCHAR(255)` | None | Yes | Custom API endpoint URL |

### Model Preferences
Configures specific models for different AI tasks:

| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `model_tagger` | `VARCHAR(100)` | `'phi3'` | No | Model for content tagging operations |
| `model_enricher` | `VARCHAR(100)` | `'llama3'` | No | Model for content enrichment |
| `model_analytics` | `VARCHAR(100)` | `'llama3'` | No | Model for analytics processing |
| `model_responder` | `VARCHAR(100)` | None | Yes | Model for response generation |

### Processing Configuration
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `enabled` | `BOOLEAN` | `false` | No | Master switch for LLM processing |
| `auto_tagging` | `BOOLEAN` | `true` | No | Enable automatic content tagging |
| `auto_enrichment` | `BOOLEAN` | `true` | No | Enable automatic content enrichment |
| `external_enrichment` | `BOOLEAN` | `false` | No | Allow external API enrichment |

### Reliability Settings
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `max_retries` | `INTEGER` | `3` | No | Maximum retry attempts for failed requests |
| `retry_delay` | `INTEGER` | `300` | No | Delay between retries (seconds) |
| `backup_provider` | `VARCHAR(50)` | None | Yes | Fallback provider for reliability |
| `backup_model` | `VARCHAR(100)` | None | Yes | Fallback model configuration |

### Performance Settings
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `batch_size` | `INTEGER` | `5` | No | Number of items processed per batch |
| `concurrent_tasks` | `INTEGER` | `2` | No | Maximum concurrent processing tasks |
| `cache_responses` | `BOOLEAN` | `true` | No | Enable response caching for efficiency |

### Quality Control
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `min_confidence_tagging` | `FLOAT` | `0.7` | No | Minimum confidence threshold for tagging |
| `min_confidence_entity` | `FLOAT` | `0.8` | No | Minimum confidence threshold for entity extraction |

### Audit Fields
| Column | Type | Default | Nullable | Description |
|--------|------|---------|----------|-------------|
| `created_at` | `DATETIME` | `NOW()` | No | Record creation timestamp |
| `updated_at` | `DATETIME` | `NOW()` | No | Last modification timestamp |

## Indexes

- **Primary Index:** `ix_llm_config_id` on `id` column for efficient lookups

## Migration Functions

### `upgrade()`
Creates the `llm_config` table with all specified columns, constraints, and indexes. This function:
1. Creates the table structure with appropriate data types
2. Sets default values for configuration parameters
3. Establishes the primary key index

### `downgrade()`
Rolls back the migration by:
1. Dropping the index `ix_llm_config_id`
2. Removing the `llm_config` table entirely

## Usage Notes

- **Local-First Design:** Default configuration prioritizes local models (`phi3`, `llama3`) over external APIs
- **Flexible Provider Support:** Supports multiple LLM providers through configurable endpoints
- **Task-Specific Models:** Allows different models for different AI tasks (tagging, enrichment, analytics)
- **Performance Tuning:** Configurable batch sizes and concurrency limits for optimal resource usage
- **Quality Assurance:** Confidence thresholds ensure reliable AI outputs
- **Fault Tolerance:** Backup provider and retry mechanisms for robust operation

## Dependencies

This migration depends on the `20250525_entities` revision and should be applied after that migration is complete.