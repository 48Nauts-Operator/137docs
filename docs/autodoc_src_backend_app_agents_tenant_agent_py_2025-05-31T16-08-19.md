<!--
This documentation was auto-generated by Claude on 2025-05-31T16-08-19.
Source file: ./src/backend/app/agents/tenant_agent.py
-->

# Tenant Extraction and Auto-Assignment Agent

## Overview

The `TenantExtractionAgent` is a sophisticated document processing agent that automatically analyzes document content to extract recipient/tenant information and assigns documents to appropriate tenant profiles. It combines LLM-powered intelligent extraction with fallback rule-based processing to ensure reliable operation.

## Features

- **Intelligent Content Analysis**: Uses LLM services for sophisticated tenant information extraction
- **Fallback Processing**: Rule-based extraction when LLM services are unavailable
- **Tenant Matching**: Fuzzy matching algorithm to find existing tenants
- **Multi-language Support**: Handles Swiss German and English documents
- **Confidence Scoring**: Provides extraction confidence levels for quality control
- **Safe Operation**: Never automatically creates new tenants for security

## Class Reference

### TenantExtractionAgent

Main agent class for tenant extraction and document assignment operations.

#### Constructor

```python
TenantExtractionAgent(db_session: AsyncSession)
```

**Parameters:**
- `db_session` (AsyncSession): Database session for data operations

**Dependencies:**
- `TenantRepository`: For tenant data operations
- `DocumentRepository`: For document data operations  
- `LLMService`: For AI-powered content analysis

#### Methods

##### analyze_and_assign_tenant

```python
async def analyze_and_assign_tenant(
    document_id: int, 
    user_id: int
) -> Dict[str, Any]
```

Main entry point that analyzes document content and assigns it to appropriate tenant.

**Parameters:**
- `document_id` (int): ID of the document to analyze
- `user_id` (int): ID of the user who owns the document

**Returns:**
- `Dict[str, Any]`: Analysis results with the following structure:

```python
{
    "status": str,           # "success", "no_match", "error", "vendor_rejected"
    "message": str,          # Human-readable status message
    "tenant": Dict,          # Matched tenant information (if successful)
    "extracted_info": Dict,  # Raw extracted tenant data
    "confidence": float,     # Extraction confidence score (0.0-1.0)
    "action": str           # "found", "created", or "updated"
}
```

**Status Values:**
- `"success"`: Document successfully assigned to tenant
- `"no_match"`: No matching tenant found or low confidence extraction
- `"error"`: Processing error occurred
- `"vendor_rejected"`: Extracted information appears to be vendor/sender data

## Extraction Process

### 1. Document Validation

The agent first validates the document and checks if it already has a valid recipient assignment:

```python
# Skip if document already has a good recipient assignment
if (document.recipient and 
    document.recipient.strip() and 
    document.recipient not in ["Your Company", "", "Unknown"]):
    return {"status": "no_match", "message": f"Document already has recipient: {document.recipient}"}
```

### 2. LLM-Powered Extraction

When LLM services are available, the agent uses sophisticated AI analysis:

- **Content Analysis**: Processes document content and title
- **Recipient Focus**: Specifically extracts recipient information, not sender/vendor data
- **Structured Output**: Returns JSON-formatted tenant information
- **Confidence Scoring**: Provides reliability metrics

### 3. Fallback Rule-Based Extraction

When LLM is unavailable, uses pattern matching:

- **Swiss Legal Patterns**: Specialized patterns for Swiss documents
- **Standard Business Patterns**: Common business document formats
- **Proper Noun Detection**: Identifies potential names and entities

## Extracted Information Structure

The agent extracts comprehensive tenant information:

```python
{
    "name": str,              # Full legal name
    "alias": str,             # Short friendly name
    "type": str,              # "company" or "individual"
    "address": {
        "street": str,
        "house_number": str,
        "apartment": str,
        "area_code": str,
        "county": str,
        "country": str
    },
    "contact": {
        "phone": str,
        "email": str
    },
    "business_info": {
        "vat_id": str,
        "iban": str
    },
    "confidence": float       # 0.0-1.0 confidence score
}
```

## Tenant Matching Algorithm

The agent uses fuzzy string matching to find existing tenants:

```python
def _find_matching_tenant(self, tenant_info: Dict[str, Any], existing_tenants: List[Dict]) -> Optional[Dict]:
    """Find matching tenant using fuzzy matching."""
    from difflib import SequenceMatcher
    
    threshold = 0.8  # High threshold for tenant matching
    # Compares names and aliases using sequence matching
    # Returns best match above threshold
```

**Matching Criteria:**
- **Name Similarity**: Uses SequenceMatcher for fuzzy name comparison
- **High Threshold**: 0.8 similarity required to prevent false matches
- **Best Match**: Returns highest scoring match above threshold

## Security Features

### No Automatic Tenant Creation

For security reasons, the agent never automatically creates new tenants:

```python
# NO AUTOMATIC CREATION - User must create tenants manually
logger.info(f"No matching tenant found - tenant creation disabled for security")
return {
    "status": "no_match",
    "message": f"No matching tenant found. Please create tenant manually if needed.",
    "extracted_info": tenant_info
}
```

### Vendor Detection

The agent includes safeguards against extracting vendor/sender information instead of recipient data:

- **Vendor Name Filtering**: Maintains list of common vendor names to ignore
- **Pattern Recognition**: Identifies "From:" vs "To:" sections
- **Confidence Adjustment**: Lowers confidence when only vendor info is found

## Configuration

### Confidence Thresholds

```python
# Minimum confidence for processing
MIN_CONFIDENCE = 0.5

# Tenant matching threshold  
MATCH_THRESHOLD = 0.8
```

### Content Limits

```python
# Content truncation for LLM efficiency
MAX_CONTENT_LENGTH = 4000
```

## Error Handling

The agent implements comprehensive error handling:

```python