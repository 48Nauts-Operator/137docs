<!--
This documentation was auto-generated by Claude on 2025-06-01T06-28-42.
Source file: ./src/backend/app/agents/tenant_agent.py
-->

# Tenant Extraction and Auto-Assignment Agent

## Overview

The `TenantExtractionAgent` is a sophisticated document processing agent that automatically extracts recipient/tenant information from documents and assigns them to appropriate tenant profiles. It combines LLM-powered intelligent extraction with fallback rule-based methods to ensure reliable tenant identification.

## Features

- **Intelligent Tenant Extraction**: Uses LLM services for sophisticated content analysis
- **Fallback Rule-Based Extraction**: Provides reliable extraction when LLM is unavailable
- **Fuzzy Tenant Matching**: Matches extracted information to existing tenant profiles
- **Multi-language Support**: Handles Swiss German and standard patterns
- **Confidence Scoring**: Provides reliability metrics for extraction results
- **Safe Operation**: Never creates tenants automatically for security

## Class: TenantExtractionAgent

### Constructor

```python
def __init__(self, db_session: AsyncSession)
```

Initializes the agent with required database session and service dependencies.

**Parameters:**
- `db_session` (AsyncSession): Database session for data operations

**Dependencies:**
- `TenantRepository`: For tenant data operations
- `DocumentRepository`: For document data operations  
- `LLMService`: For intelligent content analysis

### Main Methods

#### `analyze_and_assign_tenant(document_id: int, user_id: int) -> Dict[str, Any]`

**Purpose:** Main entry point that analyzes document content to extract tenant information and assigns to appropriate tenant.

**Parameters:**
- `document_id` (int): ID of the document to analyze
- `user_id` (int): ID of the user who owns the document

**Returns:** Dictionary with analysis results and assignment status

**Return Structure:**
```python
{
    "status": "success" | "no_match" | "vendor_rejected" | "error",
    "message": "Description of the result",
    "tenant": {...},  # Tenant information (if successful)
    "extracted_info": {...},  # Raw extraction results
    "confidence": 0.0-1.0,  # Confidence score
    "action": "found" | "created" | "updated"  # Action taken
}
```

**Example Usage:**
```python
agent = TenantExtractionAgent(db_session)
result = await agent.analyze_and_assign_tenant(document_id=123, user_id=456)

if result["status"] == "success":
    print(f"Document assigned to: {result['tenant']['alias']}")
    print(f"Confidence: {result['confidence']:.2f}")
```

### Extraction Methods

#### `_extract_tenant_info(document: Document) -> Optional[Dict[str, Any]]`

**Purpose:** Extracts tenant/recipient information from document content using LLM or fallback methods.

**Parameters:**
- `document` (Document): Document object to analyze

**Returns:** Extracted tenant information or None if extraction fails

**Extraction Strategy:**
1. Check if LLM service is available
2. Use LLM-powered extraction for sophisticated analysis
3. Fall back to rule-based extraction if LLM fails
4. Return structured tenant information with confidence score

#### `_simple_tenant_extraction(document: Document) -> Optional[Dict[str, Any]]`

**Purpose:** Rule-based extraction when LLM is unavailable.

**Features:**
- Swiss legal document pattern recognition  
- Standard recipient pattern matching
- Proper noun identification
- Business entity type detection

**Supported Patterns:**
- Swiss patterns: `unsere referenz`, `gläubiger`, `zuständig mitarbeiter`
- Standard patterns: `bill to`, `customer`, company suffixes
- Address blocks and contact information

### Tenant Management Methods

#### `_find_or_create_tenant(tenant_info: Dict[str, Any], user_id: int) -> Dict[str, Any]`

**Purpose:** Finds existing matching tenant. **Never creates new tenants automatically** for security.

**Security Note:** This method only finds existing tenants and never creates new ones. Users must manually create tenant profiles.

**Parameters:**
- `tenant_info` (Dict): Extracted tenant information
- `user_id` (int): User ID for tenant lookup

**Returns:** Result dictionary with match status

#### `_find_matching_tenant(tenant_info: Dict[str, Any], existing_tenants: List[Dict]) -> Optional[Dict]`

**Purpose:** Uses fuzzy string matching to find similar existing tenants.

**Matching Algorithm:**
- Uses `difflib.SequenceMatcher` for similarity scoring
- Compares both name and alias fields
- Requires 80% similarity threshold for matches
- Returns best matching tenant above threshold

### LLM Integration Methods

#### `_create_tenant_extraction_prompt(content: str, title: str) -> str`

**Purpose:** Creates sophisticated LLM prompt for tenant extraction.

**Key Features:**
- Clear recipient vs. vendor distinction instructions
- Common vendor name exclusion list
- Structured JSON response format
- Confidence scoring guidelines
- Multi-pattern recognition hints

**Prompt Structure:**
- Document analysis instructions
- Critical extraction rules
- Vendor exclusion patterns
- JSON response template
- Confidence scoring criteria

#### `_parse_tenant_response(response: str) -> Optional[Dict[str, Any]]`

**Purpose:** Robustly parses LLM JSON responses with multiple fallback strategies.

**Parsing Strategies:**
1. Direct JSON parsing
2. JSON extraction from markdown code blocks
3. Pattern-based JSON extraction
4. JSON cleaning and repair

**Validation:**
- Confidence threshold checking (minimum 0.5)
- Required field validation
- Data structure normalization

### Utility Methods

#### `_normalize_tenant_data(data: Dict[str, Any]) -> Dict[str, Any]`

**Purpose:** Normalizes and validates extracted tenant data structure.

**Normalization Features:**
- String cleaning and trimming
- Type validation and defaults
- Nested structure processing
- Empty field removal
- Required field generation

#### `_generate_alias(name: str) -> str`

**Purpose:** Generates friendly aliases from full names.

**Algorithm:**
- Removes business suffixes (GmbH, Ltd, etc.)
- Truncates long names intelligently
- Preserves readability
- Handles both individual and company names

#### `_assign_document_to_tenant(document: Document, tenant: Dict)