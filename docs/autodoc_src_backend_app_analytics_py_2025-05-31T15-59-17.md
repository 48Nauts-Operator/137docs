<!--
This documentation was auto-generated by Claude on 2025-05-31T15-59-17.
Source file: ./src/backend/app/analytics.py
-->

# Analytics Service Documentation

## Overview

The `AnalyticsService` class provides comprehensive analytics functionality for the Document Management System. It supports both synchronous and asynchronous database operations, offering various reporting and analysis capabilities for documents, invoices, and payment tracking.

## Table of Contents

- [Class Definition](#class-definition)
- [Constructor](#constructor)
- [Core Methods](#core-methods)
- [Compatibility Methods](#compatibility-methods)
- [Usage Examples](#usage-examples)
- [Error Handling](#error-handling)

## Class Definition

```python
class AnalyticsService:
    """Service for document analytics."""
```

The service handles analytics operations with support for both async and sync database sessions, automatically detecting the session type and adapting its behavior accordingly.

## Constructor

### `__init__(db: Session)`

Initializes the analytics service with a database session.

**Parameters:**
- `db` (Session): SQLAlchemy database session (sync or async)

**Example:**
```python
analytics = AnalyticsService(db_session)
```

## Core Methods

### Document Statistics

#### `get_document_count_by_type() -> List[Dict[str, Any]]`

Returns document counts grouped by document type.

**Returns:**
- List of dictionaries containing:
  - `document_type` (str): Type of document
  - `count` (int): Number of documents of this type

**Example Response:**
```json
[
    {"document_type": "invoice", "count": 150},
    {"document_type": "receipt", "count": 89},
    {"document_type": "contract", "count": 23}
]
```

#### `get_document_count_by_status() -> List[Dict[str, Any]]`

Returns document counts grouped by status.

**Returns:**
- List of dictionaries containing:
  - `status` (str): Document status
  - `count` (int): Number of documents with this status

**Example Response:**
```json
[
    {"status": "paid", "count": 120},
    {"status": "unpaid", "count": 45},
    {"status": "pending", "count": 18}
]
```

### Time-Based Analytics

#### `get_document_count_by_month(months: int = 6) -> List[Dict[str, Any]]`

Returns document counts by month for the specified time period.

**Parameters:**
- `months` (int, optional): Number of months to include (default: 6)

**Returns:**
- List of dictionaries containing:
  - `year` (int): Year
  - `month` (int): Month number
  - `month_name` (str): Month name
  - `count` (int): Number of documents

**Features:**
- Supports multiple date formats (ISO, European)
- Falls back to `created_at` if `document_date` is unavailable
- Handles date parsing errors gracefully

**Example Response:**
```json
[
    {"year": 2024, "month": 1, "month_name": "January", "count": 25},
    {"year": 2024, "month": 2, "month_name": "February", "count": 32}
]
```

#### `get_invoice_amount_by_month(months: int = 6) -> List[Dict[str, Any]]`

Returns total invoice amounts by month for the specified time period.

**Parameters:**
- `months` (int, optional): Number of months to include (default: 6)

**Returns:**
- List of dictionaries containing:
  - `year` (int): Year
  - `month` (int): Month number
  - `month_name` (str): Month name
  - `total_amount` (float): Sum of invoice amounts
  - `count` (int): Number of invoices

**Example Response:**
```json
[
    {
        "year": 2024,
        "month": 1,
        "month_name": "January",
        "total_amount": 15750.50,
        "count": 12
    }
]
```

### Payment Analytics

#### `get_payment_status_summary() -> Dict[str, Any]`

Returns comprehensive payment status summary with counts, amounts, and percentages.

**Returns:**
- Dictionary containing:
  - `total_invoices` (int): Total number of invoices
  - `paid_invoices` (int): Number of paid invoices
  - `unpaid_invoices` (int): Number of unpaid invoices
  - `overdue_invoices` (int): Number of overdue invoices
  - `total_amount` (float): Total invoice amount
  - `paid_amount` (float): Total paid amount
  - `unpaid_amount` (float): Total unpaid amount
  - `overdue_amount` (float): Total overdue amount
  - `paid_percentage` (float): Percentage of paid invoices
  - `unpaid_percentage` (float): Percentage of unpaid invoices
  - `overdue_percentage` (float): Percentage of overdue invoices

**Example Response:**
```json
{
    "total_invoices": 100,
    "paid_invoices": 75,
    "unpaid_invoices": 25,
    "overdue_invoices": 5,
    "total_amount": 50000.0,
    "paid_amount": 37500.0,
    "unpaid_amount": 12500.0,
    "overdue_amount": 2500.0,
    "paid_percentage": 75.0,
    "unpaid_percentage": 25.0,
    "overdue_percentage": 5.0
}
```

#### `get_upcoming_due_dates(days: int = 30) -> List[Dict[str, Any]]`

Returns documents with due dates within the specified number of days.

**Parameters:**
- `days` (int, optional): Number of days ahead to check (default: 30)

**Returns:**
- List of dictionaries containing:
  - `id` (int): Document ID
  - `title` (str): Document title
  - `sender` (str): Document sender
  - `due_date` (str): Due date in ISO format
  - `amount` (float): Document amount
  - `document_type` (