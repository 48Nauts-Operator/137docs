<!--
This documentation was auto-generated by Claude on 2025-06-01T06-19-39.
Source file: ./src/backend/app/analytics.py
-->

# Analytics Service Documentation

## Overview

The `AnalyticsService` class provides comprehensive analytics functionality for the Document Management System. It supports both synchronous and asynchronous database operations, offering various metrics and insights about documents, invoices, tags, and payment statuses.

## Table of Contents

- [Class Definition](#class-definition)
- [Initialization](#initialization)
- [Core Analytics Methods](#core-analytics-methods)
- [Compatibility Methods](#compatibility-methods)
- [Usage Examples](#usage-examples)
- [Error Handling](#error-handling)

## Class Definition

```python
class AnalyticsService:
    """Service for document analytics."""
```

### Dependencies

- `sqlalchemy`: Database ORM operations
- `datetime`: Date and time manipulation
- `typing`: Type hints
- `calendar`: Calendar utilities
- `re`: Regular expression operations
- `logging`: Logging functionality

## Initialization

### `__init__(self, db: Session)`

Initializes the analytics service with a database session.

**Parameters:**
- `db` (Session): SQLAlchemy database session (supports both sync and async)

**Example:**
```python
analytics = AnalyticsService(db_session)
```

## Core Analytics Methods

### Document Distribution Analytics

#### `get_document_count_by_type(self) -> List[Dict[str, Any]]`

Returns document counts grouped by document type.

**Returns:**
- List of dictionaries containing:
  - `document_type` (str): Type of document
  - `count` (int): Number of documents of this type

**Example Response:**
```json
[
    {"document_type": "invoice", "count": 150},
    {"document_type": "receipt", "count": 89},
    {"document_type": "contract", "count": 23}
]
```

#### `get_document_count_by_status(self) -> List[Dict[str, Any]]`

Returns document counts grouped by status.

**Returns:**
- List of dictionaries containing:
  - `status` (str): Document status
  - `count` (int): Number of documents with this status

**Example Response:**
```json
[
    {"status": "paid", "count": 120},
    {"status": "unpaid", "count": 45},
    {"status": "pending", "count": 23}
]
```

### Temporal Analytics

#### `get_document_count_by_month(self, months: int = 6) -> List[Dict[str, Any]]`

Returns document counts by month for the specified time period.

**Parameters:**
- `months` (int, optional): Number of months to include. Defaults to 6.

**Returns:**
- List of dictionaries containing:
  - `year` (int): Year
  - `month` (int): Month number
  - `month_name` (str): Month name
  - `count` (int): Number of documents

**Features:**
- Supports multiple date formats (ISO and European)
- Falls back to `created_at` if `document_date` is unavailable
- Handles async and sync database operations

#### `get_invoice_amount_by_month(self, months: int = 6) -> List[Dict[str, Any]]`

Returns total invoice amounts by month for the specified time period.

**Parameters:**
- `months` (int, optional): Number of months to include. Defaults to 6.

**Returns:**
- List of dictionaries containing:
  - `year` (int): Year
  - `month` (int): Month number
  - `month_name` (str): Month name
  - `total_amount` (float): Total invoice amount
  - `count` (int): Number of invoices

### Payment Analytics

#### `get_payment_status_summary(self) -> Dict[str, Any]`

Provides comprehensive payment status analytics for invoices.

**Returns:**
Dictionary containing:
- `total_invoices` (int): Total number of invoices
- `paid_invoices` (int): Number of paid invoices
- `unpaid_invoices` (int): Number of unpaid invoices
- `overdue_invoices` (int): Number of overdue invoices
- `total_amount` (float): Total invoice amount
- `paid_amount` (float): Total paid amount
- `unpaid_amount` (float): Total unpaid amount
- `overdue_amount` (float): Total overdue amount
- `paid_percentage` (float): Percentage of paid invoices
- `unpaid_percentage` (float): Percentage of unpaid invoices
- `overdue_percentage` (float): Percentage of overdue invoices

**Example Response:**
```json
{
    "total_invoices": 200,
    "paid_invoices": 150,
    "unpaid_invoices": 50,
    "overdue_invoices": 10,
    "total_amount": 50000.0,
    "paid_amount": 37500.0,
    "unpaid_amount": 12500.0,
    "overdue_amount": 2500.0,
    "paid_percentage": 75.0,
    "unpaid_percentage": 25.0,
    "overdue_percentage": 5.0
}
```

#### `get_upcoming_due_dates(self, days: int = 30) -> List[Dict[str, Any]]`

Returns documents with upcoming due dates within the specified period.

**Parameters:**
- `days` (int, optional): Number of days ahead to check. Defaults to 30.

**Returns:**
- List of dictionaries containing:
  - `id` (int): Document ID
  - `title` (str): Document title
  - `sender` (str): Document sender
  - `due_date` (str): Due date in ISO format
  - `amount` (float): Document amount
  - `document_type` (str): Type of document
  - `days_until_due` (int): Days until due date

### Tag and Pattern Analytics

#### `get_tag_distribution(self) -> List[Dict[str, Any]]`

Returns document counts by tag, ordered by frequency.

**Returns:**
- List of dictionaries containing:
  - `name` (str): Tag name
  - `color` (str): Tag color
  - `count` (int): Number of documents