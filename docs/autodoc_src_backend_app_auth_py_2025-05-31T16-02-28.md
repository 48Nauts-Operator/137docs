<!--
This documentation was auto-generated by Claude on 2025-05-31T16-02-28.
Source file: ./src/backend/app/auth.py
-->

# Authentication Module Documentation

## Overview

The authentication module provides comprehensive authentication and authorization functionality for the Document Management System. It supports multiple authentication methods including JWT tokens and API keys, with role-based access control and secure password handling.

## Features

- **JWT Token Authentication**: Secure token-based authentication with configurable expiration
- **API Key Authentication**: Alternative authentication method using API keys
- **Password Security**: Bcrypt-based password hashing and verification
- **Role-Based Access Control**: Support for different user roles (admin, viewer)
- **Database Integration**: PostgreSQL integration with fallback support
- **Flexible Dependencies**: Optional and required authentication dependencies

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_KEY` | JWT signing secret key | Auto-generated 32-character string |

### Constants

```python
ALGORITHM = "HS256"                    # JWT signing algorithm
ACCESS_TOKEN_EXPIRE_MINUTES = 30       # Token expiration time
```

## Data Models

### Token

Represents an authentication token response.

```python
class Token(BaseModel):
    access_token: str    # JWT token string
    token_type: str      # Token type (typically "bearer")
```

### TokenData

Internal token payload data.

```python
class TokenData(BaseModel):
    username: Optional[str] = None    # Username from token payload
```

### User

Base user model for API responses.

```python
class User(BaseModel):
    id: Optional[int] = None          # User ID
    username: str                     # Username
    email: Optional[str] = None       # Email address
    full_name: Optional[str] = None   # Full display name
    role: str = "viewer"              # User role
    disabled: Optional[bool] = None   # Account status
```

### UserInDB

Extended user model including password hash.

```python
class UserInDB(User):
    hashed_password: str    # Bcrypt password hash
```

## Core Functions

### Password Management

#### `verify_password(plain_password: str, hashed_password: str) -> bool`

Verifies a plain text password against a bcrypt hash.

**Parameters:**
- `plain_password`: The plain text password to verify
- `hashed_password`: The bcrypt hash to verify against

**Returns:** `True` if password is valid, `False` otherwise

#### `get_password_hash(password: str) -> str`

Generates a bcrypt hash for a password.

**Parameters:**
- `password`: Plain text password to hash

**Returns:** Bcrypt hash string

### Database Operations

#### `get_user_db(db: AsyncSession, username: str) -> Optional[UserInDB]`

Retrieves a user from the database by username.

**Parameters:**
- `db`: Database session
- `username`: Username to lookup

**Returns:** `UserInDB` instance if found, `None` otherwise

**Behavior:**
- Queries PostgreSQL database first
- Falls back to in-memory store for testing
- Returns `None` if user not found

#### `authenticate_user(db: AsyncSession, username: str, password: str) -> Optional[UserInDB]`

Authenticates a user with username and password.

**Parameters:**
- `db`: Database session
- `username`: Username to authenticate
- `password`: Plain text password

**Returns:** `UserInDB` instance if authentication successful, `None` otherwise

### Token Management

#### `create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str`

Creates a JWT access token.

**Parameters:**
- `data`: Token payload data
- `expires_delta`: Optional custom expiration time

**Returns:** JWT token string

**Default Behavior:**
- Uses 15-minute expiration if no `expires_delta` provided
- Includes `exp` claim with expiration timestamp
- Signs with configured `SECRET_KEY`

## Authentication Dependencies

### `get_current_user(token, api_key, db) -> User`

Primary authentication dependency that supports both JWT tokens and API keys.

**Parameters:**
- `token`: JWT token from OAuth2 scheme
- `api_key`: API key from X-API-Key header
- `db`: Database session

**Returns:** Authenticated `User` instance

**Raises:** `HTTPException` (401) if authentication fails

**Authentication Flow:**
1. Check for valid API key first
2. Fall back to JWT token validation
3. Lookup user in database
4. Return user data

### `get_current_active_user(current_user: User) -> User`

Ensures the authenticated user is active (not disabled).

**Parameters:**
- `current_user`: User from `get_current_user`

**Returns:** Active `User` instance

**Raises:** `HTTPException` (400) if user is disabled

### `get_current_user_optional(token, api_key, db) -> User | None`

Optional authentication dependency that returns `None` instead of raising exceptions.

**Parameters:**
- `token`: JWT token from OAuth2 scheme
- `api_key`: API key from X-API-Key header  
- `db`: Database session

**Returns:** `User` instance if authenticated, `None` otherwise

**Use Cases:**
- Routes that allow anonymous access
- Optional authentication scenarios
- Public endpoints with enhanced features for authenticated users

### `verify_api_key(api_key: str) -> str`

Validates an API key.

**Parameters:**
- `api_key`: API key from header

**Returns:** Username associated with API key

**Raises:** `HTTPException` (401) if API key is invalid

### `get_auth(api_key, token)`

Flexible authentication dependency supporting either API key or JWT token.

**Parameters:**
- `api_key`: API key from header
- `token`: JWT token

**Returns:** Authenticated user information

**Behavior:**
- Tries API key authentication first
- Falls back to JWT token authentication
- Raises exception if both methods fail

## Security Features

### Password Security
- Uses bcrypt hashing algorithm
- Automatic salt generation
- Configurable complexity through passlib

### JWT Security
- HS256 algorithm for token signing
- Configurable expiration times
- Secure secret key generation
- Token payload validation

### API Key Security
- Header-based API key transmission
- Key-to-user mapping
- Centralized validation