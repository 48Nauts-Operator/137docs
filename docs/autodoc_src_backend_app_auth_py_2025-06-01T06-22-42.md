<!--
This documentation was auto-generated by Claude on 2025-06-01T06-22-42.
Source file: ./src/backend/app/auth.py
-->

# Authentication Module Documentation

## Overview

The authentication module provides comprehensive authentication and authorization functionality for the Document Management System. It supports both JWT token-based authentication and API key authentication, with role-based access control and secure password handling.

## Features

- **JWT Token Authentication**: Secure token-based authentication with configurable expiration
- **API Key Authentication**: Alternative authentication method using API keys
- **Password Security**: BCrypt-based password hashing and verification
- **Role-Based Access Control**: Support for different user roles (admin, viewer, etc.)
- **Database Integration**: Seamless integration with PostgreSQL database
- **Fallback Support**: In-memory fallback for testing environments

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_KEY` | JWT signing key | Auto-generated 32-character string |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | JWT token expiration time | 30 minutes |

### Constants

```python
ALGORITHM = "HS256"  # JWT signing algorithm
ACCESS_TOKEN_EXPIRE_MINUTES = 30
```

## Data Models

### Token

Represents an authentication token response.

```python
class Token(BaseModel):
    access_token: str
    token_type: str
```

### TokenData

Internal token payload data.

```python
class TokenData(BaseModel):
    username: Optional[str] = None
```

### User

Base user model for API responses.

```python
class User(BaseModel):
    id: Optional[int] = None
    username: str
    email: Optional[str] = None
    full_name: Optional[str] = None
    role: str = "viewer"
    disabled: Optional[bool] = None
```

### UserInDB

Extended user model including password hash for database operations.

```python
class UserInDB(User):
    hashed_password: str
```

## Core Functions

### Password Management

#### `verify_password(plain_password: str, hashed_password: str) -> bool`

Verifies a plain text password against a hashed password.

**Parameters:**
- `plain_password`: The plain text password to verify
- `hashed_password`: The hashed password to compare against

**Returns:** `True` if password matches, `False` otherwise

#### `get_password_hash(password: str) -> str`

Generates a secure hash for a password.

**Parameters:**
- `password`: Plain text password to hash

**Returns:** BCrypt hashed password string

### Database Operations

#### `get_user_db(db: AsyncSession, username: str) -> Optional[UserInDB]`

Retrieves a user from the database by username.

**Parameters:**
- `db`: Database session
- `username`: Username to search for

**Returns:** `UserInDB` instance if found, `None` otherwise

**Note:** Falls back to in-memory fake database for testing when user not found in PostgreSQL.

#### `authenticate_user(db: AsyncSession, username: str, password: str) -> Optional[UserInDB]`

Authenticates a user with username and password.

**Parameters:**
- `db`: Database session
- `username`: Username for authentication
- `password`: Plain text password

**Returns:** `UserInDB` instance if authentication successful, `None` otherwise

### Token Management

#### `create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str`

Creates a JWT access token.

**Parameters:**
- `data`: Token payload data
- `expires_delta`: Optional custom expiration time

**Returns:** Encoded JWT token string

**Default Expiration:** 15 minutes if no custom expiration provided

## Dependency Functions

### `get_current_user()`

**Dependencies:**
- `token`: OAuth2 bearer token
- `api_key`: X-API-Key header
- `db`: Database session

**Returns:** `User` instance

**Raises:** `HTTPException` (401) if authentication fails

Supports both JWT token and API key authentication methods.

### `get_current_active_user()`

**Dependencies:**
- `current_user`: Result from `get_current_user()`

**Returns:** `User` instance

**Raises:** `HTTPException` (400) if user is disabled

### `get_current_user_optional()`

**Dependencies:**
- `token`: OAuth2 bearer token
- `api_key`: X-API-Key header  
- `db`: Database session

**Returns:** `User` instance or `None`

**Note:** Does not raise exceptions - returns `None` for invalid/missing authentication

### `verify_api_key()`

**Dependencies:**
- `api_key`: X-API-Key header value

**Returns:** Username associated with the API key

**Raises:** `HTTPException` (401) if API key is invalid

### `get_auth()`

**Dependencies:**
- `api_key`: X-API-Key header
- `token`: OAuth2 bearer token

**Returns:** User information from either API key or JWT token

Attempts API key authentication first, falls back to JWT token authentication.

## Authentication Methods

### JWT Token Authentication

1. User provides username/password to `/token` endpoint
2. System validates credentials against database
3. If valid, returns JWT token with user information
4. Token must be included in `Authorization: Bearer <token>` header
5. Token expires after configured time period

### API Key Authentication

1. User includes API key in `X-API-Key` header
2. System validates key against configured API keys
3. If valid, grants access with associated user role
4. No expiration - keys remain valid until revoked

## Security Features

- **Password Hashing**: Uses BCrypt for secure password storage
- **JWT Signing**: Tokens signed with configurable secret key
- **Automatic Key Generation**: Generates secure secret key if not configured
- **Role-Based Access**: Supports multiple user roles for authorization
- **Token Expiration**: Configurable token lifetime
- **Secure Headers**: Proper HTTP security headers for authentication

## Testing Support

The module includes fallback authentication data for testing:

```python
fake_users_db = {
    "admin": {
        "username": "admin",
        "full_name": "Administrator", 
        "email": "admin@example.com",
        "role": "admin",
        "disabled": False,
    },
    "viewer": {
        "username