<!--
This documentation was auto-generated by Claude on 2025-05-31T16-06-31.
Source file: ./src/backend/app/calendar_export.py
-->

# Calendar Export Service Documentation

## Overview

The Calendar Export Service provides calendar functionality for the Document Management System, allowing users to export documents with due dates as calendar events in ICS format. This service is designed to help users track document deadlines and upcoming due dates.

## Classes

### CalendarService

Main service class for calendar export functionality.

#### Constructor

```python
def __init__(self, db: Session)
```

**Parameters:**
- `db` (Session): SQLAlchemy database session for querying documents

#### Methods

##### generate_calendar

```python
def generate_calendar(document_ids: Optional[List[int]] = None) -> Calendar
```

Generates a calendar with events for documents that have due dates.

**Parameters:**
- `document_ids` (Optional[List[int]]): Optional list of specific document IDs to include. If None, includes all documents with due dates.

**Returns:**
- `Calendar`: Calendar object containing events for the specified documents

**Behavior:**
- Queries documents with non-null due dates
- Filters by document IDs if provided
- Creates all-day events for each document
- Event names follow format: "{Document Type}: {Title}"
- Event descriptions include sender, amount (if applicable), status, and document ID

##### generate_ics_file

```python
def generate_ics_file(document_ids: Optional[List[int]] = None) -> str
```

Generates ICS file content for documents.

**Parameters:**
- `document_ids` (Optional[List[int]]): Optional list of specific document IDs to include

**Returns:**
- `str`: ICS file content as a string

##### generate_upcoming_due_dates_calendar

```python
def generate_upcoming_due_dates_calendar(days: int = 30) -> Calendar
```

Generates a calendar with events for documents with upcoming due dates within a specified timeframe.

**Parameters:**
- `days` (int): Number of days ahead to check for due dates. Default is 30 days.

**Returns:**
- `Calendar`: Calendar object with upcoming events

**Behavior:**
- Excludes documents with status 'paid'
- Orders results by due date
- Only includes documents with due dates between today and the specified number of days ahead

##### generate_upcoming_due_dates_ics

```python
def generate_upcoming_due_dates_ics(days: int = 30) -> str
```

Generates ICS file content for documents with upcoming due dates.

**Parameters:**
- `days` (int): Number of days ahead to check. Default is 30 days.

**Returns:**
- `str`: ICS file content as a string

##### get_events_for_month (Async)

```python
async def get_events_for_month(db, month: int, year: int)
```

Returns a list of events (documents with due dates) for a given month and year.

**Parameters:**
- `db`: Database session
- `month` (int): Month number (1-12)
- `year` (int): Year

**Returns:**
- `List[Dict]`: List of dictionaries containing event data with keys:
  - `id`: Document ID
  - `title`: Document sender or title
  - `due_date`: Due date
  - `status`: Document status

##### get_events_for_date (Async)

```python
async def get_events_for_date(db, date_str: str)
```

Returns events for a specific date.

**Parameters:**
- `db`: Database session
- `date_str` (str): Date in YYYY-MM-DD format

**Returns:**
- `List[Dict]`: List of dictionaries containing event data for the specified date

### CalendarExportService

```python
class CalendarExportService(CalendarService)
```

Backward-compatibility alias for `CalendarService`. This class is maintained for existing code that imports `CalendarExportService` but provides the same functionality as the parent class.

## Dependencies

- `ics`: For creating calendar and event objects
- `sqlalchemy`: For database operations
- `app.models.Document`: Document model for querying
- `logging`: For operation logging
- `datetime`: For date and time operations
- `typing`: For type hints

## Event Structure

Calendar events created by this service include:

- **Name**: "{Document Type}: {Document Title}"
- **Description**: Multi-line text containing:
  - Sender information
  - Amount (if applicable)
  - Document status
  - Document ID
- **Date**: All-day event on the document's due date

## Logging

The service uses Python's logging module to track operations:
- Log level: INFO
- Format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
- Logs the number of events generated for each calendar operation

## Usage Examples

```python
from sqlalchemy.orm import Session
from app.services.calendar_service import CalendarService

# Initialize service
db_session = Session()
calendar_service = CalendarService(db_session)

# Generate calendar for all documents
calendar = calendar_service.generate_calendar()

# Generate calendar for specific documents
specific_calendar = calendar_service.generate_calendar([1, 2, 3])

# Generate ICS file content
ics_content = calendar_service.generate_ics_file()

# Generate calendar for upcoming due dates (next 14 days)
upcoming_calendar = calendar_service.generate_upcoming_due_dates_calendar(days=14)
```

## Error Handling

- Invalid date formats in `get_events_for_date` return an empty list
- Database errors are propagated to the caller
- Logging provides visibility into operation success and event counts