<!--
This documentation was auto-generated by Claude on 2025-06-01T06-26-50.
Source file: ./src/backend/app/calendar_export.py
-->

# Calendar Export Module Documentation

## Overview

The Calendar Export module provides functionality for generating calendar files and managing calendar events for the Document Management System. It enables users to export document due dates as ICS calendar files and retrieve calendar events for specific time periods.

## Dependencies

- `ics`: Calendar and event creation
- `sqlalchemy`: Database operations
- `app.models.Document`: Document model
- `datetime`: Date and time handling
- `logging`: Application logging

## Classes

### CalendarService

The main service class for calendar export functionality.

#### Constructor

```python
def __init__(self, db: Session)
```

**Parameters:**
- `db` (Session): SQLAlchemy database session

**Description:**
Initializes the calendar service with a database session for document queries.

#### Methods

##### generate_calendar()

```python
def generate_calendar(self, document_ids: Optional[List[int]] = None) -> Calendar
```

**Parameters:**
- `document_ids` (Optional[List[int]]): List of specific document IDs to include. If None, includes all documents with due dates.

**Returns:**
- `Calendar`: ICS Calendar object containing document events

**Description:**
Generates a calendar with events for documents that have due dates. Each event includes:
- Event name: Document type and title
- Description: Sender, amount, status, and document ID
- All-day event set to the due date

**Example:**
```python
calendar_service = CalendarService(db_session)
calendar = calendar_service.generate_calendar([1, 2, 3])
```

##### generate_ics_file()

```python
def generate_ics_file(self, document_ids: Optional[List[int]] = None) -> str
```

**Parameters:**
- `document_ids` (Optional[List[int]]): List of specific document IDs to include

**Returns:**
- `str`: ICS file content as a string

**Description:**
Generates ICS file content that can be saved to a file or sent as a response for calendar import.

**Example:**
```python
ics_content = calendar_service.generate_ics_file()
with open('documents.ics', 'w') as f:
    f.write(ics_content)
```

##### generate_upcoming_due_dates_calendar()

```python
def generate_upcoming_due_dates_calendar(self, days: int = 30) -> Calendar
```

**Parameters:**
- `days` (int): Number of days ahead to check for due dates (default: 30)

**Returns:**
- `Calendar`: Calendar object with upcoming due date events

**Description:**
Generates a calendar containing only documents with due dates within the specified number of days. Excludes documents with 'paid' status and orders results by due date.

**Example:**
```python
# Get calendar for next 7 days
upcoming_calendar = calendar_service.generate_upcoming_due_dates_calendar(days=7)
```

##### generate_upcoming_due_dates_ics()

```python
def generate_upcoming_due_dates_ics(self, days: int = 30) -> str
```

**Parameters:**
- `days` (int): Number of days ahead to check (default: 30)

**Returns:**
- `str`: ICS file content for upcoming due dates

**Description:**
Generates ICS file content for documents with upcoming due dates within the specified time period.

##### get_events_for_month() (Async)

```python
async def get_events_for_month(self, db, month: int, year: int)
```

**Parameters:**
- `db`: Database session
- `month` (int): Month (1-12)
- `year` (int): Year

**Returns:**
- `List[Dict]`: List of event dictionaries containing id, title, due_date, and status

**Description:**
Asynchronous method that returns events for a specific month and year. Used by FastAPI endpoints.

**Example:**
```python
events = await calendar_service.get_events_for_month(db, 12, 2023)
```

##### get_events_for_date() (Async)

```python
async def get_events_for_date(self, db, date_str: str)
```

**Parameters:**
- `db`: Database session
- `date_str` (str): Date in YYYY-MM-DD format

**Returns:**
- `List[Dict]`: List of event dictionaries for the specified date

**Description:**
Asynchronous method that returns events for a specific date. Returns empty list if date format is invalid.

**Example:**
```python
events = await calendar_service.get_events_for_date(db, "2023-12-25")
```

### CalendarExportService

```python
class CalendarExportService(CalendarService):
    pass
```

**Description:**
Backward-compatibility alias for `CalendarService`. Maintained for existing code that imports `CalendarExportService`.

## Usage Examples

### Basic Calendar Generation

```python
from app.calendar_export import CalendarService
from sqlalchemy.orm import Session

# Initialize service
calendar_service = CalendarService(db_session)

# Generate calendar for all documents
calendar = calendar_service.generate_calendar()

# Generate calendar for specific documents
specific_calendar = calendar_service.generate_calendar([1, 2, 3])

# Get ICS file content
ics_content = calendar_service.generate_ics_file()
```

### Upcoming Due Dates

```python
# Get calendar for next 14 days
upcoming_calendar = calendar_service.generate_upcoming_due_dates_calendar(days=14)

# Get ICS content for upcoming due dates
upcoming_ics = calendar_service.generate_upcoming_due_dates_ics(days=7)
```

### FastAPI Integration

```python
# In FastAPI endpoint
@app.get("/calendar/month/{year}/{month}")
async def get_month_events(year: int, month: int, db: Session = Depends(get_db)):
    calendar_service = CalendarService(db)
    events = await calendar_service.get_events_for_month(db, month, year)
    return events
```

## Event Structure

Each calendar event contains the following information:

- **Name**: `{document_type}: {title}`
- **Description**: