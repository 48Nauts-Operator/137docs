<!--
This documentation was auto-generated by Claude on 2025-05-31T16-05-41.
Source file: ./src/backend/app/cleanup_vendor_tenants.py
-->

# Vendor Tenant Cleanup Script

## Overview

This cleanup script removes vendor companies that were incorrectly created as tenant entities. These companies should function as senders/vendors rather than recipients/tenants in the document processing system.

## Purpose

The script addresses a data integrity issue where vendor companies were mistakenly registered as tenants, causing incorrect document routing and processing. It identifies these misclassified entities and removes them while preserving document data integrity.

## Usage

```bash
python3 cleanup_vendor_tenants.py
```

## Prerequisites

- Python 3.6+
- SQLAlchemy with async support
- Access to the application database
- Required application modules in the `src` directory

## Script Components

### Main Function

#### `cleanup_vendor_tenants()`

**Purpose**: Asynchronous function that performs the complete cleanup operation.

**Process Flow**:

1. **Identification**: Searches for entities matching known vendor company names
2. **Impact Assessment**: Identifies documents affected by vendor tenant removal
3. **Document Reset**: Resets recipient fields for affected documents
4. **Entity Removal**: Removes incorrectly classified vendor tenant entities
5. **Transaction Commit**: Persists all changes to the database

### Vendor Company List

The script targets the following known vendor companies:

| Company Name | Variations |
|--------------|------------|
| Hetzner Online GmbH | Hetzner |
| Team Blockonauts | Blockonauts |
| Impact Labs | 21 Impact Labs AG |
| Chainstack Pte. | Chainstack |
| GitBook | GitBook (Company) |
| Digital Ocean | DigitalOcean |
| Candoo Labs | Candoo Labs (Company) |
| Validity Labs | Validity Labs (Company) |
| DAT AG | DAT AG (Company) |

## Database Operations

### Query Operations

- **Entity Search**: Uses case-insensitive pattern matching on `name` and `alias` fields
- **Document Impact**: Identifies documents where `recipient` field matches vendor aliases

### Modification Operations

- **Document Update**: Sets `recipient` field to `NULL` for affected documents
- **Entity Deletion**: Removes vendor tenant entities from the database

## Output Information

The script provides detailed console output including:

- 🔍 Search progress and results
- 📋 Impact analysis of affected documents
- 🔄 Document reset operations
- 🗑️ Entity removal operations
- 🎉 Completion summary with statistics

## Error Handling

- Database operations are wrapped in async session management
- Transaction rollback occurs automatically on exceptions
- Console output provides clear status indicators

## Post-Execution Steps

After successful cleanup:

1. Navigate to **Settings > Automation**
2. Execute **"Run Batch Processing"**
3. This will re-process documents with reset recipient fields

## Database Schema Dependencies

### Required Tables

- `Entity`: Stores tenant/company information
  - `id`: Primary key
  - `name`: Company name
  - `alias`: Company alias/short name

- `Document`: Stores document metadata
  - `id`: Primary key
  - `title`: Document title
  - `recipient`: Reference to entity alias

### Relationships

- `Document.recipient` → `Entity.alias` (foreign key relationship)

## Safety Features

- **Read-before-write**: Identifies and reports all changes before execution
- **Impact assessment**: Shows which documents will be affected
- **Atomic transactions**: All changes committed together or rolled back
- **Detailed logging**: Comprehensive output for audit trails

## Exit Conditions

- **Success**: All vendor tenants removed, affected documents reset
- **No Action**: If no vendor companies found in tenant list
- **Exception**: Database errors result in transaction rollback