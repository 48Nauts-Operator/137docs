<!--
This documentation was auto-generated by Claude on 2025-06-01T06-25-55.
Source file: ./src/backend/app/cleanup_vendor_tenants.py
-->

# Vendor Tenant Cleanup Script

## Overview

This cleanup script identifies and removes vendor companies that were incorrectly created as tenant entities in the system. These companies should function as senders/vendors rather than recipients/tenants. The script also resets any documents that were using these incorrect tenant entities to allow for proper re-processing.

## Purpose

- Remove incorrectly categorized vendor companies from the tenant list
- Reset affected documents to allow re-processing with correct entity relationships
- Maintain data integrity by ensuring vendors and tenants are properly classified

## Requirements

### Dependencies

- Python 3.7+
- SQLAlchemy with async support
- asyncio (built-in)
- Application modules:
  - `app.database` - Database engine configuration
  - `app.models` - Entity and Document models

### Database Models

The script expects the following model structure:

- **Entity**: Represents tenant/company entities
  - `id`: Primary key
  - `name`: Company name
  - `alias`: Company alias/identifier
- **Document**: Represents processed documents
  - `id`: Primary key
  - `title`: Document title
  - `recipient`: References entity alias

## Usage

### Command Line Execution

```bash
python3 cleanup_vendor_tenants.py
```

### Programmatic Usage

```python
import asyncio
from cleanup_vendor_tenants import cleanup_vendor_tenants

# Run the cleanup process
await cleanup_vendor_tenants()
```

## Function Reference

### `cleanup_vendor_tenants()`

**Description**: Main cleanup function that removes vendor companies incorrectly created as tenants.

**Parameters**: None

**Returns**: None

**Behavior**:
1. Searches for entities matching known vendor company names
2. Identifies documents using these entities as recipients
3. Resets affected documents' recipient fields
4. Removes vendor tenant entities from the database
5. Commits all changes in a single transaction

## Configuration

### Vendor Company List

The script includes a predefined list of known vendor companies:

```python
vendor_names = [
    "Hetzner Online GmbH", "Hetzner",
    "Team Blockonauts", "Blockonauts", 
    "Impact Labs", "21 Impact Labs AG",
    "Chainstack Pte.", "Chainstack",
    "GitBook", "GitBook (Company)",
    "Digital Ocean", "DigitalOcean",
    "Candoo Labs", "Candoo Labs (Company)",
    "Validity Labs", "Validity Labs (Company)",
    "DAT AG", "DAT AG (Company)"
]
```

To modify this list, edit the `vendor_names` array in the `cleanup_vendor_tenants()` function.

## Output Examples

### Successful Cleanup

```
üîç Searching for vendor companies incorrectly created as tenants...
Found 3 vendor companies incorrectly created as tenants:
  - ID: 15, Name: Hetzner Online GmbH, Alias: hetzner
  - ID: 23, Name: GitBook, Alias: gitbook
  - ID: 31, Name: DigitalOcean, Alias: digitalocean

üìã Found 5 documents using vendor tenants as recipients:
  - Doc ID: 101, Title: Invoice #2024-001 from Hetzner Online GmbH..., Using: hetzner
  - Doc ID: 102, Title: Service Agreement - GitBook Premium..., Using: gitbook

üîÑ Resetting recipient field for 5 documents...
  ‚úì Reset document 101
  ‚úì Reset document 102

üóëÔ∏è  Removing 3 vendor tenant entities...
  ‚úì Removed tenant: Hetzner Online GmbH (hetzner)
  ‚úì Removed tenant: GitBook (gitbook)
  ‚úì Removed tenant: DigitalOcean (digitalocean)

üéâ Cleanup completed successfully!
   - Removed 3 vendor tenant entities
   - Reset 5 document recipients for re-processing

üí° Tip: Run 'Run Batch Processing' in Settings > Automation to re-process these documents
```

### No Issues Found

```
üîç Searching for vendor companies incorrectly created as tenants...
‚úÖ No vendor companies found in tenant list - all clean!
```

## Error Handling

The script uses async database sessions with automatic transaction management. If any error occurs during the process, the database transaction will be rolled back, maintaining data consistency.

## Post-Cleanup Actions

After running the cleanup script:

1. **Re-process Documents**: Use the application's batch processing feature to re-process documents with reset recipients
2. **Verify Results**: Check that vendor companies no longer appear in tenant lists
3. **Monitor Logs**: Review application logs to ensure proper entity classification in future document processing

## Safety Considerations

- **Backup Database**: Always backup your database before running cleanup scripts
- **Test Environment**: Run the script in a test environment first
- **Review Output**: Carefully review the script output before confirming changes
- **Transaction Safety**: The script uses database transactions to ensure atomicity

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure the `src` directory structure matches the expected path
2. **Database Connection**: Verify database engine configuration in `app.database`
3. **Permission Issues**: Ensure the script has necessary database permissions for DELETE operations

### Debugging

Add logging or print statements to track script execution:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```