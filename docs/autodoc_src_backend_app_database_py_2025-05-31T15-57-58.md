<!--
This documentation was auto-generated by Claude on 2025-05-31T15-57-58.
Source file: ./src/backend/app/database.py
-->

# Database Module Documentation

## Overview

This module provides database connection and session management functionality for the Document Management System. It handles asynchronous SQLAlchemy operations with support for both PostgreSQL and SQLite databases.

## Module: `app.database`

### Dependencies

- `sqlalchemy.ext.asyncio`: Async SQLAlchemy components
- `sqlalchemy.orm`: ORM functionality
- `app.config`: Application configuration settings

### Configuration

The module automatically resolves the database URL using the following priority:

1. **Explicit DATABASE_URL**: Uses `settings.DATABASE_URL` if available
2. **SQLite Fallback**: Constructs SQLite URL using `settings.DATABASE_PATH`

## Components

### Database Engine

#### `async_engine`
```python
async_engine: AsyncEngine
```

**Description**: Primary asynchronous database engine with connection pooling.

**Configuration**:
- **URL**: Resolved from configuration
- **pool_pre_ping**: `True` - Validates connections before use

#### `engine`
```python
engine: AsyncEngine
```

**Description**: Legacy alias for `async_engine` to maintain backward compatibility.

### Session Management

#### `async_session`
```python
async_session: sessionmaker[AsyncSession]
```

**Description**: Session factory for creating database sessions.

**Configuration**:
- **Engine**: Uses `async_engine`
- **Class**: `AsyncSession`
- **expire_on_commit**: `False` - Prevents automatic expiration of objects after commit

### Database Base

#### `Base`
```python
Base: DeclarativeMeta
```

**Description**: Declarative base class for SQLAlchemy models. All database models should inherit from this base.

**Usage**:
```python
from app.database import Base

class MyModel(Base):
    __tablename__ = 'my_table'
    # ... model definition
```

## Dependencies

### `get_db()`

```python
async def get_db() -> AsyncGenerator[AsyncSession, None]
```

**Description**: FastAPI dependency function that provides database sessions with automatic cleanup.

**Behavior**:
- Creates a new async session
- Yields the session for use in route handlers
- Automatically closes the session after request completion
- Handles cleanup even if exceptions occur

**Usage in FastAPI**:
```python
from fastapi import Depends
from app.database import get_db

@app.get("/items/")
async def get_items(db: AsyncSession = Depends(get_db)):
    # Use db session here
    result = await db.execute(select(Item))
    return result.scalars().all()
```

## Database URL Resolution

The module supports flexible database configuration:

### PostgreSQL/MySQL
```bash
DATABASE_URL=postgresql+asyncpg://user:password@localhost/dbname
```

### SQLite (Fallback)
```bash
DATABASE_PATH=/path/to/database.db
```

**Note**: When using SQLite, the URL is automatically constructed as:
```
sqlite+aiosqlite:///[DATABASE_PATH]
```

## Best Practices

### Session Usage
- Always use `get_db()` dependency in FastAPI routes
- Never create sessions manually in route handlers
- Rely on automatic session cleanup

### Connection Management
- The engine handles connection pooling automatically
- `pool_pre_ping=True` ensures connection health
- Sessions are properly closed after each request

### Model Definition
- All models must inherit from `Base`
- Define `__tablename__` for each model
- Use async query methods with the provided sessions

## Example Usage

### Route Handler
```python
from fastapi import Depends
from sqlalchemy import select
from app.database import get_db

@router.get("/documents/")
async def list_documents(db: AsyncSession = Depends(get_db)):
    stmt = select(Document)
    result = await db.execute(stmt)
    return result.scalars().all()
```

### Model Definition
```python
from sqlalchemy import Column, Integer, String
from app.database import Base

class Document(Base):
    __tablename__ = 'documents'
    
    id = Column(Integer, primary_key=True)
    title = Column(String(255), nullable=False)
```

## Error Handling

The `get_db()` function includes automatic error handling:
- Sessions are closed in a `finally` block
- Exceptions in route handlers don't prevent cleanup
- Connection issues are handled by the engine's retry logic