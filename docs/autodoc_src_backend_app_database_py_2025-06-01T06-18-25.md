<!--
This documentation was auto-generated by Claude on 2025-06-01T06-18-25.
Source file: ./src/backend/app/database.py
-->

# Database Module Documentation

## Overview

This module provides database connection and session management functionality for the Document Management System. It handles asynchronous database operations using SQLAlchemy's async capabilities with support for both PostgreSQL/MySQL (via `DATABASE_URL`) and SQLite (via local file) backends.

## Dependencies

- `sqlalchemy.ext.asyncio` - Async SQLAlchemy components
- `sqlalchemy.orm` - ORM session management and base classes
- `app.config.settings` - Application configuration settings

## Configuration

The module automatically configures the database connection based on available settings:

| Setting | Type | Description |
|---------|------|-------------|
| `settings.DATABASE_URL` | str (optional) | Full database URL for PostgreSQL/MySQL connections |
| `settings.DATABASE_PATH` | str | Local file path for SQLite database (fallback) |

### Database URL Resolution

```python
if settings.DATABASE_URL:
    ASYNC_DATABASE_URL = settings.DATABASE_URL
else:
    ASYNC_DATABASE_URL = f"sqlite+aiosqlite:///{settings.DATABASE_PATH}"
```

The module prioritizes explicit `DATABASE_URL` configuration but gracefully falls back to a local SQLite database using the `DATABASE_PATH` setting.

## Components

### Engine Configuration

```python
async_engine = create_async_engine(ASYNC_DATABASE_URL, pool_pre_ping=True)
```

**Features:**
- Asynchronous database engine using SQLAlchemy's async capabilities
- Connection pool pre-ping enabled for connection health checks
- Legacy alias `engine` provided for backward compatibility

**Parameters:**
- `pool_pre_ping=True` - Enables automatic connection validation before use

### Session Factory

```python
async_session = sessionmaker(
    async_engine, 
    class_=AsyncSession, 
    expire_on_commit=False
)
```

**Configuration:**
- `class_=AsyncSession` - Uses async session class
- `expire_on_commit=False` - Prevents automatic expiration of objects after commit

### Base Model Class

```python
Base = declarative_base()
```

Provides the declarative base class for all ORM models in the application.

## Functions

### get_db()

```python
async def get_db() -> AsyncSession
```

**Purpose:** FastAPI dependency function that provides database session management.

**Behavior:**
- Creates a new async database session
- Yields the session for use in route handlers
- Automatically closes the session after use (cleanup guaranteed)

**Usage Example:**
```python
from fastapi import Depends
from app.database import get_db

@app.get("/users/")
async def get_users(db: AsyncSession = Depends(get_db)):
    # Use db session here
    result = await db.execute(select(User))
    return result.scalars().all()
```

**Error Handling:**
- Uses try/finally block to ensure session cleanup
- Session is closed even if exceptions occur during request processing

## Usage Patterns

### Model Definition

```python
from app.database import Base

class User(Base):
    __tablename__ = "users"
    # model fields here
```

### Direct Session Usage

```python
from app.database import async_session

async def some_function():
    async with async_session() as session:
        # database operations
        await session.commit()
```

### FastAPI Integration

```python
from fastapi import Depends
from app.database import get_db

@app.post("/items/")
async def create_item(item: ItemCreate, db: AsyncSession = Depends(get_db)):
    # database operations using db session
    pass
```

## Notes

- All database operations should use async/await syntax
- The module supports connection pooling and automatic connection health checks
- Session management follows the async context manager pattern
- Legacy `engine` alias maintains backward compatibility with existing code