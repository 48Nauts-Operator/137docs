<!--
This documentation was auto-generated by Claude on 2025-05-31T16-03-55.
Source file: ./src/backend/app/embeddings.py
-->

# Embedding Service Module

## Overview

This module provides text embedding functionality using the Ollama API with a deterministic fallback mechanism for offline development. It generates 1536-dimensional float vectors suitable for use with pgvector databases.

## Dependencies

```python
import hashlib, math, os, json, logging, httpx
from typing import List
from app.config import settings
```

## Configuration

| Variable | Default Value | Description |
|----------|---------------|-------------|
| `OLLAMA_BASE_URL` | `http://host.docker.internal:11434` | Base URL for the Ollama API service |

## Functions

### `get_embedding(text: str, model: str = "nomic-embed-text") -> List[float]`

Generates a 1536-dimensional embedding vector for the provided text using the Ollama embeddings API.

#### Parameters

- **text** (`str`): The input text to generate embeddings for
- **model** (`str`, optional): The embedding model to use. Defaults to `"nomic-embed-text"`

#### Returns

- **`List[float]`**: A list of 1536 floating-point values representing the text embedding

#### Behavior

1. **Primary Operation**: Makes an HTTP POST request to the Ollama embeddings endpoint
   - Endpoint: `{OLLAMA_BASE}/api/embeddings`
   - Timeout: 10 seconds
   - Payload: `{"model": model, "prompt": text}`

2. **Fallback Mechanism**: If the API call fails for any reason:
   - Logs a warning message with the error details
   - Generates a deterministic pseudo-random embedding using SHA-256 hash
   - Ensures identical input text always produces the same fallback vector

3. **Output Processing**: 
   - Truncates API response to exactly 1536 dimensions for pgvector compatibility
   - Scales fallback values to range [-1.0, 1.0]

#### Example Usage

```python
# Basic usage with default model
embedding = await get_embedding("Hello, world!")

# Using a specific model
embedding = await get_embedding("Sample text", model="custom-embed-model")
```

#### Error Handling

The function implements graceful degradation:
- Network connectivity issues
- API endpoint unavailability  
- Invalid responses
- Timeout errors

All exceptions are caught and logged, with the system falling back to hash-based embeddings to maintain pipeline functionality.

#### Fallback Algorithm

When the API is unavailable, the fallback mechanism:

1. Computes SHA-256 hash of the input text
2. Repeats the hash bytes to reach the required 1536 dimensions
3. Scales each byte value from [0, 255] to [-1.0, 1.0] using the formula: `(value/128.0) - 1.0`

This ensures consistent, deterministic embeddings for development and testing scenarios.

## Logging

The module uses Python's standard logging framework with logger name `__name__`. Warning-level messages are logged when the embedding endpoint fails and fallback mode is activated.