<!--
This documentation was auto-generated by Claude on 2025-06-01T06-24-55.
Source file: ./src/backend/app/notifications.py
-->

# app.notifications

A modular asynchronous notification framework for 137docs that provides flexible notification delivery through configurable channels.

## Overview

This module implements a backend-only notification system with the following key features:

- **Modular Channel Architecture**: Support for multiple notification channels (in-app, email, Slack, SMS) through a common interface
- **Asynchronous Design**: Pure SQLAlchemy async implementation with no blocking database calls
- **Extensible Framework**: New channels can be added without modifying core logic
- **Built-in Persistence**: All notifications are automatically recorded in the database
- **Document Monitoring**: Automated checking for overdue and upcoming due dates

## Classes

### NotificationChannel (Abstract Base Class)

Abstract interface for implementing notification delivery channels.

#### Methods

##### `send(notification: Notification, db: AsyncSession) -> None`

**Abstract method** - Deliver a notification via this channel.

**Parameters:**
- `notification` (Notification): The notification object to deliver
- `db` (AsyncSession): Database session for additional queries if needed

**Returns:** None

---

### InAppChannel

Default implementation of `NotificationChannel` that stores notifications only in the database without external delivery.

#### Methods

##### `send(notification: Notification, db: AsyncSession) -> None`

No-op implementation since notifications are already persisted to the database.

**Parameters:**
- `notification` (Notification): The notification object
- `db` (AsyncSession): Database session (unused)

**Returns:** None

---

### NotificationService

Stateless service class providing high-level notification management APIs.

#### Constructor

```python
NotificationService(channels: Optional[Sequence[NotificationChannel]] = None)
```

**Parameters:**
- `channels` (Optional[Sequence[NotificationChannel]]): List of notification channels. If None, only InAppChannel is used.

**Note:** `InAppChannel` is automatically added to ensure database persistence.

#### Methods

##### `create_notification(db: AsyncSession, title: str, message: str, notification_type: str, document_id: Optional[int] = None) -> dict`

Create and persist a new notification, then dispatch it to all configured channels.

**Parameters:**
- `db` (AsyncSession): Database session
- `title` (str): Notification title
- `message` (str): Notification message content
- `notification_type` (str): Type/category of notification
- `document_id` (Optional[int]): Associated document ID, if applicable

**Returns:** `dict` - Serialized notification object

**Example:**
```python
service = NotificationService()
notification = await service.create_notification(
    db=session,
    title="Payment Overdue",
    message="Invoice #123 is 5 days overdue",
    notification_type="overdue",
    document_id=123
)
```

##### `get_all_notifications(db: AsyncSession, limit: int = 100, offset: int = 0, include_read: bool = False) -> List[dict]`

Retrieve notifications with pagination and filtering options.

**Parameters:**
- `db` (AsyncSession): Database session
- `limit` (int, default=100): Maximum number of notifications to return
- `offset` (int, default=0): Number of notifications to skip
- `include_read` (bool, default=False): Whether to include read notifications

**Returns:** `List[dict]` - List of serialized notification objects

##### `mark_as_read(db: AsyncSession, notification_id: int) -> Optional[dict]`

Mark a specific notification as read.

**Parameters:**
- `db` (AsyncSession): Database session
- `notification_id` (int): ID of the notification to mark as read

**Returns:** `Optional[dict]` - Updated notification object, or None if not found

##### `mark_all_as_read(db: AsyncSession) -> int`

Mark all unread notifications as read.

**Parameters:**
- `db` (AsyncSession): Database session

**Returns:** `int` - Number of notifications marked as read

##### `check_overdue_documents(db: AsyncSession) -> List[Notification]`

Scan for overdue documents and create notifications for any that don't already have unread overdue notifications.

**Parameters:**
- `db` (AsyncSession): Database session

**Returns:** `List[Notification]` - List of newly created overdue notifications

**Behavior:**
- Only processes documents with status != "paid" and non-empty due_date
- Skips documents that already have unread overdue notifications
- Calculates days overdue and includes in notification message

##### `check_upcoming_due_dates(db: AsyncSession, days_ahead: int = 7) -> List[Notification]`

Scan for documents with upcoming due dates and create reminder notifications.

**Parameters:**
- `db` (AsyncSession): Database session
- `days_ahead` (int, default=7): Number of days ahead to check for due dates

**Returns:** `List[Notification]` - List of newly created reminder notifications

**Behavior:**
- Only processes documents with status != "paid" and non-empty due_date
- Skips documents that already have unread reminder notifications
- Creates notifications for documents due within the specified timeframe

##### `create_due_date_notification(db: AsyncSession, document: Document) -> Optional[dict]`

Create a due date notification for a specific document.

**Parameters:**
- `db` (AsyncSession): Database session
- `document` (Document): Document object to create notification for

**Returns:** `Optional[dict]` - Created notification object, or None if document has no due date

## Utility Functions

### `_notification_to_dict(notif: Notification) -> dict[str, object]`

**Internal function** - Convert a Notification model instance to a JSON-serializable dictionary.

**Parameters:**
- `notif` (Notification): Notification model instance

**Returns:** `dict[str, object]` - Serialized notification data

**Output Format:**
```python
{
    "id": int,
    "title": str,
    "message": str,
    "type": str,
    "document_id": Optional[int],
    "is_read": bool,
    "created_at": Optional[str]  # ISO format
}
```

## Usage Examples

### Basic Setup

```python
from app.notifications import NotificationService

# Use default in-