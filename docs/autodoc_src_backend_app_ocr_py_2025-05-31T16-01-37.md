<!--
This documentation was auto-generated by Claude on 2025-05-31T16-01-37.
Source file: ./src/backend/app/ocr.py
-->

# OCR and Document Processing Module

## Overview

The OCR and Document Processing module provides asynchronous text extraction capabilities for the Document Management System. This module is designed to efficiently process various document formats including PDFs, images, and text files while minimizing memory overhead and avoiding common stability issues associated with external libraries.

## Features

- **Asynchronous Processing**: All document processing operations are non-blocking
- **Multi-format Support**: Handles PDF, image (JPG, PNG, TIFF), and text files
- **Intelligent PDF Processing**: Uses a two-pass approach to optimize performance and stability
- **Lazy Loading**: Heavy libraries are imported only when needed to reduce startup costs
- **Error Handling**: Comprehensive error handling with detailed logging

## Architecture

### Lazy Import System

The module implements a lazy import system to minimize memory overhead:

```python
def _lazy_import(module_name: str)
```

**Purpose**: Imports modules only when first needed and caches them for reuse.

**Parameters**:
- `module_name` (str): Name of the module to import

**Returns**: The imported module

### OCRProcessor Class

The main class responsible for document processing operations.

## API Reference

### OCRProcessor.process_document()

```python
async def process_document(self, file_path: str) -> str
```

**Description**: Main entry point for document processing. Automatically detects file type and routes to appropriate processing method.

**Parameters**:
- `file_path` (str): Path to the document file to process

**Returns**: 
- `str`: Extracted text content from the document

**Supported File Types**:
- PDF: `.pdf`
- Images: `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`
- Text: `.txt`

**Example Usage**:
```python
processor = OCRProcessor()
text = await processor.process_document("/path/to/document.pdf")
```

### Private Methods

#### _process_pdf()

```python
async def _process_pdf(self, file_path: str) -> str
```

**Description**: Processes PDF files using a two-pass approach for optimal performance and stability.

**Processing Strategy**:
1. **Pass 1**: Extract embedded text using `pdfplumber` (pure Python, stable)
2. **Pass 2**: Apply OCR only to pages without extractable text using `PyMuPDF`

**Benefits**:
- Avoids segmentation faults from external poppler libraries
- Minimizes expensive OCR operations
- Maintains high text quality from digital PDFs

#### _process_image()

```python
async def _process_image(self, file_path: str) -> str
```

**Description**: Processes image files using Tesseract OCR.

**Parameters**:
- `file_path` (str): Path to the image file

**Returns**: 
- `str`: Extracted text from the image

**OCR Configuration**:
- Language: English (`eng`)
- Processing: Asynchronous using thread pool

#### _process_text()

```python
async def _process_text(self, file_path: str) -> str
```

**Description**: Reads and returns content from plain text files.

**Parameters**:
- `file_path` (str): Path to the text file

**Returns**: 
- `str`: File content

## Dependencies

### Required Libraries

- `pytesseract`: OCR engine interface
- `PIL` (Pillow): Image processing
- `pdfplumber`: PDF text extraction (pure Python)
- `fitz` (PyMuPDF): PDF rendering and manipulation

### System Requirements

- Tesseract OCR engine must be installed on the system
- Python 3.7+ (for asyncio support)

## Error Handling

The module implements comprehensive error handling:

- **File Type Errors**: Unsupported file types return descriptive error messages
- **Processing Errors**: Exceptions are caught and logged with detailed error information
- **Fallback Mechanisms**: PDF processing falls back to OCR when text extraction fails

## Logging

The module uses Python's built-in logging system:

```python
logger = logging.getLogger(__name__)
```

**Log Levels Used**:
- `INFO`: Processing status and progress updates
- `WARNING`: Non-critical issues (unsupported file types, fallback scenarios)
- `ERROR`: Processing failures and exceptions

## Performance Considerations

1. **Memory Efficiency**: Lazy imports prevent unnecessary memory usage
2. **Processing Optimization**: PDF text extraction is prioritized over OCR
3. **Async Operations**: All I/O operations are non-blocking
4. **Selective OCR**: Only pages without embedded text undergo OCR processing

## Usage Examples

### Basic Document Processing

```python
import asyncio
from ocr_module import OCRProcessor

async def main():
    processor = OCRProcessor()
    
    # Process a PDF
    pdf_text = await processor.process_document("document.pdf")
    
    # Process an image
    image_text = await processor.process_document("scan.png")
    
    # Process a text file
    text_content = await processor.process_document("notes.txt")

asyncio.run(main())
```

### Batch Processing

```python
async def process_multiple_documents(file_paths):
    processor = OCRProcessor()
    tasks = [processor.process_document(path) for path in file_paths]
    results = await asyncio.gather(*tasks)
    return results
```

## Best Practices

1. **Error Handling**: Always handle potential exceptions when calling document processing methods
2. **File Validation**: Verify file existence and permissions before processing
3. **Memory Management**: For large batch operations, consider processing documents in chunks
4. **Logging Configuration**: Configure appropriate log levels for production environments