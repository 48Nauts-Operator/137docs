<!--
This documentation was auto-generated by Claude on 2025-05-31T15-58-21.
Source file: ./src/backend/app/rule_engine.py
-->

# Rule Engine Documentation

## Overview

The Rule Engine module provides automated document processing and classification functionality. It evaluates processing rules against documents and executes actions when rules match, enabling dynamic document workflow automation.

## Module Structure

```python
from app.rule_engine import RuleEvaluator, RuleActionExecutor, DocumentRuleProcessor
```

## Classes

### RuleEvaluator

Evaluates processing rules against documents to determine which actions should be executed.

#### Constructor

```python
RuleEvaluator()
```

Creates a new rule evaluator instance with an initialized `ProcessingRuleRepository`.

#### Methods

##### `evaluate_document(db, document)`

Evaluates all enabled rules against a document and returns matching actions.

**Parameters:**
- `db` (AsyncSession): Database session
- `document` (Document): Document to evaluate

**Returns:**
- `List[Dict[str, Any]]`: List of actions to execute

**Example:**
```python
evaluator = RuleEvaluator()
actions = await evaluator.evaluate_document(db_session, document)
```

##### `_evaluate_rule(document, rule)` (Private)

Evaluates a single rule against a document using Boolean AND logic for all conditions.

**Parameters:**
- `document` (Document): Document to evaluate
- `rule` (Dict[str, Any]): Rule configuration

**Returns:**
- `bool`: True if rule matches, False otherwise

##### `_matches_vendor(document_sender, rule_vendor)` (Private)

Performs case-insensitive partial matching between document sender and rule vendor.

**Parameters:**
- `document_sender` (str): Document sender field
- `rule_vendor` (str): Rule vendor constraint

**Returns:**
- `bool`: True if vendor matches

##### `_evaluate_condition(document, condition)` (Private)

Evaluates a single condition against a document using various operators.

**Supported Operators:**
- `equals`: Exact match
- `contains`: Substring match
- `starts_with`: Prefix match
- `ends_with`: Suffix match
- `not_equals`: Negated exact match
- `not_contains`: Negated substring match

**Parameters:**
- `document` (Document): Document to evaluate
- `condition` (Dict[str, Any]): Condition configuration

**Returns:**
- `bool`: True if condition matches

##### `_get_document_field_value(document, field)` (Private)

Extracts field values from document objects.

**Supported Fields:**
- `title`: Document title
- `content`/`text`: Document content
- `sender`: Document sender
- `recipient`: Document recipient
- `document_type`: Document type
- `category`: Document category
- `amount`: Document amount
- `currency`: Document currency
- `status`: Document status
- `filename`: Original file name
- `file_path`: File storage path

---

### RuleActionExecutor

Executes actions on documents when rules match.

#### Methods

##### `execute_actions(db, document, actions)`

Executes a list of actions on a document with error handling and result tracking.

**Parameters:**
- `db` (AsyncSession): Database session
- `document` (Document): Document to modify
- `actions` (List[Dict[str, Any]]): Actions to execute

**Returns:**
- `Dict[str, Any]`: Execution summary with format:
  ```python
  {
      'executed': List[Dict],    # Successfully executed actions
      'failed': List[Dict],      # Failed actions with errors
      'total': int              # Total number of actions
  }
  ```

##### `_execute_action(db, document, action)` (Private)

Executes a single action on a document.

**Supported Action Types:**
- `assign_tenant`: Assigns document to a tenant
- `set_category`: Sets document category
- `add_tag`: Adds a tag to the document
- `set_status`: Sets document status
- `set_document_type`: Sets document type

**Parameters:**
- `db` (AsyncSession): Database session
- `document` (Document): Document to modify
- `action` (Dict[str, Any]): Action configuration

**Returns:**
- `bool`: True if action executed successfully

---

### DocumentRuleProcessor

Main orchestration class that combines rule evaluation and action execution.

#### Constructor

```python
DocumentRuleProcessor()
```

Creates a processor with initialized `RuleEvaluator` and `RuleActionExecutor` instances.

#### Methods

##### `process_document(db, document)`

Processes a document through the complete rule engine pipeline.

**Parameters:**
- `db` (AsyncSession): Database session
- `document` (Document): Document to process

**Returns:**
- `Dict[str, Any]`: Processing results with format:
  ```python
  {
      'document_id': int,           # Document ID
      'rules_matched': int,         # Number of unique rules matched
      'actions_executed': int,      # Number of successful actions
      'actions_failed': int,        # Number of failed actions
      'results': Dict,             # Detailed execution results
      'error': str                 # Error message (if applicable)
  }
  ```

**Example:**
```python
processor = DocumentRuleProcessor()
result = await processor.process_document(db_session, document)

print(f"Processed document {result['document_id']}")
print(f"Rules matched: {result['rules_matched']}")
print(f"Actions executed: {result['actions_executed']}")
```

## Usage Examples

### Basic Document Processing

```python
from app.rule_engine import DocumentRuleProcessor
from app.models import Document

async def process_uploaded_document(db_session, document_id):
    # Get document from database
    document = await get_document_by_id(db_session, document_id)
    
    # Process through rule engine
    processor = DocumentRuleProcessor()
    result = await processor.process_document(db_session, document)
    
    if result.get('error'):
        print(f"Error processing document: {result['error']}")
    else:
        print(f"Successfully processed document with {result['actions_executed']} actions")
    
    return result
```

### Custom Rule Evaluation

```python
from app.rule_engine import RuleEvaluator