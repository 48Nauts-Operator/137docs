<!--
This documentation was auto-generated by Claude on 2025-05-31T16-00-06.
Source file: ./src/backend/app/scheduler.py
-->

# app.scheduler

## Overview

A lightweight background task scheduler that periodically scans invoices and creates reminder notifications before due dates. This module provides a simple alternative to heavyweight task queue systems like Celery or APScheduler by using asyncio tasks with sleep-based scheduling.

## Key Features

- **Periodic Invoice Scanning**: Automatically checks for upcoming invoice due dates
- **Reminder Notifications**: Creates notifications 3 days before invoice due dates
- **Lightweight Implementation**: Uses asyncio instead of external task queue dependencies
- **Startup Safety**: Performs immediate scan on startup and prevents duplicate tasks
- **Error Resilience**: Continues operation even if individual scan cycles fail

## Configuration

### Constants

| Constant | Default Value | Description |
|----------|---------------|-------------|
| `DAYS_BEFORE_DUE` | `3` | Number of days before due date when reminders are created |
| `SCAN_HOUR_UTC` | `2` | UTC hour (24-hour format) when daily scans are performed |

## Functions

### `scheduler_loop()`

```python
async def scheduler_loop() -> None
```

**Purpose**: Main background coroutine that runs continuously with a 24-hour cycle.

**Behavior**:
- Performs an immediate scan on startup
- Calculates sleep duration until next scheduled scan time
- Runs daily at the configured UTC hour
- Handles exceptions gracefully to maintain continuous operation

**Usage**: Called internally by `start_scheduler()` - not intended for direct use.

---

### `start_scheduler()`

```python
def start_scheduler() -> None
```

**Purpose**: Spawns the background scheduler task safely.

**Features**:
- **Idempotent**: Safe to call multiple times
- **Duplicate Prevention**: Checks for existing scheduler tasks before creating new ones
- **Hot-reload Safe**: Prevents multiple scheduler instances during development

**Usage**:
```python
# Typically called during application startup
start_scheduler()
```

---

### `_run_once()` *(Internal)*

```python
async def _run_once() -> None
```

**Purpose**: Executes a single scan cycle to create missing reminder notifications.

**Process**:
1. Opens database session
2. Calls `NotificationService.check_upcoming_due_dates()`
3. Commits changes to database
4. Logs results (info level for created notifications, debug level for no results)

## Dependencies

- **Database**: `app.database.async_session` for database operations
- **Notifications**: `app.notifications.NotificationService` for creating reminders
- **Standard Library**: `asyncio`, `datetime`, `logging`

## Integration

### Startup Integration

The scheduler is designed to be started during application initialization:

```python
# In main.startup()
from app.scheduler import start_scheduler

async def startup():
    # ... other startup tasks
    start_scheduler()
```

### Database Session Management

The scheduler uses async database sessions and properly commits transactions after creating notifications.

## Logging

The module uses structured logging with different levels:

- **INFO**: Reports successful notification creation with counts
- **DEBUG**: Reports scheduling details and empty scan results  
- **ERROR**: Logs exceptions during scan execution (via `logger.exception()`)

## Error Handling

The scheduler implements resilient error handling:
- Individual scan failures are logged but don't terminate the scheduler
- The infinite loop continues even after exceptions
- Database sessions are properly managed with async context managers

## Architecture Notes

### Lightweight Design Philosophy

This implementation deliberately avoids external task queue dependencies to:
- Reduce system complexity
- Minimize resource overhead
- Simplify deployment and configuration
- Maintain direct control over scheduling logic

### Service Instance Management  

Uses a dedicated `NotificationService` instance (`_service`) to avoid import cycles with the main application module.