<!--
This documentation was auto-generated by Claude on 2025-06-01T06-20-27.
Source file: ./src/backend/app/scheduler.py
-->

# app.scheduler

## Overview

The `app.scheduler` module provides a lightweight background task scheduler for invoice reminder notifications. It periodically scans invoices and creates reminder notifications three days before their due dates.

This implementation uses asyncio tasks instead of heavyweight dependencies like Celery or APScheduler, making it suitable for containerized deployments with minimal overhead.

## Features

- **Lightweight Design**: Uses asyncio for background processing without external dependencies
- **Daily Scanning**: Runs at a configurable UTC hour (default: 02:00)
- **Immediate Startup**: Performs an initial scan on startup for immediate system readiness
- **Error Handling**: Includes exception handling and logging for monitoring
- **Hot-reload Safe**: Prevents duplicate tasks during development

## Configuration

### Constants

| Constant | Default Value | Description |
|----------|---------------|-------------|
| `DAYS_BEFORE_DUE` | `3` | Number of days before due date when reminder notifications are created |
| `SCAN_HOUR_UTC` | `2` | UTC hour when the daily scan runs (02:00 UTC) |

## API Reference

### Functions

#### `start_scheduler()`

Spawns the background scheduler task. Safe to call multiple times as it prevents duplicate tasks.

**Usage:**
```python
from app.scheduler import start_scheduler

# In your application startup
start_scheduler()
```

**Returns:** `None`

**Note:** This function should be called during application initialization (e.g., in `main.startup()`).

#### `scheduler_loop()`

**Internal Function** - Background coroutine that runs the scheduling loop.

- Performs an immediate scan on startup
- Calculates sleep duration until next scheduled run
- Runs continuously with 24-hour intervals
- Handles exceptions gracefully with logging

**Returns:** `None` (runs indefinitely)

#### `_run_once()`

**Internal Function** - Executes a single scan cycle.

- Creates database session
- Checks for upcoming due dates
- Creates missing reminder notifications
- Commits changes and logs results

**Returns:** `None`

## Implementation Details

### Scheduling Logic

The scheduler calculates the next run time based on the current UTC time and the configured `SCAN_HOUR_UTC`:

1. If current time is before the scheduled hour today, schedule for today
2. If current time is after the scheduled hour today, schedule for tomorrow
3. Sleep until the calculated next run time

### Database Integration

The scheduler uses:
- `app.database.async_session` for database connections
- `app.notifications.NotificationService` for creating notifications
- Automatic transaction management with commit/rollback

### Error Handling

- Exceptions during scheduled runs are caught and logged
- The scheduler continues running even after errors
- Database sessions are properly managed with async context managers

## Example Usage

```python
# In your main application file
from app.scheduler import start_scheduler

async def startup():
    """Application startup handler."""
    # Start the background scheduler
    start_scheduler()
    
    # Other startup tasks...
```

## Logging

The module uses structured logging with the logger name `app.scheduler`:

- **INFO**: When reminder notifications are created
- **DEBUG**: Sleep duration and run scheduling details
- **ERROR**: Exception details when runs fail

Example log messages:
```
INFO - Scheduler: created 5 upcoming-due notifications
DEBUG - Scheduler sleeping for 3600 seconds (until 2024-01-15 02:00:00+00:00)
DEBUG - Scheduler: no upcoming invoices in next 3 days
```

## Dependencies

- `asyncio`: For background task management
- `datetime`: For time calculations and timezone handling
- `app.database`: Database session management
- `app.notifications.NotificationService`: Notification creation logic

## Notes

- The scheduler runs in UTC timezone to ensure consistent behavior across deployments
- Database sessions are properly closed after each run
- The implementation avoids import cycles by using a dedicated service instance