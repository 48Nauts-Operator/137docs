<!--
This documentation was auto-generated by Claude on 2025-05-31T16-06-02.
Source file: ./src/backend/app/search.py
-->

# LLM Search Service Documentation

## Overview

The `SearchService` class provides LLM-powered search functionality for a Document Management System. It offers multiple search methods including basic keyword search, semantic vector search, advanced intent-based search, and vision-based search using ColPali embeddings.

## Class: SearchService

### Description
Service class that handles various types of document search operations using machine learning and natural language processing capabilities.

### Constructor

```python
def __init__(self, db: Session)
```

**Parameters:**
- `db` (Session): SQLAlchemy database session for document queries

**Dependencies:**
- `LLMProcessor`: For natural language processing tasks
- Database models and embeddings modules
- Logging configuration

---

## Methods

### basic_search

```python
async def basic_search(self, query: str, limit: int = 20) -> List[Dict[str, Any]]
```

Performs keyword-based search across document content, titles, and sender information.

**Parameters:**
- `query` (str): Search query string
- `limit` (int, optional): Maximum number of results to return. Default: 20

**Returns:**
- `List[Dict[str, Any]]`: List of matching documents with the following structure:
  ```python
  {
      "id": int,
      "title": str,
      "sender": str,
      "document_date": str,  # ISO format or None
      "document_type": str,
      "status": str,
      "relevance": str  # "high" or "medium"
  }
  ```

**Search Fields:**
- Document content text
- Document title
- Document sender

**Relevance Scoring:**
- "high": Query found in document title
- "medium": Query found in other fields

---

### semantic_search

```python
async def semantic_search(self, query: str, limit: int = 10) -> List[Dict[str, Any]]
```

Performs vector-based semantic search using pgvector and cosine distance similarity.

**Parameters:**
- `query` (str): Natural language search query
- `limit` (int, optional): Maximum number of results to return. Default: 10

**Returns:**
- `List[Dict[str, Any]]`: List of semantically similar documents:
  ```python
  {
      "id": int,
      "title": str,
      "sender": str,
      "document_type": str,
      "status": str,
      "relevance_score": float  # 1 - cosine_distance
  }
  ```

**Requirements:**
- Documents must have embeddings stored in the database
- Uses PostgreSQL pgvector extension
- Requires `app.embeddings.get_embedding()` function

---

### extract_search_intent

```python
async def extract_search_intent(self, query: str) -> Dict[str, Any]
```

Extracts structured search parameters from natural language queries using LLM processing.

**Parameters:**
- `query` (str): Natural language search query

**Returns:**
- `Dict[str, Any]`: Extracted search parameters with possible fields:
  ```python
  {
      "document_type": str,           # Optional
      "sender": str,                  # Optional
      "date_range": {                 # Optional
          "start": str,               # YYYY-MM-DD format
          "end": str                  # YYYY-MM-DD format
      },
      "amount_range": {               # Optional
          "min": float,
          "max": float
      },
      "status": str,                  # Optional
      "keywords": List[str]           # Optional
  }
  ```

**Error Handling:**
- Returns `{"keywords": [query]}` if LLM response parsing fails
- Logs JSON parsing errors

---

### advanced_search

```python
async def advanced_search(self, params, limit: int = 20) -> List[Dict[str, Any]]
```

Performs sophisticated search using either pre-structured parameters or natural language queries with LLM intent extraction.

**Parameters:**
- `params` (Union[Dict, str]): Either a dictionary of search parameters or a natural language query string
- `limit` (int, optional): Maximum number of results to return. Default: 20

**Returns:**
- `List[Dict[str, Any]]`: List of matching documents:
  ```python
  {
      "id": int,
      "title": str,
      "sender": str,
      "document_date": str,      # ISO format or None
      "document_type": str,
      "status": str,
      "amount": float            # Optional
  }
  ```

**Supported Filters:**
- Document type (exact match)
- Sender (partial match, case-insensitive)
- Status (exact match)
- Date range (start and/or end dates)
- Amount range (min and/or max values)
- Keywords (content and title search)

---

### suggest_related_documents

```python
async def suggest_related_documents(self, document_id: int, limit: int = 5) -> List[Dict[str, Any]]
```

Finds documents related to a given document using LLM analysis of content similarity and relationships.

**Parameters:**
- `document_id` (int): ID of the source document
- `limit` (int, optional): Maximum number of related documents to return. Default: 5

**Returns:**
- `List[Dict[str, Any]]`: List of related documents:
  ```python
  {
      "id": int,
      "title": str,
      "sender": str,
      "document_date": str,         # ISO format or None
      "document_type": str,
      "relationship_type": str,     # See relationship types below
      "confidence": int             # 0-10 scale
  }
  ```

**Relationship Types:**
- `"same_sender"`: Documents from the same sender
- `"invoice_payment"`: Invoice and its corresponding payment
- `"invoice_reminder"`: Invoice and its reminder
- `"related_subject"`: Documents with related subject matter
- `"time_sequence"`: Documents that are part of a chronological sequence

**Filtering:**
- Only returns documents with confidence score â‰¥ 5
- Results sorted by confidence (highest first)
- Excludes the source