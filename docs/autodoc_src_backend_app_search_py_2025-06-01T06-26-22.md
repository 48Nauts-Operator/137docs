<!--
This documentation was auto-generated by Claude on 2025-06-01T06-26-22.
Source file: ./src/backend/app/search.py
-->

# SearchService Documentation

## Overview

The `SearchService` class provides comprehensive LLM-powered search functionality for the Document Management System. It offers multiple search methods including basic keyword search, semantic vector search, advanced intent-based search, document relationship discovery, and visual document search using ColPali embeddings.

## Table of Contents

- [Class Overview](#class-overview)
- [Initialization](#initialization)
- [Search Methods](#search-methods)
- [Helper Methods](#helper-methods)
- [Usage Examples](#usage-examples)
- [Error Handling](#error-handling)
- [Dependencies](#dependencies)

## Class Overview

```python
class SearchService:
    """Service for LLM-powered document search."""
```

The `SearchService` class integrates multiple search technologies:
- Traditional keyword-based search
- Semantic vector search using pgvector
- LLM-powered intent extraction and advanced search
- Document relationship analysis
- Visual document search with ColPali embeddings

## Initialization

### `__init__(db: Session)`

Initializes the search service with a database session.

**Parameters:**
- `db` (Session): SQLAlchemy database session for document queries

**Example:**
```python
from sqlalchemy.orm import Session
from app.search import SearchService

search_service = SearchService(db_session)
```

## Search Methods

### Basic Search

#### `async basic_search(query: str, limit: int = 20) -> List[Dict[str, Any]]`

Performs basic keyword search across document content, titles, and sender information.

**Parameters:**
- `query` (str): Search query string
- `limit` (int, optional): Maximum number of results to return. Defaults to 20.

**Returns:**
- `List[Dict[str, Any]]`: List of matching documents with metadata

**Response Format:**
```python
[
    {
        "id": 123,
        "title": "Document Title",
        "sender": "Sender Name",
        "document_date": "2023-12-01T00:00:00",
        "document_type": "invoice",
        "status": "paid",
        "relevance": "high"  # or "medium"
    }
]
```

### Semantic Search

#### `async semantic_search(query: str, limit: int = 10) -> List[Dict[str, Any]]`

Performs vector-based semantic search using pgvector and document embeddings.

**Parameters:**
- `query` (str): Natural language search query
- `limit` (int, optional): Maximum number of results to return. Defaults to 10.

**Returns:**
- `List[Dict[str, Any]]`: Documents ordered by semantic similarity

**Response Format:**
```python
[
    {
        "id": 123,
        "title": "Document Title",
        "sender": "Sender Name",
        "document_type": "invoice",
        "status": "paid",
        "relevance_score": 0.85  # Cosine similarity score
    }
]
```

**Note:** Requires documents to have pre-computed embeddings stored in the database.

### Advanced Search

#### `async advanced_search(params, limit: int = 20) -> List[Dict[str, Any]]`

Performs intelligent search using LLM-powered intent extraction or structured parameters.

**Parameters:**
- `params` (Dict or str): Either a dictionary of search parameters or a natural language query
- `limit` (int, optional): Maximum number of results to return. Defaults to 20.

**Supported Search Parameters:**
- `document_type`: Document type filter
- `sender`: Sender name filter (partial match)
- `status`: Document status filter
- `date_range`: Object with `start` and `end` dates (YYYY-MM-DD format)
- `amount_range`: Object with `min` and `max` amounts
- `keywords`: Array of keywords to search for

**Example Parameters:**
```python
params = {
    "document_type": "invoice",
    "sender": "Acme Corp",
    "date_range": {"start": "2023-01-01", "end": "2023-03-31"},
    "amount_range": {"min": 100, "max": 500},
    "status": "unpaid",
    "keywords": ["urgent", "electricity"]
}
```

**Returns:**
- `List[Dict[str, Any]]`: Filtered documents matching the criteria

### Vision Search

#### `async vision_search(query: str, limit: int = 10) -> List[Dict[str, Any]]`

Searches documents using visual content analysis with ColPali multi-vector embeddings.

**Parameters:**
- `query` (str): Text query to search for visually similar content
- `limit` (int, optional): Maximum number of results to return. Defaults to 10.

**Returns:**
- `List[Dict[str, Any]]`: Documents ranked by visual similarity

**Response Format:**
```python
[
    {
        "id": 123,
        "title": "Document Title",
        "sender": "Sender Name",
        "document_type": "invoice",
        "status": "paid",
        "vision_score": 0.92  # Visual similarity score
    }
]
```

**Note:** Requires ColPali embeddings to be pre-computed and stored in Qdrant vector database.

## Helper Methods

### Intent Extraction

#### `async extract_search_intent(query: str) -> Dict[str, Any]`

Extracts structured search parameters from natural language queries using LLM.

**Parameters:**
- `query` (str): Natural language search query

**Returns:**
- `Dict[str, Any]`: Extracted search parameters

**Example:**
```python
query = "Find all unpaid invoices from Acme Corp in January 2023"
intent = await search_service.extract_search_intent(query)
# Returns: {
#     "document_type": "invoice",
#     "sender": "Acme Corp",
#     "date_range": {"start": "2023-01-01", "end": "2023-01-31"},
#     "status": "unpaid"
# }
```

### Document Relationships

#### `async suggest_related_documents(document_id: int, limit: int = 5) -> List[Dict