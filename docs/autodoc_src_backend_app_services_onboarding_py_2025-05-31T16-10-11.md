<!--
This documentation was auto-generated by Claude on 2025-05-31T16-10-11.
Source file: ./src/backend/app/services/onboarding.py
-->

# OnboardingService

## Overview

The `OnboardingService` class manages the application's terms of service (TOS) acceptance flow and handles application settings initialization. It provides methods to accept terms of service, check acceptance status, and manage the underlying settings configuration.

## Dependencies

```python
from datetime import datetime
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from app.models import AppSettings
```

## Class Definition

### OnboardingService

Handles onboarding-related operations including TOS acceptance and settings management.

#### Constructor

```python
def __init__(self, db: AsyncSession)
```

**Parameters:**
- `db` (AsyncSession): SQLAlchemy async database session for database operations

**Description:**
Initializes the service with a database session.

---

## Public Methods

### accept_tos()

```python
async def accept_tos() -> datetime
```

**Returns:**
- `datetime`: The timestamp when the terms of service were accepted

**Description:**
Records the user's acceptance of the terms of service by setting the current UTC timestamp in the application settings.

**Example:**
```python
service = OnboardingService(db_session)
accepted_time = await service.accept_tos()
print(f"TOS accepted at: {accepted_time}")
```

---

### tos_accepted()

```python
async def tos_accepted() -> bool
```

**Returns:**
- `bool`: `True` if terms of service have been accepted, `False` otherwise

**Description:**
Checks whether the terms of service have been previously accepted by verifying if the `tos_accepted_at` field contains a timestamp.

**Example:**
```python
service = OnboardingService(db_session)
if await service.tos_accepted():
    print("User has accepted TOS")
else:
    print("TOS acceptance required")
```

---

## Private Methods

### _settings_row()

```python
async def _settings_row() -> AppSettings
```

**Returns:**
- `AppSettings`: The application settings record

**Description:**
Retrieves the application settings record from the database. If no settings record exists (ID = 1), creates a new one with default values:
- `inbox_path`: "/tmp"
- `storage_root`: "/tmp"

The method ensures that an application settings record always exists before returning it.

**Behavior:**
1. Attempts to fetch the settings record with ID = 1
2. If no record exists, creates a new `AppSettings` instance with default paths
3. Adds the new record to the database session
4. Commits the transaction
5. Refreshes the record to reflect any database-generated values
6. Returns the settings record

---

## Usage Example

```python
from sqlalchemy.ext.asyncio import AsyncSession
from app.services.onboarding import OnboardingService

async def handle_onboarding(db_session: AsyncSession):
    onboarding_service = OnboardingService(db_session)
    
    # Check if TOS is already accepted
    if not await onboarding_service.tos_accepted():
        # Accept TOS
        accepted_at = await onboarding_service.accept_tos()
        print(f"TOS accepted at {accepted_at}")
    else:
        print("TOS already accepted")
```

## Notes

- The service assumes a single application settings record with ID = 1
- Default paths are set to "/tmp" for both inbox and storage locations
- All database operations are asynchronous and require proper session management
- The service automatically handles the creation of missing settings records