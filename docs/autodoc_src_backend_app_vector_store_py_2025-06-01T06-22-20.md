<!--
This documentation was auto-generated by Claude on 2025-06-01T06-22-20.
Source file: ./src/backend/app/vector_store.py
-->

# Qdrant Helper Module

A lightweight utility module for integrating with Qdrant vector database, specifically designed for ColPali document processing workflows.

## Overview

This module provides a minimal interface to Qdrant operations, featuring lazy client initialization and essential vector storage functionality. It is optimized for use in background tasks where heavy initialization should be avoided when vector database operations are not required.

## Configuration

The module uses environment variables for configuration:

| Variable | Default Value | Description |
|----------|---------------|-------------|
| `QDRANT_COLLECTION` | `colpali_pages` | Name of the Qdrant collection |
| `VECTOR_DB_HOST` | `qdrant` | Qdrant server hostname |
| `VECTOR_DB_PORT` | `6333` | Qdrant server port |

## Functions

### `ensure_collection(vector_size: int = 128)`

Idempotently creates the required Qdrant collection if it doesn't exist.

**Parameters:**
- `vector_size` (int, optional): The dimensionality of vectors to be stored. Defaults to 128.

**Behavior:**
- Checks if the collection exists
- If not found, creates a new collection with cosine distance metric
- Uses `recreate_collection` to ensure a clean state

**Example:**
```python
ensure_collection(vector_size=256)
```

### `upsert_page(doc_id: int, page_idx: int, multi_vectors: Sequence[Sequence[float]]) -> List[str]`

Inserts multiple vectors for a document page and returns the generated point IDs.

**Parameters:**
- `doc_id` (int): Unique identifier for the document
- `page_idx` (int): Page number within the document
- `multi_vectors` (Sequence[Sequence[float]]): Collection of vector embeddings for the page

**Returns:**
- `List[str]`: List of generated UUID strings (hexadecimal format) for each inserted point

**Behavior:**
- Automatically ensures collection exists with appropriate vector dimensions
- Generates unique UUIDs for each vector point
- Stores metadata including document ID and page index
- Performs batch upsert operation

**Example:**
```python
vectors = [[0.1, 0.2, 0.3], [0.4, 0.5, 0.6]]
point_ids = upsert_page(doc_id=123, page_idx=0, multi_vectors=vectors)
print(f"Inserted {len(point_ids)} vectors")
```

### `search(query_vector: Sequence[float], top_k: int = 20)`

Performs similarity search against the stored vectors.

**Parameters:**
- `query_vector` (Sequence[float]): Query vector for similarity search
- `top_k` (int, optional): Maximum number of results to return. Defaults to 20.

**Returns:**
- List of `ScoredPoint` objects from Qdrant containing matching vectors with similarity scores

**Behavior:**
- Ensures collection exists with matching vector dimensions
- Performs cosine similarity search
- Returns results ordered by similarity score

**Example:**
```python
query = [0.1, 0.2, 0.3, 0.4]
results = search(query_vector=query, top_k=10)
for result in results:
    print(f"Score: {result.score}, Doc ID: {result.payload['doc_id']}")
```

## Architecture Notes

### Lazy Initialization
- The `QdrantClient` instance is created only when first needed
- Reduces initialization overhead for importing modules
- Thread-safe singleton pattern using global variable

### Minimal Dependencies
- Designed for lightweight imports in background tasks
- Focused API surface for specific ColPali use cases
- Avoids heavy initialization when vector operations aren't required

### Data Structure
Each stored point contains:
- **ID**: UUID4 hexadecimal string
- **Vector**: List of float values
- **Payload**: 
  - `doc_id`: Document identifier
  - `page`: Page index within document

## Dependencies

- `qdrant-client`: Official Qdrant Python client
- Standard library modules: `os`, `uuid`, `typing`

## Error Handling

- Collection existence checks use broad exception handling
- Missing collections trigger automatic recreation
- Vector dimension mismatches are handled by automatic collection setup