<!--
This documentation was auto-generated by Claude on 2025-05-31T16-05-11.
Source file: ./src/backend/app/watcher.py
-->

# Document Watcher Module

A Python module for monitoring a folder for new documents using both real-time file system events and polling mechanisms. The module provides priority-based processing where new documents are given higher priority over existing ones.

## Features

- **Dual Monitoring Mechanisms**: Combines watchdog file system events with polling for reliable file detection
- **Priority-based Processing**: New/modified files are processed before existing files
- **Asynchronous Processing**: Non-blocking document processing using asyncio
- **Multiple File Format Support**: Supports PDF, Word documents, and various image formats
- **Robust Error Handling**: Comprehensive logging and error recovery

## Classes

### ProcessingTask

A data class representing a document processing task with priority information.

```python
@dataclass
class ProcessingTask:
    priority: int          # Lower number = higher priority
    file_path: str         # Path to the file
    task_type: str         # 'new', 'existing', 'modified'
    timestamp: float       # Task creation timestamp
```

**Priority Levels:**
- `1`: New or modified files (highest priority)
- `2`: Modified files detected via polling
- `10`: Existing files (lowest priority)

**Methods:**
- `__lt__(other)`: Comparison method for priority queue ordering

### DocumentEventHandler

File system event handler that responds to document creation, modification, and movement events.

```python
class DocumentEventHandler(FileSystemEventHandler):
    def __init__(self, callback: Callable[[str], Awaitable[None]], task_queue: asyncio.Queue)
```

**Parameters:**
- `callback`: Async function to process detected documents
- `task_queue`: Queue for managing processing tasks

**Methods:**

#### `_handle_event(path: str, task_type: str = 'new')`
Internal method that processes file system events for supported document types.

#### `_is_document(file_path: str) -> bool`
Checks if a file has a supported document extension.

**Supported Extensions:**
- Documents: `.pdf`, `.docx`, `.doc`
- Images: `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`

#### Event Handlers
- `on_created(event)`: Handles file creation events
- `on_moved(event)`: Handles file move/rename events  
- `on_modified(event)`: Handles file modification events

### FolderWatcher

Main class that orchestrates document monitoring using multiple detection mechanisms.

```python
class FolderWatcher:
    def __init__(self, folder_path: str, callback: Callable[[str], Awaitable[None]], poll_interval: int = 30)
```

**Parameters:**
- `folder_path`: Directory path to monitor
- `callback`: Async function to process detected documents
- `poll_interval`: Polling interval in seconds (default: 30)

**Attributes:**
- `known_files`: Dictionary tracking file modification times
- `processed_files`: Set of files that have been processed
- `task_queue`: Priority queue for processing tasks
- `processing_active`: Flag indicating if processing is active

## Methods

### `start_watching() -> None`
Starts the document monitoring system with all mechanisms:

1. **Watchdog Observer**: Real-time file system event monitoring
2. **Task Processor**: Handles priority-based task execution
3. **Polling Loop**: Fallback mechanism for missed events
4. **Existing Files Processing**: Background processing of pre-existing files

**Example:**
```python
async def process_document(file_path: str):
    print(f"Processing: {file_path}")

watcher = FolderWatcher("/path/to/documents", process_document)
await watcher.start_watching()
```

### `_process_task_queue() -> None`
Internal coroutine that processes tasks from the priority queue sequentially.

### `_polling_loop() -> None`
Internal coroutine that periodically scans the folder for new or modified files.

### `_check_for_new_files() -> None`
Scans the directory and identifies new or modified documents for processing.

### `_queue_existing_files() -> None`
Queues all existing documents in the folder with low priority for background processing.

### `_is_document(file_path: str) -> bool`
Utility method to check if a file is a supported document type.

## Usage Example

```python
import asyncio
import logging
from document_watcher import FolderWatcher

# Configure logging
logging.basicConfig(level=logging.INFO)

async def process_document(file_path: str):
    """Your document processing logic here"""
    print(f"Processing document: {file_path}")
    # Add your processing logic (OCR, indexing, etc.)
    await asyncio.sleep(1)  # Simulate processing time

async def main():
    # Create watcher instance
    watcher = FolderWatcher(
        folder_path="/path/to/watch",
        callback=process_document,
        poll_interval=30  # Check every 30 seconds
    )
    
    # Start monitoring (runs indefinitely)
    await watcher.start_watching()

if __name__ == "__main__":
    asyncio.run(main())
```

## Error Handling

The module includes comprehensive error handling:

- **File Access Errors**: Handles permission issues and file locks
- **Processing Errors**: Continues operation even if individual files fail to process
- **Cancellation**: Graceful shutdown when tasks are cancelled
- **Logging**: Detailed logging for debugging and monitoring

## Dependencies

- `watchdog`: File system event monitoring
- `asyncio`: Asynchronous programming support
- `logging`: Application logging
- `typing`: Type hints support
- `dataclasses`: Data class support

## Installation

```bash
pip install watchdog
```

The module uses only standard library modules except for `watchdog`.

## Notes

- The folder is created automatically if it doesn't exist
- Files are processed only once to avoid duplicate processing
- New documents always have priority over existing ones
- The system is designed to be fault-tolerant with multiple detection mechanisms