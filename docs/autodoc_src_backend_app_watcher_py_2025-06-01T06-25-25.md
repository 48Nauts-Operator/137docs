<!--
This documentation was auto-generated by Claude on 2025-06-01T06-25-25.
Source file: ./src/backend/app/watcher.py
-->

# Document Watcher Module

A comprehensive document monitoring system that watches a folder for new documents using multiple detection mechanisms including file system events and polling.

## Overview

The Document Watcher module provides robust file monitoring capabilities with priority-based processing, ensuring new documents are processed before existing ones. It combines real-time file system event monitoring with polling fallback mechanisms for maximum reliability.

## Classes

### ProcessingTask

A data class representing a document processing task with priority handling.

#### Attributes

- `priority` (int): Task priority (lower number = higher priority)
- `file_path` (str): Path to the document file
- `task_type` (str): Type of task ('new', 'existing', 'modified')
- `timestamp` (float): Task creation timestamp (defaults to current time)

#### Methods

##### `__lt__(self, other) -> bool`

Comparison method for priority queue ordering. Tasks are ordered by priority first, then by timestamp (newer files first for same priority).

---

### DocumentEventHandler

File system event handler that monitors document-related file events.

#### Constructor

```python
DocumentEventHandler(callback: Callable[[str], Awaitable[None]], task_queue: asyncio.Queue)
```

**Parameters:**
- `callback`: Async function to call when a document event occurs
- `task_queue`: Queue for managing processing tasks

#### Methods

##### `on_created(self, event: FileCreatedEvent)`

Handles file creation events. Adds new documents to the processing queue with priority 1.

##### `on_moved(self, event: FileMovedEvent)`

Handles file move events. Treats moved files as new documents for processing.

##### `on_modified(self, event: FileModifiedEvent)`

Handles file modification events. Adds modified documents to the processing queue.

##### `_handle_event(self, path: str, task_type: str = 'new')`

Internal method that processes file system events and queues supported documents for processing.

**Parameters:**
- `path`: File path that triggered the event
- `task_type`: Type of event ('new', 'existing', 'modified')

##### `_is_document(self, file_path: str) -> bool`

Checks if a file is a supported document type based on file extension.

**Supported Extensions:**
- PDF: `.pdf`
- Word: `.docx`, `.doc`  
- Images: `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`

**Returns:** `True` if the file is a supported document type

---

### FolderWatcher

Main class for monitoring a folder with multiple detection mechanisms.

#### Constructor

```python
FolderWatcher(folder_path: str, callback: Callable[[str], Awaitable[None]], poll_interval: int = 30)
```

**Parameters:**
- `folder_path`: Path to the folder to monitor
- `callback`: Async function to call for each detected document
- `poll_interval`: Polling interval in seconds (default: 30)

#### Attributes

- `folder_path` (str): Monitored folder path
- `callback`: Document processing callback function
- `observer`: Watchdog file system observer
- `poll_interval` (int): Polling frequency in seconds
- `known_files` (Dict[str, float]): Tracked files with modification times
- `processed_files` (Set[str]): Set of already processed files
- `task_queue` (asyncio.Queue): Priority task queue
- `processing_active` (bool): Flag indicating active processing

#### Methods

##### `async start_watching(self)`

Starts the complete monitoring system including:
- File system event monitoring (watchdog)
- Polling fallback mechanism
- Priority-based task processing
- Existing file queue processing

Creates the target folder if it doesn't exist.

##### `async _process_task_queue(self)`

Internal task processor that handles the priority queue. Processes tasks in priority order:
1. Priority 1: New/modified files (highest)
2. Priority 10: Existing files (lowest)

##### `async _polling_loop(self)`

Fallback polling mechanism that periodically scans the folder for new or modified files when file system events may be missed.

##### `async _check_for_new_files(self)`

Scans the monitored folder for new or modified files and adds them to the processing queue with appropriate priorities.

##### `async _queue_existing_files(self)`

Processes existing files in the folder at startup, adding them to the queue with low priority (10) to ensure new files are processed first.

##### `_is_document(self, file_path: str) -> bool`

Checks if a file is a supported document type. Same implementation as `DocumentEventHandler._is_document()`.

## Usage Example

```python
import asyncio
from document_watcher import FolderWatcher

async def process_document(file_path: str):
    """Process a detected document."""
    print(f"Processing document: {file_path}")
    # Add your document processing logic here
    await asyncio.sleep(1)  # Simulate processing time

async def main():
    # Create watcher instance
    watcher = FolderWatcher(
        folder_path="/path/to/documents",
        callback=process_document,
        poll_interval=30
    )
    
    # Start monitoring
    await watcher.start_watching()

if __name__ == "__main__":
    asyncio.run(main())
```

## Features

### Multi-Layer Detection
- **Real-time Events**: Uses watchdog for immediate file system event detection
- **Polling Fallback**: Periodic scanning ensures no files are missed
- **Existing File Processing**: Handles documents already present in the folder

### Priority Processing
- **Priority 1**: New and modified files (immediate processing)
- **Priority 10**: Existing files (background processing)
- **Timestamp Ordering**: Newer files processed first within same priority

### Supported File Types
- PDF documents (`.pdf`)
- Microsoft Word documents (`.docx`, `.doc`)
- Image files (`.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`)

### Error Handling
- Graceful handling of file system errors
- Automatic retry mechanisms
- Comprehensive logging for debugging

### Async/Await Support
- Fully asynchronous operation
- Non-blocking file processing
- Concurrent task handling

## Dependencies

- `watchdog`: File