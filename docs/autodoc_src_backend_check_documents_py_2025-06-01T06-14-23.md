<!--
This documentation was auto-generated by Claude on 2025-06-01T06-14-23.
Source file: ./src/backend/check_documents.py
-->

# Document Recipients Checker

A Python script for analyzing and validating document recipient assignments in a database, helping identify and troubleshoot assignment issues.

## Overview

This script provides comprehensive analysis of document recipient assignments, identifying problematic entries and providing statistics on assignment quality. It's designed to help maintain data quality in document management systems.

## Features

- **Problematic Document Detection**: Identifies documents with missing, empty, or placeholder recipient values
- **Statistical Analysis**: Provides comprehensive statistics on assignment rates and data quality
- **Entity Verification**: Lists available tenant entities for reference
- **LLM Configuration Check**: Validates machine learning configuration settings
- **Sample Data Display**: Shows examples of both problematic and properly assigned documents

## Requirements

- Python 3.7+
- SQLAlchemy with async support
- SQLite database with aiosqlite driver

### Dependencies

```python
sqlalchemy[asyncio]
aiosqlite
```

## Database Schema

The script expects the following database models:

- **Document**: Contains `id`, `title`, `recipient`, `sender` fields
- **Entity**: Contains `id`, `name`, `alias`, `type` fields  
- **LLMConfig**: Contains configuration for machine learning features

## Usage

### Basic Execution

```bash
python3 document_recipients_checker.py
```

### Expected Output

The script provides structured output with emoji indicators:

```
üîç Checking Document Recipient Assignments
============================================================
‚ùå Documents with problematic recipients:
  ID: 123 | Example Document Title               | Recipient: None     | Sender: Company A
  
üìä Document Statistics:
  Total documents: 1000
  Problematic recipients: 150
  Properly assigned: 850
  Assignment rate: 85.0%

üë• Available Tenants (5):
  ID:   1 | tenant_alias        | Type: company    | Name: Example Company

üß† LLM Configuration:
  Enabled: True
  Provider: openai
  Auto-tagging: True
  Auto-enrichment: False

‚úÖ Examples of properly assigned documents:
  ID: 456 | Another Document                     | Recipient: 'Client Corp' | Sender: Vendor Inc
```

## Configuration

### Database Connection

The script automatically configures the database connection:

```python
os.environ["DATABASE_URL"] = f"sqlite+aiosqlite:///src/backend/documents.db"
```

### Path Configuration

The script adds necessary paths to the Python path:

```python
sys.path.append('/app')
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
```

## Functions

### `check_documents()`

**Purpose**: Main analysis function that performs comprehensive document recipient validation.

**Functionality**:
1. **Problematic Document Detection**: Queries documents with:
   - `NULL` recipient values
   - Empty string recipients
   - Placeholder values ('Your Company', 'Unknown')

2. **Statistical Analysis**: Calculates:
   - Total document count
   - Problematic assignment count
   - Assignment success rate

3. **Entity Verification**: Lists all available tenant entities with their details

4. **Configuration Validation**: Checks LLM configuration status and settings

5. **Quality Examples**: Displays samples of properly assigned documents

**Parameters**: None

**Returns**: None (outputs results to console)

**Error Handling**: Gracefully handles LLM configuration errors and missing data

## Data Quality Checks

### Problematic Recipients Identified

- `NULL` values
- Empty strings (`''`)
- Generic placeholders (`'Your Company'`)
- Unknown values (`'Unknown'`)

### Quality Metrics

- **Assignment Rate**: Percentage of documents with valid recipients
- **Total Coverage**: Overall document processing statistics
- **Entity Availability**: Verification that target entities exist

## Output Interpretation

### Status Indicators

- ‚úÖ **Green Check**: Successful validation or good examples
- ‚ùå **Red X**: Problems detected
- üîç **Magnifying Glass**: Analysis in progress
- üìä **Chart**: Statistical information  
- üë• **People**: Entity/tenant information
- üß† **Brain**: AI/ML configuration status

### Statistical Thresholds

Monitor assignment rates to maintain data quality:
- **90%+**: Excellent assignment rate
- **80-90%**: Good assignment rate  
- **70-80%**: Needs attention
- **<70%**: Requires immediate action

## Troubleshooting

### Common Issues

1. **Database Connection Errors**
   - Verify database file path exists
   - Check file permissions
   - Ensure SQLite database is not corrupted

2. **Missing Models**
   - Verify `app.models` imports correctly
   - Check database schema matches model definitions

3. **Path Resolution Issues**
   - Adjust `sys.path.append()` statements for your environment
   - Verify script execution location

### Error Messages

- **"LLM Configuration: Error loading"**: Database schema mismatch or missing LLM config table
- **"No documents with problematic recipients found"**: All documents properly assigned (ideal state)

## Integration

This script can be integrated into:

- **Data Quality Pipelines**: Regular validation workflows
- **CI/CD Processes**: Pre-deployment data verification
- **Monitoring Systems**: Automated quality checking
- **Manual Audits**: On-demand data analysis

## Performance Considerations

- **Query Limits**: Results limited to prevent overwhelming output (15 problematic, 5 good examples)
- **Async Operations**: Uses async/await for efficient database operations
- **Memory Efficient**: Processes results in batches rather than loading all data