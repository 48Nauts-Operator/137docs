<!--
This documentation was auto-generated by Claude on 2025-05-31T15-55-47.
Source file: ./src/backend/fix_hetzner_sender_names.py
-->

# Hetzner Invoice Sender Name Fix Script

## Overview

This script is designed to clean up problematic sender names in Hetzner invoices stored in the database. It identifies documents where the sender field contains JSON strings instead of clean company names and normalizes them to display "Hetzner Online GmbH" or other appropriate clean names.

## Purpose

- **Problem**: Some Hetzner invoice records have sender fields containing JSON data instead of readable company names
- **Solution**: Parse JSON data to extract meaningful company names and update the database records
- **Target**: Specifically focuses on Hetzner-related documents in the database

## Requirements

### Dependencies
- Python 3.7+
- `asyncio` (built-in)
- `json` (built-in)
- `re` (built-in)
- `sys` (built-in)
- `sqlalchemy` with async support
- Custom application modules:
  - `app.database` (provides `async_engine`)
  - `app.models` (provides `Document` model)

### Environment
- Script expects to run in an environment where `/app` contains the backend application code
- Database connection must be configured through `app.database.async_engine`

## Functions

### `extract_sender_name(sender_data)`

Extracts a clean company name from potentially malformed sender data.

**Parameters:**
- `sender_data` (str|any): The raw sender data that may contain JSON or plain text

**Returns:**
- `str`: Clean, trimmed company name

**Logic:**
1. Returns empty string for falsy input
2. For string input:
   - Detects JSON format by checking for `{` and `}` delimiters
   - Attempts JSON parsing if detected
   - Searches for common name fields: `name`, `company`, `sender`, `company_name`
   - Falls back to first non-empty string value in JSON object
   - Returns original string if JSON parsing fails
3. Converts non-string input to string and trims whitespace

### `fix_hetzner_sender_names()`

Main async function that processes and fixes Hetzner invoice sender names in the database.

**Process:**
1. **Query**: Finds all documents with sender names containing "hetzner" (case-insensitive)
2. **Analysis**: Checks each document's sender field for cleanup opportunities
3. **Processing**: 
   - Extracts clean sender name using `extract_sender_name()`
   - Compares original vs. cleaned version
   - Updates database if changes are needed
4. **Reporting**: Provides detailed console output showing:
   - Total documents found
   - Before/after comparison for each document
   - Success/skip status for each record
   - Final summary of changes made

**Database Operations:**
- Uses async SQLAlchemy session management
- Performs SELECT query with ILIKE pattern matching
- Executes UPDATE statements for modified records
- Commits changes only if fixes were applied

## Usage

### Command Line Execution
```bash
python3 fix_hetzner_sender_names.py
```

### Integration
```python
import asyncio
from fix_hetzner_sender_names import fix_hetzner_sender_names

# Run the fix process
asyncio.run(fix_hetzner_sender_names())
```

## Output Examples

### Successful Execution
```
Found 3 Hetzner documents to check:

Document ID 123:
  Original: {"name": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

ðŸŽ‰ Successfully fixed 1 Hetzner invoice sender names!
```

### No Changes Needed
```
Found 2 Hetzner documents to check:
âœ“ All Hetzner invoice sender names are already clean.
```

## Error Handling

- **JSON Parsing**: Gracefully handles malformed JSON with try/catch blocks
- **Database Errors**: Relies on SQLAlchemy's built-in error handling
- **Data Types**: Safely converts non-string data to strings
- **Empty Data**: Handles null, empty, or falsy sender data appropriately

## Safety Features

- **Preview Mode**: Shows before/after comparison before making changes
- **Selective Updates**: Only modifies records that actually need changes
- **Transaction Safety**: Uses database transactions with commit only after successful processing
- **Detailed Logging**: Provides comprehensive output for audit trails

## Database Schema Assumptions

The script assumes a `Document` model with at least these fields:
- `id`: Primary key
- `sender`: String field containing sender information

## Maintenance Notes

- Script can be run multiple times safely (idempotent)
- No backup is created automatically - ensure database backups exist
- Consider testing on a subset of data first in production environments