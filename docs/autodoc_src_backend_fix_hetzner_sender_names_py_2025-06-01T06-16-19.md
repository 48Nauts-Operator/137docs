<!--
This documentation was auto-generated by Claude on 2025-06-01T06-16-19.
Source file: ./src/backend/fix_hetzner_sender_names.py
-->

# Hetzner Invoice Sender Name Cleanup Script

## Overview

This script is designed to clean up Hetzner invoice sender names that contain JSON strings in the database. It identifies documents with problematic sender fields and normalizes them to display clean company names.

## Purpose

The script addresses data quality issues where sender names are stored as JSON strings instead of clean text, ensuring consistent display of "Hetzner Online GmbH" and other company names.

## Requirements

- Python 3.x
- SQLAlchemy with async support
- Access to the application database
- Required modules: `app.database`, `app.models`

## Usage

```bash
python3 fix_hetzner_sender_names.py
```

## Functions

### `extract_sender_name(sender_data)`

Extracts and cleans company names from various sender data formats.

**Parameters:**
- `sender_data` (str|any): Raw sender data that may contain JSON strings or clean text

**Returns:**
- `str`: Cleaned company name

**Logic:**
1. Returns empty string if no data provided
2. For string inputs:
   - Detects JSON format by checking for `{` and `}` delimiters
   - Attempts JSON parsing if format is detected
   - Searches for common name fields: `name`, `company`, `sender`, `company_name`
   - Falls back to first non-empty string value in JSON object
   - Handles JSON parsing errors gracefully
3. Returns trimmed string representation for non-string inputs

### `fix_hetzner_sender_names()`

Main async function that processes and updates Hetzner documents in the database.

**Process:**
1. Establishes async database session
2. Queries for documents containing "hetzner" in sender field (case-insensitive)
3. Processes each document:
   - Extracts original sender name
   - Applies cleaning logic
   - Compares original vs. cleaned versions
   - Updates database if changes are needed
4. Commits changes and provides summary statistics

**Output:**
- Progress information for each document processed
- Success indicators (âœ… for fixed, âœ“ for already clean)
- Final summary with count of fixed records

## Database Operations

The script performs the following database operations:

- **SELECT**: Queries documents with Hetzner-related sender names
- **UPDATE**: Modifies sender field for documents requiring cleanup
- **COMMIT**: Saves all changes to the database

## Error Handling

- JSON parsing errors are caught and handled gracefully
- Database operations use proper async session management
- Input validation prevents processing of null/empty data

## Example Output

```
Found 15 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

ðŸŽ‰ Successfully fixed 8 Hetzner invoice sender names!
```

## Safety Features

- Read-only operations until final commit
- Detailed logging of all changes
- Comparison logic prevents unnecessary updates
- Transaction-based updates ensure data consistency

## Dependencies

```python
import asyncio
import sys
import json
import re
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from app.database import async_engine
from app.models import Document
```

## File Structure

The script expects to be run from an environment where:
- `/app` directory contains the backend modules
- Database connection is properly configured
- Document model is available and accessible