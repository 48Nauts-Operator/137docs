<!--
This documentation was auto-generated by Claude on 2025-06-01T06-17-37.
Source file: ./src/backend/fix_tenant_automation.py
-->

# Tenant Automation Fix Script

## Overview

This script addresses tenant automation issues by automatically assigning documents to appropriate tenants based on content analysis and predefined matching rules.

## Purpose

The script identifies documents with missing or invalid tenant assignments and applies intelligent matching logic to associate them with the correct entities in the system.

## Requirements

- Python 3.7+
- SQLAlchemy with async support
- aiosqlite
- Access to the application models (`Document`, `Entity`)

## Usage

```bash
python3 fix_tenant_automation.py
```

## Functionality

### Main Function: `fix_tenant_automation()`

**Purpose**: Automatically assigns documents to matching tenants based on content analysis.

**Process**:
1. Connects to the SQLite database using async SQLAlchemy
2. Retrieves all available entities from the database
3. Identifies problematic documents requiring tenant assignment
4. Applies intelligent matching rules to assign documents to appropriate entities
5. Commits the changes to the database

### Document Selection Criteria

The script targets documents with the following characteristics:
- `recipient` field is `NULL`
- `recipient` field is empty string
- `recipient` field contains placeholder values: `'Your Company'` or `'Unknown'`

### Assignment Rules

The script uses content-based matching rules to determine appropriate tenant assignments:

#### Rule 1: Google Services
- **Trigger**: Content contains "google" in sender, title, or content fields
- **Assignment**: Documents assigned to "Google" entity
- **Use Case**: Google service notifications, account updates

#### Rule 2: Personal Documents
- **Triggers**:
  - Content contains "andr√©" or "personal"
  - Title contains "medical" or "insurance"
- **Assignment**: Documents assigned to "Personal" entity
- **Use Case**: Personal correspondence, medical records, insurance documents

#### Rule 3: Company Documents
- **Triggers**:
  - Content contains "test company", "office", or "test corp"
  - Title contains "rent"
- **Assignment**: Documents assigned to "Test Corp" entity
- **Use Case**: Business correspondence, office-related documents, rental agreements

## Database Schema

The script interacts with the following database models:

### Document Model
- `id`: Primary key
- `title`: Document title
- `content`: Document content
- `sender`: Document sender
- `recipient`: Document recipient (target for updates)
- `entity_id`: Foreign key to Entity (target for updates)

### Entity Model
- `id`: Primary key
- `name`: Full entity name
- `alias`: Short entity identifier

## Output

The script provides detailed console output including:

### Entity Information
```
üë• Available Entities:
  1: Google (Google Services)
  2: Personal (Personal Documents)
  3: Test Corp (Test Company Inc.)
```

### Assignment Results
```
üìÑ Found 15 documents to fix:
  üìÑ Google Account Security Alert        ‚Üí Google (Google service detected)
  üìÑ Medical Appointment Reminder         ‚Üí Personal (Personal document detected)
  üìÑ Office Lease Agreement              ‚Üí Test Corp (Company document detected)
  ‚ùì Unidentified Document               ‚Üí No assignment found
```

### Summary Statistics
```
‚úÖ Tenant automation fixed!
   üìä 12 documents assigned to tenants
   üéØ 3 documents still need manual review
```

## Error Handling

- Uses async context managers for proper database session management
- Automatically rolls back transactions on failure
- Gracefully handles missing entities or malformed data

## Configuration

### Database Connection
- **Engine**: SQLite with aiosqlite async driver
- **Database File**: `./documents.db`
- **Echo Mode**: Disabled for production use

### Path Configuration
The script adds the following paths to the Python path:
- `/app`: Application root directory
- Script directory: Directory containing the script file

## Best Practices

1. **Backup**: Always backup your database before running the script
2. **Testing**: Test the script on a copy of your data first
3. **Review**: Manually review documents that couldn't be automatically assigned
4. **Monitoring**: Check the output logs to ensure expected assignment counts

## Limitations

- Assignment rules are hardcoded and may need customization for different use cases
- Content matching is case-insensitive but uses simple string containment
- Unmatched documents require manual intervention
- Script assumes specific entity aliases exist in the database

## Extension Points

To customize the script for your environment:

1. **Add New Rules**: Extend the assignment logic with additional matching criteria
2. **Modify Triggers**: Update the content matching patterns for your specific use case
3. **Entity Mapping**: Adjust entity alias references to match your database
4. **Logging**: Add more detailed logging or integrate with your logging system