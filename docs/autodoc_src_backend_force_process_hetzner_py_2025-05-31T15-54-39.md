<!--
This documentation was auto-generated by Claude on 2025-05-31T15-54-39.
Source file: ./src/backend/force_process_hetzner.py
-->

# Hetzner Invoice Force Processing Script

## Overview

This script provides a manual method to force the processing of Hetzner invoices by bypassing the built-in duplicate detection system and directly adding them to the processing queue.

## Purpose

The script is designed to handle scenarios where Hetzner invoices need to be reprocessed or when the standard duplicate detection mechanism prevents legitimate documents from being processed.

## Features

- **Automatic Detection**: Scans the inbox directory for files matching the Hetzner invoice pattern
- **Batch Processing**: Processes multiple invoices sequentially
- **Error Handling**: Continues processing remaining files even if individual files fail
- **Progress Reporting**: Provides detailed console output with processing status
- **Bypass Mechanism**: Circumvents duplicate detection for forced processing

## Requirements

### Dependencies
- Python 3.7+
- `asyncio` (standard library)
- `sys` (standard library)
- `os` (standard library)
- `glob` (standard library)
- Application backend modules (from `/app`)

### Environment
- Must be run within the application container environment
- Requires access to `/hostfs/Inbox` directory
- Backend application modules must be available at `/app`

## Usage

### Basic Execution

```bash
python3 force_process_hetzner.py
```

### Docker Container Execution

```bash
# From within the container
./force_process_hetzner.py
```

## File Structure

```
/hostfs/Inbox/          # Monitored directory for Hetzner invoices
├── *Hetzner*.pdf       # Hetzner invoice files (pattern matched)
└── ...
```

## Functions

### `force_process_hetzner_invoices()`

**Type**: `async function`

**Description**: Main processing function that orchestrates the forced processing of Hetzner invoices.

**Parameters**: None

**Returns**: None

**Behavior**:
1. Scans `/hostfs/Inbox` for files matching `*Hetzner*.pdf` pattern
2. Lists all discovered files
3. Processes each file sequentially using `process_new_document()`
4. Reports success/failure status for each file
5. Provides summary of processing results

**Error Handling**: Individual file processing errors are caught and logged, but do not stop the processing of remaining files.

## Output Format

### Discovery Phase
```
Found 3 Hetzner invoice files:
  - Hetzner_Invoice_2024_01.pdf
  - Hetzner_Invoice_2024_02.pdf
  - Hetzner_Invoice_2024_03.pdf
```

### Processing Phase
```
Starting manual processing of Hetzner invoices...

Processing 1/3: Hetzner_Invoice_2024_01.pdf
✅ Successfully processed: Hetzner_Invoice_2024_01.pdf

Processing 2/3: Hetzner_Invoice_2024_02.pdf
❌ Error processing Hetzner_Invoice_2024_02.pdf: [Error message]

Processing 3/3: Hetzner_Invoice_2024_03.pdf
✅ Successfully processed: Hetzner_Invoice_2024_03.pdf

Completed processing 3 Hetzner invoices.
```

## Error Handling

- **File Not Found**: Script reports when no Hetzner invoice files are found
- **Processing Errors**: Individual file processing errors are caught and displayed with ❌ indicator
- **Path Errors**: Missing directories or permissions issues will raise exceptions
- **Import Errors**: Missing backend modules will cause import failures

## Configuration

### File Pattern Matching
- **Pattern**: `*Hetzner*.pdf`
- **Location**: `/hostfs/Inbox`
- **Case Sensitivity**: Case-sensitive matching

### Paths
- **Backend Path**: `/app` (added to `sys.path`)
- **Inbox Path**: `/hostfs/Inbox`

## Security Considerations

- Script requires file system access to inbox directory
- Bypasses duplicate detection mechanisms
- Should be used with caution in production environments
- Consider backing up files before forced processing

## Troubleshooting

### Common Issues

1. **No files found**: Verify files exist in `/hostfs/Inbox` and match `*Hetzner*.pdf` pattern
2. **Import errors**: Ensure backend application is properly mounted at `/app`
3. **Permission errors**: Verify container has read access to inbox directory
4. **Processing failures**: Check individual error messages for specific file issues

### Debug Steps

1. Verify file existence: `ls -la /hostfs/Inbox/*Hetzner*.pdf`
2. Check permissions: `ls -ld /hostfs/Inbox`
3. Test backend import: `python3 -c "from app.main import process_new_document"`

## Limitations

- Only processes PDF files
- Requires specific file naming pattern
- Must be run from within application container
- Sequential processing (not parallel)
- No rollback mechanism for processed files