<!--
This documentation was auto-generated by Claude on 2025-05-31T15-55-04.
Source file: ./src/backend/init_db.py
-->

# Database Initialization Script

## Overview

This script provides database initialization functionality for the application. It creates all necessary database tables using SQLAlchemy's async ORM and supports both SQLite and other database backends through configurable connection strings.

## File Information

- **File**: `init_db.py`
- **Purpose**: Initialize database schema by creating all required tables
- **Type**: Standalone executable script
- **Python Version**: 3.6+ (async/await support required)

## Dependencies

```python
import asyncio
import sys
import os
from sqlalchemy.ext.asyncio import create_async_engine
from app.models import Base
from app.config import settings
```

### Required Packages
- `sqlalchemy[asyncio]` - Async SQLAlchemy support
- `aiosqlite` - Async SQLite driver (for SQLite databases)

### Internal Dependencies
- `app.models.Base` - SQLAlchemy declarative base containing all model definitions
- `app.config.settings` - Application configuration settings

## Functions

### `init_database()`

Asynchronously initializes the database by creating all tables defined in the application models.

**Signature:**
```python
async def init_database() -> None
```

**Parameters:** None

**Returns:** None

**Behavior:**
1. Determines database connection URL from configuration
2. Creates async SQLAlchemy engine with echo enabled
3. Creates all tables defined in `Base.metadata`
4. Provides console feedback on success/failure
5. Properly disposes of database engine resources

**Database URL Resolution:**
- Uses `settings.DATABASE_URL` if available
- Falls back to SQLite: `sqlite+aiosqlite:///{settings.DATABASE_PATH}`

## Database Schema

The script creates the following tables:

| Table Name | Purpose |
|------------|---------|
| `users` | User account information |
| `documents` | Document storage and metadata |
| `entities` | Tenant/organization entities |
| `user_entities` | User-entity relationship mapping |
| `llm_config` | LLM configuration settings |
| `address_book` | Contact information storage |
| `tags` | Document tagging system |
| `document_tag` | Document-tag relationship mapping |
| `notifications` | User notification system |
| `settings` | Application settings |
| `vectors` | Vector embeddings storage |

## Usage

### Command Line Execution

```bash
# Make script executable
chmod +x init_db.py

# Run the script
python3 init_db.py
# or
./init_db.py
```

### Programmatic Usage

```python
import asyncio
from init_db import init_database

# Initialize database
await init_database()

# Or run in sync context
asyncio.run(init_database())
```

## Configuration

The script relies on configuration settings from `app.config.settings`:

- `DATABASE_URL` (optional): Full database connection string
- `DATABASE_PATH` (fallback): Path for SQLite database file

### Example Configurations

**PostgreSQL:**
```python
DATABASE_URL = "postgresql+asyncpg://user:password@localhost/dbname"
```

**SQLite:**
```python
DATABASE_PATH = "/app/data/database.db"
```

## Output Examples

### Successful Initialize

```
üóÑÔ∏è Initializing Database
========================================
Database URL: sqlite+aiosqlite:///app/data/database.db

‚úÖ Database initialized successfully!
üìä Tables created:
  - users
  - documents
  - entities (tenants)
  - user_entities
  - llm_config
  - address_book
  - tags
  - document_tag
  - notifications
  - settings
  - vectors
```

### Error Handling

```
üóÑÔ∏è Initializing Database
========================================
Database URL: postgresql+asyncpg://user:password@localhost/nonexistent
‚ùå Error initializing database: could not connect to server
```

## Error Handling

The script implements comprehensive error handling:

- **Database Connection Errors**: Catches and reports connection failures
- **Table Creation Errors**: Reports schema creation issues
- **Resource Cleanup**: Ensures database engine is properly disposed
- **Exception Reporting**: Provides detailed error messages for debugging

## Notes

- **Idempotent Operation**: Safe to run multiple times; existing tables won't be affected
- **Echo Mode**: SQL queries are logged to console for debugging
- **Path Configuration**: Adds `/app` and script directory to Python path for imports
- **Async Context**: Uses proper async context management for database operations

## Security Considerations

- Database credentials should be stored securely in environment variables
- Consider using connection pooling for production deployments
- Ensure proper file permissions on SQLite database files
- Use parameterized connection strings to prevent injection attacks