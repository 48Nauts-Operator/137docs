<!--
This documentation was auto-generated by Claude on 2025-06-01T06-15-38.
Source file: ./src/backend/init_db.py
-->

# Database Initialization Script

## Overview

This script initializes the application database by creating all required tables based on SQLAlchemy model definitions. It provides a standalone utility for setting up the database schema during application deployment or development setup.

## File Information

- **File**: `init_db.py`
- **Type**: Database initialization script
- **Python Version**: 3.6+ (requires async/await support)

## Dependencies

### Required Packages
- `asyncio` - Built-in async support
- `sqlalchemy` - Database ORM with async extensions
- `aiosqlite` - Async SQLite driver (for SQLite databases)

### Internal Dependencies
- `app.models.Base` - SQLAlchemy declarative base containing all table models
- `app.config.settings` - Application configuration settings

## Functions

### `init_database()`

**Type**: `async function`

**Description**: 
Initializes the database by creating all tables defined in the application's SQLAlchemy models.

**Parameters**: None

**Returns**: None

**Behavior**:
1. Determines database URL from configuration settings
2. Creates an async SQLAlchemy engine with echo logging enabled
3. Executes table creation using SQLAlchemy metadata
4. Provides detailed console output about the initialization process
5. Handles exceptions and ensures proper engine cleanup

**Database URL Resolution**:
- Primary: Uses `settings.DATABASE_URL` if configured
- Fallback: Constructs SQLite URL using `settings.DATABASE_PATH`

## Database Schema

The script creates the following tables:

| Table Name | Purpose |
|------------|---------|
| `users` | User account information |
| `documents` | Document storage and metadata |
| `entities` | Tenant/organization entities |
| `user_entities` | User-entity relationship mapping |
| `llm_config` | LLM configuration settings |
| `address_book` | Contact information storage |
| `tags` | Document tagging system |
| `document_tag` | Document-tag relationships |
| `notifications` | User notifications |
| `settings` | Application settings |
| `vectors` | Vector embeddings storage |

## Usage

### Command Line Execution

```bash
python3 init_db.py
```

### Programmatic Usage

```python
import asyncio
from init_db import init_database

# Run database initialization
asyncio.run(init_database())
```

## Configuration Requirements

### Environment Variables

The script requires the following configuration settings:

- `DATABASE_URL` (optional): Complete database connection string
- `DATABASE_PATH` (fallback): File path for SQLite database

### Example Configuration

```python
# Using DATABASE_URL
DATABASE_URL = "postgresql+asyncpg://user:pass@localhost/dbname"

# Using DATABASE_PATH (SQLite)
DATABASE_PATH = "/app/data/database.db"
```

## Output Examples

### Successful Initialization

```
üóÑÔ∏è Initializing Database
========================================
Database URL: sqlite+aiosqlite:///app/data/database.db

‚úÖ Database initialized successfully!
üìä Tables created:
  - users
  - documents
  - entities (tenants)
  - user_entities
  - llm_config
  - address_book
  - tags
  - document_tag
  - notifications
  - settings
  - vectors
```

### Error Handling

```
üóÑÔ∏è Initializing Database
========================================
Database URL: postgresql+asyncpg://invalid:connection@localhost/db
‚ùå Error initializing database: connection failed
```

## Error Handling

The script implements comprehensive error handling:

- **Database Connection Errors**: Catches and reports connection failures
- **Table Creation Errors**: Handles schema-related exceptions
- **Resource Cleanup**: Ensures database engine disposal in all scenarios

## Best Practices

### Deployment Usage

1. **Run during deployment**: Execute as part of application deployment process
2. **Idempotent operations**: Safe to run multiple times (existing tables won't be affected)
3. **Environment-specific**: Configure appropriate database URLs for different environments

### Development Usage

1. **Fresh setup**: Run when setting up development environment
2. **Schema updates**: Re-run after model changes (may require manual migration handling)
3. **Testing**: Use for test database initialization

## Security Considerations

- **Database Credentials**: Ensure database URLs contain properly secured credentials
- **File Permissions**: Set appropriate permissions on SQLite database files
- **Network Security**: Use encrypted connections for remote databases

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure all dependencies are installed and paths are correctly configured
2. **Permission Errors**: Verify write permissions for SQLite database directory
3. **Connection Timeouts**: Check database server availability and network connectivity

### Debugging

Enable detailed logging by reviewing the SQLAlchemy echo output during execution.