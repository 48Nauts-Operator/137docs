<!--
This documentation was auto-generated by Claude on 2025-06-01T06-30-52.
Source file: ./src/backend/tests/conftest.py
-->

# Pytest Configuration and Fixtures Documentation

## Overview

This module provides comprehensive pytest configuration and fixtures for testing the 137Docs backend application. It sets up test database connections, HTTP clients, and mock data to support isolated and reliable testing.

## Configuration

### Test Database

- **Database URL**: `sqlite+aiosqlite:///:memory:`
- **Type**: In-memory SQLite database for fast, isolated tests
- **Engine**: Async SQLAlchemy engine with echo disabled

## Fixtures

### Session Management

#### `event_loop`
**Scope**: `session`

Creates and manages the default event loop for the entire test session.

```python
@pytest.fixture(scope="session")
def event_loop():
```

**Returns**: `asyncio.AbstractEventLoop`

**Lifecycle**:
- Creates new event loop at session start
- Yields loop for test execution
- Closes loop after session completion

---

#### `test_engine`
**Scope**: `session`

Provides an async SQLAlchemy engine configured for testing.

```python
@pytest.fixture(scope="session")
async def test_engine():
```

**Returns**: `sqlalchemy.ext.asyncio.AsyncEngine`

**Features**:
- Uses in-memory SQLite for speed and isolation
- Automatically creates all database tables
- Properly disposes of engine after tests

**Configuration**:
- `echo=False`: Disables SQL query logging
- `future=True`: Enables SQLAlchemy 2.0 style

---

#### `test_session`
**Scope**: `function`

Creates a fresh database session for each test function.

```python
@pytest.fixture
async def test_session(test_engine):
```

**Returns**: `sqlalchemy.ext.asyncio.AsyncSession`

**Dependencies**: `test_engine`

**Isolation Strategy**:
- Creates new session per test
- Rolls back all changes after test completion
- Ensures test isolation and clean state

---

### HTTP Client

#### `test_client`
**Scope**: `function`

Provides an HTTP client for testing API endpoints with database dependency injection.

```python
@pytest.fixture
async def test_client(test_session):
```

**Returns**: `httpx.AsyncClient`

**Dependencies**: `test_session`

**Features**:
- Overrides application database dependency
- Base URL: `http://test`
- Automatic cleanup of dependency overrides
- Uses test database session for all requests

**Usage Example**:
```python
async def test_api_endpoint(test_client):
    response = await test_client.get("/api/documents")
    assert response.status_code == 200
```

---

### Mock Data and Configuration

#### `mock_llm_config`
**Scope**: `function`

Provides mock LLM (Large Language Model) configuration for testing AI features.

```python
@pytest.fixture
def mock_llm_config():
```

**Returns**: `dict`

**Configuration Fields**:

| Field | Value | Description |
|-------|--------|-------------|
| `provider` | `'local'` | LLM provider type |
| `api_url` | `'http://localhost:11434'` | Local API endpoint |
| `api_key` | `''` | Empty for local provider |
| `model_tagger` | `'phi3'` | Model for document tagging |
| `model_enricher` | `'llama3'` | Model for content enrichment |
| `model_analytics` | `'llama3'` | Model for analytics |
| `model_responder` | `'gpt-4'` | Model for responses |
| `enabled` | `True` | LLM features enabled |
| `auto_tagging` | `True` | Automatic tagging enabled |
| `auto_enrichment` | `True` | Automatic enrichment enabled |
| `external_enrichment` | `False` | External enrichment disabled |
| `max_retries` | `3` | Maximum retry attempts |
| `retry_delay` | `300` | Delay between retries (seconds) |
| `batch_size` | `5` | Processing batch size |
| `concurrent_tasks` | `2` | Maximum concurrent tasks |
| `cache_responses` | `True` | Response caching enabled |
| `min_confidence_tagging` | `0.7` | Minimum confidence for tagging |
| `min_confidence_entity` | `0.8` | Minimum confidence for entities |

---

#### `sample_document_text`
**Scope**: `function`

Provides realistic sample document text for testing document processing features.

```python
@pytest.fixture
def sample_document_text():
```

**Returns**: `str`

**Content**: Sample invoice document containing:
- Invoice header and number
- Sender and recipient addresses
- Dates and payment terms
- Line items with pricing
- Tax calculations

**Usage Example**:
```python
def test_document_parsing(sample_document_text):
    result = parse_document(sample_document_text)
    assert "INV-2024-001" in result.invoice_number
```

---

#### `temp_file`
**Scope**: `function`

Creates a temporary file for testing file operations.

```python
@pytest.fixture
def temp_file():
```

**Returns**: `str` (file path)

**Features**:
- Creates temporary file with `.txt` extension
- Pre-populated with test content: `"Test document content"`
- Automatic cleanup after test completion
- Safe deletion with existence check

**Usage Example**:
```python
def test_file_upload(temp_file, test_client):
    with open(temp_file, 'rb') as f:
        response = await test_client.post("/upload", files={"file": f})
    assert response.status_code == 200
```

## Dependencies

### Required Packages
- `pytest`: Testing framework
- `pytest-asyncio`: Async testing support
- `sqlalchemy`: Database ORM
- `httpx`: HTTP client for API testing
- `aiosqlite`: Async SQLite driver

### Internal Dependencies
- `app.main.app`: FastAPI application instance
- `app.database.get_db`: Database dependency
- `tests.test_models.Base`: Test database models

## Usage Patterns