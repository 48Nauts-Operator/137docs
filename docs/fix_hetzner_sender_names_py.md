<!-- Auto-generated by Claude on 2025-06-02 06:15 -->

# Hetzner Invoice Sender Name Cleanup Script

## Overview

This Python script is designed to clean up corrupted sender names in Hetzner invoice records stored in a database. The script identifies documents where the sender field contains JSON strings instead of clean company names and converts them to a readable format like "Hetzner Online GmbH".

## Purpose

- **Problem**: Some Hetzner invoice records have sender fields that contain JSON data instead of clean company names
- **Solution**: Parse JSON data to extract meaningful company names and update the database records
- **Target**: Documents in the database with sender names containing "hetzner" (case-insensitive)

## Key Functions

### `extract_sender_name(sender_data)`

Extracts a clean company name from potentially corrupted sender data.

**Parameters:**
- `sender_data`: The raw sender data (string or other type)

**Returns:**
- Clean company name as a string

**Logic:**
1. Returns empty string if no data provided
2. For string inputs:
   - Detects JSON format (starts with `{` and ends with `}`)
   - Attempts to parse JSON and extract name from common fields:
     - `name`
     - `company` 
     - `sender`
     - `company_name`
   - Falls back to first non-empty string value in JSON
   - Returns original string if JSON parsing fails
3. Converts non-string inputs to strings

### `fix_hetzner_sender_names()`

Main async function that performs the database cleanup operation.

**Process:**
1. Creates database session using SQLAlchemy async engine
2. Queries for all documents with sender names containing "hetzner"
3. Processes each document:
   - Extracts clean sender name
   - Compares with original
   - Updates database if changes needed
4. Commits all changes and reports results

## Dependencies

```python
import asyncio
import sys
import json
import re
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
```

**External modules:**
- `app.database.async_engine` - Database connection
- `app.models.Document` - Document model class

## Usage

Run the script directly:

```bash
python3 hetzner_cleanup.py
```

The script will:
- Display all Hetzner documents found
- Show original vs cleaned sender names
- Report how many records were updated
- Provide visual feedback with checkmarks and emojis

## Database Requirements

- **Table**: Documents table with the following columns:
  - `id` - Primary key
  - `sender` - Sender name field (target for cleanup)
- **Engine**: Async SQLAlchemy engine configured
- **Permissions**: Read and write access to Documents table

## Example Output

```
Found 5 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

ðŸŽ‰ Successfully fixed 1 Hetzner invoice sender names!
```

## Notes and Considerations

- **Safety**: The script only updates records where changes are detected
- **Backup**: Consider backing up the database before running
- **Path**: Script assumes `/app` contains the backend modules
- **Error Handling**: JSON parsing errors are gracefully handled
- **Case Sensitivity**: Uses case-insensitive search for "hetzner"
- **Transaction**: All changes are committed in a single transaction

## Potential Improvements

- Add dry-run mode to preview changes without committing
- Include more sophisticated name extraction logic
- Add logging instead of print statements
- Include error handling for database connection issues
- Add command-line arguments for filtering criteria