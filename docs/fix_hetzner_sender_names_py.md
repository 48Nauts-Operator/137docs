<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Hetzner Invoice Sender Name Cleanup Script

## Overview

This Python script is designed to fix and clean up sender names in Hetzner invoice documents stored in a database. The script specifically targets documents where the sender field contains JSON strings instead of clean company names, converting them to a readable format like "Hetzner Online GmbH".

## Purpose

- **Problem**: Some Hetzner invoice documents have sender fields containing JSON data instead of clean company names
- **Solution**: Parse JSON strings and extract meaningful company names, or clean up existing string data
- **Target**: Documents in the database with sender names containing "Hetzner"

## Key Components

### Functions

#### `extract_sender_name(sender_data)`

Extracts and cleans company names from various sender data formats.

**Parameters:**
- `sender_data`: The raw sender data (string, JSON string, or other format)

**Returns:**
- Clean company name as a string

**Logic:**
- Handles already clean strings by returning them as-is
- Detects JSON strings (starting with `{` and ending with `}`)
- Attempts to parse JSON and extract company names from common fields:
  - `name`
  - `company` 
  - `sender`
  - `company_name`
- Falls back to the first non-empty string value if no standard name field exists
- Gracefully handles JSON parsing errors

#### `fix_hetzner_sender_names()` (async)

Main function that processes all Hetzner documents in the database.

**Workflow:**
1. Connects to the database using async session
2. Queries for all documents with sender names containing "Hetzner" (case-insensitive)
3. Processes each document to clean the sender name
4. Updates documents where changes are needed
5. Commits changes to the database
6. Provides detailed console output showing progress

## Database Integration

### Dependencies
- **SQLAlchemy**: Async ORM for database operations
- **Database Models**: Uses `Document` model from `app.models`
- **Database Engine**: Connects via `async_engine` from `app.database`

### Database Operations
```python
# Query for Hetzner documents
select(Document).where(Document.sender.ilike('%hetzner%'))

# Update sender names
update(Document).where(Document.id == doc.id).values(sender=cleaned_sender)
```

## Usage

### Running the Script
```bash
python3 hetzner_invoice_fix.py
```

### Prerequisites
- Database connection configured in `/app/database.py`
- Document model available in `/app/models.py`
- Appropriate database permissions for read/write operations

## Output Example

```
Found 15 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  âœ… Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  âœ“ Already clean

ðŸŽ‰ Successfully fixed 8 Hetzner invoice sender names!
```

## Important Notes

### Safety Features
- **Non-destructive**: Only updates documents that actually need changes
- **Detailed logging**: Shows before/after states for transparency
- **Transaction safety**: Uses database transactions with commit/rollback capability

### Error Handling
- Graceful JSON parsing with fallback to original string
- Database session management with proper async context
- Handles various data types and edge cases

### Recommendations
- **Backup first**: Always backup your database before running cleanup scripts
- **Test environment**: Run on a test database first to verify behavior
- **Monitor output**: Review the console output to ensure expected changes
- **Scheduling**: Consider running periodically if new problematic data is regularly imported

## Dependencies

```python
import asyncio      # Async execution
import sys          # Path manipulation
import json         # JSON parsing
import re           # Regular expressions (imported but not used)
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
```

## File Structure Requirements

The script expects the following application structure:
```
/app/
â”œâ”€â”€ database.py     # Contains async_engine
â”œâ”€â”€ models.py       # Contains Document model
â””â”€â”€ [other files]
```