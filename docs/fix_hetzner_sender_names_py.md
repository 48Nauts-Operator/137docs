<!-- Auto-generated by Claude on 2025-06-08 06:13 -->

# Hetzner Invoice Sender Name Fixer

## Overview

This script is a database maintenance utility designed to clean up corrupted sender names in Hetzner invoice records. The main issue it addresses is when sender names contain JSON strings instead of clean company names, replacing them with properly formatted "Hetzner Online GmbH" or extracted company names.

## Purpose

- **Problem**: Hetzner invoice records in the database have sender fields containing JSON strings instead of clean company names
- **Solution**: Parse JSON data to extract the actual company name and update the database records
- **Target**: Specifically focuses on documents from Hetzner (case-insensitive search)

## Key Functions

### `extract_sender_name(sender_data)`

Extracts and cleans company names from various data formats.

**Parameters:**
- `sender_data`: Raw sender data (string, JSON, or other format)

**Returns:**
- Clean company name as a string

**Logic:**
1. Handles empty/null data
2. Detects JSON-formatted strings (starts with `{`, ends with `}`)
3. Attempts to parse JSON and extract name from common fields:
   - `name`
   - `company` 
   - `sender`
   - `company_name`
4. Falls back to first non-empty string value if no standard name field found
5. Returns cleaned string for non-JSON data

```python
# Example usage
clean_name = extract_sender_name('{"company": "Hetzner Online GmbH", "id": 123}')
# Returns: "Hetzner Online GmbH"
```

### `fix_hetzner_sender_names()`

Main async function that processes and fixes Hetzner invoice sender names in the database.

**Process:**
1. Queries all documents with "hetzner" in the sender field (case-insensitive)
2. For each document:
   - Extracts clean sender name
   - Compares with original
   - Updates database if changes needed
3. Commits all changes in a single transaction
4. Provides detailed console output showing progress

## Database Operations

- **Query**: Uses `ILIKE` for case-insensitive search of Hetzner documents
- **Update**: Bulk updates using SQLAlchemy's `update()` statement
- **Transaction**: All changes committed together for data consistency

## Dependencies

- `asyncio`: Async/await support
- `sqlalchemy`: Database ORM with async support
- `json`: JSON parsing
- `re`: Regular expressions (imported but not used)

## Usage

```bash
python3 hetzner_sender_fix.py
```

## Output Example

```
Found 15 Hetzner documents to check:

Document ID 123:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  ‚úÖ Fixed!

Document ID 124:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  ‚úì Already clean

üéâ Successfully fixed 8 Hetzner invoice sender names!
```

## Notes and Suggestions

### ‚ö†Ô∏è Important Considerations

- **Backup First**: Always backup your database before running data modification scripts
- **Test Environment**: Run in a test environment first to verify behavior
- **Single Use**: This appears to be a one-time fix script, not meant for regular execution

### üîß Potential Improvements

1. **Add Dry Run Mode**: 
   ```python
   # Add a --dry-run flag to preview changes without committing
   ```

2. **Better Error Handling**:
   ```python
   try:
       await session.commit()
   except Exception as e:
       await session.rollback()
       print(f"Error: {e}")
   ```

3. **Logging**: Replace print statements with proper logging for production use

4. **Configuration**: Make the target company name configurable rather than hardcoded

### üìã Code Quality Notes

- The `re` import is unused and can be removed
- Consider adding type hints for better code documentation
- The script assumes the database schema and connection are properly configured
- Path manipulation (`sys.path.insert`) suggests this is part of a larger application structure