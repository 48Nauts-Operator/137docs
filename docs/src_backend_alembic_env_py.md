<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Alembic Environment Configuration (Async)

## Overview

This file serves as the **Alembic environment configuration** for handling database migrations in an asynchronous Python application. It's a modified version of the standard Alembic `env.py` file that has been adapted to work with async SQLAlchemy operations.

## Purpose

- Configure Alembic for database schema migrations
- Support both offline and online migration modes
- Handle asynchronous database connections using SQLAlchemy's async engine
- Integrate with the application's configuration and models

## Key Components

### Imports and Path Configuration

```python
# Ensure project root is on PYTHONPATH so `import app` works
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app.models import Base
from app.config import settings
```

- Dynamically adds the project root to Python path
- Imports the SQLAlchemy Base model and application settings
- Uses `# noqa: E402` to suppress linting warnings for imports after path manipulation

### Configuration Setup

```python
config = context.config
config.set_main_option('sqlalchemy.url', settings.DATABASE_URL or f"sqlite+aiosqlite:///{settings.DATABASE_PATH}")
target_metadata = Base.metadata
```

- Sets up the database URL from application settings
- Falls back to SQLite with async driver if no DATABASE_URL is provided
- Configures target metadata for autogenerate features

## Core Functions

### `run_migrations_offline()`

**Purpose**: Executes migrations without a live database connection

- Uses literal SQL binds
- Suitable for generating SQL scripts
- Runs synchronously

### `run_migrations_online()`

**Purpose**: Executes migrations with an active database connection

- Creates an async engine using `async_engine_from_config()`
- Uses `NullPool` to avoid connection pooling issues during migrations
- Handles async operations properly with `asyncio.run()`

### `do_run_migrations(connection)`

**Purpose**: Helper function that performs the actual migration execution

- Configures the Alembic context with the provided connection
- Runs within a transaction context

## Async Implementation Details

The key difference from a standard Alembic environment is the async handling:

```python
async def run_async_migrations():
    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

asyncio.run(run_async_migrations())
```

This pattern:
- Creates an async database connection
- Uses `run_sync()` to execute the synchronous Alembic operations within the async context
- Properly manages connection lifecycle

## Usage Notes

### Requirements
- This configuration requires an async-compatible SQLAlchemy setup
- The application must use SQLAlchemy's async engine and sessions
- Alembic version should support async operations

### Configuration Dependencies
- Depends on `app.models.Base` for metadata
- Requires `app.config.settings` for database configuration
- Expects either `DATABASE_URL` or `DATABASE_PATH` in settings

### Migration Commands
Run standard Alembic commands from the directory containing this file:
```bash
alembic upgrade head
alembic revision --autogenerate -m "description"
alembic downgrade -1
```

## Important Considerations

⚠️ **Path Management**: The sys.path manipulation assumes a specific project structure where this file is one level below the app directory.

⚠️ **Database URL Format**: Ensure your `DATABASE_URL` uses async-compatible drivers (e.g., `postgresql+asyncpg://` instead of `postgresql://`).

⚠️ **Connection Pooling**: Uses `NullPool` to prevent connection pool issues during migrations, which is recommended for migration scripts.

## Troubleshooting

- If imports fail, verify the project structure matches the path manipulation logic
- For connection issues, check that the database URL uses appropriate async drivers
- Ensure all required dependencies (asyncpg, aiosqlite, etc.) are installed