<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Migration: Tenant Profile Fields

## Overview

This file is an **Alembic database migration script** that adds tenant profile fields to the Entity model. Alembic is a database migration tool for SQLAlchemy that allows you to version and manage database schema changes over time.

## Purpose

The migration enhances the database schema by:
- Adding comprehensive address and profile fields to the `entities` table
- Adding a default entity flag to the `user_entities` relationship table
- Supporting multi-tenant functionality with detailed tenant profiles

## Migration Details

### Revision Information
- **Revision ID**: `20250528_tenant_profile`
- **Previous Revision**: `20250525_llm_config`
- **Created**: 2025-05-28

## Schema Changes

### `entities` Table Modifications

The migration adds the following columns to the `entities` table:

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `alias` | String(100) | NOT NULL | 'Default' | Display name for the entity |
| `street` | String(255) | NULL | - | Street address |
| `house_number` | String(20) | NULL | - | House/building number |
| `apartment` | String(50) | NULL | - | Apartment/unit number |
| `area_code` | String(20) | NULL | - | Postal/ZIP code |
| `county` | String(100) | NULL | - | County/region |
| `country` | String(100) | NULL | - | Country |
| `is_active` | Boolean | NULL | true | Entity status flag |
| `updated_at` | DateTime | NULL | CURRENT_TIMESTAMP | Last modification timestamp |

### `user_entities` Table Modifications

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `is_default` | Boolean | NULL | false | Marks the default entity for a user |

## Key Functions

### `upgrade()`
- **Purpose**: Applies the migration changes to the database
- **Actions**: 
  - Adds new columns to both `entities` and `user_entities` tables
  - Sets appropriate default values and constraints
- **Usage**: Called when migrating forward

### `downgrade()`
- **Purpose**: Reverts the migration changes
- **Actions**: 
  - Removes all added columns in reverse order
  - Restores the database to the previous state
- **Usage**: Called when rolling back the migration

## Implementation Notes

### Batch Operations
```python
with op.batch_alter_table('entities', schema=None) as batch_op:
    batch_op.add_column(...)
```
- Uses batch operations for better compatibility with SQLite and other databases
- Ensures atomic execution of multiple column additions

### Default Values
- `alias` has a mandatory default of 'Default' to ensure existing records remain valid
- `is_active` defaults to `true` for new entities
- `updated_at` uses database-level `CURRENT_TIMESTAMP`
- `is_default` defaults to `false` for user-entity relationships

## Suggestions and Best Practices

### üîç **Data Validation**
Consider adding application-level validation for:
- Country codes (use ISO standards)
- Address format validation
- Postal code format per country

### üöÄ **Performance Considerations**
- Consider adding indexes on frequently queried fields:
  ```sql
  CREATE INDEX idx_entities_alias ON entities(alias);
  CREATE INDEX idx_entities_is_active ON entities(is_active);
  CREATE INDEX idx_user_entities_is_default ON user_entities(is_default);
  ```

### üõ°Ô∏è **Security Notes**
- Ensure proper sanitization of address fields to prevent injection attacks
- Consider data privacy regulations (GDPR) when storing address information

### üìù **Future Enhancements**
- Consider adding geolocation fields (latitude, longitude)
- Add support for multiple addresses per entity
- Implement address validation services integration

## Usage Example

After applying this migration, your Entity model might look like:

```python
class Entity(db.Model):
    # ... existing fields ...
    alias = db.Column(db.String(100), nullable=False, default='Default')
    street = db.Column(db.String(255))
    house_number = db.Column(db.String(20))
    apartment = db.Column(db.String(50))
    area_code = db.Column(db.String(20))
    county = db.Column(db.String(100))
    country = db.Column(db.String(100))
    is_active = db.Column(db.Boolean, default=True)
    updated_at = db.Column(db.DateTime, default=db.func.current_timestamp())
```