<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Processing Rules Database Migration

## Overview

This is an Alembic database migration file that creates a new `processing_rules` table for document automation functionality. The migration adds infrastructure to store and manage automated processing rules that can be applied to documents based on various criteria.

## Migration Details

- **Revision ID**: `20250530_processing_rules`
- **Previous Revision**: `20250529_final_cleanup`
- **Created**: 2025-05-30
- **Purpose**: Add processing rules table for document automation

## Database Schema Changes

### New Table: `processing_rules`

The migration creates a comprehensive table to store document processing rules with the following structure:

#### Core Fields
- **`id`** (Integer, Primary Key): Unique identifier for each rule
- **`name`** (String, 255 chars, Required): Human-readable name for the rule
- **`description`** (Text, Optional): Detailed description of the rule's purpose

#### Matching Criteria
- **`vendor`** (String, 255 chars, Optional): Vendor identifier for rule targeting
- **`preferred_tenant_id`** (Integer, Foreign Key): Links to `entities.id` table

#### Rule Logic
- **`conditions`** (Text, Required): JSON string containing rule matching conditions
- **`actions`** (Text, Required): JSON string defining actions to execute when conditions are met

#### Rule Management
- **`priority`** (Integer, Default: 0): Execution priority for rule ordering
- **`enabled`** (Boolean, Default: True): Active/inactive status toggle

#### Analytics & Tracking
- **`matches_count`** (Integer, Default: 0): Counter for rule usage statistics
- **`last_matched_at`** (DateTime, Optional): Timestamp of most recent rule execution

#### Audit Trail
- **`created_at`** (DateTime): Auto-generated creation timestamp
- **`updated_at`** (DateTime): Auto-generated modification timestamp

### Database Indexes

The migration creates the following indexes for optimal query performance:

```sql
-- Performance indexes
ix_processing_rules_id       -- Primary key index
ix_processing_rules_vendor   -- Vendor-based lookups
ix_processing_rules_priority -- Rule ordering queries
ix_processing_rules_enabled  -- Active rule filtering
```

## Functions

### `upgrade()`
Creates the `processing_rules` table and associated indexes. This function:
- Defines the complete table schema
- Establishes foreign key relationship to `entities` table
- Creates performance optimization indexes
- Sets appropriate defaults and constraints

### `downgrade()`
Safely removes all changes made by the upgrade function:
- Drops all indexes in reverse order
- Removes the `processing_rules` table
- Ensures clean rollback capability

## Usage Notes

### JSON Storage
The `conditions` and `actions` columns store JSON as text strings. Consider:
- Validating JSON structure at the application layer
- Using database JSON functions for complex queries
- Implementing proper serialization/deserialization

### Performance Considerations
- The migration includes strategic indexes for common query patterns
- Consider adding composite indexes if you frequently query multiple fields together
- Monitor query performance as rule counts grow

### Data Integrity
- Foreign key constraint ensures `preferred_tenant_id` references valid entities
- Consider adding check constraints for priority ranges
- Implement application-level validation for JSON fields

## Recommendations

1. **Add Validation**: Consider adding check constraints for:
   - Priority value ranges
   - JSON validation for conditions/actions fields

2. **Monitoring**: Implement logging around:
   - Rule execution frequency via `matches_count`
   - Performance impact of complex rules

3. **Maintenance**: Plan for:
   - Regular cleanup of disabled rules
   - Archiving of rule execution history
   - Performance monitoring as rule complexity increases

4. **Security**: Ensure proper access controls for:
   - Rule creation and modification
   - Sensitive tenant data access
   - JSON content validation to prevent injection