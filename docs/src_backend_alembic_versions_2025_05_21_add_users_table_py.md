<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Migration: Add Users Table

## Overview

This file is an **Alembic database migration** that creates a `users` table in the database. Alembic is a database migration tool for SQLAlchemy that allows you to version control your database schema changes.

## Purpose

- **Migration ID**: `2025_05_21_add_users_table`
- **Parent Migration**: `0001_baseline`
- **Created**: 2025-05-21
- **Objective**: Add a users table to support user authentication and authorization functionality

## Migration Details

### Revision Information

```python
revision = '2025_05_21_add_users_table'
down_revision = '0001_baseline'
branch_labels = None
depends_on = None
```

- **revision**: Unique identifier for this migration
- **down_revision**: The previous migration this one builds upon
- **branch_labels**: None (linear migration)
- **depends_on**: No external dependencies

## Functions

### `upgrade()`

Creates the `users` table with the following schema:

```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'viewer',
    hashed_password VARCHAR(255) NOT NULL,
    disabled BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
```

#### Table Schema

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | SERIAL | PRIMARY KEY | Auto-incrementing unique identifier |
| `username` | VARCHAR(50) | UNIQUE, NOT NULL | Unique username for login |
| `email` | VARCHAR(100) | UNIQUE, NOT NULL | User's email address |
| `full_name` | VARCHAR(100) | - | User's display name |
| `role` | VARCHAR(20) | NOT NULL, DEFAULT 'viewer' | User permission level |
| `hashed_password` | VARCHAR(255) | NOT NULL | Encrypted password storage |
| `disabled` | BOOLEAN | DEFAULT FALSE | Account status flag |
| `created_at` | TIMESTAMP | DEFAULT NOW() | Account creation timestamp |

### `downgrade()`

Removes the `users` table:

```python
def downgrade():
    op.execute("DROP TABLE IF EXISTS users;")
```

## Key Features

### Idempotency
- Uses `CREATE TABLE IF NOT EXISTS` and `DROP TABLE IF EXISTS`
- Safe to run multiple times without errors
- Prevents conflicts in deployment scenarios

### Raw SQL Implementation
- Uses `op.execute()` with raw SQL instead of SQLAlchemy ORM
- Provides direct control over table creation
- Enables use of PostgreSQL-specific features like `IF NOT EXISTS`

## Usage

### Apply Migration
```bash
alembic upgrade head
```

### Rollback Migration
```bash
alembic downgrade 0001_baseline
```

## Notes and Recommendations

### Security Considerations
- ✅ **Good**: Uses `hashed_password` field name, indicating passwords should be encrypted
- ⚠️ **Note**: Ensure password hashing is implemented in application code

### Design Decisions
- **Role-based Access**: Default role is 'viewer' for security
- **Soft Disable**: Uses `disabled` flag instead of hard deletion
- **Audit Trail**: Includes `created_at` timestamp for tracking

### Potential Improvements
- Consider adding indexes on frequently queried columns:
  ```sql
  CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
  CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
  ```
- Add updated_at timestamp for change tracking
- Consider adding password reset fields (reset_token, reset_expires)

### Prerequisites
- Requires previous migration `0001_baseline` to be applied
- Database must support PostgreSQL syntax (SERIAL, NOW())
- Alembic must be configured in the project