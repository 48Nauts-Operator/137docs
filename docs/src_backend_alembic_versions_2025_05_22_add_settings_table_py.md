<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Migration: Add Settings Table

## Overview

This is an Alembic database migration file that creates a `settings` table in the database. Alembic is a database migration tool for SQLAlchemy that allows developers to manage database schema changes over time in a version-controlled manner.

## Purpose

This migration adds a new `settings` table to store application configuration data, including file paths and operational state information.

## Migration Details

- **Revision ID**: `2025_05_22_add_settings_table`
- **Previous Revision**: `2025_05_22_expand_address_book`
- **Creation Date**: 2025-05-22

## Functions

### `upgrade()`

Creates the `settings` table with the following schema:

```sql
CREATE TABLE IF NOT EXISTS settings (
    id SERIAL PRIMARY KEY,
    inbox_path VARCHAR(255) NOT NULL,
    storage_root VARCHAR(255) NOT NULL,
    locked BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
```

**Table Structure:**
- `id`: Auto-incrementing primary key
- `inbox_path`: Required path to inbox directory (max 255 characters)
- `storage_root`: Required path to storage root directory (max 255 characters)
- `locked`: Boolean flag indicating if settings are locked (defaults to FALSE)
- `created_at`: Timestamp of record creation (auto-populated)
- `updated_at`: Timestamp of last update (auto-populated)

### `downgrade()`

Removes the `settings` table from the database:

```sql
DROP TABLE IF EXISTS settings;
```

## Usage

To apply this migration:
```bash
alembic upgrade head
```

To rollback this migration:
```bash
alembic downgrade -1
```

## Notes and Considerations

### âš ï¸ **Important Issues**

1. **Revision ID Mismatch**: The revision ID (`2025_05_22_add_settings_table`) indicates a May 22nd date, but the docstring references depending on a vectors table migration from May 24th. This creates a temporal inconsistency.

2. **Down Revision Inconsistency**: The `down_revision` points to `2025_05_22_expand_address_book`, but the docstring mentions `2025_05_24_add_vectors_table`. This needs to be corrected to maintain proper migration chain.

### ðŸ“ **Recommendations**

1. **Fix Revision Dependencies**: Ensure the `down_revision` matches the actual previous migration in your sequence.

2. **Consider Adding Constraints**: 
   - Add CHECK constraints for path validation
   - Consider adding unique constraints if only one settings record should exist

3. **Path Length**: The 255-character limit for paths might be insufficient for deeply nested directory structures. Consider increasing to 500+ characters.

4. **Updated At Trigger**: Consider adding a database trigger to automatically update the `updated_at` field when records are modified.

5. **Add Indexes**: If you'll be querying by `locked` status frequently, consider adding an index:
   ```sql
   CREATE INDEX idx_settings_locked ON settings(locked);
   ```

### ðŸ”§ **Suggested Improvements**

```python
def upgrade():
    op.execute(
        """
        CREATE TABLE IF NOT EXISTS settings (
            id SERIAL PRIMARY KEY,
            inbox_path VARCHAR(500) NOT NULL CHECK (LENGTH(inbox_path) > 0),
            storage_root VARCHAR(500) NOT NULL CHECK (LENGTH(storage_root) > 0),
            locked BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
            CONSTRAINT settings_singleton CHECK (id = 1)
        );
        """
    )
```

This adds path validation and ensures only one settings record can exist.