<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Migration: Vectors Table for ColPali Patch-ID Mapping

## Overview

This is an Alembic database migration file that creates a `vectors` table designed to support ColPali patch-ID mapping functionality. ColPali is typically used for document understanding and visual question answering, where documents are divided into patches for processing.

## Migration Details

- **Revision ID**: `20250524_vectors`
- **Previous Revision**: `20250524_user_disabled`
- **Created**: May 24, 2025
- **Purpose**: Store vector mappings for document patches in a ColPali system

## Database Schema Changes

### Table: `vectors`

The migration creates a new table with the following structure:

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | SERIAL | PRIMARY KEY | Auto-incrementing unique identifier |
| `doc_id` | INTEGER | NOT NULL, FOREIGN KEY | References `documents(id)` with cascade delete |
| `page` | INTEGER | NOT NULL | Page number within the document |
| `vector_ids` | TEXT | NOT NULL | Serialized vector identifiers (likely JSON or comma-separated) |

### Indexes

- **`ix_vectors_doc_id`**: Index on `doc_id` column for efficient document-based queries

## Functions

### `upgrade()`

Applies the migration by:
- Creating the `vectors` table with proper constraints
- Adding a foreign key relationship to the `documents` table
- Creating an index on `doc_id` for query optimization
- Using `IF NOT EXISTS` clauses for idempotent execution

### `downgrade()`

Reverses the migration by:
- Dropping the `vectors` table completely
- Using `IF EXISTS` clause to prevent errors if table doesn't exist

## Key Features

### Foreign Key Relationship
```sql
REFERENCES documents(id) ON DELETE CASCADE
```
- Maintains referential integrity with the `documents` table
- Automatically removes vector records when parent documents are deleted

### Performance Optimization
```sql
CREATE INDEX IF NOT EXISTS ix_vectors_doc_id ON vectors(doc_id);
```
- Optimizes queries that filter or join by document ID
- Essential for efficient document-based lookups

## Usage Notes

### ⚠️ Important Considerations

- **Data Format**: The `vector_ids` column stores data as TEXT, requiring application-level serialization/deserialization
- **Storage Efficiency**: Consider using JSON or JSONB (PostgreSQL) for structured vector ID storage
- **Scalability**: For large document collections, monitor index performance and consider partitioning

### 💡 Suggestions

1. **Data Validation**: Consider adding CHECK constraints to validate `page` numbers (e.g., `page > 0`)
2. **JSON Storage**: If using PostgreSQL, consider changing `vector_ids` to JSONB for better query capabilities
3. **Composite Index**: For queries filtering by both `doc_id` and `page`, consider adding:
   ```sql
   CREATE INDEX ix_vectors_doc_page ON vectors(doc_id, page);
   ```

## Example Usage Context

This table would typically be used in a ColPali system to:
- Map document pages to their corresponding vector embeddings
- Track patch-level representations for visual document understanding
- Enable efficient retrieval of vectors for specific document sections

```python
# Example query usage (conceptual)
# Get all vectors for a specific document
vectors = session.query(Vector).filter(Vector.doc_id == document_id).all()

# Get vectors for a specific page
page_vectors = session.query(Vector).filter(
    Vector.doc_id == doc_id, 
    Vector.page == page_number
).first()
```