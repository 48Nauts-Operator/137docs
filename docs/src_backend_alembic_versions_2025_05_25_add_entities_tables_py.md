<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Migration: Add Entities Tables and Columns

## Overview

This is an Alembic database migration file that introduces an entity management system to the application. The migration adds support for managing business entities (companies, organizations, etc.) and their relationships with users and documents.

**Migration Details:**
- **Revision ID:** `20250525_entities`
- **Previous Revision:** `20250524_vectors`
- **Created:** 2025-05-25

## Purpose

This migration implements a multi-entity architecture that allows:
- Multiple business entities to be managed within the application
- User-entity relationships with role-based access
- Document association with specific entities
- Terms of Service acceptance tracking

## Database Changes

### New Tables

#### 1. `entities` Table
Primary table for storing business entity information.

**Columns:**
- `id` (Integer, Primary Key) - Unique identifier
- `name` (String, 255 chars, NOT NULL) - Entity name
- `type` (String, 20 chars, Default: 'company') - Entity type classification
- `address_json` (Text, Nullable) - JSON-formatted address information
- `vat_id` (String, 50 chars, Nullable) - VAT identification number
- `iban` (String, 50 chars, Nullable) - International Bank Account Number
- `aliases` (PostgreSQL Array of Strings, Nullable) - Alternative names
- `created_at` (DateTime, Default: now()) - Creation timestamp

#### 2. `user_entities` Table
Junction table for many-to-many relationships between users and entities.

**Columns:**
- `user_id` (Integer, Primary Key, Foreign Key to `users.id`)
- `entity_id` (Integer, Primary Key, Foreign Key to `entities.id`)
- `role` (String, 20 chars, Default: 'owner') - User's role for the entity

### Modified Tables

#### `documents` Table
- **Added:** `entity_id` (Integer, Nullable, Foreign Key to `entities.id`)
- **Added:** Index on `entity_id` for query optimization

#### `settings` Table
- **Added:** `tos_accepted_at` (DateTime, Nullable) - Terms of Service acceptance timestamp

## Functions

### `upgrade()`
Applies the migration changes to add entity management capabilities:

```python
def upgrade():
    # Creates entities and user_entities tables
    # Adds entity_id column to documents with foreign key constraint
    # Adds tos_accepted_at column to settings
```

### `downgrade()`
Reverses all changes made in the upgrade function:

```python
def downgrade():
    # Removes all added columns and tables
    # Drops foreign key constraints and indexes
```

## Key Features

### Entity Management
- Support for different entity types (defaulting to 'company')
- Flexible address storage using JSON format
- Tax and banking information storage (VAT ID, IBAN)
- Alias support for alternative entity names

### User-Entity Relationships
- Many-to-many relationship between users and entities
- Role-based access control (default role: 'owner')
- Composite primary key for efficient lookups

### Document Association
- Documents can now be associated with specific entities
- Indexed for performance optimization
- Nullable to support existing documents without entities

## Notes and Suggestions

### ‚ö†Ô∏è Important Considerations

1. **PostgreSQL Dependency**: This migration uses PostgreSQL-specific features (ARRAY type). Ensure your database is PostgreSQL.

2. **Existing Data**: The `entity_id` column in `documents` is nullable, allowing existing documents to remain valid during migration.

3. **Foreign Key Names**: The migration uses `None` for foreign key constraint names, letting the database auto-generate them.

### üîß Recommendations

1. **Add Validation**: Consider adding check constraints for:
   - Entity type validation
   - VAT ID format validation
   - IBAN format validation

2. **Indexing**: Consider adding indexes on:
   - `entities.name` for name-based searches
   - `entities.type` for filtering by entity type
   - `entities.vat_id` for tax-related queries

3. **Data Migration**: Plan for migrating existing documents to appropriate entities after deployment.

### üí° Usage Examples

After migration, you can:
- Create business entities with complete information
- Assign multiple users to entities with different roles
- Associate documents with specific entities
- Track Terms of Service acceptance per user