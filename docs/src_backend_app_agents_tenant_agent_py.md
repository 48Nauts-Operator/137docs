<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Tenant Extraction and Auto-Assignment Agent

## Overview

The Tenant Extraction and Auto-Assignment Agent is a Python module designed to automatically analyze document content, extract recipient/tenant information, and assign documents to appropriate tenant profiles. This agent uses both AI-powered extraction (via LLM) and fallback rule-based extraction to identify document recipients.

## Purpose

- **Automated Document Processing**: Extracts recipient information from documents without manual intervention
- **Tenant Management**: Finds existing tenants or provides information for manual tenant creation
- **Document Assignment**: Automatically assigns documents to the correct tenant profiles
- **Multi-Strategy Extraction**: Uses LLM when available, falls back to rule-based extraction

## Main Classes

### `TenantExtractionAgent`

The primary class that orchestrates the entire tenant extraction and assignment process.

#### Constructor
```python
def __init__(self, db_session: AsyncSession)
```
- **Parameters**: 
  - `db_session`: Async SQLAlchemy database session
- **Initializes**: Repository instances and LLM service

#### Key Methods

##### `analyze_and_assign_tenant(document_id: int, user_id: int) -> Dict[str, Any]`

Main entry point that performs the complete analysis and assignment workflow.

**Parameters:**
- `document_id`: ID of the document to analyze  
- `user_id`: ID of the user who owns the document

**Returns:**
- Dictionary containing analysis results, assignment status, and extracted information

**Workflow:**
1. Retrieves document from database
2. Skips if document already has a valid recipient
3. Extracts tenant information using LLM or fallback methods
4. Validates extraction confidence (minimum 0.5)
5. Attempts to find matching existing tenant
6. Assigns document to tenant if match found

**Example Return Values:**
```python
# Success case
{
    "status": "success",
    "message": "Document assigned to tenant: John Doe",
    "tenant": {...},
    "extracted_info": {...},
    "confidence": 0.85,
    "action": "found"
}

# No match case
{
    "status": "no_match",
    "message": "Could not extract tenant information from document content"
}
```

## Extraction Methods

### LLM-Based Extraction

When LLM service is available, the agent uses sophisticated AI-powered extraction:

- **Smart Context Understanding**: Differentiates between sender and recipient information
- **Multi-Format Support**: Handles invoices, letters, legal documents
- **Structured Output**: Returns standardized JSON with confidence scores
- **Vendor Filtering**: Ignores common vendor names to focus on recipients

### Rule-Based Fallback Extraction

When LLM is unavailable, uses pattern matching:

- **Swiss Legal Documents**: Special patterns for Swiss legal terminology
- **Standard Patterns**: Common recipient indicators like "Bill To:", "Customer:"
- **Proper Noun Detection**: Identifies potential names from document text
- **Business Entity Recognition**: Detects company suffixes (GmbH, AG, Ltd, etc.)

## Important Features

### Security-First Design

```python
# NO AUTOMATIC TENANT CREATION
# Users must manually create tenants for security
if not match:
    return {
        "status": "no_match", 
        "message": "No matching tenant found. Please create tenant manually."
    }
```

### Confidence-Based Filtering

- Minimum confidence threshold of 0.5
- Higher confidence for complete extractions (0.9-1.0)
- Lower confidence for partial information (0.5-0.6)

### Robust Error Handling

- Multiple JSON parsing strategies for LLM responses  
- Graceful fallback between extraction methods
- Detailed logging for debugging
- Continues processing even on individual document failures

## Data Structure

### Extracted Tenant Information

```python
{
    "name": "Full legal name",
    "alias": "Short friendly name", 
    "type": "company" or "individual",
    "address": {
        "street": "Street name",
        "house_number": "House number",
        "apartment": "Apartment/unit",
        "area_code": "Postal code",
        "county": "State/province", 
        "country": "Country"
    },
    "contact": {
        "phone": "Phone number",
        "email": "Email address"
    },
    "business_info": {
        "vat_id": "VAT/Tax ID",
        "iban": "Bank account"
    },
    "confidence": 0.85
}
```

## Dependencies

- **SQLAlchemy**: Database ORM with async support
- **Logging**: Built-in Python logging
- **Re**: Regular expressions for pattern matching
- **JSON**: JSON parsing and manipulation
- **DiffLib**: Fuzzy string matching for tenant identification

## Usage Example

```python
# Initialize agent
agent = TenantExtractionAgent(db_session)

# Analyze and assign document
result = await agent.analyze_and_assign_tenant(
    document_id=123,
    user_id=456
)

if result["status"] == "success":
    print(f"Document assigned to: {result['tenant']['alias']}")
    print(f"Confidence: {result['confidence']}")
elif result["status"] == "no_match":
    print(f"No tenant match: {result['message']}")
```

## Notes and Recommendations

### Security Considerations
- **Manual Tenant Creation**: The agent deliberately does NOT create new tenants automatically to prevent security issues
- **High Matching Threshold**: Uses 0.8 similarity threshold for tenant matching to avoid incorrect assignments

### Performance Optimization
- **Content Truncation**: Limits document content to 4000 characters for LLM processing
- **Caching Strategy**: Consider implementing caching for frequently processed document types
- **Batch Processing**: Could be extended to process multiple documents simultaneously

### Monitoring and Debugging
- **Comprehensive Logging**: All major operations are logged with appropriate levels
- **Confidence Tracking**: Monitor confidence scores to tune extraction thresholds
- **Fallback Metrics**: Track LLM vs rule-based extraction success rates

### Future Enhancements
- **Learning Capability**: Could learn from user corrections to improve extraction
- **Custom Rules**: Allow users to define custom extraction patterns
- **Multi