<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Analytics Service Documentation

## Overview

The `AnalyticsService` class provides comprehensive analytics functionality for the Document Management System. It handles various document-related metrics, statistics, and reporting features including document counts, payment tracking, and trend analysis.

## Purpose

This service enables:
- **Document Statistics**: Count documents by type, status, and time periods
- **Financial Analytics**: Track invoice amounts and payment status
- **Trend Analysis**: Monitor document creation patterns over time
- **Due Date Management**: Identify upcoming due dates and overdue documents
- **Tag Distribution**: Analyze document categorization patterns

## Key Features

### Document Counting & Distribution
- Document count by type (invoice, contract, etc.)
- Document count by status (paid, unpaid, etc.)
- Time-based document analysis (monthly, daily patterns)

### Financial Analytics
- Invoice amount tracking by month
- Payment status summaries with percentages
- Overdue invoice identification

### Reporting & Insights
- Tag distribution analysis
- Day-of-week patterns
- Upcoming due date notifications

## Class Structure

### AnalyticsService

The main service class that handles all analytics operations.

```python
class AnalyticsService:
    def __init__(self, db: Session):
        """Initialize with database session (sync or async)"""
        self.db = db
```

## Core Methods

### Document Distribution Methods

#### `get_document_count_by_type()`
```python
async def get_document_count_by_type() -> List[Dict[str, Any]]
```
- **Purpose**: Groups documents by their type and returns counts
- **Returns**: List of dictionaries with `document_type` and `count` fields
- **Use Case**: Dashboard charts showing document type distribution

#### `get_document_count_by_status()`
```python
async def get_document_count_by_status() -> List[Dict[str, Any]]
```
- **Purpose**: Groups documents by status and returns counts
- **Returns**: List of dictionaries with `status` and `count` fields
- **Use Case**: Status overview for workflow management

### Time-Based Analytics

#### `get_document_count_by_month(months: int = 6)`
```python
async def get_document_count_by_month(months: int = 6) -> List[Dict[str, Any]]
```
- **Purpose**: Analyzes document creation trends over time
- **Parameters**: `months` - Number of months to analyze (default: 6)
- **Returns**: Monthly data with year, month, month_name, and count
- **Features**: 
  - Handles multiple date formats (ISO, European)
  - Falls back to `created_at` if `document_date` is invalid
  - Filters by date range

#### `get_invoice_amount_by_month(months: int = 6)`
```python
async def get_invoice_amount_by_month(months: int = 6) -> List[Dict[str, Any]]
```
- **Purpose**: Tracks invoice amounts over time
- **Parameters**: `months` - Number of months to analyze
- **Returns**: Monthly totals with amount and invoice count
- **Use Case**: Financial trend analysis and revenue tracking

### Payment & Financial Analytics

#### `get_payment_status_summary()`
```python
async def get_payment_status_summary() -> Dict[str, Any]
```
- **Purpose**: Comprehensive payment status overview
- **Returns**: Dictionary containing:
  - Total/paid/unpaid/overdue invoice counts
  - Corresponding amounts for each status
  - Percentage calculations
- **Features**: 
  - Handles both sync and async database sessions
  - Identifies overdue invoices using due date comparison
  - Calculates financial metrics

**Return Structure**:
```python
{
    "total_invoices": int,
    "paid_invoices": int,
    "unpaid_invoices": int,
    "overdue_invoices": int,
    "total_amount": float,
    "paid_amount": float,
    "unpaid_amount": float,
    "overdue_amount": float,
    "paid_percentage": float,
    "unpaid_percentage": float,
    "overdue_percentage": float
}
```

### Due Date Management

#### `get_upcoming_due_dates(days: int = 30)`
```python
def get_upcoming_due_dates(days: int = 30) -> List[Dict[str, Any]]
```
- **Purpose**: Identifies documents with approaching due dates
- **Parameters**: `days` - Lookahead period (default: 30 days)
- **Returns**: List of documents with due date information
- **Use Case**: Proactive payment reminders and deadline management

### Tag & Pattern Analysis

#### `get_tag_distribution()`
```python
def get_tag_distribution() -> List[Dict[str, Any]]
```
- **Purpose**: Analyzes how documents are tagged/categorized
- **Returns**: Tag names with colors and usage counts
- **Use Case**: Understanding document categorization patterns

#### `get_document_count_by_day_of_week()`
```python
def get_document_count_by_day_of_week() -> List[Dict[str, Any]]
```
- **Purpose**: Identifies weekly patterns in document creation
- **Returns**: Day names with document counts
- **Use Case**: Workflow optimization and resource planning

## Compatibility Methods

The service includes several async wrapper methods for backward compatibility with existing FastAPI routes:

- `get_document_type_distribution()`
- `get_payment_status_distribution()`
- `get_monthly_document_count(year: int)`
- `get_monthly_invoice_amount(year: int)`
- `get_summary_metrics()`

## Technical Notes

### Database Compatibility
- **Dual Mode Support**: Handles both synchronous and asynchronous database sessions
- **Session Detection**: Uses `hasattr(self.db, 'execute')` to determine session type
- **Query Adaptation**: Automatically adapts queries based on session type

### Date Handling
- **Multiple Formats**: Supports ISO format (`YYYY-MM-DD`) and European format (`DD.MM.YYYY`)
- **Fallback Strategy**: Uses `created_at` when `document_date` is invalid
- **Error Resilience**: Gracefully handles date parsing errors

### Performance Considerations
- **Manual Processing**: Some complex date