<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# LLM Router API Documentation

## Overview

This module provides a FastAPI router that handles Large Language Model (LLM) integration for document processing and analysis. It manages LLM configuration, document processing, tenant extraction, and various AI-powered document analysis features.

## Purpose

The LLM router serves as the API layer for:
- **Configuration Management**: Managing LLM provider settings and model configurations
- **Document Processing**: AI-powered document analysis, tagging, and enrichment
- **Tenant Extraction**: Automatic tenant identification and assignment for documents
- **Batch Operations**: Processing multiple documents efficiently

## Key Dependencies

```python
from fastapi import APIRouter, Depends, Request, HTTPException, Form
from sqlalchemy.ext.asyncio import AsyncSession
from app.services.llm_service import LLMServiceFactory
from app.agents.tenant_agent import TenantExtractionAgent
```

## API Endpoints

### Configuration Endpoints

#### `GET /config`
**Purpose**: Retrieve current LLM configuration
- Creates default configuration if none exists
- Returns complete LLM settings including provider, models, and performance parameters

#### `PUT /config`
**Purpose**: Update LLM configuration settings
- **Input**: Form data with configuration fields
- **Supported Fields**:
  - Provider settings (`provider`, `api_key`, `api_url`)
  - Model configurations (`model_tagger`, `model_enricher`, `model_analytics`, `model_responder`)
  - Boolean flags (`enabled`, `auto_tagging`, `auto_enrichment`)
  - Performance settings (`max_retries`, `batch_size`, `concurrent_tasks`)
  - Confidence thresholds (`min_confidence_tagging`, `min_confidence_entity`)

#### `POST /test-connection`
**Purpose**: Test connectivity to LLM provider
- Validates provider credentials and connection
- Returns connection status and error details if applicable

### Document Processing Endpoints

#### `POST /process-document/{document_id}`
**Purpose**: Process a single document with LLM
- **Parameters**:
  - `document_id`: Target document ID
  - `force`: Optional boolean to force reprocessing
- Performs comprehensive document analysis including tagging and enrichment

#### `POST /batch-process`
**Purpose**: Process multiple documents in batch
- **Input**: Form data with comma-separated document IDs
- **Features**:
  - Efficient batch processing
  - Force reprocessing option
  - Error handling for individual documents

#### `POST /enrich-field/{document_id}`
**Purpose**: Enrich a specific field of a document
- **Parameters**:
  - `document_id`: Target document ID
  - `field_name`: Name of field to enrich
- Targeted field enhancement using LLM

#### `POST /suggest-tags/{document_id}`
**Purpose**: Generate tag suggestions for a document
- Returns AI-generated tags based on document content
- Useful for content categorization and organization

#### `POST /analyze/{document_id}`
**Purpose**: Perform comprehensive document analysis
- Returns detailed analysis including content insights and metadata
- Leverages LLM analytics model for deep document understanding

### Tenant Management Endpoints

#### `POST /extract-tenant/{document_id}`
**Purpose**: Extract and assign tenant information from document
- **Authentication**: Requires current user authentication
- Uses `TenantExtractionAgent` for intelligent tenant identification
- Automatically assigns identified tenant to document

#### `POST /batch-extract-tenants`
**Purpose**: Batch extract and assign tenants for multiple documents
- **Input Options**:
  - Specific document IDs list
  - `all_documents`: Process all unassigned documents
- **Features**:
  - Batch processing with configurable batch size
  - Progress tracking and detailed results
  - Error handling per document
  - Automatic database commits per batch

#### `POST /auto-assign-unmatched`
**Purpose**: Automatically assign unmatched documents to tenants
- Identifies documents with generic recipients
- **Target Patterns**:
  - Empty or null recipients
  - Generic company suffixes (Inc., Ltd., GmbH, AG)
  - "Your Company" placeholder text
- Processes up to 50 documents per request

### Status Endpoint

#### `GET /status`
**Purpose**: Get comprehensive LLM service status
- **Returns**:
  - Service enablement status
  - Current provider and model configurations
  - Performance settings
  - Feature flags (auto-tagging, auto-enrichment)

## Key Classes and Functions

### LLMServiceFactory
- **Purpose**: Factory pattern for creating LLM service instances
- **Methods**:
  - `create_document_service()`: Creates document processing service
  - `create_llm_service()`: Creates general LLM service

### TenantExtractionAgent
- **Purpose**: Specialized agent for tenant identification and assignment
- **Key Method**: `analyze_and_assign_tenant()`: Analyzes document content to identify and assign appropriate tenant

### Repository Classes
- **LLMConfigRepository**: Manages LLM configuration persistence
- **DocumentRepository**: Handles document data operations

## Error Handling

The router implements comprehensive error handling:
- **HTTP Exceptions**: Proper status codes and error messages
- **Logging**: Detailed error logging for debugging
- **Database Rollbacks**: Automatic transaction rollback on errors
- **Validation**: Input validation with meaningful error responses

## Best Practices and Notes

### Configuration Management
- Always test connections after configuration changes
- Use environment variables for sensitive API keys
- Implement proper backup provider configurations

### Batch Processing
- **Recommended Batch Size**: 10 documents per batch for optimal performance
- Monitor memory usage during large batch operations
- Implement proper progress tracking for long-running operations

### Performance Considerations
- Configure `concurrent_tasks` based on LLM provider rate limits
- Use appropriate `retry_delay` to avoid overwhelming external APIs
- Monitor and adjust confidence thresholds based on accuracy requirements

### Security Notes
- All endpoints require proper database session management
- Tenant operations require user authentication
- API keys should be stored securely and never logged

### Suggestions for Enhancement

1. **Add Pagination**: Implement pagination for batch operations on large document sets
2. **Progress Tracking**: Add WebSocket support for real-time batch processing updates
3. **Caching**: Implement response caching for frequently accessed configurations
4. **Metrics**: Add endpoint for processing statistics and performance metrics
5. **