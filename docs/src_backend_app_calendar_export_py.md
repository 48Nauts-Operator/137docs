<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Calendar Export Service Documentation

## Overview

This module provides calendar export functionality for the Document Management System. It allows exporting documents with due dates as calendar events in ICS format, making it easy to integrate document deadlines with external calendar applications.

## Purpose

- Export documents with due dates as calendar events
- Generate ICS files for calendar integration
- Filter documents by upcoming due dates
- Provide both synchronous and asynchronous methods for different use cases

## Dependencies

- `ics`: Calendar creation and ICS file generation
- `sqlalchemy`: Database operations
- `app.models.Document`: Document model for database queries

## Classes

### CalendarService

The main service class that handles calendar generation and export functionality.

#### Constructor

```python
def __init__(self, db: Session)
```

- **Parameters**: 
  - `db`: SQLAlchemy database session

#### Key Methods

##### `generate_calendar(document_ids: Optional[List[int]] = None) -> Calendar`

Generates a calendar with events for documents that have due dates.

- **Parameters**:
  - `document_ids`: Optional list of specific document IDs to include
- **Returns**: Calendar object with document events
- **Behavior**: 
  - Queries all documents with due dates if no IDs specified
  - Creates all-day events for each document's due date
  - Includes document details in event description

##### `generate_ics_file(document_ids: Optional[List[int]] = None) -> str`

Generates ICS file content as a string.

- **Parameters**:
  - `document_ids`: Optional list of specific document IDs to include
- **Returns**: ICS file content as string
- **Use Case**: Direct file download or saving

##### `generate_upcoming_due_dates_calendar(days: int = 30) -> Calendar`

Creates a calendar focused on upcoming due dates within a specified timeframe.

- **Parameters**:
  - `days`: Number of days ahead to check (default: 30)
- **Returns**: Calendar object with upcoming events
- **Features**:
  - Excludes documents with 'paid' status
  - Orders events by due date
  - Filters by date range

##### `generate_upcoming_due_dates_ics(days: int = 30) -> str`

Generates ICS content for upcoming due dates.

- **Parameters**:
  - `days`: Number of days ahead to check (default: 30)
- **Returns**: ICS file content as string

#### Async Helper Methods

##### `get_events_for_month(db, month: int, year: int)`

Returns document events for a specific month and year.

```python
async def get_events_for_month(self, db, month: int, year: int)
```

- **Parameters**:
  - `db`: Database session
  - `month`: Month number (1-12)
  - `year`: Year
- **Returns**: List of event dictionaries with id, title, due_date, status

##### `get_events_for_date(db, date_str: str)`

Returns events for a specific date.

```python
async def get_events_for_date(self, db, date_str: str)
```

- **Parameters**:
  - `db`: Database session  
  - `date_str`: Date in YYYY-MM-DD format
- **Returns**: List of event dictionaries

### CalendarExportService

```python
class CalendarExportService(CalendarService):
    pass
```

Backward-compatibility alias for `CalendarService`. Use `CalendarService` for new code.

## Event Properties

Each calendar event includes:

- **Name**: `"{document_type}: {title}"`
- **Description**: 
  - Sender information
  - Amount (if applicable)
  - Status
  - Document ID
- **Date**: All-day event on the due date

## Usage Examples

### Basic Calendar Generation

```python
from sqlalchemy.orm import Session
from calendar_service import CalendarService

# Initialize service
calendar_service = CalendarService(db_session)

# Generate calendar for all documents
calendar = calendar_service.generate_calendar()

# Generate calendar for specific documents
calendar = calendar_service.generate_calendar([1, 2, 3])
```

### ICS File Export

```python
# Generate ICS content
ics_content = calendar_service.generate_ics_file()

# Save to file
with open('documents.ics', 'w') as f:
    f.write(ics_content)
```

### Upcoming Due Dates

```python
# Get next 7 days
upcoming_calendar = calendar_service.generate_upcoming_due_dates_calendar(7)

# Get next 60 days as ICS
ics_content = calendar_service.generate_upcoming_due_dates_ics(60)
```

## Notes and Suggestions

### ‚ö†Ô∏è Important Considerations

1. **Database Session Management**: Ensure proper database session lifecycle management
2. **Error Handling**: Consider adding try-catch blocks for database operations
3. **Performance**: For large datasets, consider pagination or async processing

### üîß Potential Improvements

1. **Add timezone support** for more accurate event timing
2. **Implement caching** for frequently accessed calendars
3. **Add event categories** or colors based on document type
4. **Include reminder settings** for calendar events
5. **Add validation** for input parameters

### üìù Code Quality Notes

- The logging configuration should ideally be centralized
- Consider using dependency injection for better testability
- The async methods mix concerns - consider separating calendar logic from API response formatting

### üöÄ Usage Tips

- Use `generate_upcoming_due_dates_calendar()` for dashboard widgets
- Cache generated calendars when possible to improve performance
- Consider implementing incremental updates for large document sets