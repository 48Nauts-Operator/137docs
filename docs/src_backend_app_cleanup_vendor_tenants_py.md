<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Vendor Tenant Cleanup Script

## Overview

This script is a database cleanup utility designed to remove vendor companies that were incorrectly created as tenant entities in the system. The script identifies vendor companies that should be classified as senders/vendors rather than recipients/tenants and removes them from the tenant database.

## Purpose

- **Problem**: Vendor companies were mistakenly added as tenant entities instead of being properly classified as vendors/senders
- **Solution**: Identifies and removes these incorrect tenant entries while preserving data integrity
- **Result**: Cleans up the database to ensure proper entity classification

## Key Features

- Identifies vendor companies in the tenant database using predefined company names
- Finds documents that reference these incorrect tenant entities
- Safely removes vendor tenant entities while resetting affected document recipients
- Provides detailed logging of all operations performed

## Important Functions

### `cleanup_vendor_tenants()`

The main asynchronous function that performs the cleanup operation.

**Workflow:**
1. **Search Phase**: Identifies vendor companies incorrectly stored as tenants
2. **Analysis Phase**: Finds documents using these vendor tenants as recipients  
3. **Cleanup Phase**: Resets affected documents and removes vendor tenant entities
4. **Commit Phase**: Saves all changes to the database

**Key Operations:**
- Uses case-insensitive pattern matching (`ILIKE`) to find vendor entities
- Searches both `name` and `alias` fields for comprehensive coverage
- Resets document recipient fields to `None` for re-processing
- Provides detailed progress logging with emoji indicators

## Predefined Vendor Companies

The script targets the following known vendor companies:

```python
vendor_names = [
    "Hetzner Online GmbH", "Hetzner",
    "Team Blockonauts", "Blockonauts", 
    "Impact Labs", "21 Impact Labs AG",
    "Chainstack Pte.", "Chainstack",
    "GitBook", "GitBook (Company)",
    "Digital Ocean", "DigitalOcean",
    "Candoo Labs", "Candoo Labs (Company)",
    "Validity Labs", "Validity Labs (Company)",
    "DAT AG", "DAT AG (Company)"
]
```

## Database Models Used

- **`Entity`**: Represents tenant entities with `name` and `alias` fields
- **`Document`**: Represents documents with a `recipient` field that may reference tenant aliases

## Usage

### Prerequisites
- Python 3.7+
- SQLAlchemy with async support
- Access to the application database

### Running the Script

```bash
python cleanup_vendor_tenants.py
```

### Expected Output

```
üîç Searching for vendor companies incorrectly created as tenants...
Found 3 vendor companies incorrectly created as tenants:
  - ID: 123, Name: Hetzner Online GmbH, Alias: hetzner
  - ID: 124, Name: GitBook, Alias: gitbook

üìã Found 5 documents using vendor tenants as recipients:
  - Doc ID: 456, Title: Monthly Invoice from Hetzner..., Using: hetzner

üîÑ Resetting recipient field for 5 documents...
  ‚úì Reset document 456

üóëÔ∏è  Removing 3 vendor tenant entities...
  ‚úì Removed tenant: Hetzner Online GmbH (hetzner)

üéâ Cleanup completed successfully!
   - Removed 3 vendor tenant entities
   - Reset 5 document recipients for re-processing

üí° Tip: Run 'Run Batch Processing' in Settings > Automation to re-process these documents
```

## Important Notes

### ‚ö†Ô∏è Safety Considerations

- **Backup Database**: Always backup your database before running cleanup scripts
- **Test Environment**: Run in a test environment first to verify expected behavior
- **Review Output**: Carefully review the list of entities to be removed before proceeding

### üîÑ Post-Cleanup Actions

After running this script:

1. **Re-process Documents**: Use the application's batch processing feature to re-classify the affected documents
2. **Verify Results**: Check that documents are now properly categorized with correct vendor/sender information
3. **Monitor**: Watch for any issues with document processing after the cleanup

### üõ†Ô∏è Customization

To add more vendor companies to the cleanup list:

```python
vendor_names = [
    # Existing vendors...
    "New Vendor Company",
    "Another Vendor Ltd"
]
```

## Error Handling

The script uses async database sessions with proper transaction management. If an error occurs:

- Database changes are automatically rolled back
- Error messages will be displayed in the console
- The script will exit with an error code

## Dependencies

- `asyncio`: For asynchronous operation
- `sqlalchemy.ext.asyncio`: For async database operations
- `app.database`: Application database engine
- `app.models`: Entity and Document model definitions