<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Module Documentation

## Overview

This module provides database connection and session management for the Document Management System. It handles asynchronous database operations using SQLAlchemy's async capabilities and provides dependency injection for FastAPI applications.

## Purpose

- **Database Connection Management**: Establishes and manages asynchronous database connections
- **Session Handling**: Provides session factory and dependency injection for database operations
- **Configuration Flexibility**: Supports both explicit database URLs and local SQLite fallback
- **FastAPI Integration**: Offers database session dependency for FastAPI route handlers

## Key Components

### Database URL Configuration

The module intelligently handles database URL configuration with fallback support:

```python
if settings.DATABASE_URL:
    ASYNC_DATABASE_URL = settings.DATABASE_URL
else:
    ASYNC_DATABASE_URL = f"sqlite+aiosqlite:///{settings.DATABASE_PATH}"
```

- **Primary**: Uses `DATABASE_URL` from settings if available
- **Fallback**: Defaults to local SQLite database using `aiosqlite` driver

### Engine Configuration

```python
async_engine = create_async_engine(ASYNC_DATABASE_URL, pool_pre_ping=True)
engine = async_engine  # Legacy alias
```

**Features:**
- **Async Support**: Uses `create_async_engine` for non-blocking database operations
- **Connection Health**: `pool_pre_ping=True` ensures connection validity before use
- **Legacy Compatibility**: Provides `engine` alias for backward compatibility

### Session Management

```python
async_session = sessionmaker(
    async_engine, 
    class_=AsyncSession, 
    expire_on_commit=False
)
```

**Configuration:**
- **Async Sessions**: Uses `AsyncSession` class for asynchronous operations
- **Persistent Objects**: `expire_on_commit=False` keeps objects accessible after commit

### Database Base Class

```python
Base = declarative_base()
```

- **ORM Foundation**: Provides base class for SQLAlchemy model definitions
- **Table Creation**: Used for generating database schema

## Functions

### `get_db()`

**Purpose**: FastAPI dependency function for database session injection

```python
async def get_db():
    """
    Dependency for FastAPI to get a database session.
    Yields an async session and ensures it's closed after use.
    """
    async with async_session() as session:
        try:
            yield session
        finally:
            await session.close()
```

**Usage Example:**
```python
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

@app.get("/items/")
async def get_items(db: AsyncSession = Depends(get_db)):
    # Use db session here
    result = await db.execute(select(Item))
    return result.scalars().all()
```

**Features:**
- **Resource Management**: Automatically handles session lifecycle
- **Error Safety**: Ensures session closure even if exceptions occur
- **FastAPI Compatible**: Designed as a dependency injection function

## Usage Notes

### Best Practices

- **Import Pattern**: Import `get_db` as a FastAPI dependency
- **Session Usage**: Always use `await` with database operations
- **Model Definition**: Inherit from `Base` when creating SQLAlchemy models

### Environment Configuration

Ensure your application settings include:

```python
# Required settings
DATABASE_URL = "postgresql+asyncpg://user:pass@localhost/db"  # Optional
DATABASE_PATH = "app.db"  # Fallback for SQLite
```

### Supported Database Drivers

- **PostgreSQL**: `postgresql+asyncpg://`
- **SQLite**: `sqlite+aiosqlite://`
- **MySQL**: `mysql+aiomysql://`

## Dependencies

- `sqlalchemy.ext.asyncio`: Async SQLAlchemy support
- `sqlalchemy.orm`: ORM functionality
- `app.config.settings`: Application configuration

## Recommendations

1. **Production Setup**: Use `DATABASE_URL` environment variable for production databases
2. **Connection Pooling**: Consider adjusting pool settings for high-traffic applications
3. **Migration Management**: Implement Alembic for database schema migrations
4. **Error Handling**: Add application-level error handling for database operations
5. **Monitoring**: Consider adding database connection monitoring and logging