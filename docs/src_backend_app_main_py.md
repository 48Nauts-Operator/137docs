<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Document Management System - Main Application Module

## Overview

This is the main FastAPI application module for a comprehensive Document Management System. It provides a complete API for document processing, OCR, LLM-based metadata extraction, user management, analytics, and more.

## Key Features

- **Document Processing**: Automatic OCR, metadata extraction, and classification
- **Folder Watching**: Monitors directories for new documents
- **LLM Integration**: AI-powered document analysis and metadata extraction
- **User Management**: Authentication, authorization, and role-based access
- **Analytics**: Document statistics, payment tracking, and reporting
- **Search**: Text-based, semantic, and vision-based document search
- **Multi-tenant Support**: Organization and tenant management
- **Address Book**: Vendor and contact management
- **Calendar Integration**: Due date tracking and ICS export
- **Settings Management**: Configurable system settings

## Main Components

### FastAPI Application Setup

```python
app = FastAPI(
    title="Document Management System API",
    description="API for managing documents, OCR processing, and analytics",
    version="1.0.0",
)
```

- Configures CORS middleware for cross-origin requests
- Includes API routers for modular functionality
- Serves static files from the `/static` directory

### Core Services

The application initializes several key services:

- **DocumentRepository**: Document CRUD operations
- **OCRProcessor**: Optical Character Recognition
- **LLMService**: Large Language Model integration
- **NotificationService**: User notifications
- **AnalyticsService**: Data analytics and reporting
- **SearchService**: Document search capabilities

### Database Initialization

The `startup()` event handler performs comprehensive database setup:

- Creates database tables using SQLAlchemy
- Runs Alembic migrations
- Seeds default users (admin/viewer)
- Configures PostgreSQL vector extensions for semantic search
- Initializes settings and address book data

### Document Processing Pipeline

#### Automatic Processing

When new documents are detected by the folder watcher:

1. **OCR Processing**: Extracts text from PDF/image files
2. **LLM Analysis**: Extracts metadata (dates, amounts, vendors, etc.)
3. **Duplicate Detection**: Uses SHA256 hashing to prevent duplicates
4. **Data Validation**: Normalizes dates, amounts, and other fields
5. **Tagging**: Auto-applies tags based on content and dates
6. **Address Book Integration**: Updates vendor information
7. **Vector Embeddings**: Creates embeddings for semantic search
8. **Notifications**: Creates due date reminders if applicable

#### Processing Status Tracking

Documents go through several status stages:
- `processing`: Initial status when document is being analyzed
- `processed`: Successfully processed and ready
- `failed`: Processing encountered errors

## API Endpoints

### Authentication (`/api/auth/`)

- `POST /login` - User authentication
- `GET /me` - Get current user info
- `POST /change-password` - Change user password
- `POST /register` - Initial admin registration (first-time setup only)

### Documents (`/api/documents/`)

- `GET /` - List documents with filtering
- `GET /{id}` - Get specific document
- `PUT /{id}` - Update document
- `DELETE /{id}` - Delete document
- `POST /upload` - Upload new document
- `GET /{id}/file` - Download document file
- `GET /{id}/tags` - Get document tags
- `POST /{id}/tags` - Add tag to document
- `DELETE /{id}/tags/{tag}` - Remove tag from document

### Search (`/api/search/`)

- `GET /` - Basic text search
- `POST /advanced` - Advanced search with filters
- `GET /semantic` - Semantic similarity search
- `GET /vision` - Vision-based search using ColPali embeddings
- `GET /related/{id}` - Find related documents

### Analytics (`/api/analytics/`)

- `GET /document-types` - Document type distribution
- `GET /payment-status` - Payment status breakdown
- `GET /monthly-documents` - Monthly document counts
- `GET /monthly-invoices` - Monthly invoice amounts
- `GET /summary` - Summary metrics

### User Management (`/api/users/`) - Admin Only

- `GET /` - List all users
- `POST /` - Create new user
- `PUT /{id}` - Update user
- `DELETE /{id}` - Delete user
- `POST /{id}/reset-password` - Reset user password

### Address Book (`/api/address-book/`)

- `GET /` - List address entries
- `POST /` - Create new entry
- `PUT /{id}` - Update entry
- `DELETE /{id}` - Delete entry

### Tenant Management (`/api/tenants/`)

- `GET /` - Get user tenants
- `GET /default` - Get default tenant
- `POST /` - Create tenant
- `PUT /{id}` - Update tenant
- `DELETE /{id}` - Delete tenant
- `POST /{id}/set-default` - Set as default

### Settings (`/api/settings/`)

- `GET /` - Get current settings
- `PUT /` - Update settings
- `POST /validate-folders` - Validate folder permissions
- `POST /migrate-storage` - Migrate storage location
- `GET /migration-status` - Check migration progress

### Notifications (`/api/notifications/`)

- `GET /` - List notifications
- `PUT /{id}/read` - Mark as read
- `PUT /read-all` - Mark all as read
- `DELETE /{id}` - Delete notification

### Calendar (`/api/calendar/`)

- `GET /events` - Get calendar events
- `GET /events/date` - Get events for specific date
- `GET /export` - Export calendar as ICS
- `POST /api-key` - Generate API key for public access
- `GET /export/ics` - Public ICS feed (token or API key auth)

### System Management

- `GET /api/health` - Health check endpoint
- `GET /api/version` - Get application version
- `GET /api/fs` - Browse filesystem (with pagination)
- `GET /api/processing/status` - Get processing queue status

## Important Classes and Functions

### `process_new_document(file_path: str)`

The core