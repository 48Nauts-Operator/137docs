<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Rule Engine Documentation

## Overview

The Rule Engine module provides automated document processing and classification functionality. It evaluates predefined processing rules against documents and executes actions when rules match, enabling automated workflows for document management systems.

## Purpose

- **Automated Processing**: Automatically classify and process documents based on configurable rules
- **Rule Evaluation**: Match documents against conditions like content, sender, type, etc.
- **Action Execution**: Perform automated actions such as categorization, tagging, and status updates
- **Scalable Workflows**: Support complex document processing workflows with priority-based rule execution

## Core Classes

### RuleEvaluator

Evaluates processing rules against documents to determine which actions should be executed.

#### Key Methods

- **`evaluate_document(db, document)`**: Main evaluation method that processes all enabled rules
- **`_evaluate_rule(document, rule)`**: Evaluates a single rule against a document
- **`_evaluate_condition(document, condition)`**: Evaluates individual rule conditions
- **`_matches_vendor(document_sender, rule_vendor)`**: Checks vendor/sender matching

#### Supported Operators

- `equals`: Exact match (case-insensitive)
- `contains`: Substring match
- `starts_with`: Prefix match
- `ends_with`: Suffix match
- `not_equals`: Negated exact match
- `not_contains`: Negated substring match

#### Document Fields

The evaluator can check against these document fields:

- `title`, `content`/`text`, `sender`, `recipient`
- `document_type`, `category`, `amount`, `currency`
- `status`, `filename`, `file_path`

### RuleActionExecutor

Executes actions from matched rules on documents.

#### Key Methods

- **`execute_actions(db, document, actions)`**: Executes a list of actions
- **`_execute_action(db, document, action)`**: Executes a single action

#### Supported Actions

- **`assign_tenant`**: Assign document to a specific tenant
- **`set_category`**: Set document category
- **`add_tag`**: Add tags to document
- **`set_status`**: Update document status
- **`set_document_type`**: Set document type

### DocumentRuleProcessor

Main orchestrator class that combines rule evaluation and action execution.

#### Key Methods

- **`process_document(db, document)`**: Complete document processing workflow

## Usage Example

```python
from app.rule_engine import DocumentRuleProcessor

# Initialize the processor
processor = DocumentRuleProcessor()

# Process a document
async def process_document_example(db_session, document):
    result = await processor.process_document(db_session, document)
    
    print(f"Rules matched: {result['rules_matched']}")
    print(f"Actions executed: {result['actions_executed']}")
    print(f"Actions failed: {result['actions_failed']}")
    
    return result
```

## Rule Structure Example

```json
{
  "id": 1,
  "name": "Invoice Classification",
  "vendor": "ACME Corp",
  "conditions": [
    {
      "field": "content",
      "operator": "contains",
      "value": "invoice"
    },
    {
      "field": "sender",
      "operator": "contains", 
      "value": "billing@acme.com"
    }
  ],
  "actions": [
    {
      "type": "set_category",
      "value": "Financial"
    },
    {
      "type": "add_tag",
      "value": "invoice"
    },
    {
      "type": "set_status",
      "value": "pending_review"
    }
  ]
}
```

## Return Values

The `process_document` method returns a dictionary with:

```python
{
    'document_id': int,           # Document ID processed
    'rules_matched': int,         # Number of rules that matched
    'actions_executed': int,      # Number of actions successfully executed
    'actions_failed': int,        # Number of actions that failed
    'results': {                  # Detailed execution results
        'executed': [...],        # Successfully executed actions
        'failed': [...],          # Failed actions with error details
        'total': int             # Total actions attempted
    }
}
```

## Error Handling

- **Rule Evaluation Errors**: Individual rule failures don't stop processing of other rules
- **Action Execution Errors**: Failed actions are logged and reported but don't prevent other actions
- **Database Transactions**: Changes are committed only if all processing succeeds; rollback on errors
- **Comprehensive Logging**: All operations are logged for debugging and monitoring

## Notes and Suggestions

### Performance Considerations

- Rules are processed in priority order (configured in database)
- Consider adding rule caching for high-volume processing
- Database sessions are properly managed with commit/rollback

### Extensibility

- **New Operators**: Add support for numeric comparisons (`greater_than`, `less_than`)
- **Complex Logic**: Consider adding OR logic support between conditions
- **Custom Actions**: Easy to extend with new action types
- **Rule Dependencies**: Could add support for rule prerequisites

### Best Practices

- **Rule Testing**: Test rules thoroughly before enabling in production
- **Performance Monitoring**: Monitor rule execution times and optimize slow rules
- **Rule Maintenance**: Regularly review and update rules based on processing results
- **Error Monitoring**: Set up alerts for high action failure rates

### Security Considerations

- Validate all rule inputs to prevent injection attacks
- Ensure proper access controls for rule management
- Audit trail for rule modifications and executions