<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# app.scheduler

## Overview

The `app.scheduler` module implements a lightweight background task scheduler for invoice reminder notifications. It periodically scans invoices and creates reminder notifications three days before their due dates.

## Purpose

This module provides a simple alternative to heavyweight task scheduling dependencies like Celery or APScheduler by using asyncio tasks that sleep until their next scheduled run. The scheduler runs daily at a configured UTC hour and checks for upcoming invoice due dates.

## Key Features

- **Lightweight Design**: Uses asyncio instead of external task queue systems
- **Daily Scheduling**: Runs once per day at a configurable UTC hour
- **Automatic Reminders**: Creates notifications 3 days before invoice due dates
- **Hot-reload Safe**: Prevents duplicate scheduler tasks during development
- **Error Handling**: Continues running even if individual scans fail

## Configuration Constants

```python
DAYS_BEFORE_DUE = 3      # Days before due-date to send reminders
SCAN_HOUR_UTC = 2        # UTC hour when daily scan runs (02:00)
```

## Core Functions

### `scheduler_loop()`

The main background coroutine that runs indefinitely with a 24-hour cycle.

**Behavior:**
- Performs an immediate scan on startup
- Calculates sleep time until next scheduled run
- Handles exceptions to prevent the scheduler from stopping

```python
async def scheduler_loop() -> None:
    """Background coroutine that runs forever with a 24-h cadence."""
```

### `start_scheduler()`

Entry point function that spawns the background scheduler task.

**Features:**
- Safe to call multiple times (prevents duplicate tasks)
- Integrates with existing asyncio event loop
- Handles hot-reload scenarios in development

```python
def start_scheduler() -> None:
    """Spawn the background task; safe to call multiple times."""
```

### `_run_once()` *(Internal)*

Executes a single scan cycle to check for upcoming due dates and create notifications.

**Process:**
1. Opens database session
2. Calls notification service to check upcoming due dates
3. Commits any new notifications to database
4. Logs results

## Dependencies

- **Database**: Uses `app.database.async_session` for database operations
- **Notifications**: Integrates with `app.notifications.NotificationService`
- **Logging**: Comprehensive logging for monitoring and debugging

## Usage

The scheduler is typically started from the main application startup:

```python
# In main.startup()
from app.scheduler import start_scheduler

start_scheduler()
```

## Notes and Suggestions

### ‚úÖ Strengths
- Simple and lightweight implementation
- Good error handling and logging
- Safe for development environments with hot-reload
- Immediate startup scan ensures system is current

### ‚ö†Ô∏è Considerations
- **Single Instance**: Not designed for multi-instance deployments
- **Time Zone**: Uses UTC only - consider if local time zones are needed
- **Configuration**: Constants are hardcoded - consider environment variables for production

### üîß Potential Improvements
1. **Configuration**: Move constants to environment variables or config file
2. **Health Checks**: Add endpoint to verify scheduler status
3. **Metrics**: Consider adding metrics for monitoring scheduler performance
4. **Graceful Shutdown**: Implement proper cleanup on application shutdown

### üí° Production Considerations
- Monitor logs for failed scheduler runs
- Consider using proper task queue (Celery/RQ) for high-scale deployments
- Implement distributed locking if running multiple application instances