<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# SearchService Documentation

## Overview

The `SearchService` module provides comprehensive LLM-powered search functionality for a Document Management System. It offers multiple search methods ranging from basic keyword matching to advanced semantic search and AI-powered document relationship discovery.

## Purpose

This service enables users to:
- Search documents using various methods (keyword, semantic, natural language)
- Extract search intent from natural language queries
- Find related documents using AI analysis
- Perform vision-based document search using ColPali embeddings

## Key Features

- **Multiple Search Types**: Basic keyword, semantic vector search, and vision-based search
- **AI-Powered Intent Extraction**: Uses LLM to understand natural language queries
- **Document Relationship Discovery**: Suggests related documents based on content analysis
- **Flexible Parameter Handling**: Supports both structured parameters and natural language input

## Class: SearchService

### Initialization

```python
def __init__(self, db: Session):
    """Initialize the search service with a database session."""
```

**Parameters:**
- `db`: SQLAlchemy database session for document queries

### Core Methods

#### basic_search()

```python
async def basic_search(self, query: str, limit: int = 20) -> List[Dict[str, Any]]
```

Performs simple keyword-based search across document content, titles, and senders.

**Parameters:**
- `query`: Search query string
- `limit`: Maximum number of results (default: 20)

**Returns:** List of matching documents with basic metadata and relevance scoring

**Features:**
- Case-insensitive matching
- Searches across content, title, and sender fields
- Simple relevance scoring (high/medium)

---

#### semantic_search()

```python
async def semantic_search(self, query: str, limit: int = 10) -> List[Dict[str, Any]]
```

Vector-based semantic search using pgvector for cosine similarity matching.

**Parameters:**
- `query`: Search query string
- `limit`: Maximum number of results (default: 10)

**Returns:** Documents ordered by semantic similarity with relevance scores

**Requirements:**
- Requires `app.embeddings.get_embedding()` function
- Documents must have pre-computed embeddings
- PostgreSQL with pgvector extension

---

#### extract_search_intent()

```python
async def extract_search_intent(self, query: str) -> Dict[str, Any]
```

Uses LLM to extract structured search parameters from natural language queries.

**Parameters:**
- `query`: Natural language search query

**Returns:** Dictionary with extracted parameters:
- `document_type`: Type of document (invoice, receipt, etc.)
- `sender`: Document sender
- `date_range`: Start and end dates
- `amount_range`: Min and max amounts
- `status`: Document status
- `keywords`: Important keywords array

**Example Input/Output:**
```python
# Input: "Find unpaid invoices from Acme Corp between January and March"
# Output: {
#   "document_type": "invoice",
#   "sender": "Acme Corp", 
#   "date_range": {"start": "2023-01-01", "end": "2023-03-31"},
#   "status": "unpaid"
# }
```

---

#### advanced_search()

```python
async def advanced_search(self, params, limit: int = 20) -> List[Dict[str, Any]]
```

Comprehensive search using either structured parameters or natural language queries.

**Parameters:**
- `params`: Search parameters (dict) or natural language query (string)
- `limit`: Maximum number of results (default: 20)

**Returns:** List of matching documents with full metadata

**Features:**
- Automatic intent extraction for natural language queries
- Filters by document type, sender, status, date range, amount range
- Keyword matching across content and titles

---

#### suggest_related_documents()

```python
async def suggest_related_documents(self, document_id: int, limit: int = 5) -> List[Dict[str, Any]]
```

Uses LLM to analyze and suggest documents related to a given document.

**Parameters:**
- `document_id`: ID of the source document
- `limit`: Maximum number of suggestions (default: 5)

**Returns:** List of related documents with relationship types and confidence scores

**Relationship Types:**
- `same_sender`: Documents from the same sender
- `invoice_payment`: Invoice and payment pairs
- `invoice_reminder`: Invoice and reminder pairs  
- `related_subject`: Similar subject matter
- `time_sequence`: Chronologically related documents

---

#### vision_search()

```python
async def vision_search(self, query: str, limit: int = 10) -> List[Dict[str, Any]]
```

Performs vision-based document search using ColPali embeddings and late-interaction approximation.

**Parameters:**
- `query`: Text query to search against visual document content
- `limit`: Maximum number of results (default: 10)

**Returns:** Documents ranked by vision-based similarity scores

**Requirements:**
- `app.colpali_embedder.ColPaliEmbedder` class
- `app.vector_store.search()` function
- Qdrant vector database with pre-indexed document patches

## Dependencies

### Required Modules
- `sqlalchemy`: Database ORM operations
- `app.models.Document`: Document model class
- `app.llm.LLMProcessor`: LLM interaction handling
- `app.embeddings.get_embedding()`: Text embedding generation
- `app.colpali_embedder.ColPaliEmbedder`: Vision embedding generation
- `app.vector_store.search()`: Vector similarity search

### Database Requirements
- PostgreSQL with pgvector extension for semantic search
- Qdrant vector database for vision search
- Document embeddings pre-computed and stored

## Usage Examples

```python
# Initialize service
search_service = SearchService(db_session)

# Basic keyword search
results = await search_service.basic_search("invoice payment")

# Natural language search
results = await search_service.advanced_search(
    "Find all unpaid invoices from last month"
)

# Semantic search
results = await search_service.semantic_search("contract renewal")

# Find related documents
related = await search_service.suggest_related_documents(document_id=123)

# Vision-based search
visual_results = await search_