<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# OnboardingService Documentation

## Overview

The `OnboardingService` class provides functionality for managing application onboarding processes, specifically handling Terms of Service (ToS) acceptance tracking. This service interacts with the database to store and retrieve onboarding-related settings and user acceptance status.

## Purpose

- Track whether users have accepted the Terms of Service
- Manage application settings related to onboarding
- Provide a clean interface for onboarding operations with async database operations

## Dependencies

```python
from datetime import datetime
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from app.models import AppSettings
```

## Class: OnboardingService

### Constructor

```python
def __init__(self, db: AsyncSession):
```

**Parameters:**
- `db` (AsyncSession): SQLAlchemy async database session for database operations

### Public Methods

#### `accept_tos()`

```python
async def accept_tos()
```

Records the timestamp when a user accepts the Terms of Service.

**Returns:**
- `datetime`: The timestamp when ToS was accepted

**Behavior:**
- Retrieves or creates the settings row
- Sets `tos_accepted_at` to current UTC timestamp
- Commits the changes to the database

#### `tos_accepted()`

```python
async def tos_accepted() -> bool
```

Checks whether the Terms of Service have been accepted.

**Returns:**
- `bool`: `True` if ToS has been accepted, `False` otherwise

**Logic:**
- Returns `True` if `tos_accepted_at` field is not `None`
- Returns `False` if `tos_accepted_at` is `None`

### Private Methods

#### `_settings_row()`

```python
async def _settings_row()
```

Internal method to retrieve or create the application settings record.

**Returns:**
- `AppSettings`: The settings record from the database

**Behavior:**
- Attempts to get `AppSettings` record with ID `1`
- If no record exists, creates a new one with default values:
  - `inbox_path`: `"/tmp"`
  - `storage_root`: `"/tmp"`
- Commits and refreshes the new record if created

## Usage Example

```python
async def example_usage():
    # Initialize service with database session
    onboarding = OnboardingService(db_session)
    
    # Check if ToS is already accepted
    if not await onboarding.tos_accepted():
        # Accept ToS and get timestamp
        accepted_at = await onboarding.accept_tos()
        print(f"ToS accepted at: {accepted_at}")
    else:
        print("ToS already accepted")
```

## Notes and Suggestions

### ‚ö†Ô∏è Potential Issues

1. **Hardcoded ID**: The service assumes `AppSettings` record always has ID `1`. This could be problematic in multi-tenant scenarios.

2. **Default Paths**: Uses `/tmp` as default for `inbox_path` and `storage_root`, which may not be appropriate for production environments.

3. **Error Handling**: No explicit error handling for database operations.

### üí° Recommendations

1. **Configuration**: Consider making default paths configurable through environment variables or configuration files.

2. **Error Handling**: Add try-catch blocks for database operations:
   ```python
   try:
       await self.db.commit()
   except SQLAlchemyError as e:
       await self.db.rollback()
       raise OnboardingServiceError(f"Failed to accept ToS: {e}")
   ```

3. **Multi-tenant Support**: If supporting multiple tenants, consider passing a tenant ID or user ID to identify the correct settings record.

4. **Logging**: Add logging for important operations like ToS acceptance for audit purposes.

5. **Type Hints**: Consider adding more specific return type hints for better IDE support.

## Database Dependencies

This service requires:
- `AppSettings` model with fields:
  - `id` (primary key)
  - `tos_accepted_at` (datetime, nullable)
  - `inbox_path` (string)
  - `storage_root` (string)