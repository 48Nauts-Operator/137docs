<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Qdrant Helper Module

## Overview

This module provides a lightweight wrapper around Qdrant vector database specifically designed for ColPali integration. It implements a lazy-loading pattern for the Qdrant client and offers essential operations for managing document page vectors.

## Purpose

- **Minimal dependency surface**: Designed to be imported in background tasks without heavy initialization overhead
- **Lazy client instantiation**: Creates Qdrant client only when needed
- **ColPali integration**: Specifically tailored for handling multi-vector document page embeddings
- **Idempotent operations**: Safe to call repeatedly without side effects

## Configuration

The module uses environment variables for configuration:

| Variable | Default Value | Description |
|----------|---------------|-------------|
| `QDRANT_COLLECTION` | `"colpali_pages"` | Name of the Qdrant collection |
| `VECTOR_DB_HOST` | `"qdrant"` | Qdrant server hostname |
| `VECTOR_DB_PORT` | `6333` | Qdrant server port |

## Key Functions

### `_get_client() -> QdrantClient`

**Private function** that implements the lazy-loading pattern for the Qdrant client.

- Returns a singleton `QdrantClient` instance
- Creates the client only on first call
- Subsequent calls return the cached instance

### `ensure_collection(vector_size: int = 128)`

Idempotently creates the required Qdrant collection if it doesn't exist.

**Parameters:**
- `vector_size` (int, optional): Dimension of vectors to store. Defaults to 128.

**Behavior:**
- Checks if collection exists
- If not found, creates a new collection with:
  - Cosine distance metric
  - Specified vector dimensions

### `upsert_page(doc_id: int, page_idx: int, multi_vectors: Sequence[Sequence[float]]) -> List[str]`

Inserts multiple vectors for a document page into the collection.

**Parameters:**
- `doc_id` (int): Document identifier
- `page_idx` (int): Page index within the document
- `multi_vectors` (Sequence[Sequence[float]]): List of vector embeddings for the page

**Returns:**
- `List[str]`: List of generated UUID strings for the inserted points

**Process:**
1. Ensures collection exists with proper vector dimensions
2. Generates unique UUID for each vector
3. Creates point structures with metadata (doc_id, page)
4. Performs batch upsert operation

### `search(query_vector: Sequence[float], top_k: int = 20)`

Performs vector similarity search in the collection.

**Parameters:**
- `query_vector` (Sequence[float]): Query vector for similarity search
- `top_k` (int, optional): Number of top results to return. Defaults to 20.

**Returns:**
- List of `ScoredPoint` objects from Qdrant

## Data Structure

Each point stored in Qdrant contains:

```python
{
    "id": "uuid_string",
    "vector": [float, float, ...],
    "payload": {
        "doc_id": int,
        "page": int
    }
}
```

## Usage Example

```python
# Insert vectors for a document page
point_ids = upsert_page(
    doc_id=123, 
    page_idx=0, 
    multi_vectors=[[0.1, 0.2, ...], [0.3, 0.4, ...]]
)

# Search for similar vectors
results = search(query_vector=[0.1, 0.2, ...], top_k=10)
```

## Notes and Suggestions

### ✅ Strengths
- **Lazy loading**: Efficient resource usage
- **Error handling**: Graceful collection creation
- **Batch operations**: Efficient vector insertion

### ⚠️ Considerations
- **Broad exception handling**: `except Exception:` in `ensure_collection()` might mask specific errors
- **Vector dimension inference**: Automatically infers dimensions from first vector, which could be fragile
- **No connection error handling**: Network issues with Qdrant server aren't explicitly handled

### 🔧 Suggested Improvements

1. **More specific exception handling**:
   ```python
   from qdrant_client.http.exceptions import UnexpectedResponse
   
   try:
       client.get_collection(_COLLECTION)
   except UnexpectedResponse as e:
       if e.status_code == 404:  # Collection not found
           # Create collection
   ```

2. **Add connection health check**:
   ```python
   def health_check() -> bool:
       """Check if Qdrant server is accessible."""
       try:
           client = _get_client()
           return client.get_collections() is not None
       except Exception:
           return False
   ```

3. **Validate vector dimensions**:
   ```python
   def _validate_vectors(vectors: Sequence[Sequence[float]]) -> None:
       if not vectors:
           raise ValueError("Empty vector list")
       
       expected_dim = len(vectors[0])
       for i, vec in enumerate(vectors):
           if len(vec) != expected_dim:
               raise ValueError(f"Vector {i} has dimension {len(vec)}, expected {expected_dim}")
   ```