<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Document Watcher Module

## Overview

The Document Watcher module provides a comprehensive file monitoring system that watches a specified folder for new, modified, or existing documents. It uses both event-based monitoring (via the `watchdog` library) and polling mechanisms to ensure reliable document detection and processing.

## Purpose

This module is designed to:
- Monitor a folder for document files (PDF, Word docs, images)
- Detect new files, moved files, and modified files in real-time
- Process documents with a priority-based queue system
- Provide fallback polling mechanism when event-based monitoring fails
- Handle existing files with lower priority than new documents

## Key Features

- **Multi-layered Detection**: Combines watchdog events with polling for reliability
- **Priority Processing**: New/modified files get higher priority than existing files
- **Asynchronous Processing**: Non-blocking document processing using asyncio
- **Automatic Folder Creation**: Creates the watched folder if it doesn't exist
- **Comprehensive Logging**: Detailed logging for monitoring and debugging

## Classes and Functions

### `ProcessingTask` (Dataclass)

Represents a document processing task with priority handling.

```python
@dataclass
class ProcessingTask:
    priority: int      # Lower number = higher priority
    file_path: str    # Path to the document
    task_type: str    # 'new', 'existing', or 'modified'
    timestamp: float  # When the task was created
```

**Key Points:**
- Uses `__lt__` method for priority queue ordering
- Higher priority tasks (lower numbers) get processed first
- Newer files get priority when tasks have the same priority level

### `DocumentEventHandler`

Handles file system events from the watchdog observer.

**Key Methods:**

#### `__init__(callback, task_queue)`
- **callback**: Async function to process documents
- **task_queue**: Queue for scheduling processing tasks

#### `_is_document(file_path)`
Checks if a file has a supported extension:
- **PDF**: `.pdf`
- **Word**: `.docx`, `.doc`  
- **Images**: `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`

#### Event Handlers
- `on_created()`: Handles newly created files
- `on_moved()`: Handles moved files (treated as new)
- `on_modified()`: Handles modified files

### `FolderWatcher`

Main class that orchestrates the entire document watching system.

#### `__init__(folder_path, callback, poll_interval=30)`

**Parameters:**
- **folder_path**: Directory to monitor
- **callback**: Async function to process documents
- **poll_interval**: Seconds between polling checks (default: 30)

#### `start_watching()`

Starts the complete monitoring system:

```python
async def start_watching(self):
    # Starts watchdog observer
    # Launches task processor
    # Begins polling loop
    # Queues existing files
```

**Process Flow:**
1. Starts watchdog observer for real-time events
2. Launches priority task processor
3. Begins fallback polling loop
4. Queues existing files with low priority

#### Priority System

| Priority Level | Task Type | Description |
|---------------|-----------|-------------|
| 1 | New/Modified (via events) | Highest priority for real-time detection |
| 1 | New (via polling) | High priority for polling detection |
| 2 | Modified (via polling) | Medium priority for modified files |
| 10 | Existing files | Lowest priority for startup processing |

## Usage Example

```python
import asyncio
from document_watcher import FolderWatcher

async def process_document(file_path: str):
    """Your document processing logic here"""
    print(f"Processing: {file_path}")
    # Add your document processing code
    await asyncio.sleep(1)  # Simulate processing time

async def main():
    watcher = FolderWatcher(
        folder_path="/path/to/documents",
        callback=process_document,
        poll_interval=60  # Check every minute
    )
    
    await watcher.start_watching()

if __name__ == "__main__":
    asyncio.run(main())
```

## Configuration Notes

### Supported File Types
Currently supports these document types:
- **PDF**: `.pdf`
- **Microsoft Word**: `.docx`, `.doc`
- **Images**: `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif`

### Polling Interval
- Default: 30 seconds
- Recommended: 30-300 seconds depending on volume
- Lower values = more responsive but higher CPU usage

## Important Considerations

### Performance
- **New files get immediate priority** over existing files
- Processing is single-threaded per task to avoid conflicts
- Polling provides fallback when watchdog events are missed

### Reliability
- **Dual detection system**: Both events and polling ensure files aren't missed
- **Error handling**: Continues operation even if individual files fail
- **Graceful shutdown**: Properly stops all monitoring when cancelled

### Logging
- Uses Python's standard logging module
- Log level should be set to INFO or DEBUG for monitoring
- Key events are logged for troubleshooting

## Suggestions for Implementation

1. **Error Handling**: Implement robust error handling in your callback function
2. **File Locking**: Consider file locking mechanisms if multiple processes access files
3. **Configuration**: Make supported file extensions configurable if needed
4. **Monitoring**: Set up proper logging and monitoring for production use
5. **Resource Management**: Monitor memory usage with large numbers of files

## Dependencies

```python
# Required packages
watchdog>=2.1.0  # For file system event monitoring
asyncio          # Built-in async support
logging          # Built-in logging
os               # Built-in file system operations
time             # Built-in time utilities
typing           # Built-in type hints
heapq            # Built-in priority queue
dataclasses      # Built-in dataclass support
```