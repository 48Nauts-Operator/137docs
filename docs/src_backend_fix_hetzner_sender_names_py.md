<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Hetzner Invoice Sender Name Fixer

## Overview

This Python script is designed to clean up corrupted sender names in Hetzner invoices stored in a database. The script identifies and fixes sender fields that contain JSON strings instead of clean company names, standardizing them to display "Hetzner Online GmbH" or other appropriate clean names.

## Purpose

- **Problem**: Hetzner invoice sender names may be stored as JSON strings instead of clean text
- **Solution**: Parse JSON data and extract meaningful company names
- **Goal**: Ensure consistent, readable sender names in the database

## Key Components

### Functions

#### `extract_sender_name(sender_data)`

**Purpose**: Extracts a clean company name from potentially corrupted sender data.

**Parameters**:
- `sender_data`: The raw sender data (string or other type)

**Returns**: Clean sender name as a string

**Logic**:
- Returns empty string if no data provided
- If data is already a clean string (non-JSON), returns it as-is
- If data appears to be JSON:
  - Attempts to parse the JSON
  - Looks for common name fields: `name`, `company`, `sender`, `company_name`
  - Falls back to first non-empty string value if no standard fields found
- Handles JSON parsing errors gracefully

```python
# Example usage
clean_name = extract_sender_name('{"company": "Hetzner Online GmbH", "id": 123}')
# Returns: "Hetzner Online GmbH"
```

#### `fix_hetzner_sender_names()`

**Purpose**: Main async function that processes all Hetzner documents in the database.

**Process**:
1. Connects to database using async session
2. Queries for all documents with "hetzner" in sender field (case-insensitive)
3. For each document:
   - Extracts clean sender name
   - Compares with original
   - Updates database if changes needed
4. Commits all changes and reports results

## Database Integration

### Dependencies
- **SQLAlchemy**: Async ORM for database operations
- **Custom modules**: 
  - `app.database.async_engine`: Database connection
  - `app.models.Document`: Document model

### Query Details
- Uses `ILIKE` for case-insensitive search of Hetzner documents
- Updates records in bulk transaction for efficiency
- Commits changes only if fixes are made

## Usage

### Prerequisites
- Python 3.7+ (uses `asyncio`)
- Database with Document model containing sender field
- Required dependencies installed

### Running the Script

```bash
python3 fix_hetzner_sender.py
```

### Output Example
```
Found 15 Hetzner documents to check:

Document ID 101:
  Original: {"company": "Hetzner Online GmbH", "address": "..."}
  Cleaned:  Hetzner Online GmbH
  ‚úÖ Fixed!

Document ID 102:
  Original: Hetzner Online GmbH
  Cleaned:  Hetzner Online GmbH
  ‚úì Already clean

üéâ Successfully fixed 8 Hetzner invoice sender names!
```

## Technical Notes

### Important Considerations

- **Path Modification**: Script adds `/app` to `sys.path` for module imports
- **Error Handling**: Gracefully handles JSON parsing errors
- **Transaction Safety**: Uses database transactions to ensure data integrity
- **Case Sensitivity**: Uses case-insensitive search for "hetzner"

### Potential Improvements

- **Logging**: Consider adding proper logging instead of print statements
- **Backup**: Add option to backup original data before modifications
- **Validation**: Add validation to ensure extracted names are reasonable
- **Configuration**: Make company name patterns configurable
- **Dry Run**: Add option to preview changes without committing

### Limitations

- **Hetzner-Specific**: Currently only searches for Hetzner documents
- **Field Assumptions**: Assumes specific JSON field names for company information
- **No Rollback**: No built-in mechanism to undo changes

## Security & Safety

- ‚úÖ Uses parameterized queries (safe from SQL injection)
- ‚úÖ Handles malformed JSON gracefully
- ‚úÖ Uses database transactions
- ‚ö†Ô∏è Modifies data without backup - consider adding backup functionality