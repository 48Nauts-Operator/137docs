<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Tenant Automation Fix Script

## Overview

This Python script is designed to fix tenant automation issues by automatically assigning documents to their appropriate tenant entities based on content analysis. It identifies documents that lack proper tenant assignment and uses intelligent rules to match them with existing entities in the database.

## Purpose

- **Problem**: Documents in the system have missing, empty, or generic recipient assignments (`None`, `''`, `'Your Company'`, `'Unknown'`)
- **Solution**: Automatically analyze document content and assign them to appropriate tenant entities based on predefined rules
- **Goal**: Improve document organization and tenant-based filtering

## Key Components

### Database Models
The script works with two main database models:
- **`Document`**: Contains document information (title, content, sender, recipient, entity_id)
- **`Entity`**: Represents tenant organizations with aliases and names

### Main Function: `fix_tenant_automation()`

This asynchronous function performs the complete tenant assignment process:

#### 1. **Entity Discovery**
```python
# Loads all available entities from database
result = await session.execute(select(Entity))
entities = {entity.id: entity for entity in result.scalars().all()}
```

#### 2. **Problematic Document Identification**
Finds documents with missing or generic recipient information:
- `recipient` is `None` or empty string
- `recipient` equals `'Your Company'` or `'Unknown'`

#### 3. **Smart Assignment Rules**

The script uses three intelligent assignment rules:

| Rule | Trigger Keywords | Target Entity | Use Case |
|------|------------------|---------------|----------|
| **Rule 1** | "google" in sender/title/content | Google entity | Google services documents |
| **Rule 2** | "andr√©", "personal", "medical", "insurance" | Personal entity | Personal/medical documents |
| **Rule 3** | "test company", "office", "rent", "test corp" | Test Corp entity | Business documents |

#### 4. **Assignment Application**
Updates matching documents with:
- `recipient` field set to entity alias
- `entity_id` field set to entity ID

## Usage

### Prerequisites
- Python 3.7+
- Required packages: `sqlalchemy`, `aiosqlite`
- SQLite database at `./documents.db`
- Proper `app.models` module with `Document` and `Entity` classes

### Running the Script
```bash
python3 fix_tenant_automation.py
```

### Sample Output
```
üîß Fixing Tenant Automation
========================================
üë• Available Entities:
  1: Google (Google Services)
  2: Personal (Personal Documents)
  3: Test Corp (Test Company)

üìÑ Found 15 documents to fix:
  üìÑ Google Drive Notification              ‚Üí Google (Google service detected)
  üìÑ Medical Insurance Statement             ‚Üí Personal (Personal document detected)
  üìÑ Office Rent Invoice                     ‚Üí Test Corp (Company document detected)
  ‚ùì Unknown Document Type                   ‚Üí No assignment found

üéØ Applying 12 assignments...
‚úÖ Tenant automation fixed!
   üìä 12 documents assigned to tenants
   üéØ 3 documents still need manual review
```

## Configuration Notes

### Database Configuration
- Uses SQLite with async support (`aiosqlite`)
- Database path: `./documents.db`
- Set `echo=False` for production (change to `True` for SQL debugging)

### Path Configuration
The script adds paths to support module imports:
```python
sys.path.append('/app')
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
```

## Suggestions for Improvement

### 1. **Configuration File**
Consider moving assignment rules to a external configuration file:
```yaml
assignment_rules:
  - name: "Google Services"
    keywords: ["google"]
    target_entity: "Google"
    fields: ["sender", "title", "content"]
```

### 2. **Enhanced Matching**
- Add fuzzy string matching for better keyword detection
- Implement confidence scoring for assignments
- Add support for regular expressions in rules

### 3. **Logging**
Replace print statements with proper logging:
```python
import logging
logger = logging.getLogger(__name__)
logger.info("Starting tenant automation fix...")
```

### 4. **Error Handling**
Add try-catch blocks for database operations and provide rollback mechanisms.

### 5. **Testing**
Create unit tests for assignment rules and database operations.

## Security Considerations

- **Database Connection**: Consider using environment variables for database credentials
- **Input Validation**: Add validation for document content before processing
- **Access Control**: Ensure proper permissions for database modifications

## Dependencies

```python
# Required packages
sqlalchemy[asyncio]  # Database ORM with async support
aiosqlite           # Async SQLite driver
```