<!-- Auto-generated by Claude on 2025-06-01 10:12 -->

# Database Initialization Script

## Overview

This Python script is responsible for initializing the database with all required tables for the application. It serves as a setup utility that creates the complete database schema from SQLAlchemy model definitions.

## Purpose

- **Database Setup**: Creates all necessary tables in the database
- **Schema Initialization**: Ensures the database structure matches the application's data models
- **Environment Flexibility**: Supports both SQLite and other database engines via configuration

## Key Components

### Main Function

#### `init_database()`

```python
async def init_database():
```

An asynchronous function that handles the complete database initialization process.

**Features:**
- Creates database engine with appropriate connection string
- Generates all tables from SQLAlchemy Base metadata
- Provides detailed console output with progress indicators
- Handles errors gracefully with try/catch blocks
- Properly disposes of database connections

### Database Configuration

The script determines the database connection using a fallback approach:

```python
if settings.DATABASE_URL:
    DATABASE_URL = settings.DATABASE_URL
else:
    DATABASE_URL = f"sqlite+aiosqlite:///{settings.DATABASE_PATH}"
```

- **Primary**: Uses `DATABASE_URL` from settings if available
- **Fallback**: Constructs SQLite connection string using `DATABASE_PATH`

## Database Schema

The script creates the following tables:

- **users** - User account information
- **documents** - Document storage and metadata
- **entities (tenants)** - Multi-tenant organization data
- **user_entities** - User-tenant relationship mapping
- **llm_config** - Large Language Model configuration
- **address_book** - Contact information storage
- **tags** - Document tagging system
- **document_tag** - Many-to-many document-tag relationships
- **notifications** - User notification system
- **settings** - Application configuration storage
- **vectors** - Vector embeddings for search/AI features

## Usage

### Command Line Execution

```bash
python3 init_db.py
```

### Programmatic Usage

```python
import asyncio
from init_db import init_database

# Run the initialization
asyncio.run(init_database())
```

## Dependencies

- **SQLAlchemy**: Async ORM for database operations
- **aiosqlite**: Async SQLite driver (when using SQLite)
- **asyncio**: Asynchronous programming support

## Important Notes

### ‚ö†Ô∏è Path Configuration Issues

The script uses manual path manipulation:

```python
sys.path.append('/app')
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
```

**Recommendations:**
- Consider using proper package installation instead of path manipulation
- Use relative imports where possible
- Implement proper Python package structure

### üîß Configuration Dependencies

- Requires `app.config.settings` to be properly configured
- Needs `app.models.Base` to contain all model definitions
- Database connection settings must be available

### üöÄ Best Practices

1. **Run Before Application Start**: Execute this script before starting the main application
2. **Environment Variables**: Ensure database configuration is set in environment
3. **Backup Considerations**: Be cautious when running against existing databases
4. **Error Handling**: Monitor console output for initialization errors

## Error Handling

The script includes comprehensive error handling:

- Catches and displays database connection errors
- Ensures proper cleanup of database connections
- Provides clear error messages with emoji indicators

## Output Example

```
üóÑÔ∏è Initializing Database
========================================
Database URL: sqlite+aiosqlite:///./app.db

‚úÖ Database initialized successfully!
üìä Tables created:
  - users
  - documents
  - entities (tenants)
  [... additional tables listed ...]
```